---
title: "02.2Refactor"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

## General ====
library("tidyverse") # Plotting and data manipulation
library(here)

## Statistics ====
library(drc) # for asymptotic model
# library("nlme") # for nested anova via lme. See http://www.jason-french.com/tutorials/repeatedmeasures.html
# library("multcomp")
# library("car")
# library("agricolae")
# library(bayestestR)
# # library(rstanarm)
# library(estimate)
# library(equivalence)
#
#
# ## Plotting ====
library(patchwork)
# library("cowplot") # clean up ggplots, plotgrid
# library("ggthemes")
library("lemon")
# library(Hmisc) # for mean_sdl ribbons
# library("ggthemes")
# library("ggsci")
# library(see) # Utrum damnati futuri sint, qui non viderunt et crediderunt
# library(patchwork)
#
# ## Specialty functions ====
source(here("R", "02MoniterGapJunction.R"))
#
# ## Global Params ====
# # theme_set(kickme())
# theme_set(theme_minimal())
# library(broom) # for parameter estimates
# library("furrr")
# plan(multiprocess)
```

# Read in and aggregate data
```{r read in data, eval=TRUE, include=FALSE}
# Preprocessing ----
tecc <- readRDS(file = here("data", "tecc.rds"))
tevc <- readRDS(file = here("data", "tevc.rds"))

tecc <- collapse_duplicate_gj_obs(tecc)
tevc <- collapse_duplicate_gj_obs(tevc)

## Join independent data types into a single data frame ====
all.data <- full_join(tecc, tevc)

all.data <- all.data[, c(
  "Condition", "Experiment", "Time", "Inj_Cell",
  "tecc.recording", "tevc.recording",
  "r11", "r12", "r1", "rc", "cc", "rmp", "gj"
)]

all.data <- all.data %>% as.data.frame()
```

```{r}
## Rename conditions ====
rename.df <- as.data.frame(list(
  c("Aberrant Depol", "PS.0.High.Amp"),
  c("Aberrant_Depol_22.5_deg", "PS.22.High.Amp"),

  c("HA 90 Degree", "PS.90.HA"),
  c("HA 90 Degree Cd", "PS.90.HA.Cd"),

  c("0_deg", "PS.0"),
  c("22.5_degrees", "PS.22"),
  c("rep 45 Degree", "PS.45"),
  c("rep 90 Degree", "PS.90"),

  c("PS.0.orig", "PS.0.orig"),
  c("PS.22.orig", "PS.22.orig"),
  c("PS.45.orig", "PS.45.orig"),
  c("PS.90.orig", "PS.90.orig"),
  c("PS.180.orig", "PS.180.orig"),

  c("hold_at_-53mV", "Silent.53mV"),
  c("TEA_ControlWave", "PS.0.TEA"),
  c("PS.0.TEA", "PS.0.TEA"),
  c("TEA_Silent", "Silent.TEA"),
  c("Inverted Wave", "Inv"),

  c("TEA.Active", "TEA.Active")
))

rename.df <- as.data.frame(t(rename.df))
names(rename.df) <- c("old", "new")
rownames(rename.df) <- NULL # get rid of rownames

all.data$changed <- F
for (i in seq(1, nrow(rename.df))){
  all.data[all.data$Condition == as.character(rename.df[i, "old"]), "Condition"] <- as.character(rename.df[i, "new"])
  all.data[all.data$Condition == as.character(rename.df[i, "old"]), "changed"] <- T
}
# print out the unchanged rows
print(all.data[!all.data$changed & !(all.data$Condition %in% as.vector(rename.df[, "new"])), ])
#and drop
all.data <- all.data[, !(names(all.data) %in% c("changed"))]

# reorder factors
all.data$Condition <- factor(all.data$Condition, as.vector(rename.df[, "new"])[-16] ) #-16 removes the duplicate "PS.0.TEA

#convert gj to inverse to make it easier to work with.
all.data$gj <- (1/all.data$gj)
```

```{r}
# restrict to the final set of conditions:
all.data <- all.data[all.data$Condition %in% c(
  "PS.0.High.Amp", "PS.22.High.Amp",
  "PS.90.HA", "PS.90.HA.Cd",
  "PS.0", "PS.22", "PS.45", "PS.90"), ]
```

```{r}
# new qc, flag first then remove.
# this allows for visualization before removal.
dept.vars = c("r11", "r12", "r1", "rc", "cc", "rmp", "gj")

for( dept.var in dept.vars){
  QC.var = paste0("QC", dept.var)
  all.data[QC.var] = FALSE

  ### 1. Resistances can't be zero, drop any which are.  ####
  if(dept.var %in% c("r11", "r12", "r1", "rc", #"cc", "rmp",
                     "gj")){
    mask <- (!is.na(all.data[dept.var]) & (all.data[dept.var] < 0))
    all.data[mask, QC.var] = TRUE
  }
  ### 2. If coupling coef is less than 0 or above 1, drop it. ####
  if(dept.var %in% c("cc")){
    mask <- (!is.na(all.data[dept.var]) & (all.data[dept.var] > 1 | all.data[dept.var] < 0))
    all.data[mask, QC.var] = TRUE
  }
}

# # for condition | time | response var
# conditions <- all.data$Condition %>% unique()
# times <- all.data$Time %>% unique()
# response.vars <- c("r11", "r1", "cc", "a.peak.nA", "htk.peak.nA", "rc", "gj")
#
# multiplier <-  2
# use.method <- "use.sd" #use.iqr
#
# tic <- Sys.time()
# for (i in seq_along(conditions)) {
#   for (j in seq_along(times)) {
#     for (k in seq_along(response.vars)) {
#       if (use.method == "use.sd") {
#         current.mean <- all.data[all.data$Condition == conditions[i] &
#           all.data$Time == times[j], response.vars[k]] %>% mean(na.rm = TRUE)
#         current.sd <- all.data[all.data$Condition == conditions[i] &
#           all.data$Time == times[j], response.vars[k]] %>% sd(na.rm = TRUE)
#
#         all.data[all.data$Condition == conditions[i] & all.data$Time == times[j] & ((all.data[[response.vars[k]]] < (current.mean - (multiplier * current.sd))) | (all.data[[response.vars[k]]] > (current.mean + (multiplier * current.sd)))) & !(is.na(all.data[[response.vars[k]]])), response.vars[k]] <- NA
#       } else if (use.method == "use.iqr") {
#         current.median <- all.data[all.data$Condition == conditions[i] &
#           all.data$Time == times[j], response.vars[k]] %>% median(na.rm = TRUE)
#         current.iqr <- all.data[all.data$Condition == conditions[i] &
#           all.data$Time == times[j], response.vars[k]] %>% IQR(na.rm = TRUE)
#
#         all.data[all.data$Condition == conditions[i] & all.data$Time == times[j] & ((all.data[[response.vars[k]]] < (current.median - (multiplier * current.iqr))) | (all.data[[response.vars[k]]] > (current.median + (multiplier * current.iqr)))) & !(is.na(all.data[[response.vars[k]]])), response.vars[k]] <- NA
#       } else {
#         warning(paste(as.character(use.method), "is not use.sd or use.iqr!"))
#       }
#     }
#   }
# }
# print(Sys.time() - tic)

```





### Reduce dataset
```{r}
# Reduce data to target times ----
# all.data <- all.data[all.data$Time %in% c(0, 20, 40, 60), ]

```

### Calculate deltas and percent changes
```{r}
all.data.d <- convert_data_to(
  input.df = all.data,
  convert.to = c("difference"),
  data.cols = c("r11", "r12", "r1", "rc", "cc", "rmp", "gj"
  )
)

M <- all.data#[all.data$Time %in% c(0, 20, 40, 60) , ]
M.d <- all.data.d#[all.data.d$Time %in% c(0, 20, 40, 60) , ]
```

## Test w/o deltas
```{r}
# d <- add_stim_delay_phase(d = M)
# d <- M
#
# d$inter <- paste0(d$Experiment, ".", d$Inj_Cell)
# # REPEAT Manual QC wonky points ----
# ## gj ====
# #TEA sync
# d[d$inter == "180212.LC4" & d$Time %in% c(40), "gj"] <- NA
# # ps0
# d[d$inter == "180507.LC4" & d$Time %in% c(40), "gj"] <- NA
#
# ## rc ====
# # ps0
# d[d$inter == "180507.LC4" & d$Time %in% c(40), "rc"] <- NA
# # PS.22
# d[d$inter == "181001.LC4" & d$Time %in% c(40, 60), "rc"] <- NA

```

```{r}
# Use expand grid to get a full combination of tests then filter out the ones we don't want. This will let us use one future_map and maybe get faster
comparisons <- c(paste("PS.0.High.Amp", "PS.22.High.Amp", sep = "_"),
                 paste("PS.22.High.Amp", "PS.90.HA", sep = "_"),
                 paste("PS.90.HA", "PS.90.HA.Cd", sep = "_"),
                 paste("PS.0", "PS.22", "PS.45", "PS.90", sep = "_"))
dept.vars <- c("gj",
               "rc",
               "r12",
               "cc",
               "rmp",
               "r11",
               "r1")

# Set up a df with the inputs I want.
all.tests <- as.data.frame(expand.grid(comparisons, dept.vars))
names(all.tests) <- c("Groups", "DV")

# all.tests <- all.tests %>%
#   mutate(Obs.Net = ifelse(DV %in% c("gj", "Rc", "rc", "r12"), T, F)) %>% #NOTE: gj == Rc; gj != rc
#   mutate(Model = ifelse(Groups == "PS.90.HA", "dept.var ~ Time", "dept.var ~ Time * Condition")) %>% #TODO switch to a more robust   mutate(Random = "~1 | Experiment")
```

template for one
```{r}
# Test ----
d <- M
M.clean <- d #%>% rename(Rc = gj)
```

# figures explicit
```{r}
condition.labs <- c("TEA Mimic Sync", "TEA Mimic Async", "Depol. Async", "Depol. Async Cd2+",
                    "Standardized \n0 Deg.", "Standardized \n22.5 Deg.", "Standardized \n45 Deg.", "Standardized \n90 Deg.",
                    "Individualized \n0 Deg.", "Individualized \n22.5 Deg.", "Individualized \n45 Deg.", "Individualized \n90 Deg.", "Individualized \n180 Deg.")

names(condition.labs) <- c("PS.0.High.Amp", "PS.22.High.Amp", "PS.90.HA", "PS.90.HA.Cd",
                           "PS.0", "PS.22", "PS.45", "PS.90",
                           "PS.0.orig", "PS.22.orig", "PS.45.orig", "PS.90.orig", "PS.180.orig")

M.clean$Condition <- factor(M.clean$Condition, levels = c("PS.0.High.Amp", "PS.22.High.Amp", "PS.90.HA", "PS.90.HA.Cd",
                                                          "PS.0", "PS.22", "PS.45", "PS.90",
                                                          "PS.0.orig", "PS.22.orig", "PS.45.orig", "PS.90.orig", "PS.180.orig"))

### Params ####
text.size = 20
point.size = 3
line.size = 3
mean.point.size = 3
mean.line.size = 3

### High Amplitude Plots ####
plt.tea <- M.clean[M.clean$Condition %in% c("PS.0.High.Amp", "PS.22.High.Amp"), ] %>%
  dplyr::select(Condition, Experiment, Inj_Cell, Time, gj) %>%
  group_by(Condition, Experiment, Inj_Cell, Time) %>%
  summarise(gj = mean(gj, na.rm = T)) %>%
  ungroup() %>%
  # mutate(Time = as.character(Time)) %>%
  pivot_wider(names_from = Time, values_from = gj) %>%
  mutate(`20` = `20` - `0`,
         `40` = `40` - `0`,
         `60` = `60` - `0`) %>%
  mutate(`0` = 0) %>%
  pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "gj") %>%
  group_by(Condition, Time) %>%
  mutate(mean_gj = mean(gj, na.rm = T),
         mean_sd_up = mean_gj+sd(gj, na.rm = T),
         mean_sd_dn =mean_gj- sd(gj, na.rm = T),) %>%
  mutate(inter = paste(Experiment, Inj_Cell, sep = ".")) %>%
  ggplot(aes(x = Time,
             y = gj,
             # color = Experiment,
             # shape = Inj_Cell,
             group = inter))+
  geom_ribbon(aes(ymin=mean_sd_dn, ymax=mean_sd_up), fill = "gray", alpha = 0.1)+
  lemon::geom_pointline(size = point.size, linesize = line.size)+
  geom_point(aes(x = Time, y = mean_gj), color = "white", size = mean.point.size, alpha = 0.3)+
  geom_pointline(aes(x = Time, y = mean_gj), color = "firebrick", size = mean.point.size, linesize = mean.line.size,  shape = 1)+
  labs(y = expression(paste(Delta, "Rc", " in M", Omega)), x = "Time in Minutes")+
  facet_grid(.~Condition,
             labeller = labeller(Condition = condition.labs))+
  geom_hline(yintercept = 0)+
  theme(
    # axis.text = element_text(size = rel(2), angle = 0),
        text = element_text(size=text.size)
        )

plt.hv <- M.clean[M.clean$Condition %in% c("PS.90.HA", "PS.90.HA.Cd" ), ] %>%
  dplyr::select(Condition, Experiment, Inj_Cell, Time, gj) %>%
  group_by(Condition, Experiment, Inj_Cell, Time) %>%
  summarise(gj = mean(gj, na.rm = T)) %>%
  ungroup() %>%
  # mutate(Time = as.character(Time)) %>%
  pivot_wider(names_from = Time, values_from = gj) %>%
  mutate(`20` = `20` - `0`,
         `40` = `40` - `0`,
         `60` = `60` - `0`) %>%
  mutate(`0` = 0) %>%
  pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "gj") %>%
  group_by(Condition, Time) %>%
  mutate(mean_gj = mean(gj, na.rm = T),
         mean_sd_up = mean_gj+sd(gj, na.rm = T),
         mean_sd_dn =mean_gj- sd(gj, na.rm = T),) %>%
  mutate(inter = paste(Experiment, Inj_Cell, sep = ".")) %>%
  ggplot(aes(x = Time,
             y = gj,
             # color = Experiment,
             # shape = Inj_Cell,
             group = inter))+
  geom_ribbon(aes(ymin=mean_sd_dn, ymax=mean_sd_up), fill = "gray", alpha = 0.1)+
  lemon::geom_pointline(size = point.size, linesize = line.size)+
  geom_point(aes(x = Time, y = mean_gj), color = "white", size = mean.point.size, alpha = 0.3)+
  geom_pointline(aes(x = Time, y = mean_gj), color = "firebrick", size = mean.point.size, linesize = mean.line.size,  shape = 1)+
  labs(y = expression(paste(Delta, "Rc", " in M", Omega)), x = "Time in Minutes")+
  facet_grid(.~Condition,
             labeller = labeller(Condition = condition.labs))+
  geom_hline(yintercept = 0)+
  theme(
    # axis.text = element_text(size = rel(2), angle = 0),
        text = element_text(size=text.size)
        )




### Low Voltage plots ####
plt.lv <- M.clean[M.clean$Condition %in% c("PS.0", "PS.22", "PS.45", "PS.90"), ] %>%
  dplyr::select(Condition, Experiment, Inj_Cell, Time, gj) %>%
  group_by(Condition, Experiment, Inj_Cell, Time) %>%
  summarise(gj = mean(gj, na.rm = T)) %>%
  ungroup() %>%
  # mutate(Time = as.character(Time)) %>%
  pivot_wider(names_from = Time, values_from = gj) %>%
  mutate(`20` = `20` - `0`,
         `40` = `40` - `0`,
         `60` = `60` - `0`) %>%
  mutate(`0` = 0) %>%
  pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "gj") %>%
  group_by(Condition, Time) %>%
  mutate(mean_gj = mean(gj, na.rm = T),
         mean_sd_up = mean_gj+sd(gj, na.rm = T),
         mean_sd_dn =mean_gj- sd(gj, na.rm = T),) %>%
  mutate(inter = paste(Experiment, Inj_Cell, sep = ".")) %>%
  ggplot(aes(x = Time,
             y = gj,
             # color = Experiment,
             # shape = Inj_Cell,
             group = inter))+
  geom_ribbon(aes(ymin=mean_sd_dn, ymax=mean_sd_up), fill = "gray", alpha = 0.1)+
  lemon::geom_pointline(size = point.size, linesize = line.size)+
  geom_point(aes(x = Time, y = mean_gj), color = "white", size = mean.point.size, alpha = 0.3)+
  geom_pointline(aes(x = Time, y = mean_gj), color = "firebrick", size = mean.point.size, linesize = mean.line.size,  shape = 1)+
  labs(y = expression(paste(Delta, "Rc", " in M", Omega)), x = "Time in Minutes")+
  facet_grid(.~Condition,
             labeller = labeller(Condition = condition.labs))+
  geom_hline(yintercept = 0)+
  theme(
    # axis.text = element_text(size = rel(2), angle = 0),
        text = element_text(size=text.size)
        )
```



# Functions for plotting/reporting
```{r}
mk_annotated_delta_df <- function(
all.data = all.data,
# what is the largest change in 20 minutes that we're willing to accept as real?
# to be useful this might be something on the order of 1.5 but can be set high
# to use only threshold change on the residual relative to the median.
threshold_change = 21.4,  
# relative to the median.
threshold_change_res = 1.5,
ith_condition = c("PS.0", "PS.22", "PS.45", "PS.90")
){
# # inputs
# all.data = all.data
# threshold_change = 21.4  #1.5 #
# threshold_change_res = 1.5
# ith_condition = c("PS.0", "PS.22", "PS.45", "PS.90")
  
## Calculate baseline, deltas ==================================================
temp <- all.data %>% dplyr::select(Condition, Experiment, Inj_Cell, Time, gj)

# Get baseline values so we can easily replace with deltas
temp.t0 <- temp %>%
  dplyr::filter(Time == 0) %>%
  rename(initial = gj) %>%
  dplyr::select(-Time)

temp <- full_join(temp, temp.t0)
temp$gj = temp$gj - temp$initial

temp$Time <- as.numeric(temp$Time)

# reduce down to target conditions
temp_2 <- temp[temp$Condition %in% c(ith_condition), ]

# Check if there's an 80 minute time point. calculate delta accordingly
if (80 %in% unique(temp_2$Time) ){
  # Get stepwise change
  temp_2_diff = temp_2 %>% 
    pivot_wider(names_from =  Time, values_from = gj) %>% 
    mutate(delta00 = 0,
           delta20 = `20`-`0`,
           delta40 = `40`-`20`,
           delta60 = `60`-`40`,
           delta80 = `80`-`60`
           ) %>% 
    pivot_longer(c(delta00, delta20, delta40, delta60
                   , delta80
                   ), 
                 names_to = "dTime", values_to = "diffgj") %>% 
    dplyr::select(Condition, Experiment, Inj_Cell, dTime, diffgj) %>% 
    mutate(Time = as.numeric(str_remove(dTime, "delta"))) %>% 
    dplyr::select(-dTime)
} else {
  temp_2_diff = temp_2 %>% 
    pivot_wider(names_from =  Time, values_from = gj) %>% 
    mutate(delta00 = 0,
           delta20 = `20`-`0`,
           delta40 = `40`-`20`,
           delta60 = `60`-`40`
           ) %>% 
    pivot_longer(c(delta00, delta20, delta40, delta60
                   ), 
                 names_to = "dTime", values_to = "diffgj") %>% 
    dplyr::select(Condition, Experiment, Inj_Cell, dTime, diffgj) %>% 
    mutate(Time = as.numeric(str_remove(dTime, "delta"))) %>% 
    dplyr::select(-dTime)  
}

temp_2 = full_join(temp_2, temp_2_diff)


## Calculate selection metrics =================================================
# Try adding in residual from groupxtime change
temp_2 <- temp_2 %>%
  ungroup() %>%
  group_by(Condition, Time) %>%
  mutate(median_gj = median(gj, na.rm = T)) %>%
  mutate(residual_gj = median_gj - gj) %>%
  ungroup()

temp_2["absdiffgj"] <- abs(temp_2$diffgj)
temp_2["absresidgj"] <- abs(temp_2$residual_gj)


## Flag all points after an offending observation ==============================
temp_2["remove"] = FALSE
temp_2 <- temp_2[!is.na(temp_2$gj), ]
temp_2 <- temp_2[!is.na(temp_2$absdiffgj), ]
temp_2[temp_2$absdiffgj > threshold_change, "remove"] = TRUE
# and add in residual
temp_2[temp_2$absresidgj > threshold_change_res, "remove"] = TRUE

temp_2$Condition <- as.character(temp_2$Condition)
# flag everything after the first deviation
# assume that if an experiment fails, every time point after it is not to be trusted.
flag_after <- temp_2[temp_2$remove, ]
if(nrow(flag_after >= 1)){
  for(i in seq(1, nrow(flag_after))){
   mask <- (temp_2$Condition == unlist(flag_after[i, "Condition" ])
       ) & (temp_2$Experiment == unlist(flag_after[i, "Experiment" ])
       ) & (temp_2$Inj_Cell == unlist(flag_after[i, "Inj_Cell" ])
       ) & (temp_2$Time >= unlist(flag_after[i, "Time"]))
  
    temp_2[mask, "remove"] <- TRUE 
  }
}


## =============================================================================

return(temp_2)
  
}

# summary and diagnostics 
# diagnostic plot --------------------------------------------------------------
annotated_delta_df_diagnostic <- function(df,
                              threshold_change_res = 1.5){
  temp_2 <- df
  plt <- temp_2 %>% 
    ggplot(aes(Time, gj, color = remove))+
    geom_ribbon(aes(ymin=median_gj-threshold_change_res, 
                    ymax=median_gj+threshold_change_res), 
                fill = "gray", color = "black", alpha = 1)+
    geom_line(aes(y = median_gj), color = "black", size = 1)+
    geom_hline(yintercept = 0)+
    geom_point()+
    geom_point(shape = 1, color = 'black')+
    geom_line(aes(group = interaction(Experiment, Inj_Cell)))+
    facet_grid(.~Condition)+
    theme(legend.position = 'bottom')
  return(plt)
}



get_grouped_iqrs <- function(df = temp_2){
  df %>% 
    group_by(Condition, Time) %>% 
    summarize(iqr = IQR(gj, na.rm = T)) %>% 
    pivot_wider(id_cols = Condition, 
                names_from = Time, 
                values_from = iqr)  
}

# get groupwise iqr, summarize at time points
get_grouped_iqrs_collapse_to_time <- function(df = temp_2){
  df %>% 
    group_by(Condition, Time) %>% 
    summarize(iqr = IQR(gj, na.rm = T)) %>% 
    ungroup() %>% 
    group_by(Time) %>% 
    summarize(
      min_iqr  = min(iqr, na.rm = T),
      mean_iqr = mean(iqr, na.rm = T),
      max_iqr  = max(iqr, na.rm = T) )   
}



# Models to compare ------------------------------------------------------------
## Full model
mk_asymptotic_model <- function(
  df = temp_2,
  apply_qc = TRUE
){
  if(apply_qc){
    # fit model with condition affecting intercept but not time constant
    fm <- drm(gj ~ Time, Condition,
            data = df[!df$remove,],
            fct = AR.2(),
            pmodels = list(~factor(Condition), 
                           ~1))
  } else {
    # This is expected to fail in some cases. Not intended to be used.
    fm <- drm(gj ~ Time, Condition,
          data = df,
          fct = AR.2(),
          pmodels = list(~factor(Condition), 
                         ~1))
  }
  return(fm)
}

## Reduced Model
mk_reduced_asymptotic_model <- function(
    df = temp_2,
  apply_qc = TRUE
){
  if(apply_qc){
    # fit model with condition affecting intercept but not time constant
    fm <- drm(gj ~ Time, Condition,
            data = df[!df$remove,],
            fct = AR.2(),
            pmodels = list(~1, 
                           ~1))
  } else {
    # This is expected to fail in some cases. Not intended to be used.
    fm <- drm(gj ~ Time, Condition,
          data = df,
          fct = AR.2(),
          pmodels = list(~1, 
                         ~1))
  }
  return(fm)
}


# Compare Models ---------------------------------------------------------------
# returns anova table, d effect table
mk_tables <- function(fm, fm_reduced){
  # is using the treatment effect justified?
  ares <- anova(fm, fm_reduced) # note that the "1st" model is not the first one
                                # input but the simpler one.
  ares_p <- ares[2, 'p value']
  if(ares_p < 0.05){
    print("P < 0.05")
  } else {
    print("Warning P >= 0.05")
  }
  
  fmres <- compParm(fm, "d")
  
  return(list(ares, fmres))
}

# wrap mk tables and save out stats
write_out_fm_res <- function(fm = fm, 
                             fm_reduced = fm_reduced,
                             save_suffix = ""){
  res <- mk_tables(fm, fm_reduced)
  main_effect <- res[[1]]
  compare_d <- res[[2]]
  write.csv(main_effect, file = paste0("./a_reg_main_", save_suffix, ".csv"))
  write.csv(compare_d,   file = paste0("./a_reg_d_",    save_suffix, ".csv"))
  return(list(main_effect, compare_d))
}



#fcn that takes fm, time and returns predictions
mk_fm_plotting_df <- function(df = temp_2, 
                              fm = fm){
  fm_line <- data.frame(expand.grid(
  Time = seq(0, max(df$Time, na.rm = TRUE), by  = 1), 
  Condition = unique(df$Condition) 
  ))
  # remove any time in a condition beyond what we have observations for.
  for(condition in unique(df$Condition)){
    max_time <- max(df[df$Condition == condition, 'Time'], na.rm = T)
    
    mask <- ((fm_line$Condition != condition) | (
              (fm_line$Condition == condition) & (fm_line$Time <= max_time))
             )
    fm_line <- fm_line[mask, ]
  }
  
  fm_line$Prediction <- predict(fm, newdata = fm_line)
  # fm_line <- cbind(fm_line, predict(fm, newdata = fm_line))#, se.fit = TRUE))
  # SE is only provided once, apply to rest of data.
  if("SE" %in% names(fm_line)){
    fm_line_se <- fm_line[!is.na(fm_line$SE), c('Time', 'SE')]
    fm_line <- fm_line %>% dplyr::select(-SE)
    fm_line <- full_join(fm_line, fm_line_se)
  }
  return(fm_line)
}



#fcn that takes predictions, data and plots a second diagnostic
# this is what will be tweaked to be the final plot
delta_df_prediction_plot <- function(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions
){
  if(apply_qc){
    df <- df[!df$remove,]  
  }
  # sem lower and upper
  # predictions['SEML'] <-   predictions['Prediction'] - predictions['SE']
  # predictions['SEMU'] <-   predictions['Prediction'] + predictions['SE']  
  
  ### Does the fit look reasonable?
  plt <- df %>% 
    ggplot(aes(Time))+ #, color = remove))+
    geom_hline(yintercept = 0)+
    # geom_ribbon(data = predictions, aes(ymin=SEML, ymax=SEMU), 
    #             fill = "gray", color = "black", alpha = 1)+
    geom_point(aes(y=gj))+
    geom_line(aes(y=gj, group = interaction(Experiment, Inj_Cell)))+
    geom_line(data = predictions, aes(y = Prediction), color = 'red', size = 1)+
    facet_grid(.~Condition)
  
  return(plt)
}



# extends delta_df_prediction_plot to have similar aes to the previous plot set.
# bands are sd 
# red lines are predition and sem
delta_df_publication_plot <- function(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions,
  text.size = 20,
  point.size = 2,
  line.size = 3,
  mean.point.size = 2,
  mean.line.size = 2,
  ylab_expression = expression(paste(Delta, "gj"^-1, " in M", Omega))
){
  # df = temp_2
  # apply_qc = TRUE
  # predictions = predictions
  # 
  # text.size = 20
  # point.size = 2
  # line.size = 3
  # mean.point.size = 2
  # mean.line.size = 2
  # ylab_expression = expression(paste(Delta, "gj"^-1, " in M", Omega))
  
  
  if(apply_qc){
    df <- df[!df$remove,]  
  }
  # sem lower and upper
  # predictions['SEML'] <-   predictions['Prediction'] - predictions['SE']
  # predictions['SEMU'] <-   predictions['Prediction'] + predictions['SE']  
  
  
  # keep line form extending past data
  
  for (condition in unique(df$Condition)){
    condition_max_time = max( df[df$Condition == condition, 'Time'], na.rm = TRUE)
    mask <- (predictions$Condition != condition
             ) | ((predictions$Condition == condition
              ) & (predictions$Time <= condition_max_time)) 
    
    predictions <- predictions[mask, ]
  }
  
  
  summary_stats <- df %>% 
    group_by(Condition, Time) %>% 
    summarise(mean = mean(gj, na.rm = T),
              median = median(gj, na.rm = T),
              iqr = IQR(gj, na.rm = T),
              sd = sd(gj, na.rm = T)) %>% 
    ungroup() %>% 
    mutate(mean_up = mean +sd,
           mean_do = mean -sd,
           med_up = median+iqr, # TODO do we want to show 1 or 1/2?
           med_do = median-iqr)
  
  
  ### Does the fit look reasonable?
  plt <- df %>% 
    ggplot(aes(Time))+ #, color = remove))+
    geom_hline(yintercept = 0)+
    ## Bands ==============================================================
    geom_ribbon(data = summary_stats, aes(ymin=mean_do, ymax=mean_up), 
                fill = "cornflowerblue", 
                #color = "cornflowerblue", 
                alpha = 0.3)+
    
    geom_line(data = predictions, aes(y = Prediction), 
            color = 'firebrick', size = 1, alpha = 0.5)+
    # geom_line(data = predictions, aes(y = SEML), 
    #         color = 'firebrick', size = 1, alpha = 0.5, linetype = 'dashed')+
    # geom_line(data = predictions, aes(y = SEMU), 
    #         color = 'firebrick', size = 1, alpha = 0.5, linetype = 'dashed')+
  
    
    # geom_ribbon(data = summary_stats, aes(ymin=med_do, ymax=med_up),   # median
    #             fill = "blue", color = "blue", alpha = 0.51)+
    # geom_ribbon(data = predictions, aes(ymin=SEML, ymax=SEMU), # model
    #             fill = "cornflowerblue", color = "cornflowerblue", alpha = 0.3)+
  
    ## data ======================================================================
    # geom_point(aes(y=gj))+
    # geom_line(aes(y=gj, group = interaction(Experiment, Inj_Cell)))+
    lemon::geom_pointline(aes(y=gj, group = interaction(Experiment, Inj_Cell)),
                          color = "cornflowerblue", size = point.size, 
                          linesize = line.size, alpha = 0.5)+
    
    # geom_point(data = summary_stats, aes(x = Time, y = mean), 
    #            color = "white", size = mean.point.size, alpha = 0.3)+
    # geom_pointline(data = summary_stats, aes(x = Time, y = mean), 
    #                color = "firebrick", size = mean.point.size, 
    #                linesize = mean.line.size,  shape = 1)+
    
    ## lines =====================================================================
    # # mean
    # geom_line(data = summary_stats, aes(y = mean), 
    #           color = 'cornflowerblue', size = 1)+
    # # median
    # geom_line(data = summary_stats, aes(y = median), 
    #           color = 'blue', size = 1)+
    # 
  
    
    facet_grid(.~Condition, labeller = labeller(Condition = condition.labs))+
    labs(y = ylab_expression, x = "Time in Minutes")+
    # facet_grid(.~Condition,
              
    geom_hline(yintercept = 0)+
    theme(
      # axis.text = element_text(size = rel(2), angle = 0),
          text = element_text(size=text.size)
          )
  return(plt)
}

```


# Delta GJ Statistics
## TEA
```{r}
savename = "TEAMimic"

temp_2 <- mk_annotated_delta_df(
  all.data = all.data,
  threshold_change = 100.07,     # 
  threshold_change_res = 1.63, # <- max groupwise collapsed iqr
  ith_condition = c("PS.0.High.Amp",  "PS.22.High.Amp")
)


# for selecting a reasonable cutoff for threshold change residual
get_grouped_iqrs(df = temp_2)

get_grouped_iqrs_collapse_to_time(df = temp_2)

plt1 <- annotated_delta_df_diagnostic(df = temp_2,
                                      threshold_change_res = 1.5)


fm <- mk_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)


fm_reduced <- mk_reduced_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)

write_out_fm_res(
  fm = fm, 
  fm_reduced = fm_reduced,
  save_suffix = savename)


predictions <- mk_fm_plotting_df(df = temp_2, fm = fm)


plt2 <- delta_df_prediction_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions)

diagnositc_plt <- plt1 + plt2  
ggsave(here("data", "figures", paste0(savename, '_diagnostic', ".pdf")),         
       plot = diagnositc_plt) 


plt <- delta_df_publication_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions,
  text.size = 20,
  point.size = 2,
  line.size = 3,
  mean.point.size = 2,
  mean.line.size = 2,
  ylab_expression = expression(paste(Delta, "gj"^-1, " in M", Omega))
  
)

plt


ggsave(here("data", "figures", paste0(savename, ".pdf")), plot = last_plot(), 
       width = 7.14, height = 5.81, units = "in")
       # width = 10.68, height = 5.81, units = "in")
ggsave(here("data", "figures", paste0(savename, ".svg")), plot = last_plot(), 
       width = 7.14, height = 5.81, units = "in")
       # width = 10.68, height = 5.81, units = "in")


```


## ha (actual)
```{r}
savename = "HighAmpCd"

temp_2 <- mk_annotated_delta_df(
  all.data = all.data,
  threshold_change = 100.07,     # 
  threshold_change_res = 1.23, # <- max groupwise collapsed iqr
  ith_condition = c("PS.90.HA", "PS.90.HA.Cd")
)




# for selecting a reasonable cutoff for threshold change residual
get_grouped_iqrs(df = temp_2)

get_grouped_iqrs_collapse_to_time(df = temp_2)

plt1 <- annotated_delta_df_diagnostic(df = temp_2,
                                      threshold_change_res = 1.5)

fm <- mk_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)


fm_reduced <- mk_reduced_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)

write_out_fm_res(
  fm = fm, 
  fm_reduced = fm_reduced,
  save_suffix = savename)

predictions <- mk_fm_plotting_df(df = temp_2, fm = fm)

plt2 <- delta_df_prediction_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions)

diagnositc_plt <- plt1 + plt2  
ggsave(here("data", "figures", paste0(savename, '_diagnostic', ".pdf")),         
       plot = diagnositc_plt) 


plt <- delta_df_publication_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions,
  text.size = 20,
  point.size = 2,
  line.size = 3,
  mean.point.size = 2,
  mean.line.size = 2,
  ylab_expression = expression(paste(Delta, "gj"^-1, " in M", Omega))
  
)

plt


ggsave(here("data", "figures", paste0(savename, ".pdf")), plot = last_plot(), 
       width = 7.14, height = 5.81, units = "in")
       # width = 10.68, height = 5.81, units = "in")
ggsave(here("data", "figures", paste0(savename, ".svg")), plot = last_plot(), 
       width = 7.14, height = 5.81, units = "in")
       # width = 10.68, height = 5.81, units = "in")
```

## standardized

```{r}
savename = "Standardized"

temp_2 <- mk_annotated_delta_df(
  all.data = all.data,
  threshold_change = 100.07,     # 
  threshold_change_res = 1.16, # <- max groupwise collapsed iqr
  ith_condition = c("PS.0", "PS.22", "PS.45", "PS.90")
)

# for selecting a reasonable cutoff for threshold change residual
get_grouped_iqrs(df = temp_2)

get_grouped_iqrs_collapse_to_time(df = temp_2)

plt1 <- annotated_delta_df_diagnostic(df = temp_2,
                                      threshold_change_res = 1.5)

fm <- mk_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)


fm_reduced <- mk_reduced_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)

write_out_fm_res(
  fm = fm, 
  fm_reduced = fm_reduced,
  save_suffix = savename)

predictions <- mk_fm_plotting_df(df = temp_2, fm = fm)

plt2 <- delta_df_prediction_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions)

diagnositc_plt <- plt1 + plt2  
ggsave(here("data", "figures", paste0(savename, '_diagnostic', ".pdf")),         
       plot = diagnositc_plt) 

plt <- delta_df_publication_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions,
  text.size = 20,
  point.size = 2,
  line.size = 3,
  mean.point.size = 2,
  mean.line.size = 2,
  ylab_expression = expression(paste(Delta, "gj"^-1, " in M", Omega))
  
)

plt


ggsave(here("data", "figures", paste0(savename, ".pdf")), plot = last_plot(), 
       # width = 7.14, height = 5.81, units = "in")
       width = 10.68, height = 5.81, units = "in")
ggsave(here("data", "figures", paste0(savename, ".svg")), plot = last_plot(), 
       # width = 7.14, height = 5.81, units = "in")
       width = 10.68, height = 5.81, units = "in")
```


# Delta CC Statistics (begin wrapper)
## TEA
```{r}
YLAB_EXPRESSION = expression(paste(Delta, "CC"))


savename = "cc_TEAMimic"
threshold_change = 100.07    # 
threshold_change_res = 0.13 # <- max groupwise collapsed iqr
ith_condition = c("PS.0.High.Amp",  "PS.22.High.Amp")
ylab_expression = YLAB_EXPRESSION
width = 7.14
height = 5.81

# overwrite 'gj' with desired parameter
all.data_alias_gj <- all.data
all.data_alias_gj <- all.data_alias_gj %>% 
  mutate(gj = cc)  # <------------------------------------------------------ !!!

# Boilerplate ------------------------------------------------------------------
temp_2 <- mk_annotated_delta_df(
  all.data = all.data_alias_gj,
  threshold_change = threshold_change,     # 
  threshold_change_res = threshold_change_res, # <- max groupwise collapsed iqr
  ith_condition = ith_condition
)

# for selecting a reasonable cutoff for threshold change residual
get_grouped_iqrs(df = temp_2)

largest_timewise_iqr <- get_grouped_iqrs_collapse_to_time(df = temp_2)
largest_timewise_iqr
print("-- -- -- -- -- -- -- -- ")
print(as.character(max(largest_timewise_iqr$max_iqr)))
print("-- -- -- -- -- -- -- -- ")


plt1 <- annotated_delta_df_diagnostic(df = temp_2,
                                      threshold_change_res = threshold_change_res)


fm <- mk_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)


fm_reduced <- mk_reduced_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)

write_out_fm_res(
  fm = fm, 
  fm_reduced = fm_reduced,
  save_suffix = savename)


predictions <- mk_fm_plotting_df(df = temp_2, fm = fm)


plt2 <- delta_df_prediction_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions)

diagnositc_plt <- plt1 + plt2  
ggsave(here("data", "figures", paste0(savename, '_diagnostic', ".pdf")),         
       plot = diagnositc_plt) 


plt <- delta_df_publication_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions,
  text.size = 20,
  point.size = 2,
  line.size = 3,
  mean.point.size = 2,
  mean.line.size = 2,
  ylab_expression = ylab_expression
  
)


plt


ggsave(here("data", "figures", paste0(savename, ".pdf")), plot = last_plot(), 
       width = width, height = height, units = "in")
ggsave(here("data", "figures", paste0(savename, ".svg")), plot = last_plot(), 
       width = width, height = height, units = "in")
```


## High Amplitude
```{r}
savename = "cc_HighAmpCd"
threshold_change = 100.07    # 
threshold_change_res = 0.24  # <- max groupwise collapsed iqr
ith_condition = c("PS.90.HA", "PS.90.HA.Cd")
ylab_expression = YLAB_EXPRESSION
width = 7.14
height = 5.81

# overwrite 'gj' with desired parameter
all.data_alias_gj <- all.data
all.data_alias_gj <- all.data_alias_gj %>% 
  mutate(gj = cc)  # <------------------------------------------------------ !!!

# Boilerplate ------------------------------------------------------------------
temp_2 <- mk_annotated_delta_df(
  all.data = all.data_alias_gj,
  threshold_change = threshold_change,     # 
  threshold_change_res = threshold_change_res, # <- max groupwise collapsed iqr
  ith_condition = ith_condition
)

# for selecting a reasonable cutoff for threshold change residual
get_grouped_iqrs(df = temp_2)

largest_timewise_iqr <- get_grouped_iqrs_collapse_to_time(df = temp_2)
largest_timewise_iqr
print("-- -- -- -- -- -- -- -- ")
print(as.character(max(largest_timewise_iqr$max_iqr)))
print("-- -- -- -- -- -- -- -- ")


plt1 <- annotated_delta_df_diagnostic(df = temp_2,
                                      threshold_change_res = threshold_change_res)


fm <- mk_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)


fm_reduced <- mk_reduced_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)

write_out_fm_res(
  fm = fm, 
  fm_reduced = fm_reduced,
  save_suffix = savename)


predictions <- mk_fm_plotting_df(df = temp_2, fm = fm)


plt2 <- delta_df_prediction_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions)

diagnositc_plt <- plt1 + plt2  
ggsave(here("data", "figures", paste0(savename, '_diagnostic', ".pdf")),         
       plot = diagnositc_plt) 


plt <- delta_df_publication_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions,
  text.size = 20,
  point.size = 2,
  line.size = 3,
  mean.point.size = 2,
  mean.line.size = 2,
  ylab_expression = ylab_expression
  
)


plt


ggsave(here("data", "figures", paste0(savename, ".pdf")), plot = last_plot(), 
       width = width, height = height, units = "in")
ggsave(here("data", "figures", paste0(savename, ".svg")), plot = last_plot(), 
       width = width, height = height, units = "in")
```

## standardized

```{r}
savename = "cc_Standardized"
threshold_change = 100.07    # 
threshold_change_res = 0.25  # <- max groupwise collapsed iqr
ith_condition = c("PS.0", "PS.22", "PS.45", "PS.90")
ylab_expression = YLAB_EXPRESSION
width = 10.68
height = 5.81

# overwrite 'gj' with desired parameter
all.data_alias_gj <- all.data
all.data_alias_gj <- all.data_alias_gj %>% 
  mutate(gj = cc)  # <------------------------------------------------------ !!!

# Boilerplate ------------------------------------------------------------------
temp_2 <- mk_annotated_delta_df(
  all.data = all.data_alias_gj,
  threshold_change = threshold_change,     # 
  threshold_change_res = threshold_change_res, # <- max groupwise collapsed iqr
  ith_condition = ith_condition
)

# for selecting a reasonable cutoff for threshold change residual
get_grouped_iqrs(df = temp_2)

largest_timewise_iqr <- get_grouped_iqrs_collapse_to_time(df = temp_2)
largest_timewise_iqr
print("-- -- -- -- -- -- -- -- ")
print(as.character(max(largest_timewise_iqr$max_iqr)))
print("-- -- -- -- -- -- -- -- ")


plt1 <- annotated_delta_df_diagnostic(df = temp_2,
                                      threshold_change_res = threshold_change_res)


fm <- mk_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)


fm_reduced <- mk_reduced_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)

write_out_fm_res(
  fm = fm, 
  fm_reduced = fm_reduced,
  save_suffix = savename)

# FIXME In sqrt(diag(varMat)) : NaNs produced
predictions <- mk_fm_plotting_df(df = temp_2, fm = fm)


plt2 <- delta_df_prediction_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions)

diagnositc_plt <- plt1 + plt2  
ggsave(here("data", "figures", paste0(savename, '_diagnostic', ".pdf")),         
       plot = diagnositc_plt) 


plt <- delta_df_publication_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions,
  text.size = 20,
  point.size = 2,
  line.size = 3,
  mean.point.size = 2,
  mean.line.size = 2,
  ylab_expression = ylab_expression
  
)


plt


ggsave(here("data", "figures", paste0(savename, ".pdf")), plot = last_plot(), 
       width = width, height = height, units = "in")
ggsave(here("data", "figures", paste0(savename, ".svg")), plot = last_plot(), 
       width = width, height = height, units = "in")
```


# Delta r1 Statistics
## TEA
```{r}
YLAB_EXPRESSION = expression(paste(Delta, "r1"))


savename = "r1_TEAMimic"
threshold_change = 100.07    # 
threshold_change_res = 1.97 # <- max groupwise collapsed iqr
ith_condition = c("PS.0.High.Amp",  "PS.22.High.Amp")
ylab_expression = YLAB_EXPRESSION
width = 7.14
height = 5.81

# overwrite 'gj' with desired parameter
all.data_alias_gj <- all.data
all.data_alias_gj <- all.data_alias_gj %>% 
  mutate(gj = r1)  # <------------------------------------------------------ !!!

# Boilerplate ------------------------------------------------------------------
temp_2 <- mk_annotated_delta_df(
  all.data = all.data_alias_gj,
  threshold_change = threshold_change,     # 
  threshold_change_res = threshold_change_res, # <- max groupwise collapsed iqr
  ith_condition = ith_condition
)

# for selecting a reasonable cutoff for threshold change residual
get_grouped_iqrs(df = temp_2)

largest_timewise_iqr <- get_grouped_iqrs_collapse_to_time(df = temp_2)
largest_timewise_iqr
print("-- -- -- -- -- -- -- -- ")
print(as.character(max(largest_timewise_iqr$max_iqr)))
print("-- -- -- -- -- -- -- -- ")


plt1 <- annotated_delta_df_diagnostic(df = temp_2,
                                      threshold_change_res = threshold_change_res)


fm <- mk_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)


fm_reduced <- mk_reduced_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)

write_out_fm_res(
  fm = fm, 
  fm_reduced = fm_reduced,
  save_suffix = savename)


predictions <- mk_fm_plotting_df(df = temp_2, fm = fm)


plt2 <- delta_df_prediction_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions)

diagnositc_plt <- plt1 + plt2  
ggsave(here("data", "figures", paste0(savename, '_diagnostic', ".pdf")),         
       plot = diagnositc_plt) 


plt <- delta_df_publication_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions,
  text.size = 20,
  point.size = 2,
  line.size = 3,
  mean.point.size = 2,
  mean.line.size = 2,
  ylab_expression = ylab_expression
  
)


plt+coord_cartesian(ylim = c(-1.5, 2.5))


ggsave(here("data", "figures", paste0(savename, ".pdf")), plot = last_plot(), 
       width = width, height = height, units = "in")
ggsave(here("data", "figures", paste0(savename, ".svg")), plot = last_plot(), 
       width = width, height = height, units = "in")
```


## High Amplitude
```{r}
savename = "r1_HighAmpCd"
threshold_change = 100.07    # 
threshold_change_res = 1.67  # <- max groupwise collapsed iqr
ith_condition = c("PS.90.HA", "PS.90.HA.Cd")
ylab_expression = YLAB_EXPRESSION
width = 7.14
height = 5.81

# overwrite 'gj' with desired parameter
all.data_alias_gj <- all.data
all.data_alias_gj <- all.data_alias_gj %>% 
  mutate(gj = r1)  # <------------------------------------------------------ !!!

# Boilerplate ------------------------------------------------------------------
temp_2 <- mk_annotated_delta_df(
  all.data = all.data_alias_gj,
  threshold_change = threshold_change,     # 
  threshold_change_res = threshold_change_res, # <- max groupwise collapsed iqr
  ith_condition = ith_condition
)

# for selecting a reasonable cutoff for threshold change residual
get_grouped_iqrs(df = temp_2)

largest_timewise_iqr <- get_grouped_iqrs_collapse_to_time(df = temp_2)
largest_timewise_iqr
print("-- -- -- -- -- -- -- -- ")
print(as.character(max(largest_timewise_iqr$max_iqr)))
print("-- -- -- -- -- -- -- -- ")


plt1 <- annotated_delta_df_diagnostic(df = temp_2,
                                      threshold_change_res = threshold_change_res)


fm <- mk_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)


fm_reduced <- mk_reduced_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)

write_out_fm_res(
  fm = fm, 
  fm_reduced = fm_reduced,
  save_suffix = savename)


predictions <- mk_fm_plotting_df(df = temp_2, fm = fm)


plt2 <- delta_df_prediction_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions)

diagnositc_plt <- plt1 + plt2  
ggsave(here("data", "figures", paste0(savename, '_diagnostic', ".pdf")),         
       plot = diagnositc_plt) 


plt <- delta_df_publication_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions,
  text.size = 20,
  point.size = 2,
  line.size = 3,
  mean.point.size = 2,
  mean.line.size = 2,
  ylab_expression = ylab_expression
  
)


plt


ggsave(here("data", "figures", paste0(savename, ".pdf")), plot = last_plot(), 
       width = width, height = height, units = "in")
ggsave(here("data", "figures", paste0(savename, ".svg")), plot = last_plot(), 
       width = width, height = height, units = "in")
```

## standardized

```{r}
savename = "r1_Standardized"
threshold_change = 100.07    # 
threshold_change_res = 3.66  # <- max groupwise collapsed iqr
ith_condition = c("PS.0", "PS.22", "PS.45", "PS.90")
ylab_expression = YLAB_EXPRESSION
width = 10.68
height = 5.81

# overwrite 'gj' with desired parameter
all.data_alias_gj <- all.data
all.data_alias_gj <- all.data_alias_gj %>% 
  mutate(gj = r1)  # <------------------------------------------------------ !!!

# Boilerplate ------------------------------------------------------------------
temp_2 <- mk_annotated_delta_df(
  all.data = all.data_alias_gj,
  threshold_change = threshold_change,     # 
  threshold_change_res = threshold_change_res, # <- max groupwise collapsed iqr
  ith_condition = ith_condition
)

# for selecting a reasonable cutoff for threshold change residual
get_grouped_iqrs(df = temp_2)

largest_timewise_iqr <- get_grouped_iqrs_collapse_to_time(df = temp_2)
largest_timewise_iqr
print("-- -- -- -- -- -- -- -- ")
print(as.character(max(largest_timewise_iqr$max_iqr)))
print("-- -- -- -- -- -- -- -- ")


plt1 <- annotated_delta_df_diagnostic(df = temp_2,
                                      threshold_change_res = threshold_change_res)


fm <- mk_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)


fm_reduced <- mk_reduced_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)

write_out_fm_res(
  fm = fm, 
  fm_reduced = fm_reduced,
  save_suffix = savename)

predictions <- mk_fm_plotting_df(df = temp_2, fm = fm)

plt2 <- delta_df_prediction_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions)

diagnositc_plt <- plt1 + plt2  
ggsave(here("data", "figures", paste0(savename, '_diagnostic', ".pdf")),         
       plot = diagnositc_plt) 


plt <- delta_df_publication_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions,
  text.size = 20,
  point.size = 2,
  line.size = 3,
  mean.point.size = 2,
  mean.line.size = 2,
  ylab_expression = ylab_expression
  
)


plt


ggsave(here("data", "figures", paste0(savename, ".pdf")), plot = last_plot(), 
       width = width, height = height, units = "in")
ggsave(here("data", "figures", paste0(savename, ".svg")), plot = last_plot(), 
       width = width, height = height, units = "in")
```

# Delta r11 Statistics 

We already have a measure for resistance. We should use that. However if we must use rin we should use a linear model to get around failures to converge.

```
mk_linear_model <- function(
  df = temp_2,
  apply_qc = TRUE
){
  if(apply_qc){
    fm <- lm(gj ~ Time*Condition, data = df[!df$remove,])
  } else {
    fm <- lm(gj ~ Time*Condition, data = df)
  }
  return(fm)
}

fm <- mk_linear_model(
  df = temp_2,
  apply_qc = TRUE
)

car::Anova(fm)
hsd_res <- agricolae::HSD.test(fm, trt = "Condition")
```

## TEA
```{r eval=FALSE}
YLAB_EXPRESSION = expression(paste(Delta, "r11"))


savename = "r11_TEAMimic"
threshold_change = 100.07    # 
threshold_change_res = 1.10 # <- max groupwise collapsed iqr
ith_condition = c("PS.0.High.Amp",  "PS.22.High.Amp")
ylab_expression = YLAB_EXPRESSION
width = 7.14
height = 5.81

# overwrite 'gj' with desired parameter
all.data_alias_gj <- all.data
all.data_alias_gj <- all.data_alias_gj %>% 
  mutate(gj = r11)  # <------------------------------------------------------ !!!

# Boilerplate ------------------------------------------------------------------
temp_2 <- mk_annotated_delta_df(
  all.data = all.data_alias_gj,
  threshold_change = threshold_change,     # 
  threshold_change_res = threshold_change_res, # <- max groupwise collapsed iqr
  ith_condition = ith_condition
)

# for selecting a reasonable cutoff for threshold change residual
get_grouped_iqrs(df = temp_2)

largest_timewise_iqr <- get_grouped_iqrs_collapse_to_time(df = temp_2)
largest_timewise_iqr
print("-- -- -- -- -- -- -- -- ")
print(as.character(max(largest_timewise_iqr$max_iqr)))
print("-- -- -- -- -- -- -- -- ")


plt1 <- annotated_delta_df_diagnostic(df = temp_2,
                                      threshold_change_res = threshold_change_res)


# FIXME Error in optim(startVec, opfct, hessian = TRUE, method = optMethod, control = list(maxit = maxIt,  : 
  # non-finite finite-difference value [3]

fm <- mk_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)


fm_reduced <- mk_reduced_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)

write_out_fm_res(
  fm = fm, 
  fm_reduced = fm_reduced,
  save_suffix = savename)


predictions <- mk_fm_plotting_df(df = temp_2, fm = fm)


plt2 <- delta_df_prediction_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions)

diagnositc_plt <- plt1 + plt2  
ggsave(here("data", "figures", paste0(savename, '_diagnostic', ".pdf")),         
       plot = diagnositc_plt) 


plt <- delta_df_publication_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions,
  text.size = 20,
  point.size = 2,
  line.size = 3,
  mean.point.size = 2,
  mean.line.size = 2,
  ylab_expression = ylab_expression
  
)


plt


ggsave(here("data", "figures", paste0(savename, ".pdf")), plot = last_plot(), 
       width = width, height = height, units = "in")
ggsave(here("data", "figures", paste0(savename, ".svg")), plot = last_plot(), 
       width = width, height = height, units = "in")
```


## High Amplitude
```{r eval=FALSE}
savename = "r11_HighAmpCd"
threshold_change = 100.07    # 
threshold_change_res = 0.95  # <- max groupwise collapsed iqr
ith_condition = c("PS.90.HA", "PS.90.HA.Cd")
ylab_expression = YLAB_EXPRESSION
width = 7.14
height = 5.81

# overwrite 'gj' with desired parameter
all.data_alias_gj <- all.data
all.data_alias_gj <- all.data_alias_gj %>% 
  mutate(gj = r11)  # <------------------------------------------------------ !!!

# Boilerplate ------------------------------------------------------------------
temp_2 <- mk_annotated_delta_df(
  all.data = all.data_alias_gj,
  threshold_change = threshold_change,     # 
  threshold_change_res = threshold_change_res, # <- max groupwise collapsed iqr
  ith_condition = ith_condition
)

# for selecting a reasonable cutoff for threshold change residual
get_grouped_iqrs(df = temp_2)

largest_timewise_iqr <- get_grouped_iqrs_collapse_to_time(df = temp_2)
largest_timewise_iqr
print("-- -- -- -- -- -- -- -- ")
print(as.character(max(largest_timewise_iqr$max_iqr)))
print("-- -- -- -- -- -- -- -- ")


plt1 <- annotated_delta_df_diagnostic(df = temp_2,
                                      threshold_change_res = threshold_change_res)


fm <- mk_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)


fm_reduced <- mk_reduced_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)

write_out_fm_res(
  fm = fm, 
  fm_reduced = fm_reduced,
  save_suffix = savename)


predictions <- mk_fm_plotting_df(df = temp_2, fm = fm)


plt2 <- delta_df_prediction_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions)

diagnositc_plt <- plt1 + plt2  
ggsave(here("data", "figures", paste0(savename, '_diagnostic', ".pdf")),         
       plot = diagnositc_plt) 


plt <- delta_df_publication_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions,
  text.size = 20,
  point.size = 2,
  line.size = 3,
  mean.point.size = 2,
  mean.line.size = 2,
  ylab_expression = ylab_expression
  
)


plt


ggsave(here("data", "figures", paste0(savename, ".pdf")), plot = last_plot(), 
       width = width, height = height, units = "in")
ggsave(here("data", "figures", paste0(savename, ".svg")), plot = last_plot(), 
       width = width, height = height, units = "in")
```

## standardized

```{r eval=FALSE}
savename = "r11_Standardized"
threshold_change = 100.07    # 
threshold_change_res = 1.51  # <- max groupwise collapsed iqr
ith_condition = c("PS.0", "PS.22", "PS.45", "PS.90")
ylab_expression = YLAB_EXPRESSION
width = 10.68
height = 5.81

# overwrite 'gj' with desired parameter
all.data_alias_gj <- all.data
all.data_alias_gj <- all.data_alias_gj %>% 
  mutate(gj = r11)  # <------------------------------------------------------ !!!

# Boilerplate ------------------------------------------------------------------
temp_2 <- mk_annotated_delta_df(
  all.data = all.data_alias_gj,
  threshold_change = threshold_change,     # 
  threshold_change_res = threshold_change_res, # <- max groupwise collapsed iqr
  ith_condition = ith_condition
)

# for selecting a reasonable cutoff for threshold change residual
get_grouped_iqrs(df = temp_2)

largest_timewise_iqr <- get_grouped_iqrs_collapse_to_time(df = temp_2)
largest_timewise_iqr
print("-- -- -- -- -- -- -- -- ")
print(as.character(max(largest_timewise_iqr$max_iqr)))
print("-- -- -- -- -- -- -- -- ")


plt1 <- annotated_delta_df_diagnostic(df = temp_2,
                                      threshold_change_res = threshold_change_res)

# FIXME Warning message:
# In sqrt(diag(varMat)) : NaNs produced

fm <- mk_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)


fm_reduced <- mk_reduced_asymptotic_model(
  df = temp_2,
  apply_qc = TRUE
)

write_out_fm_res(
  fm = fm, 
  fm_reduced = fm_reduced,
  save_suffix = savename)


predictions <- mk_fm_plotting_df(df = temp_2, fm = fm)


plt2 <- delta_df_prediction_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions)

diagnositc_plt <- plt1 + plt2  
ggsave(here("data", "figures", paste0(savename, '_diagnostic', ".pdf")),        
       plot = diagnositc_plt) 


plt <- delta_df_publication_plot(
  df = temp_2,
  apply_qc = TRUE,
  predictions = predictions,
  text.size = 20,
  point.size = 2,
  line.size = 3,
  mean.point.size = 2,
  mean.line.size = 2,
  ylab_expression = ylab_expression
  
)


plt


ggsave(here("data", "figures", paste0(savename, ".pdf")), plot = last_plot(), 
       width = width, height = height, units = "in")
ggsave(here("data", "figures", paste0(savename, ".svg")), plot = last_plot(), 
       width = width, height = height, units = "in")
```



---
title: 'Chapter 2: Transjunctional voltage is responsible for activity dependent gap
  junction modulation'
author: "Daniel R. Kick"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
## General ====
library("tidyverse") # Plotting and data manipulation
library(here)

## Statistics ====
library("nlme") # for nested anova via lme. See http://www.jason-french.com/tutorials/repeatedmeasures.html
library("multcomp")
library("car")
library("agricolae")
library(bayestestR)
# library(rstanarm)
library(estimate)
library(equivalence)


## Plotting ====
library("cowplot") # clean up ggplots, plotgrid
library("ggthemes")
library("lemon")
library(Hmisc) # for mean_sdl ribbons
library("ggthemes")
library("ggsci")
library(see) # Utrum damnati futuri sint, qui non viderunt et crediderunt
library(patchwork)

## Specialty functions ====
source(here("R", "02MoniterGapJunction.R"))

## Global Params ====
# theme_set(kickme())
theme_set(theme_minimal())
library(broom) # for parameter estimates
library("furrr")
plan(multiprocess)
```

refactored 2021-12-27


# Read in and aggregate data
```{r read in data, eval=TRUE, include=FALSE}
# Preprocessing ----
tecc <- readRDS(file = here("data", "tecc.rds"))
tevc <- readRDS(file = here("data", "tevc.rds"))
htk <- readRDS(file = here("data", "htk.rds"))
a <- readRDS(file = here("data", "a.rds"))

tecc <- collapse_duplicate_gj_obs(tecc)
tevc <- collapse_duplicate_gj_obs(tevc)



## Join independent data types into a single data frame ====

#FIXME see above
all.data <- full_join(tecc, tevc) %>% full_join(htk) %>% full_join(a)

#%>% full_join(htk.p) %>% full_join(htk.e) %>% full_join(a.p) %>% full_join(a.e)
all.data <- all.data[, c(
  "Condition", "Experiment", "Time", "Inj_Cell",
  "tecc.recording", "tevc.recording",
  #"htk.recording", "a.recording", "subtracted.rin",
  "r11", "r12", "r1", "rc", "cc", "rmp", "gj",
  #"htk.peak.mV", "htk.peak.nA", "htk.end.mV", "htk.end.nA",
  #"a.peak.mV", "a.peak.nA", "a.end.mV", "a.end.nA"
  "intercept.peak_htk", "slope.peak_htk", "intercept.end_htk", "slope.end_htk",
  "intercept.peak_a", "slope.peak_a", "intercept.end_a", "slope.end_a"

)]

all.data <- all.data %>% as.data.frame()
```

```{r}
## Rename conditions ====
rename.df <- as.data.frame(list(
  c("Aberrant Depol", "PS.0.High.Amp"),
  c("Aberrant_Depol_22.5_deg", "PS.22.High.Amp"),

  c("HA 90 Degree", "PS.90.HA"),
  c("HA 90 Degree Cd", "PS.90.HA.Cd"),

  c("0_deg", "PS.0"),
  c("22.5_degrees", "PS.22"),
  c("rep 45 Degree", "PS.45"),
  c("rep 90 Degree", "PS.90"),

  c("PS.0.orig", "PS.0.orig"),
  c("PS.22.orig", "PS.22.orig"),
  c("PS.45.orig", "PS.45.orig"),
  c("PS.90.orig", "PS.90.orig"),
  c("PS.180.orig", "PS.180.orig"),

  c("hold_at_-53mV", "Silent.53mV"),
  c("TEA_ControlWave", "PS.0.TEA"),
  c("PS.0.TEA", "PS.0.TEA"),
  c("TEA_Silent", "Silent.TEA"),
  c("Inverted Wave", "Inv"),

  c("TEA.Active", "TEA.Active")
))

rename.df <- as.data.frame(t(rename.df))
names(rename.df) <- c("old", "new")
rownames(rename.df) <- NULL # get rid of rownames

all.data$changed <- F
for (i in seq(1, nrow(rename.df))){
  all.data[all.data$Condition == as.character(rename.df[i, "old"]), "Condition"] <- as.character(rename.df[i, "new"])
  all.data[all.data$Condition == as.character(rename.df[i, "old"]), "changed"] <- T
}
# print out the unchanged rows
print(all.data[!all.data$changed & !(all.data$Condition %in% as.vector(rename.df[, "new"])), ])
#and drop
all.data <- all.data[, !(names(all.data) %in% c("changed"))]

# reorder factors
all.data$Condition <- factor(all.data$Condition, as.vector(rename.df[, "new"])[-16] ) #-16 removes the duplicate "PS.0.TEA


#convert gj to inverse to make it easier to work with.
all.data$gj <- (1/all.data$gj)
```


QC
```{r}
### 1. Resistances can't be zero, drop any which are.  ####
all.data[(all.data$r11 < 0) & !is.na(all.data$r11) , "r11"] <- NA
all.data[(all.data$r1 < 0) & !is.na(all.data$r1) , "r1"] <- NA
all.data[(all.data$rc < 0) & !is.na(all.data$rc) , "rc"] <- NA
all.data[(all.data$gj < 0) & !is.na(all.data$gj) , "gj"] <- NA

# 2. If coupling coef is less than 0 or above 1, drop it. ####
all.data[(all.data$cc > 1 | all.data$cc < 0) & !is.na(all.data$cc) , "cc"] <- NA

# for condition | time | response var
conditions <- all.data$Condition %>% unique()
times <- all.data$Time %>% unique()
response.vars <- c("r11", "r1", "cc", "a.peak.nA", "htk.peak.nA", "rc", "gj")

multiplier <-  2
use.method <- "use.sd" #use.iqr

tic <- Sys.time()
for (i in seq_along(conditions)) {
  for (j in seq_along(times)) {
    for (k in seq_along(response.vars)) {
      if (use.method == "use.sd") {
        current.mean <- all.data[all.data$Condition == conditions[i] &
          all.data$Time == times[j], response.vars[k]] %>% mean(na.rm = TRUE)
        current.sd <- all.data[all.data$Condition == conditions[i] &
          all.data$Time == times[j], response.vars[k]] %>% sd(na.rm = TRUE)

        all.data[all.data$Condition == conditions[i] & all.data$Time == times[j] & ((all.data[[response.vars[k]]] < (current.mean - (multiplier * current.sd))) | (all.data[[response.vars[k]]] > (current.mean + (multiplier * current.sd)))) & !(is.na(all.data[[response.vars[k]]])), response.vars[k]] <- NA
      } else if (use.method == "use.iqr") {
        current.median <- all.data[all.data$Condition == conditions[i] &
          all.data$Time == times[j], response.vars[k]] %>% median(na.rm = TRUE)
        current.iqr <- all.data[all.data$Condition == conditions[i] &
          all.data$Time == times[j], response.vars[k]] %>% IQR(na.rm = TRUE)

        all.data[all.data$Condition == conditions[i] & all.data$Time == times[j] & ((all.data[[response.vars[k]]] < (current.median - (multiplier * current.iqr))) | (all.data[[response.vars[k]]] > (current.median + (multiplier * current.iqr)))) & !(is.na(all.data[[response.vars[k]]])), response.vars[k]] <- NA
      } else {
        warning(paste(as.character(use.method), "is not use.sd or use.iqr!"))
      }
    }
  }
}
print(Sys.time() - tic)
```

### Reduce dataset
```{r}
# Reduce data to target times ----
all.data <- all.data[all.data$Time %in% c(0, 20, 40, 60) |
                       all.data$Condition == "TEA.Active", ]

```

## Drop questionable observation
```{r}
all.data <- all.data[all.data$Experiment != "170817a",]
```

### Calculate deltas and percent changes
```{r}
## Calculate percent change for later use: ====
all.data.p <- convert_data_to(
  input.df = all.data,
  convert.to = c("percent"),
  data.cols = c(
    "r11", "r12", "r1", "rc", "cc", "rmp", "gj"#,
    #FIXME as above, so below
    # "intercept.peak_htk", "slope.peak_htk", "intercept.end_htk", "slope.end_htk",
    # "intercept.peak_a", "slope.peak_a", "intercept.end_a", "slope.end_a"
    # "htk.peak.mV", "htk.peak.nA", "htk.end.mV", "htk.end.nA",
    # "a.peak.mV", "a.peak.nA", "a.end.mV", "a.end.nA"
  )
)



all.data.d <- convert_data_to(
  input.df = all.data,
  convert.to = c("difference"),
  data.cols = c(   "r11", "r12", "r1", "rc", "cc", "rmp", "gj"#,
                   #FIXME as above, so below
                   # "intercept.peak_htk", "slope.peak_htk", "intercept.end_htk", "slope.end_htk",
                   # "intercept.peak_a", "slope.peak_a", "intercept.end_a", "slope.end_a"
                   # "htk.peak.mV", "htk.peak.nA", "htk.end.mV", "htk.end.nA",
                   # "a.peak.mV", "a.peak.nA", "a.end.mV", "a.end.nA"
  )
)

M <- all.data#[all.data$Time %in% c(0, 20, 40, 60) , ]
M.p <- all.data.p#[all.data.p$Time %in% c(0, 20, 40, 60) , ]
M.d <- all.data.d#[all.data.d$Time %in% c(0, 20, 40, 60) , ]

## Deduplicate gap junction measurements ====
M.gj<- deduplicate_gj_obs(input.df = M)
M.p.gj<- deduplicate_gj_obs(input.df = M.p)
M.d.gj <- deduplicate_gj_obs(input.df = M.d)
```

## Test w/o deltas
```{r}
# d <- add_stim_delay_phase(d = M)
d <- M

d$inter <- paste0(d$Experiment, ".", d$Inj_Cell)
# REPEAT Manual QC wonky points ----
## gj ====
#TEA sync
d[d$inter == "180212.LC4" & d$Time %in% c(40), "gj"] <- NA
# ps0
d[d$inter == "180507.LC4" & d$Time %in% c(40), "gj"] <- NA
# natural 0
d[d$inter == "170711e.LC4" & d$Time %in% c(20), "gj"] <- NA
d[d$inter == "170814b.LC5" & d$Time %in% c(60), "gj"] <- NA
# natural 22.5

#  natural 45
d[d$inter == "170925A.LC5" & d$Time %in% c(20), "gj"] <- NA
d[d$inter == "170925A.LC4" & d$Time %in% c(20, 40), "gj"] <- NA

# natural 90
d[d$inter == "170803a.LC4" & d$Time %in% c(20), "gj"] <- NA

# natural 180
d[d$inter == "170801a.LC5" & d$Time %in% c(20), "gj"] <- NA


## rc ====
d[d$inter == "180507.LC4" & d$Time %in% c(40), "rc"] <- NA
d[d$inter == "181001.LC4" & d$Time %in% c(40, 60), "rc"] <- NA


#natural 22.5
d[d$inter == "180718a.LC5" & d$Time %in% c(20), "rc"] <- NA
# natural 180
d[d$inter == "170801a.LC5" & d$Time %in% c(20), "rc"] <- NA
```

```{r}
# Use expand grid to get a full combination of tests then filter out the ones we don't want. This will let us use one future_map and maybe get faster
comparisons <- c(paste("PS.0.High.Amp", "PS.22.High.Amp", sep = "_"),
                 paste("PS.22.High.Amp", "PS.90.HA", sep = "_"),
                 paste("PS.90.HA", "PS.90.HA.Cd", sep = "_"),
                 paste("PS.0", "PS.22", "PS.45", "PS.90", sep = "_")#,
                 # paste("PS.0.orig", "PS.22.orig", "PS.45.orig", "PS.90.orig", "PS.180.orig", sep = "_")
                 )

dept.vars <- c("gj",
               "rc",
               "r12",
               "cc",
               "rmp",
               "r11",
               "r1"#,
               # "intercept.peak_htk",
               # "slope.peak_htk",
               # "intercept.end_htk",
               # "slope.end_htk",
               # "intercept.peak_a",
               # "slope.peak_a",
               # "intercept.end_a",
               # "slope.end_a"
)

# Set up a df with the inputs I want.
all.tests <- as.data.frame(expand.grid(comparisons, dept.vars))
names(all.tests) <- c("Groups", "DV")

all.tests <- all.tests %>%
  mutate(Obs.Net = ifelse(DV %in% c("gj", "Rc", "rc", "r12"), T, F)) %>% #NOTE: gj == Rc; gj != rc
  mutate(Model = ifelse(Groups == "PS.90.HA", "dept.var ~ Time", "dept.var ~ Time * Condition")) %>% #TODO switch to a more robust version built on str_split count
  mutate(Random = "~1 | Experiment")
# %>%
# mutate(Contrast = ifelse(!(DV %in% c("PS.90.HA")), "dept.var ~ Time * Condition", "dept.var ~ Time"))

# drop Rc and intercept.peak* from the *.orig datasets.
# all.tests <- all.tests[!((str_detect(all.tests$Groups, "orig") & (all.tests$DV %in% c("gj", "Rc", "intercept.peak_htk",
#                                                                                       "slope.peak_htk",
#                                                                                       "intercept.end_htk",
#                                                                                       "slope.end_htk",
#                                                                                       "intercept.peak_a",
#                                                                                       "slope.peak_a",
#                                                                                       "intercept.end_a",
#                                                                                       "slope.end_a")) )) , ]
# There's no data for htk with cd
# all.tests <- all.tests[!((str_detect(all.tests$Groups, "HA.Cd") & (all.tests$DV %in% c("intercept.peak_htk",
#                                                                                        "slope.peak_htk",
#                                                                                        "intercept.end_htk",
#                                                                                        "slope.end_htk",
#                                                                                        "intercept.peak_a",
#                                                                                        "slope.peak_a",
#                                                                                        "intercept.end_a",
#                                                                                        "slope.end_a")) )) , ]

#TODO data for ps90 isn't meshed well. There is current data and ionic current data but they are not tidy.

# TODO allow this when the K current data is in.
# all.tests <- all.tests[!(all.tests$DV %in% c("intercept.peak_htk", "intercept.peak_a")), ]

```

template for one
```{r}
# Test ----
M.clean <- d #%>% rename(Rc = gj)
```

# figures explicit
figures above are missing 20,60

```{r}

condition.labs <- c("TEA Mimic Sync", "TEA Mimic Async", "Depol. Async", "Depol. Async Cd2+",
                    "Standardized \n0 Deg.", "Standardized \n22.5 Deg.", "Standardized \n45 Deg.", "Standardized \n90 Deg.",
                    "Individualized \n0 Deg.", "Individualized \n22.5 Deg.", "Individualized \n45 Deg.", "Individualized \n90 Deg.", "Individualized \n180 Deg.")

names(condition.labs) <- c("PS.0.High.Amp", "PS.22.High.Amp", "PS.90.HA", "PS.90.HA.Cd",
                           "PS.0", "PS.22", "PS.45", "PS.90",
                           "PS.0.orig", "PS.22.orig", "PS.45.orig", "PS.90.orig", "PS.180.orig")

M.clean$Condition <- factor(M.clean$Condition, levels = c("PS.0.High.Amp", "PS.22.High.Amp", "PS.90.HA", "PS.90.HA.Cd",
                                                          "PS.0", "PS.22", "PS.45", "PS.90",
                                                          "PS.0.orig", "PS.22.orig", "PS.45.orig", "PS.90.orig", "PS.180.orig"))

### Params ####
text.size = 20
point.size = 3
line.size = 3
mean.point.size = 3
mean.line.size = 3

### High Amplitude Plots ####
plt.tea <- M.clean[M.clean$Condition %in% c("PS.0.High.Amp", "PS.22.High.Amp"), ] %>%
  dplyr::select(Condition, Experiment, Inj_Cell, Time, gj) %>%
  group_by(Condition, Experiment, Inj_Cell, Time) %>%
  summarise(gj = mean(gj, na.rm = T)) %>%
  ungroup() %>%
  # mutate(Time = as.character(Time)) %>%
  pivot_wider(names_from = Time, values_from = gj) %>%
  mutate(`20` = `20` - `0`,
         `40` = `40` - `0`,
         `60` = `60` - `0`) %>%
  mutate(`0` = 0) %>%
  pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "gj") %>%
  group_by(Condition, Time) %>%
  mutate(mean_gj = mean(gj, na.rm = T),
         mean_sd_up = mean_gj+sd(gj, na.rm = T),
         mean_sd_dn =mean_gj- sd(gj, na.rm = T),) %>%
  mutate(inter = paste(Experiment, Inj_Cell, sep = ".")) %>%
  ggplot(aes(x = Time,
             y = gj,
             # color = Experiment,
             # shape = Inj_Cell,
             group = inter))+
  geom_ribbon(aes(ymin=mean_sd_dn, ymax=mean_sd_up), fill = "gray", alpha = 0.1)+
  lemon::geom_pointline(size = point.size, linesize = line.size)+
  geom_point(aes(x = Time, y = mean_gj), color = "white", size = mean.point.size, alpha = 0.3)+
  geom_pointline(aes(x = Time, y = mean_gj), color = "firebrick", size = mean.point.size, linesize = mean.line.size,  shape = 1)+
  labs(y = expression(paste(Delta, "Rc", " in M", Omega)), x = "Time in Minutes")+
  facet_grid(.~Condition,
             labeller = labeller(Condition = condition.labs))+
  geom_hline(yintercept = 0)+
  theme(
    # axis.text = element_text(size = rel(2), angle = 0),
        text = element_text(size=text.size)
        )

plt.hv <- M.clean[M.clean$Condition %in% c("PS.90.HA", "PS.90.HA.Cd" ), ] %>%
  dplyr::select(Condition, Experiment, Inj_Cell, Time, gj) %>%
  group_by(Condition, Experiment, Inj_Cell, Time) %>%
  summarise(gj = mean(gj, na.rm = T)) %>%
  ungroup() %>%
  # mutate(Time = as.character(Time)) %>%
  pivot_wider(names_from = Time, values_from = gj) %>%
  mutate(`20` = `20` - `0`,
         `40` = `40` - `0`,
         `60` = `60` - `0`) %>%
  mutate(`0` = 0) %>%
  pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "gj") %>%
  group_by(Condition, Time) %>%
  mutate(mean_gj = mean(gj, na.rm = T),
         mean_sd_up = mean_gj+sd(gj, na.rm = T),
         mean_sd_dn =mean_gj- sd(gj, na.rm = T),) %>%
  mutate(inter = paste(Experiment, Inj_Cell, sep = ".")) %>%
  ggplot(aes(x = Time,
             y = gj,
             # color = Experiment,
             # shape = Inj_Cell,
             group = inter))+
  geom_ribbon(aes(ymin=mean_sd_dn, ymax=mean_sd_up), fill = "gray", alpha = 0.1)+
  lemon::geom_pointline(size = point.size, linesize = line.size)+
  geom_point(aes(x = Time, y = mean_gj), color = "white", size = mean.point.size, alpha = 0.3)+
  geom_pointline(aes(x = Time, y = mean_gj), color = "firebrick", size = mean.point.size, linesize = mean.line.size,  shape = 1)+
  labs(y = expression(paste(Delta, "Rc", " in M", Omega)), x = "Time in Minutes")+
  facet_grid(.~Condition,
             labeller = labeller(Condition = condition.labs))+
  geom_hline(yintercept = 0)+
  theme(
    # axis.text = element_text(size = rel(2), angle = 0),
        text = element_text(size=text.size)
        )




### Low Voltage plots ####
plt.lv <- M.clean[M.clean$Condition %in% c("PS.0", "PS.22", "PS.45", "PS.90"), ] %>%
  dplyr::select(Condition, Experiment, Inj_Cell, Time, gj) %>%
  group_by(Condition, Experiment, Inj_Cell, Time) %>%
  summarise(gj = mean(gj, na.rm = T)) %>%
  ungroup() %>%
  # mutate(Time = as.character(Time)) %>%
  pivot_wider(names_from = Time, values_from = gj) %>%
  mutate(`20` = `20` - `0`,
         `40` = `40` - `0`,
         `60` = `60` - `0`) %>%
  mutate(`0` = 0) %>%
  pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "gj") %>%
  group_by(Condition, Time) %>%
  mutate(mean_gj = mean(gj, na.rm = T),
         mean_sd_up = mean_gj+sd(gj, na.rm = T),
         mean_sd_dn =mean_gj- sd(gj, na.rm = T),) %>%
  mutate(inter = paste(Experiment, Inj_Cell, sep = ".")) %>%
  ggplot(aes(x = Time,
             y = gj,
             # color = Experiment,
             # shape = Inj_Cell,
             group = inter))+
  geom_ribbon(aes(ymin=mean_sd_dn, ymax=mean_sd_up), fill = "gray", alpha = 0.1)+
  lemon::geom_pointline(size = point.size, linesize = line.size)+
  geom_point(aes(x = Time, y = mean_gj), color = "white", size = mean.point.size, alpha = 0.3)+
  geom_pointline(aes(x = Time, y = mean_gj), color = "firebrick", size = mean.point.size, linesize = mean.line.size,  shape = 1)+
  labs(y = expression(paste(Delta, "Rc", " in M", Omega)), x = "Time in Minutes")+
  facet_grid(.~Condition,
             labeller = labeller(Condition = condition.labs))+
  geom_hline(yintercept = 0)+
  theme(
    # axis.text = element_text(size = rel(2), angle = 0),
        text = element_text(size=text.size)
        )

### Low Voltage naturalistic ####
plt.nv <- M.clean[M.clean$Condition %in% c("PS.0.orig", "PS.22.orig", "PS.45.orig", "PS.90.orig", "PS.180.orig"), ] %>%
  dplyr::select(Condition, Experiment, Inj_Cell, Time, gj) %>%
  group_by(Condition, Experiment, Inj_Cell, Time) %>%
  summarise(gj = mean(gj, na.rm = T)) %>%
  ungroup() %>%
  # mutate(Time = as.character(Time)) %>%
  pivot_wider(names_from = Time, values_from = gj) %>%
  mutate(`20` = `20` - `0`,
         `40` = `40` - `0`,
         `60` = `60` - `0`) %>%
  mutate(`0` = 0) %>%
  pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "gj") %>%
  group_by(Condition, Time) %>%
  mutate(mean_gj = mean(gj, na.rm = T),
         mean_sd_up = mean_gj+sd(gj, na.rm = T),
         mean_sd_dn =mean_gj- sd(gj, na.rm = T),) %>%
  mutate(inter = paste(Experiment, Inj_Cell, sep = ".")) %>%
  ggplot(aes(x = Time,
             y = gj,
             # color = Experiment,
             # shape = Inj_Cell,
             group = inter))+
  geom_ribbon(aes(ymin=mean_sd_dn, ymax=mean_sd_up), fill = "gray", alpha = 0.1)+
  lemon::geom_pointline(size = point.size, linesize = line.size)+
  geom_point(aes(x = Time, y = mean_gj), color = "white", size = mean.point.size, alpha = 0.3)+
  geom_pointline(aes(x = Time, y = mean_gj), color = "firebrick", size = mean.point.size, linesize = mean.line.size,  shape = 1)+
  labs(y = expression(paste(Delta, "Rc", " in M", Omega)), x = "Time in Minutes")+
  facet_grid(.~Condition,
             labeller = labeller(Condition = condition.labs))+
  geom_hline(yintercept = 0)+
  theme(
    # axis.text = element_text(size = rel(2), angle = 0),
        text = element_text(size=text.size)
        )
```

```{r}
# workspace
temp <- M.clean[M.clean$Condition %in% c(
  # "PS.90.HA.Cd", "PS.90.HA"
  # "PS.0.High.Amp", "PS.22.High.Amp"
  "PS.0", "PS.22", "PS.45", "PS.90"
                                         
                                         ), ] %>%
  dplyr::select(Condition, Experiment, Inj_Cell, Time, gj) %>%
  group_by(Condition, Experiment, Inj_Cell, Time) %>%
  summarise(gj = mean(gj, na.rm = T)) %>%
  ungroup() %>%
  # mutate(Time = as.character(Time)) %>%
  pivot_wider(names_from = Time, values_from = gj) %>%
  mutate(`20` = `20` - `0`,
         `40` = `40` - `0`,
         `60` = `60` - `0`) %>%
  mutate(`0` = 0) %>% 
  pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "gj")

# temp =temp[temp$Condition == 'PS.90', ]
temp$Time <- as.numeric(temp$Time)

ggplot(temp, aes(Time, gj, #color = Condition, 
                 color = Experiment,
                 group = interaction(Experiment, Inj_Cell)))+
  geom_point()+
  geom_line()+
  # facet_grid(.~Experiment)
  facet_grid(.~Condition)
```


work through low amp
for(entry in c(
  #"180308", 
  # "180309", 
  "180309a",
  "180314",
  # "180315", # must be included
  "180705",
  "181001"
               )){
  print(entry)
  fm <- drm(gj ~ Time, Condition, data = temp[temp$Experiment != entry, ], 
            fct = AR.2(),
      pmodels = list(~1, # d
                     ~1                  # e
                     ))
  
  print(summary(fm))
  
}




What's up with 22?
```{r}

library(drc)

indf = temp[temp$Condition %in% c(
  "PS.0",
  "PS.22", 
  "PS.45", "PS.90"
  ) , ]

mask_0 <- (indf$Condition == "PS.0")

# keep only ok
mask_22 <- (
  indf$Experiment %in% c(
    "180308",  # works
    # "180309",  # no info
    # "180309a", # no info
    # "180314",  # nans produced  -- added to all working, t value goes to infinity
    "180315",  # works
    # "180705",  # nans produced -- added to working seems ... okay?
    "181001",  # works
    "none") )
mask_22 <- mask_22 | (
  (indf$Experiment %in% c("180314") ) | #& indf$Time != 20
  (indf$Experiment %in% c("180705"))
)

mask_22 <- mask_22 & !((indf$Experiment == "180308") & (indf$Inj_Cell == "LC5"))
mask_22 <- mask_22 & !((indf$Experiment == "181001"
                        ) & (indf$Inj_Cell == "LC5"
                        ) & (indf$Time == 60
                      ))


    # error causing entries
    # (indf$Experiment %in% c("180314") & indf$Time != 20) |
    # (indf$Experiment %in% c("180705") #& indf$Time != 20

mask_45 <- (indf$Condition == "PS.45")
mask_90 <- (indf$Condition == "PS.90")

# indf_filter = indf[, ]
## global-ish ====
# ok -- 0+90
# not - 0+90+45
# not - 0+90+22
# ok -- 22+90
# ok -- 45+90
fm_g = drm(gj ~ Time, Condition, 
         data = indf[
           (mask_0 |
            mask_22 |
           mask_45# |
           # mask_90
           ),
                     ], 
         fct = AR.2(), 
         pmodels = list(~1, ~1))

summary(fm_g)

pred_g = data.frame(Time = seq(0, 60))
pred_g = cbind(pred_g, predict(fm_g, newdata = pred_g, se.fit = TRUE)) %>% 
  rename(gj = Prediction)
## 0 ====
fm_0 = drm(gj ~ Time, Condition, 
         data = indf[mask_0, ], 
         fct = AR.2(), 
         pmodels = list(~1, ~1))
summary(fm_0)
pred_0 = data.frame(Time = seq(0, 60),Condition = c("PS.0"))
pred_0 = cbind(pred_0, predict(fm_0, newdata = pred_0, se.fit = TRUE)) %>% 
  rename(gj = Prediction)
## 22 ====
fm_22 = drm(gj ~ Time, Condition, 
         data = indf[mask_22, ], 
         fct = AR.2(), 
         pmodels = list(~1, ~1))
summary(fm_22)
pred_22 = data.frame(Time = seq(0, 60),Condition = c("PS.22"))
pred_22 = cbind(pred_22, predict(fm_22, newdata = pred_22, se.fit = TRUE)) %>% 
  rename(gj = Prediction)
## 45 ====
fm_45 = drm(gj ~ Time, Condition, 
         data = indf[mask_45, ], 
         fct = AR.2(), 
         pmodels = list(~1, ~1))
summary(fm_45)
pred_45 = data.frame(Time = seq(0, 60),Condition = c("PS.45"))
pred_45 = cbind(pred_45, predict(fm_45, newdata = pred_45, se.fit = TRUE)) %>% 
  rename(gj = Prediction)
## 90 ====
fm_90 = drm(gj ~ Time, Condition, 
         data = indf[mask_90, ], 
         fct = AR.2(), 
         pmodels = list(~1, ~1))
summary(fm_90)
pred_90 = data.frame(Time = seq(0, 60),Condition = c("PS.90"))
pred_90 = cbind(pred_90, predict(fm_90, newdata = pred_90, se.fit = TRUE)) %>% 
  rename(gj = Prediction)

## plot ====
ggplot(data = indf, aes(Time, gj #color = Condition, 
                 # color = Experiment,
                 ))+
  geom_hline(yintercept = 0)+
  geom_line(color = 'darkgray', aes(group = interaction(Experiment, Inj_Cell)))+
  geom_point(color = 'red')+
  geom_point(data = indf[
           (mask_0 |
           mask_22 |
           mask_45 |
           mask_90),
                     ], color = 'darkgray')+
  geom_line(data = pred_g, aes(y = gj), color = 'black', linetype = 'dashed')+
  geom_line(data = pred_0, aes(y = gj, color=Condition))+
  geom_line(data = pred_22, aes(y = gj, color=Condition))+
  geom_line(data = pred_45, aes(y = gj, color=Condition))+
  geom_line(data = pred_90, aes(y = gj, color=Condition))+
  facet_grid(.~Condition)

## stats ====
fm_full = drm(gj ~ Time, Condition, 
         data = indf[
           (mask_0 |
           mask_22 |
           mask_45 |
           mask_90
           ),], 
         fct = AR.2(), 
         pmodels = list(
           # ~1,
           ~factor(Condition),
           # ~1
           ~factor(Condition)
           ))

summary(fm_full)

fm0 <- drm(gj ~ Time, Condition, data = indf[
           (mask_0 |
           mask_22 |
           mask_45 |
           mask_90
           ), ], 
          fct = AR.2(),
    pmodels = list(~1, # d
                   ~1                  # e
                   ))
# is using the treatment effect justified?
anova(fm_full, fm0)

# ED(fm, c(10, 50, 90))
compParm(fm_full, "d")

# modelFit(fm)



## plot with FULL MODEL ====

# predict all with full model
pred_00 = data.frame(expand.grid(Time = seq(0, 60),
                     Condition = c("PS.0",  "PS.22", "PS.45", "PS.90")))
pred_00 = cbind(pred_00, predict(fm_full, newdata = pred_00, se.fit = TRUE)) %>% 
  rename(gj = Prediction)


ggplot(data = indf, aes(Time, gj #color = Condition, 
                 # color = Experiment,
                 ))+
  geom_hline(yintercept = 0)+
  geom_line(color = 'darkgray', aes(group = interaction(Experiment, Inj_Cell)))+
  geom_point(color = 'red')+
  geom_point(data = indf[
           (mask_0 |
           mask_22 |
           mask_45 |
           mask_90),
                     ], color = 'darkgray')+
  # geom_line(data = pred_g, aes(y = gj), color = 'black', linetype = 'dashed')+
  geom_line(data = pred_00, aes(y = gj, color=Condition))+
  # geom_line(data = pred_22, aes(y = gj, color=Condition))+
  # geom_line(data = pred_45, aes(y = gj, color=Condition))+
  # geom_line(data = pred_90, aes(y = gj, color=Condition))+
  facet_grid(.~Condition)

```


```{r}
# try outwith drc

library(drc)
temp = temp[!is.na(temp$gj), ]
temp = temp[temp$Condition %in% c(
  "PS.0",
  "PS.22",
  "PS.45", "PS.90"
  ) , ]

# fm <- drm(gj ~ Time, Condition, data = temp, 
#           fct = AR.2(),
#     pmodels = list(~1, # d
#                    ~1                  # e
#                    ))
# 
# summary(fm)




# will it run if we drop those two points?
temp = temp[
  
  (      (temp$Experiment != '180309'
     ) & (temp$Experiment != '180309a'
     ) & (temp$Experiment != "180314"
     ) & (temp$Experiment != "180705")
   # ) | ((temp$Experiment %in% c("180314") & temp$Time != 20
   #  ) | (temp$Experiment %in% c("180705") & temp$Time != 20)
    )
  , ]






fm <- drm(gj ~ Time, Condition, data = temp,
          fct = AR.2(),
    pmodels = list(~factor(Condition), # d
                   ~1                  # e
                   ))

summary(fm)




pred1 = data.frame(
      Time = seq(0, 60), 
      Condition = 'PS.90.HA')
pred1 = cbind(pred1, 
              predict(fm, 
                      newdata = pred1, 
                      se.fit = TRUE)) %>% 
  rename(gj = Prediction)

pred2 = data.frame(
      Time = seq(0, 60), 
      Condition = 'PS.90.HA.Cd')
pred2 = cbind(pred2, 
              predict(fm, 
                      newdata = pred2, 
                      se.fit = TRUE)) %>% 
  rename(gj = Prediction)



ggplot(temp, 
       aes(Time, gj, color = Condition))+

  geom_line(data = pred1, color = 'black')+
  geom_line(data = pred1, aes(y = gj+0.14958), color = 'black', linetype = 'dashed')+
  geom_line(data = pred1, aes(y = gj-0.14958), color = 'black', linetype = 'dashed')+
  geom_line(data = pred2, color = 'black')+
  geom_line(data = pred2, aes(y = gj+0.22437), color = 'black', linetype = 'dashed')+
  geom_line(data = pred2, aes(y = gj-0.22437), color = 'black', linetype = 'dashed')+
  
  geom_point(alpha = 0.3)+
  geom_line(aes(group = interaction(Experiment, Inj_Cell)), alpha = 0.6)+
  
  facet_grid(.~Condition)

summary(fm)
anova(fm)

# https://www.researchgate.net/post/dose_response_curves_is_better_to_create_different_models_or_just_one



fm0 <- drm(gj ~ Time, Condition, data = temp, 
          fct = AR.2(),
    pmodels = list(~1, # d
                   ~1                  # e
                   ))
# is using the treatment effect justified?
anova(fm, fm0)

# ED(fm, c(10, 50, 90))
compParm(fm, "d")

# modelFit(fm)

```





























##### addition 2021 11 11
```{r}
condition.labs <- c("TEA Mimic Sync", "TEA Mimic Async", "Depol. Async", "Depol. Async Cd2+",
                    "Standardized \n0 Deg.", "Standardized \n22.5 Deg.", "Standardized \n45 Deg.", "Standardized \n90 Deg.",
                    "Individualized \n0 Deg.", "Individualized \n22.5 Deg.", "Individualized \n45 Deg.", "Individualized \n90 Deg.", "Individualized \n180 Deg.")

names(condition.labs) <- c("PS.0.High.Amp", "PS.22.High.Amp", "PS.90.HA", "PS.90.HA.Cd",
                           "PS.0", "PS.22", "PS.45", "PS.90",
                           "PS.0.orig", "PS.22.orig", "PS.45.orig", "PS.90.orig", "PS.180.orig")

M.clean$Condition <- factor(M.clean$Condition, levels = c("PS.0.High.Amp", "PS.22.High.Amp", "PS.90.HA", "PS.90.HA.Cd",
                                                          "PS.0", "PS.22", "PS.45", "PS.90",
                                                          "PS.0.orig", "PS.22.orig", "PS.45.orig", "PS.90.orig", "PS.180.orig"))

### Params ####
text.size = 20
point.size = 3
line.size = 3
mean.point.size = 3
mean.line.size = 3

### High Amplitude Plots ####
plt.tea.cc <- M.clean[M.clean$Condition %in% c("PS.0.High.Amp", "PS.22.High.Amp"), ] %>%
  dplyr::select(Condition, Experiment, Inj_Cell, Time, cc) %>%
  group_by(Condition, Experiment, Inj_Cell, Time) %>%
  summarise(cc = mean(cc, na.rm = T)) %>%
  ungroup() %>%
  # mutate(Time = as.character(Time)) %>%
  pivot_wider(names_from = Time, values_from = cc) %>%
  mutate(`20` = `20` - `0`,
         `40` = `40` - `0`,
         `60` = `60` - `0`) %>%
  mutate(`0` = 0) %>%
  pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "cc") %>%
  group_by(Condition, Time) %>%
  mutate(mean_cc = mean(cc, na.rm = T),
         mean_sd_up = mean_cc+sd(cc, na.rm = T),
         mean_sd_dn =mean_cc- sd(cc, na.rm = T),) %>%
  mutate(inter = paste(Experiment, Inj_Cell, sep = ".")) %>%
  ggplot(aes(x = Time,
             y = cc,
             # color = Experiment,
             # shape = Inj_Cell,
             group = inter))+
  geom_ribbon(aes(ymin=mean_sd_dn, ymax=mean_sd_up), fill = "gray", alpha = 0.1)+
  lemon::geom_pointline(size = point.size, linesize = line.size)+
  geom_point(aes(x = Time, y = mean_cc), color = "white", size = mean.point.size, alpha = 0.3)+
  geom_pointline(aes(x = Time, y = mean_cc), color = "firebrick", size = mean.point.size, linesize = mean.line.size,  shape = 1)+
  labs(y = expression(paste(Delta, "CC")), x = "Time in Minutes")+
  facet_grid(.~Condition,
             labeller = labeller(Condition = condition.labs))+
  geom_hline(yintercept = 0)+
  theme(
    # axis.text = element_text(size = rel(2), angle = 0),
        text = element_text(size=text.size)
        )

plt.hv.cc <- M.clean[M.clean$Condition %in% c("PS.90.HA", "PS.90.HA.Cd" ), ] %>%
  dplyr::select(Condition, Experiment, Inj_Cell, Time, cc) %>%
  group_by(Condition, Experiment, Inj_Cell, Time) %>%
  summarise(cc = mean(cc, na.rm = T)) %>%
  ungroup() %>%
  # mutate(Time = as.character(Time)) %>%
  pivot_wider(names_from = Time, values_from = cc) %>%
  mutate(`20` = `20` - `0`,
         `40` = `40` - `0`,
         `60` = `60` - `0`) %>%
  mutate(`0` = 0) %>%
  pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "cc") %>%
  group_by(Condition, Time) %>%
  mutate(mean_cc = mean(cc, na.rm = T),
         mean_sd_up = mean_cc+sd(cc, na.rm = T),
         mean_sd_dn =mean_cc- sd(cc, na.rm = T),) %>%
  mutate(inter = paste(Experiment, Inj_Cell, sep = ".")) %>%
  ggplot(aes(x = Time,
             y = cc,
             # color = Experiment,
             # shape = Inj_Cell,
             group = inter))+
  geom_ribbon(aes(ymin=mean_sd_dn, ymax=mean_sd_up), fill = "gray", alpha = 0.1)+
  lemon::geom_pointline(size = point.size, linesize = line.size)+
  geom_point(aes(x = Time, y = mean_cc), color = "white", size = mean.point.size, alpha = 0.3)+
  geom_pointline(aes(x = Time, y = mean_cc), color = "firebrick", size = mean.point.size, linesize = mean.line.size,  shape = 1)+
  labs(y = expression(paste(Delta, "CC")), x = "Time in Minutes")+
  facet_grid(.~Condition,
             labeller = labeller(Condition = condition.labs))+
  geom_hline(yintercept = 0)+
  theme(
    # axis.text = element_text(size = rel(2), angle = 0),
        text = element_text(size=text.size)
        )




### Low Voltage plots ####
plt.lv.cc <- M.clean[M.clean$Condition %in% c("PS.0", "PS.22", "PS.45", "PS.90"), ] %>%
  dplyr::select(Condition, Experiment, Inj_Cell, Time, cc) %>%
  group_by(Condition, Experiment, Inj_Cell, Time) %>%
  summarise(cc = mean(cc, na.rm = T)) %>%
  ungroup() %>%
  # mutate(Time = as.character(Time)) %>%
  pivot_wider(names_from = Time, values_from = cc) %>%
  mutate(`20` = `20` - `0`,
         `40` = `40` - `0`,
         `60` = `60` - `0`) %>%
  mutate(`0` = 0) %>%
  pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "cc") %>%
  group_by(Condition, Time) %>%
  mutate(mean_cc = mean(cc, na.rm = T),
         mean_sd_up = mean_cc+sd(cc, na.rm = T),
         mean_sd_dn =mean_cc- sd(cc, na.rm = T),) %>%
  mutate(inter = paste(Experiment, Inj_Cell, sep = ".")) %>%
  ggplot(aes(x = Time,
             y = cc,
             # color = Experiment,
             # shape = Inj_Cell,
             group = inter))+
  geom_ribbon(aes(ymin=mean_sd_dn, ymax=mean_sd_up), fill = "gray", alpha = 0.1)+
  lemon::geom_pointline(size = point.size, linesize = line.size)+
  geom_point(aes(x = Time, y = mean_cc), color = "white", size = mean.point.size, alpha = 0.3)+
  geom_pointline(aes(x = Time, y = mean_cc), color = "firebrick", size = mean.point.size, linesize = mean.line.size,  shape = 1)+
  labs(y = expression(paste(Delta, "CC")), x = "Time in Minutes")+
  facet_grid(.~Condition,
             labeller = labeller(Condition = condition.labs))+
  geom_hline(yintercept = 0)+
  theme(
    # axis.text = element_text(size = rel(2), angle = 0),
        text = element_text(size=text.size)
        )



```
##### end of same



## Waveform annotations on figs
```{r}
protocol_files <- list.files("D:/Box Sync/AllWorkProjects/dynamicclamp - Copy/inst/extdata/protocol_waveforms/")

data.reduction <- 250

stims <- map(protocol_files, function(i){
  temp <- read.table(paste0("D:/Box Sync/AllWorkProjects/dynamicclamp - Copy/inst/extdata/protocol_waveforms/", i))
  temp <- temp[4:nrow(temp), ]
  names(temp) <- c("Seconds", "mV")
  temp$Seconds <- as.numeric(as.character(temp$Seconds))
  temp$mV <- as.numeric(as.character(temp$mV))

  temp$Protocol <- i

  # don't data reduce the naturalistic, it's lower res already.
  if (!(i %in% c("170828_lead.atf",
                 "180717a_follow.atf",
                 "180718_lead.atf"))) {
    temp <- temp[seq(1, nrow(temp), by = data.reduction), ]
  }

  return(temp)
})

## make 22.5 - 180 shifts for 170828_lead.atf
add.to.stims <- map(c(2, 4, 8, 16), function(i, temp = stims[[which(protocol_files == "170828_lead.atf")]]){

  # make shifted times
  shift.by <- floor(nrow(temp) / i)
  temp$Seconds <- c(temp$Seconds[seq(shift.by+1, nrow(temp))], temp$Seconds[seq(1, shift.by)])
  # update Protocol name

  temp$Protocol <- stringr::str_remove(temp$Protocol, "lead.atf")
  temp$Protocol <- paste0(temp$Protocol, as.character((1/i)*360), ".atf")

  # since we'll visualize with geom_path we need to sort here.
  temp <- arrange(temp, Seconds)

  return(temp)

})

# Grow list
for (i in seq_along(add.to.stims)){
  stims[[length(stims)+1]] <- add.to.stims[[i]]
}


stims <- do.call(rbind, stims)
```

```{r}
inset_plts <- map(c("aberrant_depol_man.atf",
                    "aberrant_depol_man_22deg.ATF",
                    "HA_00.ATF",
                    "HA_90.ATF",

                    "180110_stim.atf",
                    "180110_stim_22deg.ATF",
                    "180110_stim_45deg.ATF",
                    "180110_stim_90deg.ATF",

                    "170828_lead.atf",
                    "170828_22.5.atf",
                    "170828_45.atf",
                    "170828_90.atf",
                    "170828_180.atf"), function(i){
                      plt <- stims[stims$Protocol == i, ] %>%
                        ggplot( aes(Seconds, mV, group = 1))+
                        geom_path()+
                        theme_void()
                    })

names(inset_plts) <- c("tea0", "tea22", "ha0", "ha90",
                       "s0", "s22", "s45", "s90",
                       "n0", "n22", "n45", "n90", "n180")

```

## Prep Figure 1
```{r}

trace.size = 1
bar.size = 2

ex.1 <-
ggplot()+
  geom_path(data = stims[stims$Protocol %in% c("aberrant_depol_man.atf") , ], aes(Seconds/1000, mV+53.53, group = 1), size = trace.size)+
  geom_segment(aes(x = 0, xend = 0, y = -1, yend = 9), size = bar.size)+
  geom_segment(aes(x = 0, xend = 1, y = -1, yend = -1), size = bar.size)+
  geom_vline(xintercept = 3.9)+
  theme_void()

ex.2 <-
ggplot()+
  geom_path(data = stims[stims$Protocol %in% c("HA_00.ATF") , ], aes(Seconds, mV+53.53, group = 1), size = trace.size)+
  geom_segment(aes(x = 0, xend = 0, y = -1, yend = 9), size = bar.size)+
  geom_segment(aes(x = 0, xend = 1, y = -1, yend = -1), size = bar.size)+
  theme_void()

ex.3 <-
ggplot()+
  geom_path(data = stims[stims$Protocol %in% c("180110_stim.atf") , ], aes(Seconds/1000, mV+53.53, group = 1), size = trace.size)+
  geom_segment(aes(x = 0, xend = 0, y = -1, yend = 9), size = bar.size)+
  geom_segment(aes(x = 0, xend = 1, y = -1, yend = -1), size = bar.size)+
  theme_void()


#Control lab position even with different x axis
label.size = 4
label.x.fract = 4/5
label.y = 7

ex.4 <-
ggplot()+
  geom_path(data = stims[stims$Protocol %in% c("170828_lead.atf") , ], aes(Seconds/1000, mV+43.29, group = 1), size = trace.size)+
  geom_segment(aes(x = 0, xend = 0, y = -1, yend = 9), size = bar.size)+
  geom_segment(aes(x = 0, xend = 1, y = -1, yend = -1), size = bar.size)+
  annotate("text", x = ((label.x.fract)*5.178), y = label.y, label = 'paste(italic(Animal), " ", italic("1"))',  parse = T, size = label.size)+
  theme_void()


ex.5 <-
ggplot()+
  geom_path(data = stims[stims$Protocol %in% c("180717a_follow.atf") , ], aes(Seconds/1000, mV+55.83, group = 1), size = trace.size, color = "gray")+
  geom_segment(aes(x = 0, xend = 0, y = -1, yend = 9), size = bar.size)+
  geom_segment(aes(x = 0, xend = 1, y = -1, yend = -1), size = bar.size)+
  annotate("text", x = ((label.x.fract)*4.919), y = label.y, label = 'paste(italic(Animal), " ", italic("2"))',  parse = T, size = label.size)+
  theme_void()

ex.6 <-
ggplot()+
  geom_path(data = stims[stims$Protocol %in% c("180718_lead.atf") , ], aes((Seconds-281297)/1000, mV+62.36, group = 1), size = trace.size, color = "gray")+
  geom_segment(aes(x = 0, xend = 0, y = -1, yend = 9), size = bar.size)+
  geom_segment(aes(x = 0, xend = 1, y = -1, yend = -1), size = bar.size)+
  annotate("text", x = ((label.x.fract)*5.652), y = label.y, label = 'paste(italic(Animal), " ", italic("3"))',  parse = T, size = label.size)+
  theme_void()

fig1.left <- (ex.1 / ex.2 / ex.3 / ex.4 / ex.5 / ex.6)


#Rescale data so that it has a mV range 0-1
example.shift <- stims[stims$Protocol %in% c("180110_stim.atf") , ]
example.shift$Seconds <- example.shift$Seconds/1000
example.shift$mV <- example.shift$mV - min(example.shift$mV, na.rm = T)
example.shift$mV <- example.shift$mV / max(example.shift$mV, na.rm = T)

example.shift$Protocol <- "B"
# example.shift$ShiftBy <- 0
examples.shifted <- map(seq_along(c(1, 16, 8, 4, 2)), function(j, temp = example.shift){
  i <- c(1, 16, 8, 4, 2)[j]

  if (i == 1){
    temp$Protocol <- "0"
  } else {
    # make shifted times
    shift.by <- floor(nrow(temp) / i)
    temp$Seconds <- c(temp$Seconds[seq(shift.by+1, nrow(temp))], temp$Seconds[seq(1, shift.by)])
    # add ShiftBy so we can make scale bars
    # temp$ShiftBy <- temp[shift.by, "Seconds"]
    # update Protocol name
    temp$Protocol <- as.character((1/i)*360)
  }
  # change min mV so that
  temp$mV <- temp$mV - j

  # since we'll visualize with geom_path we need to sort here.
  temp <- arrange(temp, Seconds)

  return(temp)
})

# Grow list
examples.shifted[[length(examples.shifted)+1]] <- example.shift
# collapse into df
example.shift.plt.df <- do.call(rbind, examples.shifted)


period <- max(example.shift.plt.df$Seconds, na.rm = T)

font.size = 2

fig1.right <- ggplot(example.shift.plt.df, aes(Seconds, mV, group = Protocol))+
  # geom_segment(aes(x = 0.71, xend = 0.71,                         y = 1, yend = -1), size = 1, color = "cornflowerblue")+
  geom_segment(aes(x = 0.71+(period/16), xend = 0.71+(period/16), y = 1, yend = -1), size = 1, color = "cornflowerblue")+
  geom_segment(aes(x = 0.71+(period/8),  xend = 0.71+(period/8),  y = 1, yend = -2), size = 1, color = "cornflowerblue")+
  geom_segment(aes(x = 0.71+(period/4),  xend = 0.71+(period/4),  y = 1, yend = -3), size = 1, color = "cornflowerblue")+
  geom_segment(aes(x = 0.71+(period/2),  xend = 0.71+(period/2),  y = 1, yend = -4), size = 1, color = "cornflowerblue")+

  geom_segment(aes(x = 0.71,  xend = 0.71+(period/2),             y = 1, yend = 1), size = 1, color = "cornflowerblue")+
  # annotate("text", x = 0.61, y = 1.1, parse = TRUE, label = as.character(expression(paste(Phi, "=", sep = ""))) )+
  annotate("text", x = 0.71, y = 1.1, parse = TRUE, label = as.character(expression(paste("0", degree, sep = ""))) , size = font.size)+
  annotate("text", x = 0.71+(period/16), y = 1.1, parse = TRUE, label = as.character(expression(paste("22", degree, sep = ""))) , size = font.size)+
  annotate("text", x = 0.71+(period/8), y = 1.1, parse = TRUE, label = as.character(expression(paste("45", degree, sep = ""))) , size = font.size)+
  annotate("text", x = 0.71+(period/4), y = 1.1, parse = TRUE, label = as.character(expression(paste("90", degree, sep = ""))) , size = font.size)+
  annotate("text", x = 0.71+(period/2), y = 1.1, parse = TRUE, label = as.character(expression(paste("180", degree, sep = ""))) , size = font.size)+

  geom_path(size = trace.size)+
  geom_segment(aes(x = 0, xend = 0, y = -5.05, yend = -5.05+((1/20.2529)*10)), size = bar.size)+
  geom_segment(aes(x = 0, xend = 1, y = -5.05, yend = -5.05), size = bar.size)+
  theme_void()

fig1.part <- (fig1.left | fig1.right) + plot_annotation(tag_levels = 'i')




# tea.protocol.fig <-
# ggplot()+
#   geom_path(data = stims[stims$Protocol %in% c("aberrant_depol_man.atf") , ], aes(Seconds, mV, group = 1))+
#   geom_path(data = stims[stims$Protocol %in% c("aberrant_depol_man_22deg.ATF") , ], aes(Seconds, mV-(39.97*1), group = 1))+
#   geom_segment(aes(x = 0, xend = 0, y = -90, yend = -80), size = 1)+
#   geom_segment(aes(x = 0, xend = 1000, y = -90, yend = -90), size = 1)+
#   theme_void()
#
# hv.protocol.fig <-
# ggplot()+
#   geom_path(data = stims[stims$Protocol %in% c("HA_00.ATF") , ], aes(Seconds, mV, group = 1))+
#   geom_path(data = stims[stims$Protocol %in% c("HA_90.ATF") , ], aes(Seconds, mV-(39.97*1), group = 1))+
#   geom_segment(aes(x = 0, xend = 0, y = -90, yend = -80), size = 1)+
#   geom_segment(aes(x = 0, xend = 1, y = -90, yend = -90), size = 1)+
#   theme_void()
#
# nv.protocol.fig <-
# ggplot()+
#   geom_path(data = stims[stims$Protocol %in% c("180110_stim.atf") , ], aes(Seconds, mV, group = 1))+
#   geom_path(data = stims[stims$Protocol %in% c("180110_stim_22deg.ATF") , ], aes(Seconds, mV-(20.26*1), group = 1))+
#   geom_path(data = stims[stims$Protocol %in% c("180110_stim_45deg.ATF") , ], aes(Seconds, mV-(20.26*2), group = 1))+
#   geom_path(data = stims[stims$Protocol %in% c("180110_stim_90deg.ATF") , ], aes(Seconds, mV-(20.26*3), group = 1))+
#   geom_segment(aes(x = 0, xend = 0, y = -110, yend = -100), size = 1)+
#   geom_segment(aes(x = 0, xend = 1000, y = -110, yend = -110), size = 1)+
#   theme_void()
#
# fig1.part <- ((tea.protocol.fig / hv.protocol.fig) | nv.protocol.fig) + plot_annotation(tag_levels = 'i')
```




## Prep Figures 2-4
```{r}
# ## High Volt ====
manual.y1 = -3.7
manual.y2 = 2.1

# plt.tea
inset.w = .22
inset.h = .05

x1 = 0.167
x2 = 0.61

y1 = .825
y2 = .88

plt.tea.a <- ggdraw()+
  draw_plot(plt.tea+ylim(manual.y1, manual.y2)) +
  # lead
  draw_plot(inset_plts$tea0, x = x1, y = y1, width = inset.w, height = inset.h)+
  draw_plot(inset_plts$tea0, x = x2, y = y1, width = inset.w, height = inset.h)+
  # follow
  draw_plot(inset_plts$tea0,   x = x1, y = y2, width = inset.w, height = inset.h)+
  draw_plot(inset_plts$tea22,  x = x2, y = y2, width = inset.w, height = inset.h)

### plot high voltage ####
# inset.w = .24
# inset.h = .05
#
# x1 = 0.1
# x2 = 0.7
#
# y1 = .825
# y2 = .88

plt.hv.a <- ggdraw()+
  draw_plot(plt.hv+ylim(manual.y1, manual.y2)) +
  # lead
  draw_plot(inset_plts$ha0, x = x1, y = y1, width = inset.w, height = inset.h)+
  draw_plot(inset_plts$ha0, x = x2, y = y1, width = inset.w, height = inset.h)+
  # follow
  draw_plot(inset_plts$ha90,   x = x1, y = y2, width = inset.w, height = inset.h)+
  draw_plot(inset_plts$ha90,  x = x2, y = y2, width = inset.w, height = inset.h)

plt.tea.hv.a <- plt.tea.a + plt.hv.a + plot_annotation(tag_levels = 'A')

## Standardized ====

inset.w = .12
inset.h = .05

x1 = 0.085
x2 = 0.32
x3 = 0.555
x4 = 0.792

y1 = .825
y2 = .88

plt.lv.a <- ggdraw()+
  draw_plot(plt.lv) +
  # lead
  draw_plot(inset_plts$s0, x = x1, y = y1, width = inset.w, height = inset.h)+
  draw_plot(inset_plts$s0, x = x2, y = y1, width = inset.w, height = inset.h)+
  draw_plot(inset_plts$s0, x = x3, y = y1, width = inset.w, height = inset.h)+
  draw_plot(inset_plts$s0, x = x4, y = y1, width = inset.w, height = inset.h)+
  # follow
  draw_plot(inset_plts$s0,   x = x1, y = y2, width = inset.w, height = inset.h)+
  draw_plot(inset_plts$s22,  x = x2, y = y2, width = inset.w, height = inset.h)+
  draw_plot(inset_plts$s45,  x = x3, y = y2, width = inset.w, height = inset.h)+
  draw_plot(inset_plts$s90,  x = x4, y = y2, width = inset.w, height = inset.h)


# ## Naturalistic ====

# inset.w = .12
# inset.h = .05
#
# x1 = 0.075
# x2 = 0.265
# x3 = 0.455
# x4 = 0.645
# x5 = 0.835
#
# y1 = .815
# y2 = .87
#
# plt.nv.a <- ggdraw()+
#   draw_plot(plt.nv) +
#   # lead
#   draw_plot(inset_plts$n0, x = x1, y = y1, width = inset.w, height = inset.h)+
#   draw_plot(inset_plts$n0, x = x2, y = y1, width = inset.w, height = inset.h)+
#   draw_plot(inset_plts$n0, x = x3, y = y1, width = inset.w, height = inset.h)+
#   draw_plot(inset_plts$n0, x = x4, y = y1, width = inset.w, height = inset.h)+
#   draw_plot(inset_plts$n0, x = x5, y = y1, width = inset.w, height = inset.h)+
#   # follow
#   draw_plot(inset_plts$n0,   x = x1, y = y2, width = inset.w, height = inset.h)+
#   draw_plot(inset_plts$n22,  x = x2, y = y2, width = inset.w, height = inset.h)+
#   draw_plot(inset_plts$n45,  x = x3, y = y2, width = inset.w, height = inset.h)+
#   draw_plot(inset_plts$n90,  x = x4, y = y2, width = inset.w, height = inset.h)+
#   draw_plot(inset_plts$n180, x = x5, y = y2, width = inset.w, height = inset.h)

indv1 <- stims[stims$Protocol %in% c("170828_lead.atf") , ]
indv2 <- stims[stims$Protocol %in% c("180717a_follow.atf") , ]
indv3 <- stims[stims$Protocol %in% c("180718_lead.atf") , ]



add_shifts_indv <- function(df = indv1){
  df <- cbind(df, data.frame(p0 = NA, p16 = NA, p8 = NA, p4 = NA, p2 = NA))
  df$Seconds <- df$Seconds - min(df$Seconds, na.rm = T)
  df$mV <- df$mV - min(df$mV, na.rm = T)

  df$p0 <- df$mV
  df$p16<- c(df$mV[seq(length(df$mV)-(ceiling(length(df$mV) / 16)-1), length(df$mV))],
             df$mV[seq(1, (length(df$mV)-ceiling(length(df$mV) / 16)))])
  df$p8 <- c(df$mV[seq(length(df$mV)-(ceiling(length(df$mV) / 8)-1), length(df$mV))],
             df$mV[seq(1, (length(df$mV)-ceiling(length(df$mV) / 8)))])
  df$p4 <- c(df$mV[seq(length(df$mV)-(ceiling(length(df$mV) / 4)-1), length(df$mV))],
             df$mV[seq(1, (length(df$mV)-ceiling(length(df$mV) / 4)))])
  df$p2 <- c(df$mV[seq(length(df$mV)-(ceiling(length(df$mV) / 2)-1), length(df$mV))],
             df$mV[seq(1, (length(df$mV)-ceiling(length(df$mV) / 2)))])
  return(df)
}


indv1 <- add_shifts_indv(df = indv1)
indv2 <- add_shifts_indv(df = indv2)
indv3 <- add_shifts_indv(df = indv3)

indvs <- do.call(rbind, list(indv1, indv2, indv3))



indv_inset_2color <- map(c("p0", "p16", "p8", "p4", "p2"), function(i){
  indvs %>%
    ggplot(aes(x= Seconds, group = "Protocol"))+
    # geom_segment(aes(x = 0, xend = 0, y = 0, yend = 5))+
    geom_path(aes_string(y = i), color = "darkgray")+
    geom_path(aes(y = p0))+
    facet_wrap(.~Protocol, scales = "free_y",
               ncol = 1)+
    theme_void()+
    theme(strip.text = element_blank())
})

names(indv_inset_2color) <- c("p0", "p16", "p8", "p4", "p2")





inset.w = .12
inset.h = .17

x1 = 0.075
x2 = 0.265
x3 = 0.455
x4 = 0.645
x5 = 0.835

y2 = .7

plt.nv.a <- ggdraw()+
  draw_plot(plt.nv) +
  draw_plot(indv_inset_2color$p0,   x = x1, y = y2, width = inset.w, height = inset.h)+
  draw_plot(indv_inset_2color$p16,  x = x2, y = y2, width = inset.w, height = inset.h)+
  draw_plot(indv_inset_2color$p8,  x = x3, y = y2, width = inset.w, height = inset.h)+
  draw_plot(indv_inset_2color$p4,  x = x4, y = y2, width = inset.w, height = inset.h)+
  draw_plot(indv_inset_2color$p2, x = x5, y = y2, width = inset.w, height = inset.h)

```

### Prototype version 2 of figure 4
Show variability in traces AND delay

```{r}






```



## Confirm no directionality or rectification

```{r}
M.directionality <-
M.clean %>% dplyr::select(Condition, Experiment, Time, Inj_Cell, rc, gj) %>% distinct() %>% as_tibble()

M.directionality %>%
  gather(key = "rec", value = "Resistance", c("rc", "gj")) %>%
  filter(!is.na(Resistance)) %>%
  spread(key = "Inj_Cell", value = "Resistance") %>%
  ggplot(aes(x = LC4, y = LC5, group = Condition, color = Condition, fill = Condition))+
  geom_abline(slope = 1, intercept = 0, color = "black")+
  geom_smooth(method = "lm", fullrange = T)+
  geom_point(shape = 1)+
  xlim(0, 30)+
  ylim(0, 30)+
  facet_grid(Time~Condition)+
  theme(legend.position = "bottom")

```

## Figures for DJS -- What's happening with currents?

```{r}
temp_df <- M.clean[M.clean$Condition %in% c("PS.0.High.Amp", "PS.22", "PS.45", "PS.0", "PS.22.High.Amp", "PS.90", "PS.90.HA", "PS.90.HA.Cd"), ]

# current_DV <- "intercept.peak_htk"


dv_array <- c("intercept.peak_htk", "slope.peak_htk", "intercept.end_htk", "slope.end_htk",
    "intercept.peak_a", "slope.peak_a", "intercept.end_a", "slope.end_a")



plt_list_currents <- map(
  dv_array, function(current_DV){

      temp_df$DV <- temp_df[[current_DV]]

      temp_df %>%
        dplyr::select(Condition, Experiment, Inj_Cell, Time, DV) %>%
        group_by(Condition, Experiment, Inj_Cell, Time) %>%
        summarise(DV = mean(DV, na.rm = T)) %>%
        ungroup() %>%
        # mutate(Time = as.character(Time)) %>%
        pivot_wider(names_from = Time, values_from = DV) %>%
        mutate(`20` = `20` - `0`,
               `40` = `40` - `0`,
               `60` = `60` - `0`) %>%
        mutate(`0` = 0) %>%
        pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "DV") %>%
        group_by(Condition, Time) %>%
        mutate(mean_DV = mean(DV, na.rm = T),
               mean_sd_up = mean_DV+sd(DV, na.rm = T),
               mean_sd_dn =mean_DV- sd(DV, na.rm = T),) %>%
        mutate(inter = paste(Experiment, Inj_Cell, sep = ".")) %>%
        ggplot(aes(x = Time,
                   y = DV,
                   # color = Experiment,
                   # shape = Inj_Cell,
                   group = inter))+
        geom_ribbon(aes(ymin=mean_sd_dn, ymax=mean_sd_up), fill = "gray", alpha = 0.1)+
        lemon::geom_pointline(size = point.size, linesize = line.size)+
        geom_point(size = point.size)+
        geom_point(aes(x = Time, y = mean_DV), color = "white", size = mean.point.size, alpha = 0.3)+
        geom_pointline(aes(x = Time, y = mean_DV), color = "firebrick", size = mean.point.size, linesize = mean.line.size,  shape = 1)+
        # labs(y = expression(paste(Delta, "Rc", " in M", Omega)), x = "Time in Minutes")+
        facet_grid(.~Condition,
                   labeller = labeller(Condition = condition.labs))+
        geom_hline(yintercept = 0)+
        theme(
          # axis.text = element_text(size = rel(2), angle = 0),
          text = element_text(size=text.size)
        )+
        labs(title = current_DV)
    })





temp_df$Condition <- as.character(temp_df$Condition)
temp_df[temp_df$Condition %in% c("PS.0.High.Amp", "PS.22.High.Amp", "PS.90.HA", "PS.90.HA.Cd"), "Condition"] <- "HighAmp"
temp_df[temp_df$Condition %in% c("PS.22", "PS.45", "PS.0", "PS.90"), "Condition"] <- "LowAmp"

plt_list_currents2 <- map(
  dv_array, function(current_DV){

      temp_df$DV <- temp_df[[current_DV]]

      temp_df %>%
        dplyr::select(Condition, Experiment, Inj_Cell, Time, DV) %>%
        group_by(Condition, Experiment, Inj_Cell, Time) %>%
        summarise(DV = mean(DV, na.rm = T)) %>%
        ungroup() %>%
        # mutate(Time = as.character(Time)) %>%
        pivot_wider(names_from = Time, values_from = DV) %>%
        mutate(`20` = `20` - `0`,
               `40` = `40` - `0`,
               `60` = `60` - `0`) %>%
        mutate(`0` = 0) %>%
        pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "DV") %>%
        group_by(Condition, Time) %>%
        mutate(mean_DV = mean(DV, na.rm = T),
               mean_sd_up = mean_DV+sd(DV, na.rm = T),
               mean_sd_dn =mean_DV- sd(DV, na.rm = T),) %>%
        mutate(inter = paste(Experiment, Inj_Cell, sep = ".")) %>%
        ggplot(aes(x = Time,
                   y = DV,
                   # color = Experiment,
                   # shape = Inj_Cell,
                   group = inter))+
        geom_ribbon(aes(ymin=mean_sd_dn, ymax=mean_sd_up), fill = "gray", alpha = 0.1)+
        lemon::geom_pointline(size = point.size, linesize = line.size)+
        geom_point(size = point.size)+
        geom_point(aes(x = Time, y = mean_DV), color = "white", size = mean.point.size, alpha = 0.3)+
        geom_pointline(aes(x = Time, y = mean_DV), color = "firebrick", size = mean.point.size, linesize = mean.line.size,  shape = 1)+
        # labs(y = expression(paste(Delta, "Rc", " in M", Omega)), x = "Time in Minutes")+
        facet_grid(.~Condition
                   # ,
                   # labeller = labeller(Condition = condition.labs)
                   )+
        geom_hline(yintercept = 0)+
        theme(
          # axis.text = element_text(size = rel(2), angle = 0),
          text = element_text(size=text.size)
        )+
        labs(title = current_DV)
    })






walk(seq_along(dv_array), function(i){
  current_DV <- dv_array[i]

ggsave(plt_list_currents2[[i]], path = here("data", "figures"),
       filename = paste("DJS_VC_Join-", current_DV, ".tiff", sep = ""))

ggsave(plt_list_currents[[i]], path = here("data", "figures"),
       filename = paste("DJS_VC_Sept-", current_DV, ".tiff", sep = ""))
})




temp_df_lc_similarity <- temp_df %>% dplyr::filter(Time == 0)



dv_array2 <- c("r11", "r12", "r1", "rc", "cc", "rmp", "gj",
               "gj", # <--- just a placeholder
               "intercept.peak_htk", "slope.peak_htk", "intercept.end_htk", "slope.end_htk", "intercept.peak_a", "slope.peak_a", "intercept.end_a", "slope.end_a")

similarity_plts <- map(seq_along(dv_array2), function(i){
  current_DV <- dv_array2[i]

  temp_df_lc_similarity$DV <- temp_df_lc_similarity[[current_DV]]

  plt <-
    temp_df_lc_similarity %>%
    dplyr::select(Experiment, Inj_Cell, DV) %>%
    dplyr::filter(!is.na(DV)) %>%
    # spread(Inj_Cell, DV) %>%
    ggplot(aes(x = Inj_Cell, y = DV, group = Experiment))+
    geom_line()+
    geom_point()+
    labs(title =  current_DV, x = "", y = "")

  if (current_DV=="rc"){
    plt <-
      temp_df_lc_similarity %>%
      dplyr::select(Experiment, Inj_Cell, DV) %>%
      dplyr::filter(!is.na(DV)) %>%
      dplyr::filter(DV < 20) %>%
      # spread(Inj_Cell, DV) %>%
      ggplot(aes(x = Inj_Cell, y = DV, group = Experiment))+
      geom_line()+
      geom_point()+
      labs(title =  current_DV, x = "", y = "")
  }

  return(plt)
})


similarity_plts[[8]] <- NA


# cowplot::plot_grid(plotlist = similarity_plts)

ggsave(cowplot::plot_grid(plotlist = similarity_plts), path = here("data", "figures"),
       filename = paste("DJS_LC_Similarity.tiff", sep = ""), width = 12, height = 12

       )












similarity_plts2 <- map(seq_along(dv_array2), function(i){
  current_DV <- dv_array2[i]

  temp_df_lc_similarity$DV <- temp_df_lc_similarity[[current_DV]]

  resample_iters = 1000

  real_diffs <- temp_df_lc_similarity %>%
    dplyr::select(Experiment, Inj_Cell, DV) %>%
    dplyr::filter(!is.na(DV)) %>%
    spread(Inj_Cell, DV) %>%
    dplyr::filter(!is.na(LC4)) %>%
    dplyr::filter(!is.na(LC5)) %>%
    mutate(DV_Diff = LC4-LC5) %>%
    mutate(iter = 0, real = T) %>%
    dplyr::select(Experiment, DV_Diff, iter, real)

  fake_diffs <- map(1:resample_iters, function(i){
    temp <- temp_df_lc_similarity

    # temp$inter <- paste(temp$Experiment, temp$Inj_Cell, sep = ".")
    #
    # temp$inter <- sample(temp$inter, replace = F)
    #
    # new_labels <- temp$inter %>% str_split(pattern = "\\.") %>% transpose()
    #
    # temp$Experiment <- unlist(new_labels[[1]])
    # temp$Inj_Cell <- unlist(new_labels[[2]])

    temp <- temp %>%
      dplyr::select(Experiment, Inj_Cell, DV) %>%
      dplyr::filter(!is.na(DV)) %>%
      spread(Inj_Cell, DV) %>%
      dplyr::filter(!is.na(LC4)) %>%
      dplyr::filter(!is.na(LC5)) %>%
      gather(Inj_Cell, DV, c("LC4", "LC5"))

    temp$DV <- sample(temp$DV)

    temp %>%
      spread(Inj_Cell, DV) %>%
      mutate(DV_Diff = LC4-LC5) %>%
      mutate(iter = i, real = F) %>%
      dplyr::select(Experiment, DV_Diff, iter, real)
  })

  compare_diffs <- rbind(real_diffs, do.call(rbind, fake_diffs))

  plt_a <-
    compare_diffs %>%
    ggplot(aes(x = DV_Diff, fill = real, color = real))+
    geom_vline(xintercept = 0, linetype = "dashed")+
    geom_density(alpha = 0.5)+
    labs(title =  current_DV, x = "", y = "")+
    theme(legend.position = "bottom")

  plt_b <-
    compare_diffs %>%
    ggplot(aes(x = DV_Diff, color = real))+
    stat_ecdf()+
    labs(title =  current_DV, x = "", y = "")+
    theme(legend.position = "bottom")

  # plt  <- plt_a + plt_b
  # return(plt)
  return(list(plt_a, plt_b))
})



similarity_plts2[[8]] <- list(NA, NA)


similarity_plts2 <- transpose(similarity_plts2)

ggsave(cowplot::plot_grid(plotlist = similarity_plts2[[1]], ncol = 4), path = here("data", "figures"),
filename = paste("DJS_LC_Similarity_density.tiff", sep = ""),
width = 12, height = 12
)

ggsave(cowplot::plot_grid(plotlist = similarity_plts2[[2]], ncol = 4), path = here("data", "figures"),
filename = paste("DJS_LC_Similarity_ecdf.tiff", sep = ""),
width = 12, height = 12
)

# ggsave(cowplot::plot_grid(plotlist = list(
#   similarity_plts2[[1]],
#   similarity_plts2[[2]],
#   similarity_plts2[[3]],
#   similarity_plts2[[4]],
#   similarity_plts2[[5]],
#   similarity_plts2[[6]],
#   similarity_plts2[[7]],
#   NA,
#   similarity_plts2[[8]],
#   similarity_plts2[[9]],
#   similarity_plts2[[10]],
#   similarity_plts2[[11]],
#   similarity_plts2[[12]],
#   similarity_plts2[[13]],
#   similarity_plts2[[14]],
#   similarity_plts2[[15]],
#   similarity_plts2[[16]]
# ), ncol = 4), path = here("data", "figures"),
# filename = paste("DJS_LC_Similarity_ecdf.tiff", sep = ""),
# width = 12, height = 12
#
# )






```

### What are the relationships between the trajectories?
```{r}
df <- M.clean[M.clean$Condition %in% c("PS.0.High.Amp", "PS.22", "PS.45", "PS.0", "PS.22.High.Amp", "PS.90", "PS.90.HA", "PS.90.HA.Cd"), ]

# current_DV <- "intercept.peak_htk"


dvs_for_delta <- c("r11", "r12", "r1", "rc", "cc", "rmp", "gj",
               "intercept.peak_htk", "slope.peak_htk", "intercept.end_htk", "slope.end_htk", "intercept.peak_a", "slope.peak_a", "intercept.end_a", "slope.end_a")

temp_delta_list <- map(
  dvs_for_delta, function(current_DV){
      temp_df <- df
      temp_df$DV <- temp_df[[current_DV]]

      temp_df <- temp_df %>%
        dplyr::select(Condition, Experiment, Inj_Cell, Time, DV) %>%
        group_by(Condition, Experiment, Inj_Cell, Time) %>%
        summarise(DV = mean(DV, na.rm = T)) %>%
        ungroup() %>%
        # mutate(Time = as.character(Time)) %>%
        pivot_wider(names_from = Time, values_from = DV) %>%
        mutate(`20` = `20` - `0`,
               `40` = `40` - `0`,
               `60` = `60` - `0`) %>%
        mutate(`0` = 0) %>%
        pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "DV") %>%
        group_by(Condition, Time) #%>%
        # mutate(mean_DV = mean(DV, na.rm = T),
        #        mean_sd_up = mean_DV+sd(DV, na.rm = T),
        #        mean_sd_dn =mean_DV- sd(DV, na.rm = T),) %>%
        # mutate(inter = paste(Experiment, Inj_Cell, sep = ".")) %>%
        # ggplot(aes(x = Time,
        #            y = DV,
        #            # color = Experiment,
        #            # shape = Inj_Cell,
        #            group = inter))+
        # geom_ribbon(aes(ymin=mean_sd_dn, ymax=mean_sd_up), fill = "gray", alpha = 0.1)+
        # lemon::geom_pointline(size = point.size, linesize = line.size)+
        # geom_point(size = point.size)+
        # geom_point(aes(x = Time, y = mean_DV), color = "white", size = mean.point.size, alpha = 0.3)+
        # geom_pointline(aes(x = Time, y = mean_DV), color = "firebrick", size = mean.point.size, linesize = mean.line.size,  shape = 1)+
        # # labs(y = expression(paste(Delta, "Rc", " in M", Omega)), x = "Time in Minutes")+
        # facet_grid(.~Condition,
        #            labeller = labeller(Condition = condition.labs))+
        # geom_hline(yintercept = 0)+
        # theme(
        #   # axis.text = element_text(size = rel(2), angle = 0),
        #   text = element_text(size=text.size)
        # )+
        # labs(title = current_DV)

      names(temp_df)[names(temp_df) == "DV"] <- current_DV

      return(temp_df)
    })

#

df2 <- temp_delta_list[[1]]
for (i in seq(2, length(temp_delta_list))){
  df2 <- full_join(df2, temp_delta_list[[i]])
}

plt1 <-
df2 %>% filter(Time %in% c(40)) %>%
  dplyr::filter(!(Condition %in% c("PS.90.HA", "PS.90.HA.Cd"))) %>%
  gather(Current, Value, c("intercept.peak_htk", "intercept.end_htk", "intercept.peak_a", "intercept.end_a"#,
                           # "slope.peak_htk", "slope.end_htk", "slope.peak_a", "slope.end_a"
                           )) %>%
  ggplot(aes(gj, Value, color = Condition, fill = Condition))+
  geom_hline(yintercept = 0, color = "darkgrey")+
  geom_vline(xintercept = 0, color = "darkgrey")+
  # geom_smooth(method = "lm", se = T, fullrange = T)+
  geom_point()+
  geom_point(shape = 1, color = "black")+
  facet_grid(Current~Condition)+
  # facet_wrap(Current~Condition, scales = "free")+
  theme(legend.position = "")+
  coord_cartesian(y = c(-100, 100))

plt2 <-
df2 %>% filter(Time %in% c(40)) %>%
  dplyr::filter(!(Condition %in% c("PS.90.HA", "PS.90.HA.Cd"))) %>%
  gather(Current, Value, c(#"intercept.peak_htk", "intercept.end_htk", "intercept.peak_a", "intercept.end_a",
                           "slope.peak_htk", "slope.end_htk", "slope.peak_a", "slope.end_a"
                           )) %>%
  ggplot(aes(gj, Value, color = Condition, fill = Condition))+
  geom_hline(yintercept = 0, color = "darkgrey")+
  geom_vline(xintercept = 0, color = "darkgrey")+
  # geom_smooth(method = "lm", se = T, fullrange = T)+
  geom_point()+
  geom_point(shape = 1, color = "black")+
  facet_grid(Current~Condition)+
  # facet_wrap(Current~Condition, scales = "free")+
  theme(legend.position = "")





plt1 + plt2
```







# Reorganizing alternate predictors for naturalistic stim
```{r}
library(tidyverse)
library(zoo)

# Really just a wrapper for loadABF()
readABF_as_matrix <- function(
  path = "",
  channels = c("IN 4", "IN 9")){

  trace <- readABF::readABF(file = path)

  start.time <- trace$header$recTime[1]
  end.time <- trace$header$recTime[2]
  obs <- nrow(trace$data[[1]])

  temp <- trace$data[[1]][, (trace$channelNames %in% channels)]
  temp <- as.matrix(temp)

  colnames(temp) <- trace$channelNames[trace$channelNames %in% channels]
  temp <- cbind(temp, Time = seq(from = start.time,
                                 to = end.time,
                                 length.out = obs))

  return(temp)
}



# traces %>% stringr::str_detect(pattern = ".abf")
#
# traces %>% stringr::str_detect(pattern = ".atf")
# traces %>% stringr::str_detect(pattern = ".ATF")
#
#
# abf_version <- readABF_as_matrix(path = here("inst", "extdata", "orig_waveforms", "180717a_0013.abf"),
#                                  channels = c("IN 4", "IN 9"))
#
# head(abf_version)

# atf_version <- read.table(here("inst", "extdata", "orig_waveforms", "HA_90.ATF"))
#
# head(atf_version)

# traces <- map(c("180221_0029", "180308_0013", "180425_0017", "180510_0034", "180604_0009", "190408_0026", "191209_0011"), function(i){


```

```{r}
traces <- list.files(here::here("inst", "extdata", "orig_waveforms"))

## load in traces, make them into dfs, and give them names equal to their file names ====
stim <- map(traces, function(i){
  readABF_as_matrix(
  path = paste0(here::here("inst", "extdata", "orig_waveforms"), "/", i),
  channels = c("IN 4", "IN 9"))
})
names(stim) <- traces
stim <- plyr::ldply(stim, data.frame)
stim <- rename(stim, Trace = .id)

## find the start time for each trace and adjust the mime of each so all begin at 0 ====
min.times <- stim %>% group_by(Trace) %>% summarise(min(Time))

stim$min.time <- NA
walk(seq(from = 1, to = nrow(min.times)),
     function(i){
       stim[stim$Trace == as.character(min.times[i, "Trace"]), "min.time"] <<- as.numeric(min.times[i, 2])
     })

stim <- stim %>% mutate(Time = Time - min.time) %>% gather(Ch, mV, c("IN.4", "IN.9"))

## Remove any artifacts ====
#large artifact in 180717a_0013.abf between 4.918, 4.926. Replace with values at 4.918
# replace.vals <- stim %>% ungroup() %>% filter(Trace == "180717a_0013.abf", Time == 0) %>% group_by(Ch)
stim[stim$Trace == "180717a_0013.abf" & (stim$Time > 4.918 & stim$Time < 4.926), "mV"] <- -56.0


## Smooth ====
stim <- stim %>%
  ungroup() %>%
  group_by(Trace, Ch) %>%
  mutate(mV.f = zoo::rollmean(x = mV, k = 5, fill = "extend")) %>%
  mutate(ID = paste(Ch, Trace)) %>%
  ungroup()


### The diversity of traces used ####
# stim %>%
#   # filter(Trace == "180717a_0013.abf") %>%
#   ggplot(aes(Time, mV.f, group = ID, color = Trace))+
#   geom_line(alpha = 0.6)+
#   facet_grid(.~Ch)+
#   theme(legend.position = "")


# See the standardized protocols to pair them with ####
# "180221_0029.abf", "TEA sync",
# "180308_0013.abf", "b",
# "180425_0017.abf", "c",
# "180510_0034.abf", "a",
# "180604_0009.abf", "TEA async",
# "190408_0026.abf", "d",
# "191209_0011.abf", "HA 90"

# stim[stim$Trace %in% c("180221_0029.abf",
#                        "180308_0013.abf",
#                        "180425_0017.abf",
#                        "180510_0034.abf",
#                        "180604_0009.abf",
#                        "190408_0026.abf",
#                        "191209_0011.abf"),  ] %>%
#   ggplot(aes(Time, mV.f, group = ID, color = Ch))+
#   geom_line(alpha = 0.6)+
#   facet_grid(Trace~.)+
#   theme(legend.position = "")




one.trace <- stim %>%
  # filter(Trace %in% c("170710_0037.abf", "180718a_0009.abf")) %>% #FIXME When ready, remove to put all through
  dplyr::select(-min.time,  -ID, -mV) %>%
  spread(Ch, mV.f)


### Once again, lots of crazy variation ####
# one.trace %>% ggplot(aes(group = Trace))+
#   geom_line(aes(x = Time, y = IN.4), color = "Steelblue")+
#   geom_line(aes(x = Time, y = IN.9), color = "Firebrick")


### We can see the overlap/lack of same here. We should get a unity line when there is no differnce in the stimulus.
# one.trace %>% ggplot()+
#   geom_path(aes(x = IN.4, y = IN.9, color = Time))


```

For summary plot later
```{r}
plt.trace.variation <- one.trace



```



```{r}
# First pass at annotation ----

# one.trace %>% ggplot()+
#   geom_line(aes(x = Time, y = IN.4), color = "Steelblue")+
#   geom_line(aes(x = Time, y = IN.9), color = "Firebrick")+
#   geom_hline(yintercept = min(one.trace$IN.4, na.rm = T), color = "Steelblue")+
#   geom_hline(yintercept = min(one.trace$IN.9, na.rm = T), color = "Firebrick")


# one.trace %>%
#   # Voltage difference
#   mutate(diff = IN.4 - IN.9) %>% # Not really useful atm
#   mutate(intersect.V = ifelse( # lower of the two, used for overlap
#     IN.4 <= IN.9,
#     IN.4, IN.9
#     )
#     ) %>%
#     mutate(union.V = ifelse( # Higher of the two.
#     IN.4 >= IN.9,
#     IN.4, IN.9
#     )
#     ) %>%
#   mutate(higher.V.min = ifelse(
#     min(one.trace$IN.4, na.rm = T) >= min(one.trace$IN.9, na.rm = T),
#      min(one.trace$IN.4, na.rm = T),
#      min(one.trace$IN.9, na.rm = T)
#   )) %>%
#   mutate(Overlap.V =  intersect.V - higher.V.min) %>%
#   ggplot()+
#   geom_line(aes(x = Time, y = Overlap.V))+
#   geom_ribbon(aes(x = Time, ymin=min(Overlap.V), ymax=Overlap.V))+
#   geom_line(aes(x = Time, y = IN.4 - min(one.trace$IN.4, na.rm = T)),
#             color = "Steelblue",
#             size = 1)+
#   geom_line(aes(x = Time, y = IN.9 - min(one.trace$IN.9, na.rm = T)),
#             color = "Firebrick",
#             size = 1)

# geom_line(aes(x = Time, y = IN.4), color = "Steelblue")+
# geom_line(aes(x = Time, y = IN.9), color = "Firebrick")
# geom_hline(yintercept = min(one.trace$IN.4, na.rm = T), color = "Steelblue")+
# geom_hline(yintercept = min(one.trace$IN.9, na.rm = T), color = "Firebrick")

# geom_line(aes(x = Time, y = IN.4 - min(one.trace$IN.4, na.rm = T)), color = "Steelblue")+
# geom_line(aes(x = Time, y = IN.9 - min(one.trace$IN.9, na.rm = T)), color = "Firebrick")+
# geom_line(aes(x = Time, y = diff))

# Second pass at annotation ----

## Group by trace and add possible predictors to it ====

### min, baseline, max, median, and mean mV, and duration (period) ####
one.trace <-
  one.trace %>%
  ungroup() %>%
  gather(Ch, mV, c("IN.4", "IN.9")) %>%
  group_by(Trace, Ch) %>%
  # Min Voltage
  mutate(Min.V = min(mV, na.rm = T)) %>%
  # Baseline voltage
  # Defining as average of the lowest 20% of points
  mutate(Use.in.Base = quantile(mV, probs = .2, na.rm = T)) %>%
  mutate(Use.in.Base = ifelse(mV <= Use.in.Base,
    mV,
    NA
  )) %>%
  mutate(Use.in.Base = mean(Use.in.Base, na.rm = T)) %>%
  # Max voltage
  mutate(Max.V = max(mV, na.rm = T)) %>%
  # Median Voltage
  mutate(Med.V = median(mV, na.rm = T)) %>%
  # Mean Voltage
  mutate(Mean.V = mean(mV, na.rm = T)) %>%
  # Duration
  mutate(Max.Time = max(Time, na.rm = T))

### Delay between channels ####
# Get time at which voltage traces cross a threshold. Then compute the abs(difference)
delays.to.annotate <- one.trace %>%
  mutate(Delay = (mV >= quantile(mV, probs = .9, na.rm = T))) %>%
  filter(Delay == T) %>%
  summarise(
    Thres.Time.b = min(Time, na.rm = T),
    Thres.Time.e = max(Time, na.rm = T)
  )

one.trace$Onset <- NA
one.trace$Termination <- NA
walk(seq(1, nrow(delays.to.annotate)), function(i) {
  one.trace[
    one.trace$Trace == as.character(delays.to.annotate[i, "Trace"]) &
      one.trace$Ch == as.character(delays.to.annotate[i, "Ch"]),
    "Onset"
  ] <<- as.numeric(delays.to.annotate[i, "Thres.Time.b"])

  one.trace[
    one.trace$Trace == as.character(delays.to.annotate[i, "Trace"]) &
      one.trace$Ch == as.character(delays.to.annotate[i, "Ch"]),
    "Termination"
  ] <<- as.numeric(delays.to.annotate[i, "Thres.Time.e"])
})

### Add in On duration, Duty Cycle, and AUC ####
one.trace <- one.trace %>%
  # On duration
  mutate(On.Duration = Termination - Onset) %>%
  # Duty Cycle
  mutate(Duty.Cycle = On.Duration / Max.Time) %>%
  # AUC
  # Using Min.V
  mutate(AUC = (mV - Min.V))


## make a list with more user friendly names ====

# Each elemen tof the list consists of only one channel.
one.trace.list <- map(c("IN.4", "IN.9"), function(i) {
  temp <- filter(one.trace, Ch == i)

  temp.names <- names(temp)

  temp.names[!(temp.names %in% c("Trace", "Time", "Ch"))] <-
    paste(temp.names[!(temp.names %in% c("Trace", "Time", "Ch"))], i, sep = "_")

  names(temp) <- temp.names

  temp %>% ungroup()

  return(temp)
})

# put the channels back together
one.trace <- full_join(
  one.trace.list[[1]],
  one.trace.list[[2]],
  by = c("Trace", "Time")
)


##add in delay for each channel (if it starts first it's 0), percent delay, corrlation between channels, and intersectional overlap between channels ====
one.trace <- one.trace %>%
  dplyr::group_by(Trace) %>%
  # Delay
  mutate(Delay_IN.4 = ifelse(
    Onset_IN.4 <= Onset_IN.9,
    0,
    Onset_IN.4 - Onset_IN.9
  )) %>%
  mutate(Delay_IN.9 = ifelse(
    Onset_IN.9 <= Onset_IN.4,
    0,
    Onset_IN.9 - Onset_IN.4
  )) %>%
  # Percent Delay (can be converted into phase)
  mutate(P.Delay_IN.4 = Delay_IN.4 / Max.Time_IN.4) %>%
  mutate(P.Delay_IN.9 = Delay_IN.9 / Max.Time_IN.9) %>%
  # Correlation
  mutate(Cor = cor(mV_IN.4, mV_IN.9,
    use = "pairwise.complete.obs",
    method = "pearson"
  )) %>%
  # intersect AUC / % overlap
  mutate(Min.AUC = ifelse(AUC_IN.4 <= AUC_IN.9,
    AUC_IN.4,
    AUC_IN.9
  ))


## show that min AUC is acting as expected ====
# one.trace %>%
#   ggplot(aes(group = Trace)) +
#   geom_line(aes(x = Time, y = mV_IN.4 - Min.V_IN.4), color = "Blue", alpha = 0.4) +
#   geom_line(aes(x = Time, y = mV_IN.9 - Min.V_IN.9), color = "Red", alpha = 0.4) +
#   geom_line(aes(x = Time, y = Min.AUC), color = "Purple") +
#   facet_grid(. ~ Trace)
```


```{r}
## Get summary of all ====

# 1. Get single value descriptors for each trace
one.trace  <- one.trace %>%
  ungroup() %>%
  dplyr::group_by(Trace) %>%
  # Voltages
  mutate(Mean.Min.V = mean(mean(Min.V_IN.4, na.rm = T), mean(Min.V_IN.9, na.rm = T))) %>%
  mutate(Mean.Max.V = mean(mean(Max.V_IN.4, na.rm = T), mean(Max.V_IN.9, na.rm = T))) %>%
  mutate(Mean.Med.V = mean(mean(Med.V_IN.4, na.rm = T), mean(Med.V_IN.9, na.rm = T))) %>%
  mutate(Mean.Mean.V = mean(mean(Mean.V_IN.4, na.rm = T), mean(Mean.V_IN.9, na.rm = T))) %>%

  # Times
  mutate(Mean.Duration = mean(mean(Max.Time_IN.4, na.rm = T), mean(Max.Time_IN.9, na.rm = T))) %>%
  mutate(Mean.On.Duration = mean(mean(On.Duration_IN.4, na.rm = T), mean(On.Duration_IN.9, na.rm = T))) %>%
  mutate(Mean.Duty.Cycle = mean(mean(Duty.Cycle_IN.4, na.rm = T), mean(Duty.Cycle_IN.9, na.rm = T))) %>%

  mutate(Onset.Delay = max(Delay_IN.4, Delay_IN.9, na.rm = T)) %>%
  mutate(P.Onset.Delay = max(P.Delay_IN.4, P.Delay_IN.9, na.rm = T)) %>%

  # AUCs -- convert to single value of mV/trace
  mutate(Mean.AUC = mean(sum(AUC_IN.4, na.rm = T), sum(AUC_IN.9, na.rm = T))) %>%
  mutate(Min.AUC = sum(Min.AUC, na.rm = T)) %>%
  ## and mV/S
  mutate(Mean.AUC.mV.S = Mean.AUC/Mean.Duration) %>%
  mutate(Min.AUC.mV.S = Min.AUC/Mean.Duration) %>%

  # Clean up selection
  dplyr::select(Trace, #Time,
                Mean.Min.V, Mean.Max.V, Mean.Med.V, Mean.Mean.V,
                Mean.Duration, Mean.On.Duration, Mean.Duty.Cycle,
                Onset.Delay, P.Onset.Delay,
                Mean.AUC, Min.AUC,
                Mean.AUC.mV.S, Min.AUC.mV.S,
                Cor) %>% ungroup()

# 2. Remove the duplicate measures.
one.trace <- one.trace[!(duplicated(one.trace)), ]

# 3. Join with gj change datasets
## get the OG dataset ====
# Orig <- M.clean %>%
Orig <- M.d %>%
  dplyr::filter(Condition %in% c("PS.0.orig",
                                 "PS.22.orig",
                                 "PS.45.orig",
                                 "PS.90.orig",
                                 "PS.180.orig"))
Orig.exps <- Orig$Experiment %>% unique()

## get the standardized dataset ====
Standard <- M.d %>%
  dplyr::filter(Condition %in% c("PS.0.High.Amp",
                                 "PS.22.High.Amp",
                                 "PS.90.HA",
                                 "PS.0",
                                 "PS.22",
                                 "PS.45",
                                 "PS.90"))

## Make trace names join-able ====
new.Trace.names <- stringr::str_split(one.trace$Trace, pattern = "_0") %>%
  map(function(i){
    pluck(i,1)
  }) %>% unlist()

# Manually fix two
# Orig.exps[!(Orig.exps %in% new.Trace.names)]
# new.Trace.names[!(new.Trace.names %in% Orig.exps)]
new.Trace.names[new.Trace.names == "171016_B"] <- "171016"
new.Trace.names[new.Trace.names == "171017_A"] <- "171017"

one.trace <- one.trace %>% mutate(Experiment = new.Trace.names)


## Produce New Datasets ====
one.trace.orig <- one.trace[!(one.trace$Trace %in%
                                c("180221_0029.abf",
                                  "180308_0013.abf",
                                  "180425_0017.abf",
                                  "180510_0034.abf",
                                  "180604_0009.abf",
                                  "190408_0026.abf",
                                  "191209_0011.abf")), ]

one.trace.standard <- one.trace[one.trace$Trace %in%
                                  c("180221_0029.abf",
                                    "180308_0013.abf",
                                    "180425_0017.abf",
                                    "180510_0034.abf",
                                    "180604_0009.abf",
                                    "190408_0026.abf",
                                    "191209_0011.abf"), ]

one.trace.standard$Condition <- NA
one.trace.standard[one.trace.standard$Trace == "180221_0029.abf", "Condition"] <- "PS.0.High.Amp"
one.trace.standard[one.trace.standard$Trace == "180308_0013.abf", "Condition"] <- "PS.22"
one.trace.standard[one.trace.standard$Trace == "180425_0017.abf", "Condition"] <- "PS.45"
one.trace.standard[one.trace.standard$Trace == "180510_0034.abf", "Condition"] <- "PS.0"
one.trace.standard[one.trace.standard$Trace == "180604_0009.abf", "Condition"] <- "PS.22.High.Amp"
one.trace.standard[one.trace.standard$Trace == "190408_0026.abf", "Condition"] <- "PS.90"
one.trace.standard[one.trace.standard$Trace == "191209_0011.abf", "Condition"] <- "PS.90.HA"



Orig <- full_join(Orig, one.trace.orig, by = "Experiment")

Standard <- full_join(Standard, one.trace.standard, by = "Condition")
```

Version 1 of the figure displaying individualized data.

```{r}
# plt.trace.variation <- plt.trace.variation[plt.trace.variation$Trace %in% unique(plt.trace.variation$Trace)[c(1,2,4,11,14,#17,19,
#                                                                                                               20,21,26)], ]


plt.trace.variation <- plt.trace.variation[!(plt.trace.variation$Trace %in%
                                c("180221_0029.abf",
                                  "180308_0013.abf",
                                  "180425_0017.abf",
                                  "180510_0034.abf",
                                  "180604_0009.abf",
                                  "190408_0026.abf",
                                  "191209_0011.abf")),]

# Add in labels for facetting
temp <- Orig %>% dplyr::select(Condition, Experiment#, Mean.Duration, Mean.On.Duration
                               ) %>% rename(Trace = Experiment) %>% distinct()



# which experiments use the same stim protocol?
temp1 <- left_join(mutate(plt.trace.variation, Trace = unlist(transpose(str_split(plt.trace.variation$Trace, "_"))[[1]]) ) , temp) %>% dplyr::select(-Condition)

temp1 %>%
  group_by(Trace) %>%
  summarise(Duration = max(Time)) %>% arrange(Duration)

#     Trace   Duration
# 1	  170623b	2.799864

# 2	  170803b	3.165165

# 3	  170825a	3.200130
# 4	  170925A	3.200130

# 5	  170705a	3.240090
# 6  	170710	3.240090
# 7  	170711e	3.240090

# 8	  170814b	4.300029

# 9	  170808a	4.399929
# 10	170808b	4.399929
# 11	170811	4.399929
# 12	171016	4.399929
# 13	171017	4.399929
# 14	171201	4.399929

# 15	180717a	5.000000

# 16	170828a	5.200128
# 17	180717	5.200128

# 18	170728a	5.435892
# 19	170801a	5.435892
# 20	170802a	5.435892
# 21	170803a	5.435892

# 22	180718	5.660000
# 23	180718a	5.660000

# 24	170817b	5.900094

# 25	170713b	6.216777

# 26	170824a	9.300024



temp1 %>%
  filter(Trace %in% c(
    # "170623b", "170803b",
    # "170825a", "170925A", #same stim
    # "170705a", "170710", #same stim
                 "170711e",

    # "170814b",
    # "170808a", "170808b",  "170811",  # Same Stim
                 "171016",  "171017",  "171201" #(171016 and 171201 look to be the same but the clamp on the latter is much worse -- unlikely that it acts as the same stim. Code it as a separate variable?)
    # "180717a",
    # "170828a", "180717"  # Same Stim
    # "170728a", "170801a", "170802a", "170803a", #same stim
    # "180718",  "180718a"#same stim
    # "170817b", "170713b", "170824a"
  )) %>%
  group_by(Trace) %>%
  mutate(Duration = round(max(Time), digits = 2)) %>%
  gather(key = Ch, value = mV, c("IN.4", "IN.9")) %>%
  ggplot()+
  geom_line(aes(x = Time, y = mV, group = Trace, color = as.character(Duration)))+
  facet_grid(Trace~Ch)+
  theme(legend.position = "")



```

First test of showing individualized phase
```{r}
# denomerator <- 16
for (denomerator in c(16, 8, 4, 2)){

temp2 <- left_join(mutate(plt.trace.variation, Trace = unlist(transpose(str_split(plt.trace.variation$Trace, "_"))[[1]]) ) , temp)

# time.tol <- 0.01
# temp2[(temp2$Mean.Duration > 3.24-time.tol & temp2$Mean.Duration < 3.24+time.tol) |
#         (temp2$Mean.Duration > 5.900094-time.tol & temp2$Mean.Duration < 5.900094+time.tol) |
#         (temp2$Mean.Duration > 9.300024-time.tol & temp2$Mean.Duration < 9.300024+time.tol), ] %>%

temp2 <- temp2 %>% dplyr::filter(Trace %in% c("170711e", "170817b")) %>% dplyr::select(-IN.4)




temp2 <- temp2 %>%
  group_by(Trace) %>%
  mutate(IN.9 = IN.9 - min(IN.9, na.rm = T)) %>%
  # mutate(mV2 = mV - max(mV, na.rm = T)) %>%
  mutate(ShiftSec = max(Time, na.rm = T)/denomerator) %>%
  mutate(Time2 = ifelse(Time < max(Time, na.rm = T)-ShiftSec, Time+ShiftSec, Time-(max(Time, na.rm = T)-ShiftSec)) )

# temp2[temp2$Trace == "170817b", "mV2"] <- temp2[temp2$Trace == "170817b", "mV2"] + min(temp2[temp2$Trace == "170711e", "mV2"], na.rm = T)
# temp2[temp2$Trace == "170817b", "mV"] <- temp2[temp2$Trace == "170817b", "mV2"] + min(temp2[temp2$Trace == "170711e", "mV2"], na.rm = T)


X.shift <- (1.57 -0.355)

ggplot(temp2)+
  geom_line(data = temp2[temp2$Trace == "170711e",], aes(x = Time + X.shift, y = IN.9, group = Trace))+
  geom_line(data = temp2[temp2$Trace == "170711e",], aes(x = Time2 + X.shift, y = IN.9-10, group = Trace))+
  geom_line(data = temp2[temp2$Trace == "170817b",], aes(x = Time, y = IN.9-20, group = Trace))+
  geom_line(data = temp2[temp2$Trace == "170817b",], aes(x = Time2, y = IN.9-30, group = Trace))+
  geom_segment(aes(x = 0, xend = 1, y = -30, yend = -30), size = 1)+
  geom_segment(aes(x = 0, xend = 0, y = -30, yend = -25), size = 1)+
    # geom_vline(xintercept = 1.56)+
  geom_segment(aes(x = 1.56, xend = 1.56+0.2025056, y = 10, yend = 10), size = 1, color = "cornflowerblue")+
  geom_segment(aes(x = 1.56, xend = 1.56+0.3687559 , y = -10, yend = -10), size = 1, color = "cornflowerblue")+
  theme_void()

ggsave(here("data", "figures", as.character(paste0("individual_pro_", as.character(round(360/denomerator, digits = 2)), "_v1.pdf"))),
       width = 8.79, height = 7.21)

ggsave(here("data", "figures", as.character(paste0("individual_pro_", as.character(round(360/denomerator, digits = 2)), "_v1.svg"))),
       width = 8.79, height = 7.21)
}
```


Second test
```{r}
# Use fraction shift


temp3 <- left_join(mutate(plt.trace.variation, Trace = unlist(transpose(str_split(plt.trace.variation$Trace, "_"))[[1]]) ) , temp)


#   Trace mtime
# 1	170623b	2.799864
# 2	170803b	3.165165
# 3	170825a	3.200130
# 4	170925A	3.200130
# 5	170705a	3.240090
# 6	170710	3.240090
# 7	170711e	3.240090
# 8	170814b	4.300029
# 9	170808a	4.399929
# 10	170808b	4.399929
# 11	170811	4.399929
# 12	171016	4.399929
# 13	171017	4.399929
# 14	171201	4.399929
# 15	180717a	5.000000
# 16	170828a	5.200128
# 17	180717	5.200128
# 18	170728a	5.435892
# 19	170801a	5.435892
# 20	170802a	5.435892
# 21	170803a	5.435892
# 22	180718	5.660000
# 23	180718a	5.660000
# 24	170817b	5.900094
# 25	170713b	6.216777
# 26	170824a	9.300024

temp3 <- temp3 %>% dplyr::filter(Trace %in% c("170711e", "170814b", "180718a", "170817b")) %>% dplyr::select(-IN.4)

temp3$Trace <- factor(temp3$Trace, level = c("170711e", "170814b", "180718a", "170817b"))


# denomerator <- 16

for (denomerator in c(16, 8, 4, 2)){

temp3 <- temp3 %>%
  group_by(Trace) %>%
  mutate(IN.9 = IN.9 - min(IN.9, na.rm = T)) %>%
  # mutate(mV2 = mV - max(mV, na.rm = T)) %>%
  mutate(ShiftSec = max(Time, na.rm = T)/denomerator) %>%
  mutate(Time2 = ifelse(Time < max(Time, na.rm = T)-ShiftSec, Time+ShiftSec, Time-(max(Time, na.rm = T)-ShiftSec)) ) %>%
  ungroup() %>%
  mutate(shift_down = max(IN.9, na.rm = T)) %>%
  mutate(numeric_fac = as.numeric(as.factor(Trace))) %>%
  mutate(mV = IN.9 - (((numeric_fac-1) * 2) * shift_down) - shift_down ) %>%
  mutate(mV2 = IN.9 - ((numeric_fac-1) * 2) * shift_down)


annotation_df <- temp3 %>%
  group_by(Trace, ShiftSec, numeric_fac) %>%
  summarise(#mV_max = max(mV, na.rm = T),
            mV_min = min(mV, na.rm = T)#,
            # mV2_max = max(mV2, na.rm = T)#,
            #mV2_min = min(mV2, na.rm = T)
            ) %>%
  ungroup() %>%
  mutate(ShiftSec = round(ShiftSec, digits = 3))


tic <- Sys.time()
temp3 %>%
  ggplot()+
  geom_segment(data = annotation_df, aes(x = 0, xend = ShiftSec, y = mV_min, yend = mV_min), color = "cornflowerblue", size = 2)+
  geom_line(aes(x = Time, y = mV2, group = Trace))+
  geom_line(aes(x = Time2, y = mV, group = Trace))+
  geom_text(data = annotation_df,
            aes(x = 0.12, y = mV_min+2, label = ShiftSec, group = Trace),
            parse = T )+
  geom_path(data = data.frame(x = c(-0.1, -0.1, 0.9), y = c(-72, -82, -82)), aes(x = x, y = y))+
  # annotate("text", x = 0.12, y = 11, parse = TRUE, label = as.character(expression(paste(phi,
  #                                                                                        " = "
  #                                                                                        )
  #                                                                                  )
  #                                                                       )
  #          )+
  theme_void()

ggsave(here("data", "figures", as.character(paste0("individual_pro_", as.character(round(360/denomerator, digits = 2)), "_v2.pdf"))),
       width = 8.79, height = 7.21)

ggsave(here("data", "figures", as.character(paste0("individual_pro_", as.character(round(360/denomerator, digits = 2)), "_v2.svg"))),
       width = 8.79, height = 7.21)
}
```


PCA is now shelved.
```{r}

# temp <- Orig[, c(
#   "Time",
#   "r11", "r12", "r1", "rc", "cc", "rmp",
#   # "gj",
#   # "intercept.peak_htk", "slope.peak_htk", "intercept.end_htk", "slope.end_htk", "intercept.peak_a", "slope.peak_a", "intercept.end_a", "slope.end_a", "a.peak.nA", "htk.peak.nA",
#   # "inter", "Trace",
#   "Mean.Min.V", "Mean.Max.V", "Mean.Med.V", "Mean.Mean.V", "Mean.Duration", "Mean.On.Duration", "Mean.Duty.Cycle", "Onset.Delay", "P.Onset.Delay", "Mean.AUC", "Min.AUC", "Mean.AUC.mV.S", "Min.AUC.mV.S", "Cor"
# )] %>%
#   dplyr::filter(Time == 40) %>%
#   dplyr::select(-Time)
#
# library(factoextra)
# z <- prcomp(~., data = temp, center = TRUE, scale. = TRUE)
# fviz_screeplot(z, addlabels = TRUE, ylim = c(0, 50))
# fviz_pca_var(z, col.var="contrib",
#              gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
#              repel = TRUE # Avoid text overlapping
#              )
#
#
# ## Standardized protocols
# plt.list <- map(list(
#   c("PS.0.High.Amp", "PS.22.High.Amp", "PS.90.HA"),
#   c("PS.22", "PS.45", "PS.0", "PS.90"),
#   c("PS.0.High.Amp", "PS.22.High.Amp", "PS.90.HA", "PS.22", "PS.45", "PS.0", "PS.90")
# ), function(i){
#   temp <- Standard[Standard$Condition %in% i , c(
#     "Time",
#     "r11", "r12", "r1", "rc", "cc", "rmp",
#     # "gj",
#     # "intercept.peak_htk", "slope.peak_htk", "intercept.end_htk", "slope.end_htk", "intercept.peak_a", "slope.peak_a", "intercept.end_a", "slope.end_a", "a.peak.nA", "htk.peak.nA",
#     # "inter", "Trace",
#     "Mean.Min.V", "Mean.Max.V", "Mean.Med.V", "Mean.Mean.V", #"Mean.Duration",
#          "Mean.On.Duration", "Mean.Duty.Cycle", "Onset.Delay", "P.Onset.Delay", "Mean.AUC", "Min.AUC", "Mean.AUC.mV.S", "Min.AUC.mV.S", "Cor"
#   )] %>%
#     dplyr::filter(Time == 40) %>%
#     dplyr::select(-Time)
#
#   z <- prcomp(~., data = temp, center = TRUE, scale. = TRUE)
#   plt.scree <- fviz_screeplot(z, addlabels = TRUE#, ylim = c(0, 50)
#                               )
#   plt.biplt <- fviz_pca_var(z, col.var="contrib",
#                             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
#                             repel = TRUE # Avoid text overlapping
#   )
#
#   return(list(scree = plt.scree,
#               biplt = plt.biplt))
# })
#
#
# plt.list[[1]]$scree
# plt.list[[1]]$biplt
# plt.list[[2]]$scree
# plt.list[[2]]$biplt
# plt.list[[3]]$scree
# plt.list[[3]]$biplt
```



model comparison with "PS.22.orig"  "PS.0.orig"   "PS.180.orig" "PS.90.orig"  "PS.45.orig"
```{r}
# Make up a new data set so we can use the random formula we used above for nlme::lme
original.obs.clean <-M.clean[M.clean$Condition %in% unique(Orig$Condition),
                             c("Condition", "Experiment", "Time", "Inj_Cell", "inter", "rc")] %>%
  group_by(Condition, Experiment, Time) %>%
  dplyr::summarise(
    # Condition = Condition,
    # Experiment = Experiment,
    # Time = Time,
    rc = mean(rc, na.rm = T)) %>%
  dplyr::ungroup()


df <- full_join(original.obs.clean, one.trace.orig, by = "Experiment")

df <- df[!is.na(df$rc), ]




library(AICcmodavg)


df$Condition_Continuous <- NA
df[df$Condition == "PS.0.orig", "Condition_Continuous"] <- 0.0
df[df$Condition == "PS.22.orig", "Condition_Continuous"] <- 0.625
df[df$Condition == "PS.45.orig", "Condition_Continuous"] <- 0.125
df[df$Condition == "PS.90.orig", "Condition_Continuous"] <- 0.25
df[df$Condition == "PS.180.orig", "Condition_Continuous"] <- 0.5




mods <- list(
    nlme::lme(rc ~ Condition*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ Condition_Continuous*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ Mean.Min.V*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ Mean.Max.V*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ Mean.Med.V*Time, random = ~1 | Experiment, method = "ML", data = df),

    nlme::lme(rc ~ Mean.Mean.V*Time, random = ~1 | Experiment, method = "ML", data = df),
        #nlme::lme(rc ~ Mean.Duration*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ Mean.On.Duration*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ Mean.Duty.Cycle*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ Onset.Delay*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ P.Onset.Delay*Time, random = ~1 | Experiment, method = "ML", data = df),

    nlme::lme(rc ~ Mean.AUC*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ Min.AUC*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ Mean.AUC.mV.S*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ Min.AUC.mV.S*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ Cor*Time, random = ~1 | Experiment, method = "ML", data = df)
  )

mod.compare.orig <- aictab(
  cand.set = mods
)

mod.compare.orig



# df$Condition <- as.factor(df$Condition)
# anova(mod <- lme(rc ~ Condition*Time, random=~1|Experiment, data=df, method="ML",na.action=na.omit))
# glht(mod, linfct=mcp(Condition="Tukey"))
#
# glht(anova.lme(mods[[11]]), linfct=mcp(Mean.AUC="Tukey"))


# anova(mods[[11]],
#       mods[[4]],
#       mods[[1]])

```

figure to answer djs question about the interacton of stimulus protocol and phase
```{r}
# hard code the protocols that correspond to each trace as a col.
Stim_Trace_Pairs <- tibble::tribble(
     ~Trace, ~Duration,  ~StimId,
  "170623b",  2.799864,      "a",
  "170803b",  3.165165,      "b",
  "170825a",   3.20013,      "c",
  "170925A",   3.20013,      "c",
  "170705a",   3.24009,      "d",
   "170710",   3.24009,      "d",
  "170711e",   3.24009,      "e",
  "170814b",  4.300029,      "f",
  "170808a",  4.399929,      "g",
  "170808b",  4.399929,      "g",
   "170811",  4.399929,      "g",
   "171016",  4.399929,      "h",
   "171017",  4.399929,      "i",
   "171201",  4.399929, "hprime",
  "180717a",         5,      "j",
  "170828a",  5.200128,      "k",
   "180717",  5.200128,      "k",
  "170728a",  5.435892,      "l",
  "170801a",  5.435892,      "l",
  "170802a",  5.435892,      "l",
  "170803a",  5.435892,      "l",
   "180718",      5.66,      "m",
  "180718a",      5.66,      "m",
  "170817b",  5.900094,      "n",
  "170713b",  6.216777,      "o",
  "170824a",  9.300024,      "p"
  )
Stim_Trace_Pairs <- Stim_Trace_Pairs %>% dplyr::select(-Duration)

djs.temp <- df %>%
  dplyr::select(Experiment, Trace, Condition, Time, rc) %>%
  pivot_wider(names_from = Time, values_from = rc) %>%
  mutate(`20` = `20`-`0`) %>%
  mutate(`40` = `40`-`0`) %>%
  mutate(`60` = `60`-`0`) %>%
  mutate(`0` = `0`-`0`) %>%
  # group_by(Experiment) %>%
  pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "rc") %>%
  mutate(Change = ifelse(rc >= 0 , 1, -1))

# add in stim ids.
djs.temp <- full_join(rename(Stim_Trace_Pairs, Experiment = Trace), djs.temp)


#Create a data frame with the faceting variables
tp <- djs.temp %>% dplyr::select(Condition, Trace, Time, Change, StimId) %>% filter(Time == 60) %>% distinct()

# by experiment/trace
ggplot(djs.temp)+
  geom_rect(data = tp, aes(fill = as.factor(Change)),xmin = -Inf,xmax = Inf, ymin = -Inf,ymax = Inf,alpha = 0.3) +
  geom_hline(yintercept = 0, color = "cornflowerblue")+
  # geom_point(data = djs.temp[djs.temp$Time == 40, ], aes(color = Change))+
  geom_pointline(aes(x = Time, y = rc, group = Experiment), shape = 1, color = "black")+
  ylim(-2, 3.5)+
  facet_grid(Condition~Trace)+
  # facet_grid(Trace~Condition)+
  scale_fill_manual(values = c("Red", "Green"))+
  theme_base()+
  theme(legend.position = "")

# by stim id
tp2 <- tp %>% group_by(Condition, StimId) %>% mutate(Change = mean(Change)) %>% distinct() %>% ungroup()

ggplot(djs.temp)+
  geom_rect(data = tp2, aes(fill = Change),xmin = -Inf,xmax = Inf, ymin = -Inf,ymax = Inf,alpha = 0.3) +
  geom_hline(yintercept = 0, color = "cornflowerblue")+
  geom_pointline(aes(x = Time, y = rc, group = Experiment), shape = 1, color = "black")+
  ylim(-2, 3.5)+
  facet_grid(Condition~StimId)+
  # facet_grid(Trace~Condition)+
  # scale_fill_manual(values = c("Red", "Green"))+
  scale_fill_gradientn(colors = c("Red", "Grey", "Green"))+
  theme_base()+
  theme(legend.position = "")



ggplot(djs.temp)+
  # geom_rect(data = tp, aes(fill = Change),xmin = -Inf,xmax = Inf, ymin = -Inf,ymax = Inf,alpha = 0.3) +
  geom_hline(yintercept = 0, color = "cornflowerblue")+
  # geom_point(data = djs.temp[djs.temp$Time == 40, ], aes(color = Change))+
  geom_pointline(aes(x = Time, y = rc, group = Experiment), shape = 1, color = "black")+
  ylim(-2, 3.5)+
  facet_grid(.~Condition)+
  scale_color_manual(values = c("Red", "Green"))+
  theme_base()+
  theme(legend.position = "")







```



Model comparison with  "PS.90.HA", "PS.22", "PS.45", "PS.0", "PS.90"
```{r}
# Make up a new data set so we can use the random formula we used above for nlme::lme
low.obs.clean <- M.clean[M.clean$Condition %in% c("PS.22", "PS.45", "PS.0", "PS.90"),
                             c("Condition", "Experiment", "Time", "Inj_Cell", "inter", "rc")] %>%
  group_by(Condition, Experiment, Time) %>%
  dplyr::summarise(
    # Condition = Condition,
    # Experiment = Experiment,
    # Time = Time,
    rc = mean(rc, na.rm = T)) %>%
  dplyr::ungroup()


df <- full_join(low.obs.clean, rename(one.trace.standard, Stim.Source = Experiment), by = "Condition")

df <- df[!is.na(df$rc), ]

# Add continuous version
df$Condition_Continuous <- NA
df[df$Condition == "PS.0", "Condition_Continuous"] <- 0.0
df[df$Condition == "PS.22", "Condition_Continuous"] <- 0.625
df[df$Condition == "PS.45", "Condition_Continuous"] <- 0.125
df[df$Condition == "PS.90", "Condition_Continuous"] <- 0.25


mods.standard <- list(
    nlme::lme(rc ~ Condition*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ Condition_Continuous*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ Mean.Min.V*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ Mean.Max.V*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ Mean.Med.V*Time, random = ~1 | Experiment, method = "ML", data = df),

    nlme::lme(rc ~ Mean.Mean.V*Time, random = ~1 | Experiment, method = "ML", data = df),
      # nlme::lme(rc ~ Mean.Duration*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ Mean.On.Duration*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ Mean.Duty.Cycle*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ Onset.Delay*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ P.Onset.Delay*Time, random = ~1 | Experiment, method = "ML", data = df),

    nlme::lme(rc ~ Mean.AUC*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ Min.AUC*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ Mean.AUC.mV.S*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ Min.AUC.mV.S*Time, random = ~1 | Experiment, method = "ML", data = df),
    nlme::lme(rc ~ Cor*Time, random = ~1 | Experiment, method = "ML", data = df)
  )

mod.compare.standard <- aictab(
  cand.set = mods.standard
)
```

contrast the two aic tables
```{r}
#TODO

mod.compare.orig$data <- "original"
mod.compare.standard$data <- "standard"

M <- rbind(mod.compare.orig, mod.compare.standard)

M$Modnum <- as.numeric(stringr::str_remove(M$Modnames, "Mod"))

mod.predictors <- c("Condition",
  "Condition_Continuous",
  "Mean.Min.V",
  "Mean.Max.V",
  "Mean.Med.V",

  "Mean.Mean.V",
  # "Mean.Duration",
  "Mean.On.Duration",
  "Mean.Duty.Cycle",
  "Onset.Delay",
  "P.Onset.Delay",

  "Mean.AUC",
  "Min.AUC",
  "Mean.AUC.mV.S",
  "Min.AUC.mV.S",
  "Cor")

M$predictor <- NA

for (i in seq_along(mod.predictors)){
  M[M$Modnum == i, "predictor"] <- mod.predictors[i]

}
```


```{r}
# M %>%
#   ggplot(aes(x = data, y = AICc,
#              label = Modnames, group = Modnames,
#              color = data))+
#   geom_point()+
#   geom_line(color = "black")+
#   geom_text(data = M[M$data == "standard",], check_overlap = TRUE, position = "dodge")+
#   geom_text(data = M[M$data == "original",], check_overlap = TRUE, position = "dodge")


M %>%
  ggplot(aes(x = data, y = Delta_AICc,
             label = predictor, group = Modnames,
             color = data))+
  # geom_point()+
  geom_line(color = "black")+
  geom_text(data = M[M$data == "standard",], check_overlap = TRUE, position = "dodge")+
  geom_text(data = M[M$data == "original",], check_overlap = TRUE, position = "dodge")

  mutate(Modnames = as.numeric(stringr::str_remove(Modnames, "Mod"))) %>%
  ggplot(aes(x = Modnames, y = Delta_AICc, color = data, group = data))+
  geom_line()+
  geom_point()
```


```{r}
as_tibble(M[M$data == "original", c("predictor", "K", "AICc", "Delta_AICc", "ModelLik", "AICcWt", "LL", "Cum.Wt")])
as_tibble(M[M$data == "standard", c("predictor", "K", "AICc", "Delta_AICc", "ModelLik", "AICcWt", "LL", "Cum.Wt")])

M %>%
  ggplot(aes(x = predictor, y = Delta_AICc,
             label = predictor, group = data,
             color = data))+
  geom_segment(aes(xend = predictor, yend = 0))+
  geom_point()+
    # geom_line(color = "black")+
  coord_flip()+
  facet_grid(.~data)

```

```{r}
M.o <- as_tibble(M[M$data == "original", c("predictor", "K", "AICc", "Delta_AICc", "ModelLik", "AICcWt", "LL", "Cum.Wt")])

M.o[M.o$predictor == "Condition_Continuous", "predictor"] <- "Phase"
M.o[M.o$predictor == "Mean.AUC", "predictor"] <- "Area Under Curve"
M.o[M.o$predictor == "Mean.Med.V", "predictor"] <- "Median mV"
M.o[M.o$predictor == "Condition", "predictor"] <- "Phase (Discrete)"
M.o[M.o$predictor == "Mean.Mean.V", "predictor"] <- "Mean mV"
M.o[M.o$predictor == "Mean.Min.V", "predictor"] <- "Minimum mV"
M.o[M.o$predictor == "P.Onset.Delay", "predictor"] <- "Percent Delay"
M.o[M.o$predictor == "Min.AUC.mV.S", "predictor"] <- "Normalized Joint AUC"
M.o[M.o$predictor == "Cor", "predictor"] <- "Stimulus Correlation"
M.o[M.o$predictor == "Onset.Delay", "predictor"] <- "Delay"
M.o[M.o$predictor == "Min.AUC", "predictor"] <- "Overlapping AUC"
M.o[M.o$predictor == "Mean.AUC.mV.S", "predictor"] <- "Normalized AUC"
M.o[M.o$predictor == "Mean.Max.V", "predictor"] <- "Max mV"
M.o[M.o$predictor == "Mean.On.Duration", "predictor"] <- "On Duration"
M.o[M.o$predictor == "Mean.Duty.Cycle", "predictor"] <- "Duty Cycle"


# order low dAICc to high
correct.order <- M.o %>% arrange(Delta_AICc) %>% dplyr::select(predictor)

M.o$predictor <- factor(M.o$predictor, levels = unlist(correct.order) )


library(ggrepel)




### Params ####
text.size = 20

plt.nv.aicc <-M.o %>%
  mutate(rDelta_AICc = as.character(round(Delta_AICc, digits = 1))) %>%
  ggplot(aes(x = predictor, y = Delta_AICc,
             label = rDelta_AICc
  ))+
  geom_segment(aes(xend = predictor, yend = 0))+
  geom_point()+

  ggrepel::geom_text_repel(direction = "y", nudge_y = 0.2, color = "darkgray")+

  geom_segment(aes(x    = 1,
                   y    = 2,
                   xend = 1,
                   yend = 0.5),
               arrow = arrow(length = unit(0.015, "npc"),
                             type = "closed"),
               color = "red")+
  geom_text(aes(x = 1, y = 2.5,
                 label = "🟉"), color = "red")+


  labs(x = "", y = expression(paste("Relative Model Error "," (", Delta, "AICc", ")")) )+
  theme(axis.text.x = element_text(angle=45,hjust=1))+
  theme(
    # axis.text = element_text(size = rel(2), angle = 0),
        text = element_text(size=text.size)
        )
```





# Fig 1 traces
```{r}

# 180223_0009.abf
#
# Use 55-115 Sec
# For Inset,
# Use 55-64


library(readABF)
# Really just a wrapper for loadABF()
readABF_as_matrix <- function(
  path = "",
  channels = c("IN 4", "IN 9")){

  trace <- readABF::readABF(file = path)

  start.time <- trace$header$recTime[1]
  end.time <- trace$header$recTime[2]
  obs <- nrow(trace$data[[1]])

  temp <- trace$data[[1]][, (trace$channelNames %in% channels)]
  temp <- as.matrix(temp)

  colnames(temp) <- trace$channelNames[trace$channelNames %in% channels]
  temp <- cbind(temp, Time = seq(from = start.time,
                                 to = end.time,
                                 length.out = obs))

  return(temp)
}


# temp <- readABF::readABF(here("inst", "extdata", "all_5", "180223_0009.abf"))

temp <- readABF_as_matrix(path = here("inst", "extdata", "all_5", "180223_0009.abf"),
                          channels = c("IN 4", "IN 6", "IN 9", "IN 11", "IN 2", "IN 14"))

temp <- janitor::clean_names(dat = as.data.frame(temp), 'upper_camel')
temp <- as_tibble(temp)
temp <- temp %>% mutate(Seconds = Time - min(Time, na.rm = T))
# Select target time, 55-64 seconds in.
temp <- dplyr::filter(temp, Seconds > 55 & Seconds < 64)

# temp <- temp[seq(1, nrow(temp), by = 10), ]

temp2 <- temp

# Test out k params ----

smooth.k <- 7

plt.list <-
map(ceiling(seq(2, 27, length.out = 5)), function(smooth.k){
  temp <- temp2


  temp$In2 <- rollmean(temp$In2, k = smooth.k, fill = NA)
  temp$In4 <- rollmean(temp$In4, k = smooth.k, fill = NA)
  temp$In6 <- rollmean(temp$In6, k = smooth.k, fill = NA)
  temp$In9 <- rollmean(temp$In9, k = smooth.k, fill = NA)
  temp$In11 <- rollmean(temp$In11, k = smooth.k, fill = NA)
  temp$In14 <- rollmean(temp$In14, k = smooth.k, fill = NA)



  scale.bar.df <- as.data.frame(
    expand.grid(Ch = c("LC1", "LC2", "LC3", "LC4", "LC5"),
                Seconds = c(0,0),
                mV = c(0,3)))

  scale.bar.df <- rbind(scale.bar.df, data.frame(Ch = "LC1", Seconds = 1, mV = 3))

  plt <- temp %>%
    gather(c("In2",  "In4",  "In6",  "In9",  "In11", "In14"), key = "Ch", value = "mV") %>%
    mutate(Ch = ifelse(Ch == "In2", "LC4",
                       ifelse(Ch == "In4", "LC5",
                              ifelse(Ch == "In6", "LC3",
                                     ifelse(Ch == "In9", "LC2",
                                            ifelse(Ch == "In11", "LC1",
                                                   ifelse(Ch == "In14", "Trunk", "NA")
                                            )
                                     )
                              )
                       )
    )
    ) %>%
    group_by(Ch) %>%
    mutate(mV = mV - min(mV, na.rm = T)) %>%
    ungroup() %>%
    mutate(Seconds = Seconds - min(Seconds, na.rm = T)) %>%
    ggplot(aes(Seconds, mV, color = Ch))+
    # geom_path(data = scale.bar.df, color = "black", size = 2)+
    geom_path()+
    # facet_wrap(Ch~., ncol = 1)+
    facet_wrap(Ch~., ncol = 1, scales = "free")+
    theme_void()+
    theme(legend.position = "")+
    # scale_color_manual(values = c(RColorBrewer::brewer.pal(7, "Reds")[3:7], "Black")) # Nice analogous scheme
    scale_color_manual(values = c(rep(RColorBrewer::brewer.pal(7, "Reds")[7], times = 5), "Black")) # save color for easy comparison on k

  return(plt)

})

cowplot::plot_grid(plotlist = plt.list, nrow = 1)


# Test out SNR based K selection ----
plt.list <-
map(c(1, 5, 10, 100, 1000),
  # ceiling(seq(1, 50, length.out = 5)),
  function(smooth.k){
  temp <- temp2

  # We want a higher K based on the range which we'll uses as a proxy for SNR
  # If the relative range is high then we want a low K, so we set a high k and scale it down with ceiling(k/ XminRange)
  k.scaling.factors <- temp %>%
    gather(c("In2",  "In4",  "In6",  "In9",  "In11", "In14"), key = "Ch", value = "mV") %>%
    group_by(Ch) %>%
    dplyr::summarize(range = abs(max(mV) - min(mV)) ) %>%
    mutate(range = range/min(range))

  temp$In2 <-  zoo::rollmean(temp$In2,  k = as.numeric(ceiling(smooth.k/ k.scaling.factors[k.scaling.factors$Ch == "In2", "range"])), fill = NA)
  temp$In4 <-  zoo::rollmean(temp$In4,  k = as.numeric(ceiling(smooth.k/ k.scaling.factors[k.scaling.factors$Ch == "In4", "range"])), fill = NA)
  temp$In6 <-  zoo::rollmean(temp$In6,  k = as.numeric(ceiling(smooth.k/ k.scaling.factors[k.scaling.factors$Ch == "In6", "range"])), fill = NA)
  temp$In9 <-  zoo::rollmean(temp$In9,  k = as.numeric(ceiling(smooth.k/ k.scaling.factors[k.scaling.factors$Ch == "In9", "range"])), fill = NA)
  temp$In11 <- zoo::rollmean(temp$In11, k = as.numeric(ceiling(smooth.k/ k.scaling.factors[k.scaling.factors$Ch == "In11", "range"])), fill = NA)
  temp$In14 <- zoo::rollmean(temp$In14, k = as.numeric(ceiling(smooth.k/ k.scaling.factors[k.scaling.factors$Ch == "In14", "range"])), fill = NA)

  scale.bar.df <- as.data.frame(
    expand.grid(Ch = c("LC1", "LC2", "LC3", "LC4", "LC5"),
                Seconds = c(0,0),
                mV = c(0,3)))

  scale.bar.df <- rbind(scale.bar.df, data.frame(Ch = "LC1", Seconds = 1, mV = 3))

  plt <- temp %>%
    gather(c("In2",  "In4",  "In6",  "In9",  "In11", "In14"), key = "Ch", value = "mV") %>%
    mutate(Ch = ifelse(Ch == "In2", "LC4",
                       ifelse(Ch == "In4", "LC5",
                              ifelse(Ch == "In6", "LC3",
                                     ifelse(Ch == "In9", "LC2",
                                            ifelse(Ch == "In11", "LC1",
                                                   ifelse(Ch == "In14", "Trunk", "NA")
                                            )
                                     )
                              )
                       )
    )
    ) %>%
    group_by(Ch) %>%
    mutate(mV = mV - min(mV, na.rm = T)) %>%
    ungroup() %>%
    mutate(Seconds = Seconds - min(Seconds, na.rm = T)) %>%
    ggplot(aes(Seconds, mV, color = Ch))+
    # geom_path(data = scale.bar.df, color = "black", size = 2)+
    geom_path()+
    # facet_wrap(Ch~., ncol = 1)+
    facet_wrap(Ch~., ncol = 1, scales = "free")+
    theme_void()+
    theme(legend.position = "")+
    # scale_color_manual(values = c(RColorBrewer::brewer.pal(7, "Reds")[3:7], "Black")) # Nice analogous scheme
    scale_color_manual(values = c(rep(RColorBrewer::brewer.pal(7, "Reds")[7], times = 5), "Black")) # save color for easy comparison on k

  return(plt)

})

cowplot::plot_grid(plotlist = plt.list, nrow = 1, labels = c("1", "5", "10", "100", "1000"))#labels = LETTERS)
```



# Write out figures
```{r}
#
#
# fig1.part
# ggsave(here("data", "figures", "fig1.part.png"), plot = last_plot(), width = 5, height = 5, units = "in")
#
# plt.tea.hv.a
# ggsave(here("data", "figures", "fig2.png"), plot = last_plot(), width = 7.14, height = 5.81, units = "in")
#
#
# plt.lv.a
# ggsave(here("data", "figures", "fig3.png"), plot = last_plot(), width = 7.14, height = 5.81, units = "in")
#
#
# plt.nv.a+labs(subtitle = expression(paste("Varied Waveforms Produce Inconsistent Effects of Phase on ", Delta, "Rc"))) + plt.nv.aicc+labs(subtitle = expression(paste("Efficacy of Predictors to Explain  ", Delta, "Rc"))) + plot_layout(widths = c(3, 2), ) + plot_annotation(tag_levels = 'A')
#
# ggsave(here("data", "figures", "fig4.png"), plot = last_plot(), width = 10.68, height = 5.81, units = "in")



fig1.part
ggsave(here("data", "figures", "fig1.part.pdf"), plot = last_plot(), width = 5, height = 5, units = "in")
ggsave(here("data", "figures", "fig1.part.svg"), plot = last_plot(), width = 5, height = 5, units = "in")

plt.tea.hv.a
ggsave(here("data", "figures", "fig2.pdf"), plot = last_plot(), width = 7.14, height = 5.81, units = "in")
ggsave(here("data", "figures", "fig2.svg"), plot = last_plot(), width = 7.14, height = 5.81, units = "in")

plt.lv.a
ggsave(here("data", "figures", "fig3.pdf"), plot = last_plot(), width = 7.14, height = 5.81, units = "in")
ggsave(here("data", "figures", "fig3.svg"), plot = last_plot(), width = 7.14, height = 5.81, units = "in")

plt.nv.a+labs(subtitle = expression(paste("Varied Waveforms Produce Inconsistent Effects of Phase on ", Delta, "Rc"))) + plt.nv.aicc+labs(subtitle = expression(paste("Efficacy of Predictors to Explain  ", Delta, "Rc"))) + plot_layout(widths = c(3, 2)) + plot_annotation(tag_levels = 'A')
ggsave(here("data", "figures", "fig4.pdf"), plot = last_plot(), width = 10.68, height = 5.81, units = "in")
ggsave(here("data", "figures", "fig4.svg"), plot = last_plot(), width = 10.68, height = 5.81, units = "in")

library(cowplot)
cowplot::plot_grid(plotlist = list(
plt.nv.a+labs(subtitle = expression(paste("Varied Waveforms Produce Inconsistent Effects of Phase on ", Delta, "Rc"))),
plt.nv.aicc+labs(subtitle = expression(paste("Efficacy of Predictors to Explain  ", Delta, "Rc")))
))
ggsave(here("data", "figures", "fig4'.pdf"), plot = last_plot(), width = 10.68, height = 5.81, units = "in")
ggsave(here("data", "figures", "fig4'.svg"), plot = last_plot(), width = 10.68, height = 5.81, units = "in")

```

##### addition 2021 11 11
```{r}
plt.tea.cc+ plt.hv.cc + plot_annotation(tag_levels = 'A')
ggsave(here("data", "figures", "fig2CC.pdf"), plot = last_plot(), width = 7.14, height = 5.81, units = "in")
ggsave(here("data", "figures", "fig2CC.svg"), plot = last_plot(), width = 7.14, height = 5.81, units = "in")


plt.lv.cc
ggsave(here("data", "figures", "fig3CC.pdf"), plot = last_plot(), width = 7.14, height = 5.81, units = "in")
ggsave(here("data", "figures", "fig3CC.svg"), plot = last_plot(), width = 7.14, height = 5.81, units = "in")


```
##### end of same




```{r}
# library(nlme)
# library(multcomp)
#
# anova(mod <- lme(Yield~Crop, random=~1|ID, data=DFField, method="ML",na.action=na.omit))
#
# glht(mod, linfct=mcp(Crop="Tukey"))
```








# Reference asymptotic regression

```{r}
library(brms)

prior1 <- prior(normal(-2, 0.5), nlpar = "v0") + 
          prior(normal(12, 2), nlpar = "tau")


# fit1 <- brm(bf(gj ~ v0*(1-exp((-1*Time) / tau )), 
#                v0 + tau ~ 1, 
#                nl = TRUE),
#             data = temp, 
#             prior = prior1)


# charging
# Vt = v0(1-e^(-t/tau))
# discharging
# Vt = v0(e^(-t/tau))



# stan(..., control = list(adapt_delta = 0.99))
fit1 <- brm(bf(gj ~ v0*(1-exp((-1*Time) / tau )),
               # v0 ~ 1 | Condition,
               nonlinear = list(v0 ~ 1 | Condition, tau ~ 1),
               # v0 + tau ~ 1,
               nl = TRUE
               # ,
               # family = student()
               ),
            data = temp,
            prior = prior1,
            chains = 4, cores = 4)




plot(conditional_effects(fit1), points = TRUE)

temp %>% 
  modelr::data_grid(Time = modelr::seq_range(Time, n = 101)) %>% 
  tidybayes::add_predicted_draws(fit1) %>%
  ggplot(aes(Time))+
  ggdist::stat_lineribbon(aes(y = .prediction), .width = c(.99, .95, .8, .5), color = "#08519C") +
  geom_point(data = temp, 
             aes(y = gj, group = interaction(Experiment, Inj_Cell)))+
  geom_line(data = temp, 
             aes(y = gj, group = interaction(Experiment, Inj_Cell), 
                 color = Condition))+
  scale_fill_brewer()


summary(fit1)
plot(fit1)



```


```{r}
v0 = 20
v1 = 40
tau = 12
x <- rep(c(0, 20, 40, 60), each = 20)

trt1 = map_dbl(x, function(i){ rnorm(1, mean =  v0*(1-exp((-1*i) / tau )) ,  sd = 5 ) })
trt2 = map_dbl(x, function(i){ rnorm(1, mean =  v1*(1-exp((-1*i) / tau )) ,  sd = 5 ) })
dat1 <- data.frame(x, trt1, trt2)
dat1[dat1$x == 0, c('trt1', 'trt2')] = 0

dat1 = dat1 %>% pivot_longer(names_to = "key", values_to = "y", cols =c('trt1', 'trt2'))

ggplot(dat1, aes(x, y, color = key))+geom_point()


prior1 <- prior(normal(20, 2), nlpar = "v0") + 
          prior(normal(0, 2), nlpar = "tau")

fit1 <- brm(bf(y ~ v0*(1-exp((-1*x) / tau )), 
               v0 ~ 1 | key,
               tau ~ 1, 
               nl = TRUE),
            data = dat1, 
            prior = prior1)



summary(fit1)
plot(fit1)

plot(conditional_effects(fit1), points = TRUE)


```




```{r}
b <- c(2, 0.75)
x <- seq(0, 60)
y <- rnorm(100, mean = b[1] * exp(b[2] * x))
dat1 <- data.frame(x, y)

plot(y, x)

prior1 <- prior(normal(1, 2), nlpar = "b1") +
  prior(normal(0, 2), nlpar = "b2")
fit1 <- brm(bf(y ~ b1 * exp(b2 * x), b1 + b2 ~ 1, nl = TRUE),
            data = dat1, prior = prior1)


summary(fit1)
plot(fit1)

plot(conditional_effects(fit1), points = TRUE)




```

```{r}
val_A= -2
val_gamma = 1
val_tau = 0

Time = seq(0, 10)
gj = val_A/(1+exp(-val_gamma/(Time-val_tau)))

simM = data.frame(gj,
                  Time)
plot(gj ~ Time)

nlm1 <- nls(gj ~  A/(1+exp(-gamma*(Time-tau))), start=c(A=-2, gamma=1, tau=0), data = simM)



fit <- nls(Weight ~ SSlogis(Age, Asym, xmid, scal), data=DF)
summary(fit)


nls(gj ~ SSasymp(Time), data = temp)


library(nlme)

# variance increases with a power of the absolute fitted values
fm1 <- gnls(weight ~ SSlogis(Time, Asym, xmid, scal), Soybean,
weights = varPower())
summary(fm1)

nlme::gnls(gj ~ v0*(1-exp((-1*Time) / tau )), 
           start=c(v0=-2,tau = 12), 
           data = temp)


EXP=function(x,L0,K) {
y=L0*exp(K*x)
y
}    
EXP.nlme=nlme(gj~EXP(Time,L0,K), data = temp)



library("nlstools")
formulaExp <- as.formula(gj ~ v0*(1 - exp(-(Time) / mu)))
fm <- nls(formulaExp, 
          start = list(v0 = -2,
                       mu = 1), 
          data = temp)

# 




SSasymp(-2:4, Asym=7, R0=2, lrc=.1)
SSasympOff(-2:4, Asym=7, c0=1/exp(.1) * log(1-2/7), lrc=.1)
with(list(Upper=7, ZeroPt=2, LogRate=.1), SSasymp(-2:4, Upper, ZeroPt, LogRate))
tDat <- data.frame(
    effort = c(0, 1, 2, 5, 8, 10),
    result = c(2, 5.34, 6.45, 6.82, 6.98, 7))
nls(result ~ SSasymp(effort, Upper, ZeroPt, LogRate), data=tDat)
    




Lob.329 <- Loblolly[ Loblolly$Seed == "329", ]

SSasymp( Lob.329$age, 100, -8.5, -3.2 )   # response only
local({
  Asym <- 100 ; resp0 <- -8.5 ; lrc <- -3.2
  SSasymp( Lob.329$age, Asym, resp0, lrc) # response _and_ gradient
})

getInitial(height ~ SSasymp( age, Asym, resp0, lrc), data = Lob.329)
## Initial values are in fact the converged values
fm1 <- nls(height ~ SSasymp( age, Asym, resp0, lrc), data = Lob.329)
summary(fm1)

   
M = Loblolly[ Loblolly$Seed %in% c("329", "331"), ]
fm = nls(height ~ SSasymp(age,  #
                          Asym,  # horizontal asymptote
                          resp0, # response when input is zero.
                          lrc    # numeric parameter representing the natural logarithm of the rate constant.
                          ), , data = M)
summary(fm)


plot(M)

nls(height ~ as.numeric(Seed == "329")*(vmax1)*(Time/(Time+(km1)))+
      as.numeric(Seed == "331")*(vmax2)*(Time/(Time+(km2))),
    data = M,
    start = list(vmax1 = 60, km1 = 3,
                 vmax2 = 60, km2 = 3,
                 Time = 0)
    
    )


nls(formula = percent_on_cells ~ 
              as.numeric(DOC==0)*(vmax1)*(Time/(Time+(km1))) 
            + as.numeric(DOC==1)*(vmax2)*(Time/(Time+(km2)))
            + as.numeric(DOC==10)*(vmax3)*(Time/(Time+(km3)))
            + as.numeric(DOC==100)*(vmax4)*(Time/(Time+(km4))),
            data = mehg, 
            start = list(vmax1=0.63, km1=3.6, 
                         vmax2=0.64, km2=3.6, 
                         vmax3=0.50, km3=3.2,
                         vmax4= 0.40, km4=9.7))
```


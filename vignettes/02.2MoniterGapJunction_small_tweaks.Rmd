---
title: 'Chapter 2: Transjunctional voltage is responsible for activity dependent gap
  junction modulation'
author: "Daniel R. Kick"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
## General ====
library("tidyverse") # Plotting and data manipulation
library(here)

## Statistics ====
library("nlme") # for nested anova via lme. See http://www.jason-french.com/tutorials/repeatedmeasures.html
library("multcomp")
library("car")
library("agricolae")
library(bayestestR)
# library(rstanarm)
library(estimate)
library(equivalence)


## Plotting ====
library("cowplot") # clean up ggplots, plotgrid
library("ggthemes")
library("lemon")
library(Hmisc) # for mean_sdl ribbons
library("ggthemes")
library("ggsci")
library(see) # Utrum damnati futuri sint, qui non viderunt et crediderunt
library(patchwork)

## Specialty functions ====
source(here("R", "02MoniterGapJunction.R"))

## Global Params ====
# theme_set(kickme())
theme_set(theme_minimal())
library(broom) # for parameter estimates
library("furrr")
plan(multiprocess)
```

refactored 2021-12-27


# Read in and aggregate data
```{r read in data, eval=TRUE, include=FALSE}
# Preprocessing ----
tecc <- readRDS(file = here("data", "tecc.rds"))
tevc <- readRDS(file = here("data", "tevc.rds"))
htk <- readRDS(file = here("data", "htk.rds"))
a <- readRDS(file = here("data", "a.rds"))

tecc <- collapse_duplicate_gj_obs(tecc)
tevc <- collapse_duplicate_gj_obs(tevc)



## Join independent data types into a single data frame ====

#FIXME see above
all.data <- full_join(tecc, tevc) %>% full_join(htk) %>% full_join(a)

#%>% full_join(htk.p) %>% full_join(htk.e) %>% full_join(a.p) %>% full_join(a.e)
all.data <- all.data[, c(
  "Condition", "Experiment", "Time", "Inj_Cell",
  "tecc.recording", "tevc.recording",
  #"htk.recording", "a.recording", "subtracted.rin",
  "r11", "r12", "r1", "rc", "cc", "rmp", "gj",
  #"htk.peak.mV", "htk.peak.nA", "htk.end.mV", "htk.end.nA",
  #"a.peak.mV", "a.peak.nA", "a.end.mV", "a.end.nA"
  "intercept.peak_htk", "slope.peak_htk", "intercept.end_htk", "slope.end_htk",
  "intercept.peak_a", "slope.peak_a", "intercept.end_a", "slope.end_a"

)]

all.data <- all.data %>% as.data.frame()
```

```{r}
## Rename conditions ====
rename.df <- as.data.frame(list(
  c("Aberrant Depol", "PS.0.High.Amp"),
  c("Aberrant_Depol_22.5_deg", "PS.22.High.Amp"),

  c("HA 90 Degree", "PS.90.HA"),
  c("HA 90 Degree Cd", "PS.90.HA.Cd"),

  c("0_deg", "PS.0"),
  c("22.5_degrees", "PS.22"),
  c("rep 45 Degree", "PS.45"),
  c("rep 90 Degree", "PS.90"),

  c("PS.0.orig", "PS.0.orig"),
  c("PS.22.orig", "PS.22.orig"),
  c("PS.45.orig", "PS.45.orig"),
  c("PS.90.orig", "PS.90.orig"),
  c("PS.180.orig", "PS.180.orig"),

  c("hold_at_-53mV", "Silent.53mV"),
  c("TEA_ControlWave", "PS.0.TEA"),
  c("PS.0.TEA", "PS.0.TEA"),
  c("TEA_Silent", "Silent.TEA"),
  c("Inverted Wave", "Inv"),

  c("TEA.Active", "TEA.Active")
))

rename.df <- as.data.frame(t(rename.df))
names(rename.df) <- c("old", "new")
rownames(rename.df) <- NULL # get rid of rownames

all.data$changed <- F
for (i in seq(1, nrow(rename.df))){
  all.data[all.data$Condition == as.character(rename.df[i, "old"]), "Condition"] <- as.character(rename.df[i, "new"])
  all.data[all.data$Condition == as.character(rename.df[i, "old"]), "changed"] <- T
}
# print out the unchanged rows
print(all.data[!all.data$changed & !(all.data$Condition %in% as.vector(rename.df[, "new"])), ])
#and drop
all.data <- all.data[, !(names(all.data) %in% c("changed"))]

# reorder factors
all.data$Condition <- factor(all.data$Condition, as.vector(rename.df[, "new"])[-16] ) #-16 removes the duplicate "PS.0.TEA


#convert gj to inverse to make it easier to work with.
all.data$gj <- (1/all.data$gj)
```


QC
```{r}
### 1. Resistances can't be zero, drop any which are.  ####
all.data[(all.data$r11 < 0) & !is.na(all.data$r11) , "r11"] <- NA
all.data[(all.data$r1 < 0) & !is.na(all.data$r1) , "r1"] <- NA
all.data[(all.data$rc < 0) & !is.na(all.data$rc) , "rc"] <- NA
all.data[(all.data$gj < 0) & !is.na(all.data$gj) , "gj"] <- NA

# 2. If coupling coef is less than 0 or above 1, drop it. ####
all.data[(all.data$cc > 1 | all.data$cc < 0) & !is.na(all.data$cc) , "cc"] <- NA

# for condition | time | response var
conditions <- all.data$Condition %>% unique()
times <- all.data$Time %>% unique()
response.vars <- c("r11", "r1", "cc", "a.peak.nA", "htk.peak.nA", "rc", "gj")

multiplier <-  2
use.method <- "use.sd" #use.iqr

tic <- Sys.time()
for (i in seq_along(conditions)) {
  for (j in seq_along(times)) {
    for (k in seq_along(response.vars)) {
      if (use.method == "use.sd") {
        current.mean <- all.data[all.data$Condition == conditions[i] &
          all.data$Time == times[j], response.vars[k]] %>% mean(na.rm = TRUE)
        current.sd <- all.data[all.data$Condition == conditions[i] &
          all.data$Time == times[j], response.vars[k]] %>% sd(na.rm = TRUE)

        all.data[all.data$Condition == conditions[i] & all.data$Time == times[j] & ((all.data[[response.vars[k]]] < (current.mean - (multiplier * current.sd))) | (all.data[[response.vars[k]]] > (current.mean + (multiplier * current.sd)))) & !(is.na(all.data[[response.vars[k]]])), response.vars[k]] <- NA
      } else if (use.method == "use.iqr") {
        current.median <- all.data[all.data$Condition == conditions[i] &
          all.data$Time == times[j], response.vars[k]] %>% median(na.rm = TRUE)
        current.iqr <- all.data[all.data$Condition == conditions[i] &
          all.data$Time == times[j], response.vars[k]] %>% IQR(na.rm = TRUE)

        all.data[all.data$Condition == conditions[i] & all.data$Time == times[j] & ((all.data[[response.vars[k]]] < (current.median - (multiplier * current.iqr))) | (all.data[[response.vars[k]]] > (current.median + (multiplier * current.iqr)))) & !(is.na(all.data[[response.vars[k]]])), response.vars[k]] <- NA
      } else {
        warning(paste(as.character(use.method), "is not use.sd or use.iqr!"))
      }
    }
  }
}
print(Sys.time() - tic)
```

### Reduce dataset
```{r}
# Reduce data to target times ----
all.data <- all.data[all.data$Time %in% c(0, 20, 40, 60) |
                       all.data$Condition == "TEA.Active", ]

```

## Drop questionable observation
```{r}
all.data <- all.data[all.data$Experiment != "170817a",]
```

### Calculate deltas and percent changes
```{r}
## Calculate percent change for later use: ====
all.data.p <- convert_data_to(
  input.df = all.data,
  convert.to = c("percent"),
  data.cols = c(
    "r11", "r12", "r1", "rc", "cc", "rmp", "gj"#,
    #FIXME as above, so below
    # "intercept.peak_htk", "slope.peak_htk", "intercept.end_htk", "slope.end_htk",
    # "intercept.peak_a", "slope.peak_a", "intercept.end_a", "slope.end_a"
    # "htk.peak.mV", "htk.peak.nA", "htk.end.mV", "htk.end.nA",
    # "a.peak.mV", "a.peak.nA", "a.end.mV", "a.end.nA"
  )
)



all.data.d <- convert_data_to(
  input.df = all.data,
  convert.to = c("difference"),
  data.cols = c(   "r11", "r12", "r1", "rc", "cc", "rmp", "gj"#,
                   #FIXME as above, so below
                   # "intercept.peak_htk", "slope.peak_htk", "intercept.end_htk", "slope.end_htk",
                   # "intercept.peak_a", "slope.peak_a", "intercept.end_a", "slope.end_a"
                   # "htk.peak.mV", "htk.peak.nA", "htk.end.mV", "htk.end.nA",
                   # "a.peak.mV", "a.peak.nA", "a.end.mV", "a.end.nA"
  )
)

M <- all.data#[all.data$Time %in% c(0, 20, 40, 60) , ]
M.p <- all.data.p#[all.data.p$Time %in% c(0, 20, 40, 60) , ]
M.d <- all.data.d#[all.data.d$Time %in% c(0, 20, 40, 60) , ]

## Deduplicate gap junction measurements ====
M.gj<- deduplicate_gj_obs(input.df = M)
M.p.gj<- deduplicate_gj_obs(input.df = M.p)
M.d.gj <- deduplicate_gj_obs(input.df = M.d)
```

## Test w/o deltas
```{r}
# d <- add_stim_delay_phase(d = M)
d <- M

d$inter <- paste0(d$Experiment, ".", d$Inj_Cell)
# REPEAT Manual QC wonky points ----
## gj ====
#TEA sync
d[d$inter == "180212.LC4" & d$Time %in% c(40), "gj"] <- NA
# ps0
d[d$inter == "180507.LC4" & d$Time %in% c(40), "gj"] <- NA
# natural 0
d[d$inter == "170711e.LC4" & d$Time %in% c(20), "gj"] <- NA
d[d$inter == "170814b.LC5" & d$Time %in% c(60), "gj"] <- NA
# natural 22.5

#  natural 45
d[d$inter == "170925A.LC5" & d$Time %in% c(20), "gj"] <- NA
d[d$inter == "170925A.LC4" & d$Time %in% c(20, 40), "gj"] <- NA

# natural 90
d[d$inter == "170803a.LC4" & d$Time %in% c(20), "gj"] <- NA

# natural 180
d[d$inter == "170801a.LC5" & d$Time %in% c(20), "gj"] <- NA


## rc ====
d[d$inter == "180507.LC4" & d$Time %in% c(40), "rc"] <- NA
d[d$inter == "181001.LC4" & d$Time %in% c(40, 60), "rc"] <- NA


#natural 22.5
d[d$inter == "180718a.LC5" & d$Time %in% c(20), "rc"] <- NA
# natural 180
d[d$inter == "170801a.LC5" & d$Time %in% c(20), "rc"] <- NA
```

```{r}
# Use expand grid to get a full combination of tests then filter out the ones we don't want. This will let us use one future_map and maybe get faster
comparisons <- c(paste("PS.0.High.Amp", "PS.22.High.Amp", sep = "_"),
                 paste("PS.22.High.Amp", "PS.90.HA", sep = "_"),
                 paste("PS.90.HA", "PS.90.HA.Cd", sep = "_"),
                 paste("PS.0", "PS.22", "PS.45", "PS.90", sep = "_")#,
                 # paste("PS.0.orig", "PS.22.orig", "PS.45.orig", "PS.90.orig", "PS.180.orig", sep = "_")
                 )

dept.vars <- c("gj",
               "rc",
               "r12",
               "cc",
               "rmp",
               "r11",
               "r1"#,
               # "intercept.peak_htk",
               # "slope.peak_htk",
               # "intercept.end_htk",
               # "slope.end_htk",
               # "intercept.peak_a",
               # "slope.peak_a",
               # "intercept.end_a",
               # "slope.end_a"
)

# Set up a df with the inputs I want.
all.tests <- as.data.frame(expand.grid(comparisons, dept.vars))
names(all.tests) <- c("Groups", "DV")

all.tests <- all.tests %>%
  mutate(Obs.Net = ifelse(DV %in% c("gj", "Rc", "rc", "r12"), T, F)) %>% #NOTE: gj == Rc; gj != rc
  mutate(Model = ifelse(Groups == "PS.90.HA", "dept.var ~ Time", "dept.var ~ Time * Condition")) %>% #TODO switch to a more robust version built on str_split count
  mutate(Random = "~1 | Experiment")
# %>%
# mutate(Contrast = ifelse(!(DV %in% c("PS.90.HA")), "dept.var ~ Time * Condition", "dept.var ~ Time"))

# drop Rc and intercept.peak* from the *.orig datasets.
# all.tests <- all.tests[!((str_detect(all.tests$Groups, "orig") & (all.tests$DV %in% c("gj", "Rc", "intercept.peak_htk",
#                                                                                       "slope.peak_htk",
#                                                                                       "intercept.end_htk",
#                                                                                       "slope.end_htk",
#                                                                                       "intercept.peak_a",
#                                                                                       "slope.peak_a",
#                                                                                       "intercept.end_a",
#                                                                                       "slope.end_a")) )) , ]
# There's no data for htk with cd
# all.tests <- all.tests[!((str_detect(all.tests$Groups, "HA.Cd") & (all.tests$DV %in% c("intercept.peak_htk",
#                                                                                        "slope.peak_htk",
#                                                                                        "intercept.end_htk",
#                                                                                        "slope.end_htk",
#                                                                                        "intercept.peak_a",
#                                                                                        "slope.peak_a",
#                                                                                        "intercept.end_a",
#                                                                                        "slope.end_a")) )) , ]

#TODO data for ps90 isn't meshed well. There is current data and ionic current data but they are not tidy.

# TODO allow this when the K current data is in.
# all.tests <- all.tests[!(all.tests$DV %in% c("intercept.peak_htk", "intercept.peak_a")), ]

```

template for one
```{r}
# Test ----
M.clean <- d #%>% rename(Rc = gj)
```

# figures explicit
figures above are missing 20,60

```{r}
condition.labs <- c("TEA Mimic Sync", "TEA Mimic Async", "Depol. Async", "Depol. Async Cd2+",
                    "Standardized \n0 Deg.", "Standardized \n22.5 Deg.", "Standardized \n45 Deg.", "Standardized \n90 Deg.",
                    "Individualized \n0 Deg.", "Individualized \n22.5 Deg.", "Individualized \n45 Deg.", "Individualized \n90 Deg.", "Individualized \n180 Deg.")

names(condition.labs) <- c("PS.0.High.Amp", "PS.22.High.Amp", "PS.90.HA", "PS.90.HA.Cd",
                           "PS.0", "PS.22", "PS.45", "PS.90",
                           "PS.0.orig", "PS.22.orig", "PS.45.orig", "PS.90.orig", "PS.180.orig")

M.clean$Condition <- factor(M.clean$Condition, levels = c("PS.0.High.Amp", "PS.22.High.Amp", "PS.90.HA", "PS.90.HA.Cd",
                                                          "PS.0", "PS.22", "PS.45", "PS.90",
                                                          "PS.0.orig", "PS.22.orig", "PS.45.orig", "PS.90.orig", "PS.180.orig"))

### Params ####
text.size = 20
point.size = 3
line.size = 3
mean.point.size = 3
mean.line.size = 3

### High Amplitude Plots ####
plt.tea <- M.clean[M.clean$Condition %in% c("PS.0.High.Amp", "PS.22.High.Amp"), ] %>%
  dplyr::select(Condition, Experiment, Inj_Cell, Time, gj) %>%
  group_by(Condition, Experiment, Inj_Cell, Time) %>%
  summarise(gj = mean(gj, na.rm = T)) %>%
  ungroup() %>%
  # mutate(Time = as.character(Time)) %>%
  pivot_wider(names_from = Time, values_from = gj) %>%
  mutate(`20` = `20` - `0`,
         `40` = `40` - `0`,
         `60` = `60` - `0`) %>%
  mutate(`0` = 0) %>%
  pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "gj") %>%
  group_by(Condition, Time) %>%
  mutate(mean_gj = mean(gj, na.rm = T),
         mean_sd_up = mean_gj+sd(gj, na.rm = T),
         mean_sd_dn =mean_gj- sd(gj, na.rm = T),) %>%
  mutate(inter = paste(Experiment, Inj_Cell, sep = ".")) %>%
  ggplot(aes(x = Time,
             y = gj,
             # color = Experiment,
             # shape = Inj_Cell,
             group = inter))+
  geom_ribbon(aes(ymin=mean_sd_dn, ymax=mean_sd_up), fill = "gray", alpha = 0.1)+
  lemon::geom_pointline(size = point.size, linesize = line.size)+
  geom_point(aes(x = Time, y = mean_gj), color = "white", size = mean.point.size, alpha = 0.3)+
  geom_pointline(aes(x = Time, y = mean_gj), color = "firebrick", size = mean.point.size, linesize = mean.line.size,  shape = 1)+
  labs(y = expression(paste(Delta, "Rc", " in M", Omega)), x = "Time in Minutes")+
  facet_grid(.~Condition,
             labeller = labeller(Condition = condition.labs))+
  geom_hline(yintercept = 0)+
  theme(
    # axis.text = element_text(size = rel(2), angle = 0),
        text = element_text(size=text.size)
        )

plt.hv <- M.clean[M.clean$Condition %in% c("PS.90.HA", "PS.90.HA.Cd" ), ] %>%
  dplyr::select(Condition, Experiment, Inj_Cell, Time, gj) %>%
  group_by(Condition, Experiment, Inj_Cell, Time) %>%
  summarise(gj = mean(gj, na.rm = T)) %>%
  ungroup() %>%
  # mutate(Time = as.character(Time)) %>%
  pivot_wider(names_from = Time, values_from = gj) %>%
  mutate(`20` = `20` - `0`,
         `40` = `40` - `0`,
         `60` = `60` - `0`) %>%
  mutate(`0` = 0) %>%
  pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "gj") %>%
  group_by(Condition, Time) %>%
  mutate(mean_gj = mean(gj, na.rm = T),
         mean_sd_up = mean_gj+sd(gj, na.rm = T),
         mean_sd_dn =mean_gj- sd(gj, na.rm = T),) %>%
  mutate(inter = paste(Experiment, Inj_Cell, sep = ".")) %>%
  ggplot(aes(x = Time,
             y = gj,
             # color = Experiment,
             # shape = Inj_Cell,
             group = inter))+
  geom_ribbon(aes(ymin=mean_sd_dn, ymax=mean_sd_up), fill = "gray", alpha = 0.1)+
  lemon::geom_pointline(size = point.size, linesize = line.size)+
  geom_point(aes(x = Time, y = mean_gj), color = "white", size = mean.point.size, alpha = 0.3)+
  geom_pointline(aes(x = Time, y = mean_gj), color = "firebrick", size = mean.point.size, linesize = mean.line.size,  shape = 1)+
  labs(y = expression(paste(Delta, "Rc", " in M", Omega)), x = "Time in Minutes")+
  facet_grid(.~Condition,
             labeller = labeller(Condition = condition.labs))+
  geom_hline(yintercept = 0)+
  theme(
    # axis.text = element_text(size = rel(2), angle = 0),
        text = element_text(size=text.size)
        )




### Low Voltage plots ####
plt.lv <- M.clean[M.clean$Condition %in% c("PS.0", "PS.22", "PS.45", "PS.90"), ] %>%
  dplyr::select(Condition, Experiment, Inj_Cell, Time, gj) %>%
  group_by(Condition, Experiment, Inj_Cell, Time) %>%
  summarise(gj = mean(gj, na.rm = T)) %>%
  ungroup() %>%
  # mutate(Time = as.character(Time)) %>%
  pivot_wider(names_from = Time, values_from = gj) %>%
  mutate(`20` = `20` - `0`,
         `40` = `40` - `0`,
         `60` = `60` - `0`) %>%
  mutate(`0` = 0) %>%
  pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "gj") %>%
  group_by(Condition, Time) %>%
  mutate(mean_gj = mean(gj, na.rm = T),
         mean_sd_up = mean_gj+sd(gj, na.rm = T),
         mean_sd_dn =mean_gj- sd(gj, na.rm = T),) %>%
  mutate(inter = paste(Experiment, Inj_Cell, sep = ".")) %>%
  ggplot(aes(x = Time,
             y = gj,
             # color = Experiment,
             # shape = Inj_Cell,
             group = inter))+
  geom_ribbon(aes(ymin=mean_sd_dn, ymax=mean_sd_up), fill = "gray", alpha = 0.1)+
  lemon::geom_pointline(size = point.size, linesize = line.size)+
  geom_point(aes(x = Time, y = mean_gj), color = "white", size = mean.point.size, alpha = 0.3)+
  geom_pointline(aes(x = Time, y = mean_gj), color = "firebrick", size = mean.point.size, linesize = mean.line.size,  shape = 1)+
  labs(y = expression(paste(Delta, "Rc", " in M", Omega)), x = "Time in Minutes")+
  facet_grid(.~Condition,
             labeller = labeller(Condition = condition.labs))+
  geom_hline(yintercept = 0)+
  theme(
    # axis.text = element_text(size = rel(2), angle = 0),
        text = element_text(size=text.size)
        )
```



# Workspace

```{r}

temp <- M.clean[M.clean$Condition %in% c(
  # "PS.90.HA.Cd", "PS.90.HA"
  # "PS.0.High.Amp", "PS.22.High.Amp"
  "PS.0", "PS.22", "PS.45", "PS.90"
                                         
                                         ), ] %>%
  dplyr::select(Condition, Experiment, Inj_Cell, Time, gj) %>%
  group_by(Condition, Experiment, Inj_Cell, Time) %>%
  summarise(gj = mean(gj, na.rm = T)) %>%
  ungroup() %>%
  # mutate(Time = as.character(Time)) %>%
  pivot_wider(names_from = Time, values_from = gj) %>%
  mutate(`20` = `20` - `0`,
         `40` = `40` - `0`,
         `60` = `60` - `0`) %>%
  mutate(`0` = 0) %>% 
  pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "gj")

# temp =temp[temp$Condition == 'PS.90', ]
temp$Time <- as.numeric(temp$Time)

ggplot(temp, aes(Time, gj, #color = Condition, 
                 color = Experiment,
                 group = interaction(Experiment, Inj_Cell)))+
  geom_point()+
  geom_line()+
  # facet_grid(.~Experiment)
  facet_grid(.~Condition)
```


work through low amp
for(entry in c(
  #"180308", 
  # "180309", 
  "180309a",
  "180314",
  # "180315", # must be included
  "180705",
  "181001"
               )){
  print(entry)
  fm <- drm(gj ~ Time, Condition, data = temp[temp$Experiment != entry, ], 
            fct = AR.2(),
      pmodels = list(~1, # d
                     ~1                  # e
                     ))
  
  print(summary(fm))
  
}




What's up with 22?
```{r}

library(drc)

indf = temp[temp$Condition %in% c(
  "PS.0",
  "PS.22", 
  "PS.45", "PS.90"
  ) , ]

mask_0 <- (indf$Condition == "PS.0")

# keep only ok
mask_22 <- (
  indf$Experiment %in% c(
    "180308",  # works
    # "180309",  # no info
    # "180309a", # no info
    # "180314",  # nans produced  -- added to all working, t value goes to infinity
    "180315",  # works
    # "180705",  # nans produced -- added to working seems ... okay?
    "181001",  # works
    "none") )
mask_22 <- mask_22 | (
  (indf$Experiment %in% c("180314") ) | #& indf$Time != 20
  (indf$Experiment %in% c("180705"))
)

mask_22 <- mask_22 & !((indf$Experiment == "180308") & (indf$Inj_Cell == "LC5"))
mask_22 <- mask_22 & !((indf$Experiment == "181001"
                        ) & (indf$Inj_Cell == "LC5"
                        ) & (indf$Time == 60
                      ))


    # error causing entries
    # (indf$Experiment %in% c("180314") & indf$Time != 20) |
    # (indf$Experiment %in% c("180705") #& indf$Time != 20

mask_45 <- (indf$Condition == "PS.45")
mask_90 <- (indf$Condition == "PS.90")

# indf_filter = indf[, ]
## global-ish ====
# ok -- 0+90
# not - 0+90+45
# not - 0+90+22
# ok -- 22+90
# ok -- 45+90
fm_g = drm(gj ~ Time, Condition, 
         data = indf[
           (mask_0 |
            mask_22 |
           mask_45# |
           # mask_90
           ),
                     ], 
         fct = AR.2(), 
         pmodels = list(~1, ~1))

summary(fm_g)

pred_g = data.frame(Time = seq(0, 60))
pred_g = cbind(pred_g, predict(fm_g, newdata = pred_g, se.fit = TRUE)) %>% 
  rename(gj = Prediction)
## 0 ====
fm_0 = drm(gj ~ Time, Condition, 
         data = indf[mask_0, ], 
         fct = AR.2(), 
         pmodels = list(~1, ~1))
summary(fm_0)
pred_0 = data.frame(Time = seq(0, 60),Condition = c("PS.0"))
pred_0 = cbind(pred_0, predict(fm_0, newdata = pred_0, se.fit = TRUE)) %>% 
  rename(gj = Prediction)
## 22 ====
fm_22 = drm(gj ~ Time, Condition, 
         data = indf[mask_22, ], 
         fct = AR.2(), 
         pmodels = list(~1, ~1))
summary(fm_22)
pred_22 = data.frame(Time = seq(0, 60),Condition = c("PS.22"))
pred_22 = cbind(pred_22, predict(fm_22, newdata = pred_22, se.fit = TRUE)) %>% 
  rename(gj = Prediction)
## 45 ====
fm_45 = drm(gj ~ Time, Condition, 
         data = indf[mask_45, ], 
         fct = AR.2(), 
         pmodels = list(~1, ~1))
summary(fm_45)
pred_45 = data.frame(Time = seq(0, 60),Condition = c("PS.45"))
pred_45 = cbind(pred_45, predict(fm_45, newdata = pred_45, se.fit = TRUE)) %>% 
  rename(gj = Prediction)
## 90 ====
fm_90 = drm(gj ~ Time, Condition, 
         data = indf[mask_90, ], 
         fct = AR.2(), 
         pmodels = list(~1, ~1))
summary(fm_90)
pred_90 = data.frame(Time = seq(0, 60),Condition = c("PS.90"))
pred_90 = cbind(pred_90, predict(fm_90, newdata = pred_90, se.fit = TRUE)) %>% 
  rename(gj = Prediction)

## plot ====
ggplot(data = indf, aes(Time, gj #color = Condition, 
                 # color = Experiment,
                 ))+
  geom_hline(yintercept = 0)+
  geom_line(color = 'darkgray', aes(group = interaction(Experiment, Inj_Cell)))+
  geom_point(color = 'red')+
  geom_point(data = indf[
           (mask_0 |
           mask_22 |
           mask_45 |
           mask_90),
                     ], color = 'darkgray')+
  geom_line(data = pred_g, aes(y = gj), color = 'black', linetype = 'dashed')+
  geom_line(data = pred_0, aes(y = gj, color=Condition))+
  geom_line(data = pred_22, aes(y = gj, color=Condition))+
  geom_line(data = pred_45, aes(y = gj, color=Condition))+
  geom_line(data = pred_90, aes(y = gj, color=Condition))+
  facet_grid(.~Condition)

## stats ====
fm_full = drm(gj ~ Time, Condition, 
         data = indf[
           (mask_0 |
           mask_22 |
           mask_45 |
           mask_90
           ),], 
         fct = AR.2(), 
         pmodels = list(
           # ~1,
           ~factor(Condition),
           # ~1
           ~factor(Condition)
           ))

summary(fm_full)

fm0 <- drm(gj ~ Time, Condition, data = indf[
           (mask_0 |
           mask_22 |
           mask_45 |
           mask_90
           ), ], 
          fct = AR.2(),
    pmodels = list(~1, # d
                   ~1                  # e
                   ))
# is using the treatment effect justified?
anova(fm_full, fm0)

# ED(fm, c(10, 50, 90))
compParm(fm_full, "d")

# modelFit(fm)



## plot with FULL MODEL ====

# predict all with full model
pred_00 = data.frame(expand.grid(Time = seq(0, 60),
                     Condition = c("PS.0",  "PS.22", "PS.45", "PS.90")))
pred_00 = cbind(pred_00, predict(fm_full, newdata = pred_00, se.fit = TRUE)) %>% 
  rename(gj = Prediction)


ggplot(data = indf, aes(Time, gj #color = Condition, 
                 # color = Experiment,
                 ))+
  geom_hline(yintercept = 0)+
  geom_line(color = 'darkgray', aes(group = interaction(Experiment, Inj_Cell)))+
  geom_point(color = 'red')+
  geom_point(data = indf[
           (mask_0 |
           mask_22 |
           mask_45 |
           mask_90),
                     ], color = 'darkgray')+
  # geom_line(data = pred_g, aes(y = gj), color = 'black', linetype = 'dashed')+
  geom_line(data = pred_00, aes(y = gj, color=Condition))+
  # geom_line(data = pred_22, aes(y = gj, color=Condition))+
  # geom_line(data = pred_45, aes(y = gj, color=Condition))+
  # geom_line(data = pred_90, aes(y = gj, color=Condition))+
  facet_grid(.~Condition)

```


```{r}
# try outwith drc

library(drc)
temp = temp[!is.na(temp$gj), ]
temp = temp[temp$Condition %in% c(
  "PS.0",
  "PS.22",
  "PS.45", "PS.90"
  ) , ]

# fm <- drm(gj ~ Time, Condition, data = temp, 
#           fct = AR.2(),
#     pmodels = list(~1, # d
#                    ~1                  # e
#                    ))
# 
# summary(fm)




# will it run if we drop those two points?
temp = temp[
  
  (      (temp$Experiment != '180309'
     ) & (temp$Experiment != '180309a'
     ) & (temp$Experiment != "180314"
     ) & (temp$Experiment != "180705")
   # ) | ((temp$Experiment %in% c("180314") & temp$Time != 20
   #  ) | (temp$Experiment %in% c("180705") & temp$Time != 20)
    )
  , ]






fm <- drm(gj ~ Time, Condition, data = temp,
          fct = AR.2(),
    pmodels = list(~factor(Condition), # d
                   ~1                  # e
                   ))

summary(fm)




pred1 = data.frame(
      Time = seq(0, 60), 
      Condition = 'PS.90.HA')
pred1 = cbind(pred1, 
              predict(fm, 
                      newdata = pred1, 
                      se.fit = TRUE)) %>% 
  rename(gj = Prediction)

pred2 = data.frame(
      Time = seq(0, 60), 
      Condition = 'PS.90.HA.Cd')
pred2 = cbind(pred2, 
              predict(fm, 
                      newdata = pred2, 
                      se.fit = TRUE)) %>% 
  rename(gj = Prediction)



ggplot(temp, 
       aes(Time, gj, color = Condition))+

  geom_line(data = pred1, color = 'black')+
  geom_line(data = pred1, aes(y = gj+0.14958), color = 'black', linetype = 'dashed')+
  geom_line(data = pred1, aes(y = gj-0.14958), color = 'black', linetype = 'dashed')+
  geom_line(data = pred2, color = 'black')+
  geom_line(data = pred2, aes(y = gj+0.22437), color = 'black', linetype = 'dashed')+
  geom_line(data = pred2, aes(y = gj-0.22437), color = 'black', linetype = 'dashed')+
  
  geom_point(alpha = 0.3)+
  geom_line(aes(group = interaction(Experiment, Inj_Cell)), alpha = 0.6)+
  
  facet_grid(.~Condition)

summary(fm)
anova(fm)

# https://www.researchgate.net/post/dose_response_curves_is_better_to_create_different_models_or_just_one



fm0 <- drm(gj ~ Time, Condition, data = temp, 
          fct = AR.2(),
    pmodels = list(~1, # d
                   ~1                  # e
                   ))
# is using the treatment effect justified?
anova(fm, fm0)

# ED(fm, c(10, 50, 90))
compParm(fm, "d")

# modelFit(fm)

```























# Workspace End





##### addition 2021 11 11
```{r}
condition.labs <- c("TEA Mimic Sync", "TEA Mimic Async", "Depol. Async", "Depol. Async Cd2+",
                    "Standardized \n0 Deg.", "Standardized \n22.5 Deg.", "Standardized \n45 Deg.", "Standardized \n90 Deg.",
                    "Individualized \n0 Deg.", "Individualized \n22.5 Deg.", "Individualized \n45 Deg.", "Individualized \n90 Deg.", "Individualized \n180 Deg.")

names(condition.labs) <- c("PS.0.High.Amp", "PS.22.High.Amp", "PS.90.HA", "PS.90.HA.Cd",
                           "PS.0", "PS.22", "PS.45", "PS.90",
                           "PS.0.orig", "PS.22.orig", "PS.45.orig", "PS.90.orig", "PS.180.orig")

M.clean$Condition <- factor(M.clean$Condition, levels = c("PS.0.High.Amp", "PS.22.High.Amp", "PS.90.HA", "PS.90.HA.Cd",
                                                          "PS.0", "PS.22", "PS.45", "PS.90",
                                                          "PS.0.orig", "PS.22.orig", "PS.45.orig", "PS.90.orig", "PS.180.orig"))

### Params ####
text.size = 20
point.size = 3
line.size = 3
mean.point.size = 3
mean.line.size = 3

### High Amplitude Plots ####
plt.tea.cc <- M.clean[M.clean$Condition %in% c("PS.0.High.Amp", "PS.22.High.Amp"), ] %>%
  dplyr::select(Condition, Experiment, Inj_Cell, Time, cc) %>%
  group_by(Condition, Experiment, Inj_Cell, Time) %>%
  summarise(cc = mean(cc, na.rm = T)) %>%
  ungroup() %>%
  # mutate(Time = as.character(Time)) %>%
  pivot_wider(names_from = Time, values_from = cc) %>%
  mutate(`20` = `20` - `0`,
         `40` = `40` - `0`,
         `60` = `60` - `0`) %>%
  mutate(`0` = 0) %>%
  pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "cc") %>%
  group_by(Condition, Time) %>%
  mutate(mean_cc = mean(cc, na.rm = T),
         mean_sd_up = mean_cc+sd(cc, na.rm = T),
         mean_sd_dn =mean_cc- sd(cc, na.rm = T),) %>%
  mutate(inter = paste(Experiment, Inj_Cell, sep = ".")) %>%
  ggplot(aes(x = Time,
             y = cc,
             # color = Experiment,
             # shape = Inj_Cell,
             group = inter))+
  geom_ribbon(aes(ymin=mean_sd_dn, ymax=mean_sd_up), fill = "gray", alpha = 0.1)+
  lemon::geom_pointline(size = point.size, linesize = line.size)+
  geom_point(aes(x = Time, y = mean_cc), color = "white", size = mean.point.size, alpha = 0.3)+
  geom_pointline(aes(x = Time, y = mean_cc), color = "firebrick", size = mean.point.size, linesize = mean.line.size,  shape = 1)+
  labs(y = expression(paste(Delta, "CC")), x = "Time in Minutes")+
  facet_grid(.~Condition,
             labeller = labeller(Condition = condition.labs))+
  geom_hline(yintercept = 0)+
  theme(
    # axis.text = element_text(size = rel(2), angle = 0),
        text = element_text(size=text.size)
        )

plt.hv.cc <- M.clean[M.clean$Condition %in% c("PS.90.HA", "PS.90.HA.Cd" ), ] %>%
  dplyr::select(Condition, Experiment, Inj_Cell, Time, cc) %>%
  group_by(Condition, Experiment, Inj_Cell, Time) %>%
  summarise(cc = mean(cc, na.rm = T)) %>%
  ungroup() %>%
  # mutate(Time = as.character(Time)) %>%
  pivot_wider(names_from = Time, values_from = cc) %>%
  mutate(`20` = `20` - `0`,
         `40` = `40` - `0`,
         `60` = `60` - `0`) %>%
  mutate(`0` = 0) %>%
  pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "cc") %>%
  group_by(Condition, Time) %>%
  mutate(mean_cc = mean(cc, na.rm = T),
         mean_sd_up = mean_cc+sd(cc, na.rm = T),
         mean_sd_dn =mean_cc- sd(cc, na.rm = T),) %>%
  mutate(inter = paste(Experiment, Inj_Cell, sep = ".")) %>%
  ggplot(aes(x = Time,
             y = cc,
             # color = Experiment,
             # shape = Inj_Cell,
             group = inter))+
  geom_ribbon(aes(ymin=mean_sd_dn, ymax=mean_sd_up), fill = "gray", alpha = 0.1)+
  lemon::geom_pointline(size = point.size, linesize = line.size)+
  geom_point(aes(x = Time, y = mean_cc), color = "white", size = mean.point.size, alpha = 0.3)+
  geom_pointline(aes(x = Time, y = mean_cc), color = "firebrick", size = mean.point.size, linesize = mean.line.size,  shape = 1)+
  labs(y = expression(paste(Delta, "CC")), x = "Time in Minutes")+
  facet_grid(.~Condition,
             labeller = labeller(Condition = condition.labs))+
  geom_hline(yintercept = 0)+
  theme(
    # axis.text = element_text(size = rel(2), angle = 0),
        text = element_text(size=text.size)
        )




### Low Voltage plots ####
plt.lv.cc <- M.clean[M.clean$Condition %in% c("PS.0", "PS.22", "PS.45", "PS.90"), ] %>%
  dplyr::select(Condition, Experiment, Inj_Cell, Time, cc) %>%
  group_by(Condition, Experiment, Inj_Cell, Time) %>%
  summarise(cc = mean(cc, na.rm = T)) %>%
  ungroup() %>%
  # mutate(Time = as.character(Time)) %>%
  pivot_wider(names_from = Time, values_from = cc) %>%
  mutate(`20` = `20` - `0`,
         `40` = `40` - `0`,
         `60` = `60` - `0`) %>%
  mutate(`0` = 0) %>%
  pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "cc") %>%
  group_by(Condition, Time) %>%
  mutate(mean_cc = mean(cc, na.rm = T),
         mean_sd_up = mean_cc+sd(cc, na.rm = T),
         mean_sd_dn =mean_cc- sd(cc, na.rm = T),) %>%
  mutate(inter = paste(Experiment, Inj_Cell, sep = ".")) %>%
  ggplot(aes(x = Time,
             y = cc,
             # color = Experiment,
             # shape = Inj_Cell,
             group = inter))+
  geom_ribbon(aes(ymin=mean_sd_dn, ymax=mean_sd_up), fill = "gray", alpha = 0.1)+
  lemon::geom_pointline(size = point.size, linesize = line.size)+
  geom_point(aes(x = Time, y = mean_cc), color = "white", size = mean.point.size, alpha = 0.3)+
  geom_pointline(aes(x = Time, y = mean_cc), color = "firebrick", size = mean.point.size, linesize = mean.line.size,  shape = 1)+
  labs(y = expression(paste(Delta, "CC")), x = "Time in Minutes")+
  facet_grid(.~Condition,
             labeller = labeller(Condition = condition.labs))+
  geom_hline(yintercept = 0)+
  theme(
    # axis.text = element_text(size = rel(2), angle = 0),
        text = element_text(size=text.size)
        )



```
##### end of same



## Waveform annotations on figs
```{r}
#E:/PseudoClone/F/
protocol_files <- list.files("Box Sync/AllWorkProjects/dynamicclamp - Copy/inst/extdata/protocol_waveforms/")

data.reduction <- 250

stims <- map(protocol_files, function(i){
  temp <- read.table(paste0("D:/Box Sync/AllWorkProjects/dynamicclamp - Copy/inst/extdata/protocol_waveforms/", i))
  temp <- temp[4:nrow(temp), ]
  names(temp) <- c("Seconds", "mV")
  temp$Seconds <- as.numeric(as.character(temp$Seconds))
  temp$mV <- as.numeric(as.character(temp$mV))

  temp$Protocol <- i

  # don't data reduce the naturalistic, it's lower res already.
  if (!(i %in% c("170828_lead.atf",
                 "180717a_follow.atf",
                 "180718_lead.atf"))) {
    temp <- temp[seq(1, nrow(temp), by = data.reduction), ]
  }

  return(temp)
})

## make 22.5 - 180 shifts for 170828_lead.atf
add.to.stims <- map(c(2, 4, 8, 16), function(i, temp = stims[[which(protocol_files == "170828_lead.atf")]]){

  # make shifted times
  shift.by <- floor(nrow(temp) / i)
  temp$Seconds <- c(temp$Seconds[seq(shift.by+1, nrow(temp))], temp$Seconds[seq(1, shift.by)])
  # update Protocol name

  temp$Protocol <- stringr::str_remove(temp$Protocol, "lead.atf")
  temp$Protocol <- paste0(temp$Protocol, as.character((1/i)*360), ".atf")

  # since we'll visualize with geom_path we need to sort here.
  temp <- arrange(temp, Seconds)

  return(temp)

})

# Grow list
for (i in seq_along(add.to.stims)){
  stims[[length(stims)+1]] <- add.to.stims[[i]]
}


stims <- do.call(rbind, stims)
```

```{r}
inset_plts <- map(c("aberrant_depol_man.atf",
                    "aberrant_depol_man_22deg.ATF",
                    "HA_00.ATF",
                    "HA_90.ATF",

                    "180110_stim.atf",
                    "180110_stim_22deg.ATF",
                    "180110_stim_45deg.ATF",
                    "180110_stim_90deg.ATF",

                    "170828_lead.atf",
                    "170828_22.5.atf",
                    "170828_45.atf",
                    "170828_90.atf",
                    "170828_180.atf"), function(i){
                      plt <- stims[stims$Protocol == i, ] %>%
                        ggplot( aes(Seconds, mV, group = 1))+
                        geom_path()+
                        theme_void()
                    })

names(inset_plts) <- c("tea0", "tea22", "ha0", "ha90",
                       "s0", "s22", "s45", "s90",
                       "n0", "n22", "n45", "n90", "n180")

```

## Prep Figure 1
```{r}

trace.size = 1
bar.size = 2

ex.1 <-
ggplot()+
  geom_path(data = stims[stims$Protocol %in% c("aberrant_depol_man.atf") , ], aes(Seconds/1000, mV+53.53, group = 1), size = trace.size)+
  geom_segment(aes(x = 0, xend = 0, y = -1, yend = 9), size = bar.size)+
  geom_segment(aes(x = 0, xend = 1, y = -1, yend = -1), size = bar.size)+
  geom_vline(xintercept = 3.9)+
  theme_void()

ex.2 <-
ggplot()+
  geom_path(data = stims[stims$Protocol %in% c("HA_00.ATF") , ], aes(Seconds, mV+53.53, group = 1), size = trace.size)+
  geom_segment(aes(x = 0, xend = 0, y = -1, yend = 9), size = bar.size)+
  geom_segment(aes(x = 0, xend = 1, y = -1, yend = -1), size = bar.size)+
  theme_void()

ex.3 <-
ggplot()+
  geom_path(data = stims[stims$Protocol %in% c("180110_stim.atf") , ], aes(Seconds/1000, mV+53.53, group = 1), size = trace.size)+
  geom_segment(aes(x = 0, xend = 0, y = -1, yend = 9), size = bar.size)+
  geom_segment(aes(x = 0, xend = 1, y = -1, yend = -1), size = bar.size)+
  theme_void()


#Control lab position even with different x axis
label.size = 4
label.x.fract = 4/5
label.y = 7

ex.4 <-
ggplot()+
  geom_path(data = stims[stims$Protocol %in% c("170828_lead.atf") , ], aes(Seconds/1000, mV+43.29, group = 1), size = trace.size)+
  geom_segment(aes(x = 0, xend = 0, y = -1, yend = 9), size = bar.size)+
  geom_segment(aes(x = 0, xend = 1, y = -1, yend = -1), size = bar.size)+
  annotate("text", x = ((label.x.fract)*5.178), y = label.y, label = 'paste(italic(Animal), " ", italic("1"))',  parse = T, size = label.size)+
  theme_void()


ex.5 <-
ggplot()+
  geom_path(data = stims[stims$Protocol %in% c("180717a_follow.atf") , ], aes(Seconds/1000, mV+55.83, group = 1), size = trace.size, color = "gray")+
  geom_segment(aes(x = 0, xend = 0, y = -1, yend = 9), size = bar.size)+
  geom_segment(aes(x = 0, xend = 1, y = -1, yend = -1), size = bar.size)+
  annotate("text", x = ((label.x.fract)*4.919), y = label.y, label = 'paste(italic(Animal), " ", italic("2"))',  parse = T, size = label.size)+
  theme_void()

ex.6 <-
ggplot()+
  geom_path(data = stims[stims$Protocol %in% c("180718_lead.atf") , ], aes((Seconds-281297)/1000, mV+62.36, group = 1), size = trace.size, color = "gray")+
  geom_segment(aes(x = 0, xend = 0, y = -1, yend = 9), size = bar.size)+
  geom_segment(aes(x = 0, xend = 1, y = -1, yend = -1), size = bar.size)+
  annotate("text", x = ((label.x.fract)*5.652), y = label.y, label = 'paste(italic(Animal), " ", italic("3"))',  parse = T, size = label.size)+
  theme_void()

fig1.left <- (ex.1 / ex.2 / ex.3 / ex.4 / ex.5 / ex.6)


#Rescale data so that it has a mV range 0-1
example.shift <- stims[stims$Protocol %in% c("180110_stim.atf") , ]
example.shift$Seconds <- example.shift$Seconds/1000
example.shift$mV <- example.shift$mV - min(example.shift$mV, na.rm = T)
example.shift$mV <- example.shift$mV / max(example.shift$mV, na.rm = T)

example.shift$Protocol <- "B"
# example.shift$ShiftBy <- 0
examples.shifted <- map(seq_along(c(1, 16, 8, 4, 2)), function(j, temp = example.shift){
  i <- c(1, 16, 8, 4, 2)[j]

  if (i == 1){
    temp$Protocol <- "0"
  } else {
    # make shifted times
    shift.by <- floor(nrow(temp) / i)
    temp$Seconds <- c(temp$Seconds[seq(shift.by+1, nrow(temp))], temp$Seconds[seq(1, shift.by)])
    # add ShiftBy so we can make scale bars
    # temp$ShiftBy <- temp[shift.by, "Seconds"]
    # update Protocol name
    temp$Protocol <- as.character((1/i)*360)
  }
  # change min mV so that
  temp$mV <- temp$mV - j

  # since we'll visualize with geom_path we need to sort here.
  temp <- arrange(temp, Seconds)

  return(temp)
})

# Grow list
examples.shifted[[length(examples.shifted)+1]] <- example.shift
# collapse into df
example.shift.plt.df <- do.call(rbind, examples.shifted)


period <- max(example.shift.plt.df$Seconds, na.rm = T)

font.size = 2

fig1.right <- ggplot(example.shift.plt.df, aes(Seconds, mV, group = Protocol))+
  # geom_segment(aes(x = 0.71, xend = 0.71,                         y = 1, yend = -1), size = 1, color = "cornflowerblue")+
  geom_segment(aes(x = 0.71+(period/16), xend = 0.71+(period/16), y = 1, yend = -1), size = 1, color = "cornflowerblue")+
  geom_segment(aes(x = 0.71+(period/8),  xend = 0.71+(period/8),  y = 1, yend = -2), size = 1, color = "cornflowerblue")+
  geom_segment(aes(x = 0.71+(period/4),  xend = 0.71+(period/4),  y = 1, yend = -3), size = 1, color = "cornflowerblue")+
  geom_segment(aes(x = 0.71+(period/2),  xend = 0.71+(period/2),  y = 1, yend = -4), size = 1, color = "cornflowerblue")+

  geom_segment(aes(x = 0.71,  xend = 0.71+(period/2),             y = 1, yend = 1), size = 1, color = "cornflowerblue")+
  # annotate("text", x = 0.61, y = 1.1, parse = TRUE, label = as.character(expression(paste(Phi, "=", sep = ""))) )+
  annotate("text", x = 0.71, y = 1.1, parse = TRUE, label = as.character(expression(paste("0", degree, sep = ""))) , size = font.size)+
  annotate("text", x = 0.71+(period/16), y = 1.1, parse = TRUE, label = as.character(expression(paste("22", degree, sep = ""))) , size = font.size)+
  annotate("text", x = 0.71+(period/8), y = 1.1, parse = TRUE, label = as.character(expression(paste("45", degree, sep = ""))) , size = font.size)+
  annotate("text", x = 0.71+(period/4), y = 1.1, parse = TRUE, label = as.character(expression(paste("90", degree, sep = ""))) , size = font.size)+
  annotate("text", x = 0.71+(period/2), y = 1.1, parse = TRUE, label = as.character(expression(paste("180", degree, sep = ""))) , size = font.size)+

  geom_path(size = trace.size)+
  geom_segment(aes(x = 0, xend = 0, y = -5.05, yend = -5.05+((1/20.2529)*10)), size = bar.size)+
  geom_segment(aes(x = 0, xend = 1, y = -5.05, yend = -5.05), size = bar.size)+
  theme_void()

fig1.part <- (fig1.left | fig1.right) + plot_annotation(tag_levels = 'i')




# tea.protocol.fig <-
# ggplot()+
#   geom_path(data = stims[stims$Protocol %in% c("aberrant_depol_man.atf") , ], aes(Seconds, mV, group = 1))+
#   geom_path(data = stims[stims$Protocol %in% c("aberrant_depol_man_22deg.ATF") , ], aes(Seconds, mV-(39.97*1), group = 1))+
#   geom_segment(aes(x = 0, xend = 0, y = -90, yend = -80), size = 1)+
#   geom_segment(aes(x = 0, xend = 1000, y = -90, yend = -90), size = 1)+
#   theme_void()
#
# hv.protocol.fig <-
# ggplot()+
#   geom_path(data = stims[stims$Protocol %in% c("HA_00.ATF") , ], aes(Seconds, mV, group = 1))+
#   geom_path(data = stims[stims$Protocol %in% c("HA_90.ATF") , ], aes(Seconds, mV-(39.97*1), group = 1))+
#   geom_segment(aes(x = 0, xend = 0, y = -90, yend = -80), size = 1)+
#   geom_segment(aes(x = 0, xend = 1, y = -90, yend = -90), size = 1)+
#   theme_void()
#
# nv.protocol.fig <-
# ggplot()+
#   geom_path(data = stims[stims$Protocol %in% c("180110_stim.atf") , ], aes(Seconds, mV, group = 1))+
#   geom_path(data = stims[stims$Protocol %in% c("180110_stim_22deg.ATF") , ], aes(Seconds, mV-(20.26*1), group = 1))+
#   geom_path(data = stims[stims$Protocol %in% c("180110_stim_45deg.ATF") , ], aes(Seconds, mV-(20.26*2), group = 1))+
#   geom_path(data = stims[stims$Protocol %in% c("180110_stim_90deg.ATF") , ], aes(Seconds, mV-(20.26*3), group = 1))+
#   geom_segment(aes(x = 0, xend = 0, y = -110, yend = -100), size = 1)+
#   geom_segment(aes(x = 0, xend = 1000, y = -110, yend = -110), size = 1)+
#   theme_void()
#
# fig1.part <- ((tea.protocol.fig / hv.protocol.fig) | nv.protocol.fig) + plot_annotation(tag_levels = 'i')
```




## Prep Figures 2-4
```{r}
# ## High Volt ====
manual.y1 = -3.7
manual.y2 = 2.1

# plt.tea
inset.w = .22
inset.h = .05

x1 = 0.167
x2 = 0.61

y1 = .825
y2 = .88

plt.tea.a <- ggdraw()+
  draw_plot(plt.tea+ylim(manual.y1, manual.y2)) +
  # lead
  draw_plot(inset_plts$tea0, x = x1, y = y1, width = inset.w, height = inset.h)+
  draw_plot(inset_plts$tea0, x = x2, y = y1, width = inset.w, height = inset.h)+
  # follow
  draw_plot(inset_plts$tea0,   x = x1, y = y2, width = inset.w, height = inset.h)+
  draw_plot(inset_plts$tea22,  x = x2, y = y2, width = inset.w, height = inset.h)

### plot high voltage ####
# inset.w = .24
# inset.h = .05
#
# x1 = 0.1
# x2 = 0.7
#
# y1 = .825
# y2 = .88

plt.hv.a <- ggdraw()+
  draw_plot(plt.hv+ylim(manual.y1, manual.y2)) +
  # lead
  draw_plot(inset_plts$ha0, x = x1, y = y1, width = inset.w, height = inset.h)+
  draw_plot(inset_plts$ha0, x = x2, y = y1, width = inset.w, height = inset.h)+
  # follow
  draw_plot(inset_plts$ha90,   x = x1, y = y2, width = inset.w, height = inset.h)+
  draw_plot(inset_plts$ha90,  x = x2, y = y2, width = inset.w, height = inset.h)

plt.tea.hv.a <- plt.tea.a + plt.hv.a + plot_annotation(tag_levels = 'A')

## Standardized ====

inset.w = .12
inset.h = .05

x1 = 0.085
x2 = 0.32
x3 = 0.555
x4 = 0.792

y1 = .825
y2 = .88

plt.lv.a <- ggdraw()+
  draw_plot(plt.lv) +
  # lead
  draw_plot(inset_plts$s0, x = x1, y = y1, width = inset.w, height = inset.h)+
  draw_plot(inset_plts$s0, x = x2, y = y1, width = inset.w, height = inset.h)+
  draw_plot(inset_plts$s0, x = x3, y = y1, width = inset.w, height = inset.h)+
  draw_plot(inset_plts$s0, x = x4, y = y1, width = inset.w, height = inset.h)+
  # follow
  draw_plot(inset_plts$s0,   x = x1, y = y2, width = inset.w, height = inset.h)+
  draw_plot(inset_plts$s22,  x = x2, y = y2, width = inset.w, height = inset.h)+
  draw_plot(inset_plts$s45,  x = x3, y = y2, width = inset.w, height = inset.h)+
  draw_plot(inset_plts$s90,  x = x4, y = y2, width = inset.w, height = inset.h)


# ## Naturalistic ====

# inset.w = .12
# inset.h = .05
#
# x1 = 0.075
# x2 = 0.265
# x3 = 0.455
# x4 = 0.645
# x5 = 0.835
#
# y1 = .815
# y2 = .87
#
# plt.nv.a <- ggdraw()+
#   draw_plot(plt.nv) +
#   # lead
#   draw_plot(inset_plts$n0, x = x1, y = y1, width = inset.w, height = inset.h)+
#   draw_plot(inset_plts$n0, x = x2, y = y1, width = inset.w, height = inset.h)+
#   draw_plot(inset_plts$n0, x = x3, y = y1, width = inset.w, height = inset.h)+
#   draw_plot(inset_plts$n0, x = x4, y = y1, width = inset.w, height = inset.h)+
#   draw_plot(inset_plts$n0, x = x5, y = y1, width = inset.w, height = inset.h)+
#   # follow
#   draw_plot(inset_plts$n0,   x = x1, y = y2, width = inset.w, height = inset.h)+
#   draw_plot(inset_plts$n22,  x = x2, y = y2, width = inset.w, height = inset.h)+
#   draw_plot(inset_plts$n45,  x = x3, y = y2, width = inset.w, height = inset.h)+
#   draw_plot(inset_plts$n90,  x = x4, y = y2, width = inset.w, height = inset.h)+
#   draw_plot(inset_plts$n180, x = x5, y = y2, width = inset.w, height = inset.h)

indv1 <- stims[stims$Protocol %in% c("170828_lead.atf") , ]
indv2 <- stims[stims$Protocol %in% c("180717a_follow.atf") , ]
indv3 <- stims[stims$Protocol %in% c("180718_lead.atf") , ]



add_shifts_indv <- function(df = indv1){
  df <- cbind(df, data.frame(p0 = NA, p16 = NA, p8 = NA, p4 = NA, p2 = NA))
  df$Seconds <- df$Seconds - min(df$Seconds, na.rm = T)
  df$mV <- df$mV - min(df$mV, na.rm = T)

  df$p0 <- df$mV
  df$p16<- c(df$mV[seq(length(df$mV)-(ceiling(length(df$mV) / 16)-1), length(df$mV))],
             df$mV[seq(1, (length(df$mV)-ceiling(length(df$mV) / 16)))])
  df$p8 <- c(df$mV[seq(length(df$mV)-(ceiling(length(df$mV) / 8)-1), length(df$mV))],
             df$mV[seq(1, (length(df$mV)-ceiling(length(df$mV) / 8)))])
  df$p4 <- c(df$mV[seq(length(df$mV)-(ceiling(length(df$mV) / 4)-1), length(df$mV))],
             df$mV[seq(1, (length(df$mV)-ceiling(length(df$mV) / 4)))])
  df$p2 <- c(df$mV[seq(length(df$mV)-(ceiling(length(df$mV) / 2)-1), length(df$mV))],
             df$mV[seq(1, (length(df$mV)-ceiling(length(df$mV) / 2)))])
  return(df)
}


indv1 <- add_shifts_indv(df = indv1)
indv2 <- add_shifts_indv(df = indv2)
indv3 <- add_shifts_indv(df = indv3)

indvs <- do.call(rbind, list(indv1, indv2, indv3))



indv_inset_2color <- map(c("p0", "p16", "p8", "p4", "p2"), function(i){
  indvs %>%
    ggplot(aes(x= Seconds, group = "Protocol"))+
    # geom_segment(aes(x = 0, xend = 0, y = 0, yend = 5))+
    geom_path(aes_string(y = i), color = "darkgray")+
    geom_path(aes(y = p0))+
    facet_wrap(.~Protocol, scales = "free_y",
               ncol = 1)+
    theme_void()+
    theme(strip.text = element_blank())
})

names(indv_inset_2color) <- c("p0", "p16", "p8", "p4", "p2")





inset.w = .12
inset.h = .17

x1 = 0.075
x2 = 0.265
x3 = 0.455
x4 = 0.645
x5 = 0.835

y2 = .7

plt.nv.a <- ggdraw()+
  draw_plot(plt.nv) +
  draw_plot(indv_inset_2color$p0,   x = x1, y = y2, width = inset.w, height = inset.h)+
  draw_plot(indv_inset_2color$p16,  x = x2, y = y2, width = inset.w, height = inset.h)+
  draw_plot(indv_inset_2color$p8,  x = x3, y = y2, width = inset.w, height = inset.h)+
  draw_plot(indv_inset_2color$p4,  x = x4, y = y2, width = inset.w, height = inset.h)+
  draw_plot(indv_inset_2color$p2, x = x5, y = y2, width = inset.w, height = inset.h)

```

### Prototype version 2 of figure 4
Show variability in traces AND delay

```{r}






```



## Confirm no directionality or rectification

```{r}
M.directionality <-
M.clean %>% dplyr::select(Condition, Experiment, Time, Inj_Cell, rc, gj) %>% distinct() %>% as_tibble()

M.directionality %>%
  gather(key = "rec", value = "Resistance", c("rc", "gj")) %>%
  filter(!is.na(Resistance)) %>%
  spread(key = "Inj_Cell", value = "Resistance") %>%
  ggplot(aes(x = LC4, y = LC5, group = Condition, color = Condition, fill = Condition))+
  geom_abline(slope = 1, intercept = 0, color = "black")+
  geom_smooth(method = "lm", fullrange = T)+
  geom_point(shape = 1)+
  xlim(0, 30)+
  ylim(0, 30)+
  facet_grid(Time~Condition)+
  theme(legend.position = "bottom")

```

## Figures for DJS -- What's happening with currents?

```{r}
temp_df <- M.clean[M.clean$Condition %in% c("PS.0.High.Amp", "PS.22", "PS.45", "PS.0", "PS.22.High.Amp", "PS.90", "PS.90.HA", "PS.90.HA.Cd"), ]

# current_DV <- "intercept.peak_htk"


dv_array <- c("intercept.peak_htk", "slope.peak_htk", "intercept.end_htk", "slope.end_htk",
    "intercept.peak_a", "slope.peak_a", "intercept.end_a", "slope.end_a")



plt_list_currents <- map(
  dv_array, function(current_DV){

      temp_df$DV <- temp_df[[current_DV]]

      temp_df %>%
        dplyr::select(Condition, Experiment, Inj_Cell, Time, DV) %>%
        group_by(Condition, Experiment, Inj_Cell, Time) %>%
        summarise(DV = mean(DV, na.rm = T)) %>%
        ungroup() %>%
        # mutate(Time = as.character(Time)) %>%
        pivot_wider(names_from = Time, values_from = DV) %>%
        mutate(`20` = `20` - `0`,
               `40` = `40` - `0`,
               `60` = `60` - `0`) %>%
        mutate(`0` = 0) %>%
        pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "DV") %>%
        group_by(Condition, Time) %>%
        mutate(mean_DV = mean(DV, na.rm = T),
               mean_sd_up = mean_DV+sd(DV, na.rm = T),
               mean_sd_dn =mean_DV- sd(DV, na.rm = T),) %>%
        mutate(inter = paste(Experiment, Inj_Cell, sep = ".")) %>%
        ggplot(aes(x = Time,
                   y = DV,
                   # color = Experiment,
                   # shape = Inj_Cell,
                   group = inter))+
        geom_ribbon(aes(ymin=mean_sd_dn, ymax=mean_sd_up), fill = "gray", alpha = 0.1)+
        lemon::geom_pointline(size = point.size, linesize = line.size)+
        geom_point(size = point.size)+
        geom_point(aes(x = Time, y = mean_DV), color = "white", size = mean.point.size, alpha = 0.3)+
        geom_pointline(aes(x = Time, y = mean_DV), color = "firebrick", size = mean.point.size, linesize = mean.line.size,  shape = 1)+
        # labs(y = expression(paste(Delta, "Rc", " in M", Omega)), x = "Time in Minutes")+
        facet_grid(.~Condition,
                   labeller = labeller(Condition = condition.labs))+
        geom_hline(yintercept = 0)+
        theme(
          # axis.text = element_text(size = rel(2), angle = 0),
          text = element_text(size=text.size)
        )+
        labs(title = current_DV)
    })





temp_df$Condition <- as.character(temp_df$Condition)
temp_df[temp_df$Condition %in% c("PS.0.High.Amp", "PS.22.High.Amp", "PS.90.HA", "PS.90.HA.Cd"), "Condition"] <- "HighAmp"
temp_df[temp_df$Condition %in% c("PS.22", "PS.45", "PS.0", "PS.90"), "Condition"] <- "LowAmp"

plt_list_currents2 <- map(
  dv_array, function(current_DV){

      temp_df$DV <- temp_df[[current_DV]]

      temp_df %>%
        dplyr::select(Condition, Experiment, Inj_Cell, Time, DV) %>%
        group_by(Condition, Experiment, Inj_Cell, Time) %>%
        summarise(DV = mean(DV, na.rm = T)) %>%
        ungroup() %>%
        # mutate(Time = as.character(Time)) %>%
        pivot_wider(names_from = Time, values_from = DV) %>%
        mutate(`20` = `20` - `0`,
               `40` = `40` - `0`,
               `60` = `60` - `0`) %>%
        mutate(`0` = 0) %>%
        pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "DV") %>%
        group_by(Condition, Time) %>%
        mutate(mean_DV = mean(DV, na.rm = T),
               mean_sd_up = mean_DV+sd(DV, na.rm = T),
               mean_sd_dn =mean_DV- sd(DV, na.rm = T),) %>%
        mutate(inter = paste(Experiment, Inj_Cell, sep = ".")) %>%
        ggplot(aes(x = Time,
                   y = DV,
                   # color = Experiment,
                   # shape = Inj_Cell,
                   group = inter))+
        geom_ribbon(aes(ymin=mean_sd_dn, ymax=mean_sd_up), fill = "gray", alpha = 0.1)+
        lemon::geom_pointline(size = point.size, linesize = line.size)+
        geom_point(size = point.size)+
        geom_point(aes(x = Time, y = mean_DV), color = "white", size = mean.point.size, alpha = 0.3)+
        geom_pointline(aes(x = Time, y = mean_DV), color = "firebrick", size = mean.point.size, linesize = mean.line.size,  shape = 1)+
        # labs(y = expression(paste(Delta, "Rc", " in M", Omega)), x = "Time in Minutes")+
        facet_grid(.~Condition
                   # ,
                   # labeller = labeller(Condition = condition.labs)
                   )+
        geom_hline(yintercept = 0)+
        theme(
          # axis.text = element_text(size = rel(2), angle = 0),
          text = element_text(size=text.size)
        )+
        labs(title = current_DV)
    })






walk(seq_along(dv_array), function(i){
  current_DV <- dv_array[i]

ggsave(plt_list_currents2[[i]], path = here("data", "figures"),
       filename = paste("DJS_VC_Join-", current_DV, ".tiff", sep = ""))

ggsave(plt_list_currents[[i]], path = here("data", "figures"),
       filename = paste("DJS_VC_Sept-", current_DV, ".tiff", sep = ""))
})




temp_df_lc_similarity <- temp_df %>% dplyr::filter(Time == 0)



dv_array2 <- c("r11", "r12", "r1", "rc", "cc", "rmp", "gj",
               "gj", # <--- just a placeholder
               "intercept.peak_htk", "slope.peak_htk", "intercept.end_htk", "slope.end_htk", "intercept.peak_a", "slope.peak_a", "intercept.end_a", "slope.end_a")

similarity_plts <- map(seq_along(dv_array2), function(i){
  current_DV <- dv_array2[i]

  temp_df_lc_similarity$DV <- temp_df_lc_similarity[[current_DV]]

  plt <-
    temp_df_lc_similarity %>%
    dplyr::select(Experiment, Inj_Cell, DV) %>%
    dplyr::filter(!is.na(DV)) %>%
    # spread(Inj_Cell, DV) %>%
    ggplot(aes(x = Inj_Cell, y = DV, group = Experiment))+
    geom_line()+
    geom_point()+
    labs(title =  current_DV, x = "", y = "")

  if (current_DV=="rc"){
    plt <-
      temp_df_lc_similarity %>%
      dplyr::select(Experiment, Inj_Cell, DV) %>%
      dplyr::filter(!is.na(DV)) %>%
      dplyr::filter(DV < 20) %>%
      # spread(Inj_Cell, DV) %>%
      ggplot(aes(x = Inj_Cell, y = DV, group = Experiment))+
      geom_line()+
      geom_point()+
      labs(title =  current_DV, x = "", y = "")
  }

  return(plt)
})


similarity_plts[[8]] <- NA


# cowplot::plot_grid(plotlist = similarity_plts)

ggsave(cowplot::plot_grid(plotlist = similarity_plts), path = here("data", "figures"),
       filename = paste("DJS_LC_Similarity.tiff", sep = ""), width = 12, height = 12

       )












similarity_plts2 <- map(seq_along(dv_array2), function(i){
  current_DV <- dv_array2[i]

  temp_df_lc_similarity$DV <- temp_df_lc_similarity[[current_DV]]

  resample_iters = 1000

  real_diffs <- temp_df_lc_similarity %>%
    dplyr::select(Experiment, Inj_Cell, DV) %>%
    dplyr::filter(!is.na(DV)) %>%
    spread(Inj_Cell, DV) %>%
    dplyr::filter(!is.na(LC4)) %>%
    dplyr::filter(!is.na(LC5)) %>%
    mutate(DV_Diff = LC4-LC5) %>%
    mutate(iter = 0, real = T) %>%
    dplyr::select(Experiment, DV_Diff, iter, real)

  fake_diffs <- map(1:resample_iters, function(i){
    temp <- temp_df_lc_similarity

    # temp$inter <- paste(temp$Experiment, temp$Inj_Cell, sep = ".")
    #
    # temp$inter <- sample(temp$inter, replace = F)
    #
    # new_labels <- temp$inter %>% str_split(pattern = "\\.") %>% transpose()
    #
    # temp$Experiment <- unlist(new_labels[[1]])
    # temp$Inj_Cell <- unlist(new_labels[[2]])

    temp <- temp %>%
      dplyr::select(Experiment, Inj_Cell, DV) %>%
      dplyr::filter(!is.na(DV)) %>%
      spread(Inj_Cell, DV) %>%
      dplyr::filter(!is.na(LC4)) %>%
      dplyr::filter(!is.na(LC5)) %>%
      gather(Inj_Cell, DV, c("LC4", "LC5"))

    temp$DV <- sample(temp$DV)

    temp %>%
      spread(Inj_Cell, DV) %>%
      mutate(DV_Diff = LC4-LC5) %>%
      mutate(iter = i, real = F) %>%
      dplyr::select(Experiment, DV_Diff, iter, real)
  })

  compare_diffs <- rbind(real_diffs, do.call(rbind, fake_diffs))

  plt_a <-
    compare_diffs %>%
    ggplot(aes(x = DV_Diff, fill = real, color = real))+
    geom_vline(xintercept = 0, linetype = "dashed")+
    geom_density(alpha = 0.5)+
    labs(title =  current_DV, x = "", y = "")+
    theme(legend.position = "bottom")

  plt_b <-
    compare_diffs %>%
    ggplot(aes(x = DV_Diff, color = real))+
    stat_ecdf()+
    labs(title =  current_DV, x = "", y = "")+
    theme(legend.position = "bottom")

  # plt  <- plt_a + plt_b
  # return(plt)
  return(list(plt_a, plt_b))
})



similarity_plts2[[8]] <- list(NA, NA)


similarity_plts2 <- transpose(similarity_plts2)

ggsave(cowplot::plot_grid(plotlist = similarity_plts2[[1]], ncol = 4), path = here("data", "figures"),
filename = paste("DJS_LC_Similarity_density.tiff", sep = ""),
width = 12, height = 12
)

ggsave(cowplot::plot_grid(plotlist = similarity_plts2[[2]], ncol = 4), path = here("data", "figures"),
filename = paste("DJS_LC_Similarity_ecdf.tiff", sep = ""),
width = 12, height = 12
)

# ggsave(cowplot::plot_grid(plotlist = list(
#   similarity_plts2[[1]],
#   similarity_plts2[[2]],
#   similarity_plts2[[3]],
#   similarity_plts2[[4]],
#   similarity_plts2[[5]],
#   similarity_plts2[[6]],
#   similarity_plts2[[7]],
#   NA,
#   similarity_plts2[[8]],
#   similarity_plts2[[9]],
#   similarity_plts2[[10]],
#   similarity_plts2[[11]],
#   similarity_plts2[[12]],
#   similarity_plts2[[13]],
#   similarity_plts2[[14]],
#   similarity_plts2[[15]],
#   similarity_plts2[[16]]
# ), ncol = 4), path = here("data", "figures"),
# filename = paste("DJS_LC_Similarity_ecdf.tiff", sep = ""),
# width = 12, height = 12
#
# )






```

### What are the relationships between the trajectories?
```{r}
df <- M.clean[M.clean$Condition %in% c("PS.0.High.Amp", "PS.22", "PS.45", "PS.0", "PS.22.High.Amp", "PS.90", "PS.90.HA", "PS.90.HA.Cd"), ]

# current_DV <- "intercept.peak_htk"


dvs_for_delta <- c("r11", "r12", "r1", "rc", "cc", "rmp", "gj",
               "intercept.peak_htk", "slope.peak_htk", "intercept.end_htk", "slope.end_htk", "intercept.peak_a", "slope.peak_a", "intercept.end_a", "slope.end_a")

temp_delta_list <- map(
  dvs_for_delta, function(current_DV){
      temp_df <- df
      temp_df$DV <- temp_df[[current_DV]]

      temp_df <- temp_df %>%
        dplyr::select(Condition, Experiment, Inj_Cell, Time, DV) %>%
        group_by(Condition, Experiment, Inj_Cell, Time) %>%
        summarise(DV = mean(DV, na.rm = T)) %>%
        ungroup() %>%
        # mutate(Time = as.character(Time)) %>%
        pivot_wider(names_from = Time, values_from = DV) %>%
        mutate(`20` = `20` - `0`,
               `40` = `40` - `0`,
               `60` = `60` - `0`) %>%
        mutate(`0` = 0) %>%
        pivot_longer(cols = c(`0`, `20`, `40`, `60`), names_to = "Time", values_to = "DV") %>%
        group_by(Condition, Time) #%>%
        # mutate(mean_DV = mean(DV, na.rm = T),
        #        mean_sd_up = mean_DV+sd(DV, na.rm = T),
        #        mean_sd_dn =mean_DV- sd(DV, na.rm = T),) %>%
        # mutate(inter = paste(Experiment, Inj_Cell, sep = ".")) %>%
        # ggplot(aes(x = Time,
        #            y = DV,
        #            # color = Experiment,
        #            # shape = Inj_Cell,
        #            group = inter))+
        # geom_ribbon(aes(ymin=mean_sd_dn, ymax=mean_sd_up), fill = "gray", alpha = 0.1)+
        # lemon::geom_pointline(size = point.size, linesize = line.size)+
        # geom_point(size = point.size)+
        # geom_point(aes(x = Time, y = mean_DV), color = "white", size = mean.point.size, alpha = 0.3)+
        # geom_pointline(aes(x = Time, y = mean_DV), color = "firebrick", size = mean.point.size, linesize = mean.line.size,  shape = 1)+
        # # labs(y = expression(paste(Delta, "Rc", " in M", Omega)), x = "Time in Minutes")+
        # facet_grid(.~Condition,
        #            labeller = labeller(Condition = condition.labs))+
        # geom_hline(yintercept = 0)+
        # theme(
        #   # axis.text = element_text(size = rel(2), angle = 0),
        #   text = element_text(size=text.size)
        # )+
        # labs(title = current_DV)

      names(temp_df)[names(temp_df) == "DV"] <- current_DV

      return(temp_df)
    })

#

df2 <- temp_delta_list[[1]]
for (i in seq(2, length(temp_delta_list))){
  df2 <- full_join(df2, temp_delta_list[[i]])
}

plt1 <-
df2 %>% filter(Time %in% c(40)) %>%
  dplyr::filter(!(Condition %in% c("PS.90.HA", "PS.90.HA.Cd"))) %>%
  gather(Current, Value, c("intercept.peak_htk", "intercept.end_htk", "intercept.peak_a", "intercept.end_a"#,
                           # "slope.peak_htk", "slope.end_htk", "slope.peak_a", "slope.end_a"
                           )) %>%
  ggplot(aes(gj, Value, color = Condition, fill = Condition))+
  geom_hline(yintercept = 0, color = "darkgrey")+
  geom_vline(xintercept = 0, color = "darkgrey")+
  # geom_smooth(method = "lm", se = T, fullrange = T)+
  geom_point()+
  geom_point(shape = 1, color = "black")+
  facet_grid(Current~Condition)+
  # facet_wrap(Current~Condition, scales = "free")+
  theme(legend.position = "")+
  coord_cartesian(y = c(-100, 100))

plt2 <-
df2 %>% filter(Time %in% c(40)) %>%
  dplyr::filter(!(Condition %in% c("PS.90.HA", "PS.90.HA.Cd"))) %>%
  gather(Current, Value, c(#"intercept.peak_htk", "intercept.end_htk", "intercept.peak_a", "intercept.end_a",
                           "slope.peak_htk", "slope.end_htk", "slope.peak_a", "slope.end_a"
                           )) %>%
  ggplot(aes(gj, Value, color = Condition, fill = Condition))+
  geom_hline(yintercept = 0, color = "darkgrey")+
  geom_vline(xintercept = 0, color = "darkgrey")+
  # geom_smooth(method = "lm", se = T, fullrange = T)+
  geom_point()+
  geom_point(shape = 1, color = "black")+
  facet_grid(Current~Condition)+
  # facet_wrap(Current~Condition, scales = "free")+
  theme(legend.position = "")





plt1 + plt2
```








# Fig 1 traces
```{r}

# 180223_0009.abf
#
# Use 55-115 Sec
# For Inset,
# Use 55-64


library(readABF)
# Really just a wrapper for loadABF()
readABF_as_matrix <- function(
  path = "",
  channels = c("IN 4", "IN 9")){

  trace <- readABF::readABF(file = path)

  start.time <- trace$header$recTime[1]
  end.time <- trace$header$recTime[2]
  obs <- nrow(trace$data[[1]])

  temp <- trace$data[[1]][, (trace$channelNames %in% channels)]
  temp <- as.matrix(temp)

  colnames(temp) <- trace$channelNames[trace$channelNames %in% channels]
  temp <- cbind(temp, Time = seq(from = start.time,
                                 to = end.time,
                                 length.out = obs))

  return(temp)
}


# temp <- readABF::readABF(here("inst", "extdata", "all_5", "180223_0009.abf"))

temp <- readABF_as_matrix(path = here("inst", "extdata", "all_5", "180223_0009.abf"),
                          channels = c("IN 4", "IN 6", "IN 9", "IN 11", "IN 2", "IN 14"))

temp <- janitor::clean_names(dat = as.data.frame(temp), 'upper_camel')
temp <- as_tibble(temp)
temp <- temp %>% mutate(Seconds = Time - min(Time, na.rm = T))
# Select target time, 55-64 seconds in.
temp <- dplyr::filter(temp, Seconds > 55 & Seconds < 64)

# temp <- temp[seq(1, nrow(temp), by = 10), ]

temp2 <- temp

# Test out k params ----

smooth.k <- 7

plt.list <-
map(ceiling(seq(2, 27, length.out = 5)), function(smooth.k){
  temp <- temp2


  temp$In2 <- rollmean(temp$In2, k = smooth.k, fill = NA)
  temp$In4 <- rollmean(temp$In4, k = smooth.k, fill = NA)
  temp$In6 <- rollmean(temp$In6, k = smooth.k, fill = NA)
  temp$In9 <- rollmean(temp$In9, k = smooth.k, fill = NA)
  temp$In11 <- rollmean(temp$In11, k = smooth.k, fill = NA)
  temp$In14 <- rollmean(temp$In14, k = smooth.k, fill = NA)



  scale.bar.df <- as.data.frame(
    expand.grid(Ch = c("LC1", "LC2", "LC3", "LC4", "LC5"),
                Seconds = c(0,0),
                mV = c(0,3)))

  scale.bar.df <- rbind(scale.bar.df, data.frame(Ch = "LC1", Seconds = 1, mV = 3))

  plt <- temp %>%
    gather(c("In2",  "In4",  "In6",  "In9",  "In11", "In14"), key = "Ch", value = "mV") %>%
    mutate(Ch = ifelse(Ch == "In2", "LC4",
                       ifelse(Ch == "In4", "LC5",
                              ifelse(Ch == "In6", "LC3",
                                     ifelse(Ch == "In9", "LC2",
                                            ifelse(Ch == "In11", "LC1",
                                                   ifelse(Ch == "In14", "Trunk", "NA")
                                            )
                                     )
                              )
                       )
    )
    ) %>%
    group_by(Ch) %>%
    mutate(mV = mV - min(mV, na.rm = T)) %>%
    ungroup() %>%
    mutate(Seconds = Seconds - min(Seconds, na.rm = T)) %>%
    ggplot(aes(Seconds, mV, color = Ch))+
    # geom_path(data = scale.bar.df, color = "black", size = 2)+
    geom_path()+
    # facet_wrap(Ch~., ncol = 1)+
    facet_wrap(Ch~., ncol = 1, scales = "free")+
    theme_void()+
    theme(legend.position = "")+
    # scale_color_manual(values = c(RColorBrewer::brewer.pal(7, "Reds")[3:7], "Black")) # Nice analogous scheme
    scale_color_manual(values = c(rep(RColorBrewer::brewer.pal(7, "Reds")[7], times = 5), "Black")) # save color for easy comparison on k

  return(plt)

})

cowplot::plot_grid(plotlist = plt.list, nrow = 1)


# Test out SNR based K selection ----
plt.list <-
map(c(1, 5, 10, 100, 1000),
  # ceiling(seq(1, 50, length.out = 5)),
  function(smooth.k){
  temp <- temp2

  # We want a higher K based on the range which we'll uses as a proxy for SNR
  # If the relative range is high then we want a low K, so we set a high k and scale it down with ceiling(k/ XminRange)
  k.scaling.factors <- temp %>%
    gather(c("In2",  "In4",  "In6",  "In9",  "In11", "In14"), key = "Ch", value = "mV") %>%
    group_by(Ch) %>%
    dplyr::summarize(range = abs(max(mV) - min(mV)) ) %>%
    mutate(range = range/min(range))

  temp$In2 <-  zoo::rollmean(temp$In2,  k = as.numeric(ceiling(smooth.k/ k.scaling.factors[k.scaling.factors$Ch == "In2", "range"])), fill = NA)
  temp$In4 <-  zoo::rollmean(temp$In4,  k = as.numeric(ceiling(smooth.k/ k.scaling.factors[k.scaling.factors$Ch == "In4", "range"])), fill = NA)
  temp$In6 <-  zoo::rollmean(temp$In6,  k = as.numeric(ceiling(smooth.k/ k.scaling.factors[k.scaling.factors$Ch == "In6", "range"])), fill = NA)
  temp$In9 <-  zoo::rollmean(temp$In9,  k = as.numeric(ceiling(smooth.k/ k.scaling.factors[k.scaling.factors$Ch == "In9", "range"])), fill = NA)
  temp$In11 <- zoo::rollmean(temp$In11, k = as.numeric(ceiling(smooth.k/ k.scaling.factors[k.scaling.factors$Ch == "In11", "range"])), fill = NA)
  temp$In14 <- zoo::rollmean(temp$In14, k = as.numeric(ceiling(smooth.k/ k.scaling.factors[k.scaling.factors$Ch == "In14", "range"])), fill = NA)

  scale.bar.df <- as.data.frame(
    expand.grid(Ch = c("LC1", "LC2", "LC3", "LC4", "LC5"),
                Seconds = c(0,0),
                mV = c(0,3)))

  scale.bar.df <- rbind(scale.bar.df, data.frame(Ch = "LC1", Seconds = 1, mV = 3))

  plt <- temp %>%
    gather(c("In2",  "In4",  "In6",  "In9",  "In11", "In14"), key = "Ch", value = "mV") %>%
    mutate(Ch = ifelse(Ch == "In2", "LC4",
                       ifelse(Ch == "In4", "LC5",
                              ifelse(Ch == "In6", "LC3",
                                     ifelse(Ch == "In9", "LC2",
                                            ifelse(Ch == "In11", "LC1",
                                                   ifelse(Ch == "In14", "Trunk", "NA")
                                            )
                                     )
                              )
                       )
    )
    ) %>%
    group_by(Ch) %>%
    mutate(mV = mV - min(mV, na.rm = T)) %>%
    ungroup() %>%
    mutate(Seconds = Seconds - min(Seconds, na.rm = T)) %>%
    ggplot(aes(Seconds, mV, color = Ch))+
    # geom_path(data = scale.bar.df, color = "black", size = 2)+
    geom_path()+
    # facet_wrap(Ch~., ncol = 1)+
    facet_wrap(Ch~., ncol = 1, scales = "free")+
    theme_void()+
    theme(legend.position = "")+
    # scale_color_manual(values = c(RColorBrewer::brewer.pal(7, "Reds")[3:7], "Black")) # Nice analogous scheme
    scale_color_manual(values = c(rep(RColorBrewer::brewer.pal(7, "Reds")[7], times = 5), "Black")) # save color for easy comparison on k

  return(plt)

})

cowplot::plot_grid(plotlist = plt.list, nrow = 1, labels = c("1", "5", "10", "100", "1000"))#labels = LETTERS)
```



# Write out figures
```{r}
#
#
# fig1.part
# ggsave(here("data", "figures", "fig1.part.png"), plot = last_plot(), width = 5, height = 5, units = "in")
#
# plt.tea.hv.a
# ggsave(here("data", "figures", "fig2.png"), plot = last_plot(), width = 7.14, height = 5.81, units = "in")
#
#
# plt.lv.a
# ggsave(here("data", "figures", "fig3.png"), plot = last_plot(), width = 7.14, height = 5.81, units = "in")
#
#
# plt.nv.a+labs(subtitle = expression(paste("Varied Waveforms Produce Inconsistent Effects of Phase on ", Delta, "Rc"))) + plt.nv.aicc+labs(subtitle = expression(paste("Efficacy of Predictors to Explain  ", Delta, "Rc"))) + plot_layout(widths = c(3, 2), ) + plot_annotation(tag_levels = 'A')
#
# ggsave(here("data", "figures", "fig4.png"), plot = last_plot(), width = 10.68, height = 5.81, units = "in")



fig1.part
ggsave(here("data", "figures", "fig1.part.pdf"), plot = last_plot(), width = 5, height = 5, units = "in")
ggsave(here("data", "figures", "fig1.part.svg"), plot = last_plot(), width = 5, height = 5, units = "in")

plt.tea.hv.a
ggsave(here("data", "figures", "fig2.pdf"), plot = last_plot(), width = 7.14, height = 5.81, units = "in")
ggsave(here("data", "figures", "fig2.svg"), plot = last_plot(), width = 7.14, height = 5.81, units = "in")

plt.lv.a
ggsave(here("data", "figures", "fig3.pdf"), plot = last_plot(), width = 7.14, height = 5.81, units = "in")
ggsave(here("data", "figures", "fig3.svg"), plot = last_plot(), width = 7.14, height = 5.81, units = "in")

plt.nv.a+labs(subtitle = expression(paste("Varied Waveforms Produce Inconsistent Effects of Phase on ", Delta, "Rc"))) + plt.nv.aicc+labs(subtitle = expression(paste("Efficacy of Predictors to Explain  ", Delta, "Rc"))) + plot_layout(widths = c(3, 2)) + plot_annotation(tag_levels = 'A')
ggsave(here("data", "figures", "fig4.pdf"), plot = last_plot(), width = 10.68, height = 5.81, units = "in")
ggsave(here("data", "figures", "fig4.svg"), plot = last_plot(), width = 10.68, height = 5.81, units = "in")

library(cowplot)
cowplot::plot_grid(plotlist = list(
plt.nv.a+labs(subtitle = expression(paste("Varied Waveforms Produce Inconsistent Effects of Phase on ", Delta, "Rc"))),
plt.nv.aicc+labs(subtitle = expression(paste("Efficacy of Predictors to Explain  ", Delta, "Rc")))
))
ggsave(here("data", "figures", "fig4'.pdf"), plot = last_plot(), width = 10.68, height = 5.81, units = "in")
ggsave(here("data", "figures", "fig4'.svg"), plot = last_plot(), width = 10.68, height = 5.81, units = "in")

```

##### addition 2021 11 11
```{r}
plt.tea.cc+ plt.hv.cc + plot_annotation(tag_levels = 'A')
ggsave(here("data", "figures", "fig2CC.pdf"), plot = last_plot(), width = 7.14, height = 5.81, units = "in")
ggsave(here("data", "figures", "fig2CC.svg"), plot = last_plot(), width = 7.14, height = 5.81, units = "in")


plt.lv.cc
ggsave(here("data", "figures", "fig3CC.pdf"), plot = last_plot(), width = 7.14, height = 5.81, units = "in")
ggsave(here("data", "figures", "fig3CC.svg"), plot = last_plot(), width = 7.14, height = 5.81, units = "in")


```
##### end of same




```{r}
# library(nlme)
# library(multcomp)
#
# anova(mod <- lme(Yield~Crop, random=~1|ID, data=DFField, method="ML",na.action=na.omit))
#
# glht(mod, linfct=mcp(Crop="Tukey"))
```








# Reference asymptotic regression

```{r}
library(brms)

prior1 <- prior(normal(-2, 0.5), nlpar = "v0") + 
          prior(normal(12, 2), nlpar = "tau")


# fit1 <- brm(bf(gj ~ v0*(1-exp((-1*Time) / tau )), 
#                v0 + tau ~ 1, 
#                nl = TRUE),
#             data = temp, 
#             prior = prior1)


# charging
# Vt = v0(1-e^(-t/tau))
# discharging
# Vt = v0(e^(-t/tau))



# stan(..., control = list(adapt_delta = 0.99))
fit1 <- brm(bf(gj ~ v0*(1-exp((-1*Time) / tau )),
               # v0 ~ 1 | Condition,
               nonlinear = list(v0 ~ 1 | Condition, tau ~ 1),
               # v0 + tau ~ 1,
               nl = TRUE
               # ,
               # family = student()
               ),
            data = temp,
            prior = prior1,
            chains = 4, cores = 4)




plot(conditional_effects(fit1), points = TRUE)

temp %>% 
  modelr::data_grid(Time = modelr::seq_range(Time, n = 101)) %>% 
  tidybayes::add_predicted_draws(fit1) %>%
  ggplot(aes(Time))+
  ggdist::stat_lineribbon(aes(y = .prediction), .width = c(.99, .95, .8, .5), color = "#08519C") +
  geom_point(data = temp, 
             aes(y = gj, group = interaction(Experiment, Inj_Cell)))+
  geom_line(data = temp, 
             aes(y = gj, group = interaction(Experiment, Inj_Cell), 
                 color = Condition))+
  scale_fill_brewer()


summary(fit1)
plot(fit1)



```


```{r}
v0 = 20
v1 = 40
tau = 12
x <- rep(c(0, 20, 40, 60), each = 20)

trt1 = map_dbl(x, function(i){ rnorm(1, mean =  v0*(1-exp((-1*i) / tau )) ,  sd = 5 ) })
trt2 = map_dbl(x, function(i){ rnorm(1, mean =  v1*(1-exp((-1*i) / tau )) ,  sd = 5 ) })
dat1 <- data.frame(x, trt1, trt2)
dat1[dat1$x == 0, c('trt1', 'trt2')] = 0

dat1 = dat1 %>% pivot_longer(names_to = "key", values_to = "y", cols =c('trt1', 'trt2'))

ggplot(dat1, aes(x, y, color = key))+geom_point()


prior1 <- prior(normal(20, 2), nlpar = "v0") + 
          prior(normal(0, 2), nlpar = "tau")

fit1 <- brm(bf(y ~ v0*(1-exp((-1*x) / tau )), 
               v0 ~ 1 | key,
               tau ~ 1, 
               nl = TRUE),
            data = dat1, 
            prior = prior1)



summary(fit1)
plot(fit1)

plot(conditional_effects(fit1), points = TRUE)


```




```{r}
b <- c(2, 0.75)
x <- seq(0, 60)
y <- rnorm(100, mean = b[1] * exp(b[2] * x))
dat1 <- data.frame(x, y)

plot(y, x)

prior1 <- prior(normal(1, 2), nlpar = "b1") +
  prior(normal(0, 2), nlpar = "b2")
fit1 <- brm(bf(y ~ b1 * exp(b2 * x), b1 + b2 ~ 1, nl = TRUE),
            data = dat1, prior = prior1)


summary(fit1)
plot(fit1)

plot(conditional_effects(fit1), points = TRUE)




```

```{r}
val_A= -2
val_gamma = 1
val_tau = 0

Time = seq(0, 10)
gj = val_A/(1+exp(-val_gamma/(Time-val_tau)))

simM = data.frame(gj,
                  Time)
plot(gj ~ Time)

nlm1 <- nls(gj ~  A/(1+exp(-gamma*(Time-tau))), start=c(A=-2, gamma=1, tau=0), data = simM)



fit <- nls(Weight ~ SSlogis(Age, Asym, xmid, scal), data=DF)
summary(fit)


nls(gj ~ SSasymp(Time), data = temp)


library(nlme)

# variance increases with a power of the absolute fitted values
fm1 <- gnls(weight ~ SSlogis(Time, Asym, xmid, scal), Soybean,
weights = varPower())
summary(fm1)

nlme::gnls(gj ~ v0*(1-exp((-1*Time) / tau )), 
           start=c(v0=-2,tau = 12), 
           data = temp)


EXP=function(x,L0,K) {
y=L0*exp(K*x)
y
}    
EXP.nlme=nlme(gj~EXP(Time,L0,K), data = temp)



library("nlstools")
formulaExp <- as.formula(gj ~ v0*(1 - exp(-(Time) / mu)))
fm <- nls(formulaExp, 
          start = list(v0 = -2,
                       mu = 1), 
          data = temp)

# 




SSasymp(-2:4, Asym=7, R0=2, lrc=.1)
SSasympOff(-2:4, Asym=7, c0=1/exp(.1) * log(1-2/7), lrc=.1)
with(list(Upper=7, ZeroPt=2, LogRate=.1), SSasymp(-2:4, Upper, ZeroPt, LogRate))
tDat <- data.frame(
    effort = c(0, 1, 2, 5, 8, 10),
    result = c(2, 5.34, 6.45, 6.82, 6.98, 7))
nls(result ~ SSasymp(effort, Upper, ZeroPt, LogRate), data=tDat)
    




Lob.329 <- Loblolly[ Loblolly$Seed == "329", ]

SSasymp( Lob.329$age, 100, -8.5, -3.2 )   # response only
local({
  Asym <- 100 ; resp0 <- -8.5 ; lrc <- -3.2
  SSasymp( Lob.329$age, Asym, resp0, lrc) # response _and_ gradient
})

getInitial(height ~ SSasymp( age, Asym, resp0, lrc), data = Lob.329)
## Initial values are in fact the converged values
fm1 <- nls(height ~ SSasymp( age, Asym, resp0, lrc), data = Lob.329)
summary(fm1)

   
M = Loblolly[ Loblolly$Seed %in% c("329", "331"), ]
fm = nls(height ~ SSasymp(age,  #
                          Asym,  # horizontal asymptote
                          resp0, # response when input is zero.
                          lrc    # numeric parameter representing the natural logarithm of the rate constant.
                          ), , data = M)
summary(fm)


plot(M)

nls(height ~ as.numeric(Seed == "329")*(vmax1)*(Time/(Time+(km1)))+
      as.numeric(Seed == "331")*(vmax2)*(Time/(Time+(km2))),
    data = M,
    start = list(vmax1 = 60, km1 = 3,
                 vmax2 = 60, km2 = 3,
                 Time = 0)
    
    )


nls(formula = percent_on_cells ~ 
              as.numeric(DOC==0)*(vmax1)*(Time/(Time+(km1))) 
            + as.numeric(DOC==1)*(vmax2)*(Time/(Time+(km2)))
            + as.numeric(DOC==10)*(vmax3)*(Time/(Time+(km3)))
            + as.numeric(DOC==100)*(vmax4)*(Time/(Time+(km4))),
            data = mehg, 
            start = list(vmax1=0.63, km1=3.6, 
                         vmax2=0.64, km2=3.6, 
                         vmax3=0.50, km3=3.2,
                         vmax4= 0.40, km4=9.7))
```


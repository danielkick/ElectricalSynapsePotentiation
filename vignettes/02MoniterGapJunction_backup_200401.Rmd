---
title: 'Chapter 2: Transjunctional voltage is responsible for activity dependent gap
  junction modulation'
author: "Daniel R. Kick"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library("tidyverse") # Plotting and data manipulation
library("cowplot") # clean up ggplots, plotgrid
library("ggthemes")
library("nlme") # for nested anova via lme. See http://www.jason-french.com/tutorials/repeatedmeasures.html
library("multcomp")
library("lemon")
library(Hmisc) # for mean_sdl ribbons
library("ggthemes")
library("ggsci")
library("car")
library("agricolae")

# library("brms")
# 
# # fm <- brm(gj ~ Phase*Amp, 
# #           data = dplyr::filter(d, Time == 60),
# #           family = gaussian())
# # 
# # plot(fm, pars = c("Phase", "Amp"))
# # plot(marginal_effects(fm, effects = "Phase:Amp"))
# # 
# # stanplot(fm)
# 
# library(bayesplot)
# # fmm <- as.matrix(fm)
# # mcmc_areas(fmm,
# #            pars = c("b_Phase22.5", "b_Amplow", "b_Phase22.5:Amplow"),
# #            prob = 0.8)
# 
# # color_scheme_set("red")
# # ppc_dens_overlay(y = fm$,
# #                  yrep = posterior_predict(fmm, draws = 50))
# 
# 
# # fit %>%
# #   posterior_predict(draws = 500) %>%
# #   ppc_stat_grouped(y = mtcars$mpg,
# #                    group = mtcars$carb,
# #                    stat = "median")
# 
# 
# plot(estimate_density(fm))
# plot(p_direction(fm))
# 

library(see)
library(bayestestR)
library(rstanarm)
library(estimate)


library(here)

source(here("R", "02MoniterGapJunction.R"))

theme_set(kickme())
```

#global todo
```{r}
# TODO Change all the file = paste0(working.dir, "/data/tecc.rds") to file = paste0("./data/tecc.rds")
ttock <- Sys.time()

# TODO 
```


# Read in and aggregate data 
```{r read in data, eval=TRUE, include=FALSE}
# Run settings ----
resample.results = T # If not TRUE resampled model list will be loaded from a previous save
resample.nreps <- 1e4 #FIXME

# Preprocessing ----
working.dir <- getwd() #FIXME FYI, this should be the project root. Ideally this should have relied on `here`

tecc <- readRDS(file = paste0(working.dir, "/data/tecc.rds"))
tevc <- readRDS(file = paste0(working.dir, "/data/tevc.rds"))
htk <- readRDS(file = paste0(working.dir, "/data/htk.rds"))
a <- readRDS(file = paste0(working.dir, "/data/a.rds"))

tecc <- collapse_duplicate_gj_obs(tecc)
tevc <- collapse_duplicate_gj_obs(tevc)

## Reduce ionic current observations to a single one at a given target voltage. ====
### split into peak and end ####
htk.p <- htk[, !(names(htk) %in% c("htk.end.mV", "htk.end.nA"))]
htk.e <- htk[, !(names(htk) %in% c("htk.peak.mV", "htk.peak.nA"))]
a.p <- a[, !(names(a) %in% c("a.end.mV", "a.end.nA"))]
a.e <- a[, !(names(a) %in% c("a.peak.mV", "a.peak.nA"))]

### apply to each current type and time ####

# TODO this no longer works. (tested on R 3.6)
# htk.p <- collapse_duplicate_current_obs(
#   input.df = htk.p,
#   target.mV = 0,
#   prefer.pn = "online",
#   prefer.recording = "highest",
#   deduplicate = "closest"
# )
# 
# htk.e <- collapse_duplicate_current_obs(
#   input.df = htk.e,
#   target.mV = 0,
#   prefer.pn = "online",
#   prefer.recording = "highest",
#   deduplicate = "closest"
# ) 
# 
# a.p <- collapse_duplicate_current_obs(
#   input.df = a.p,
#   target.mV = 0,
#   prefer.pn = "",
#   prefer.recording = "highest",
#   deduplicate = "closest"
# )
# 
# a.e <- collapse_duplicate_current_obs(
#   input.df = a.e,
#   target.mV = 0,
#   prefer.pn = "",
#   prefer.recording = "highest",
#   deduplicate = "closest"
# )


## Join independent data types into a single data frame ====

#FIXME see above
all.data <- full_join(tecc, tevc) #%>% full_join(htk.p) %>% full_join(htk.e) %>% full_join(a.p) %>% full_join(a.e) 
all.data <- all.data[, c(
  "Condition", "Experiment", "Time", "Inj_Cell",
  "tecc.recording", "tevc.recording", 
  #"htk.recording", "a.recording", "subtracted.rin",
  "r11", "r12", "r1", "rc", "cc", "rmp", "gj"#,
  #"htk.peak.mV", "htk.peak.nA", "htk.end.mV", "htk.end.nA",
  #"a.peak.mV", "a.peak.nA", "a.end.mV", "a.end.nA"
)]

all.data <- all.data %>% as.data.frame()
```

```{r}
## Rename conditions ====
rename.df <- as.data.frame(list(
  c("Aberrant Depol", "PS.0.High.Amp"), 
  c("Aberrant_Depol_22.5_deg", "PS.22.High.Amp"), 
  
  c("HA 90 Degree", "PS.90.HA"), 
  c("HA 90 Degree Cd", "PS.90.HA.Cd"), 
  
  c("0_deg", "PS.0"), 
  c("22.5_degrees", "PS.22"), 
  c("rep 45 Degree", "PS.45"), 
  c("rep 90 Degree", "PS.90"), 
  
  c("PS.0.orig", "PS.0.orig"), 
  c("PS.22.orig", "PS.22.orig"), 
  c("PS.45.orig", "PS.45.orig"),
  c("PS.90.orig", "PS.90.orig"), 
  c("PS.180.orig", "PS.180.orig"), 
  
  c("hold_at_-53mV", "Silent.53mV"), 
  c("TEA_ControlWave", "PS.0.TEA"),
  c("PS.0.TEA", "PS.0.TEA"),
  c("TEA_Silent", "Silent.TEA"), 
  c("Inverted Wave", "Inv"), 
  
  c("TEA.Active", "TEA.Active")
))

rename.df <- as.data.frame(t(rename.df))
names(rename.df) <- c("old", "new")
rownames(rename.df) <- NULL # get rid of rownames

all.data$changed <- F
for (i in seq(1, nrow(rename.df))){
  all.data[all.data$Condition == as.character(rename.df[i, "old"]), "Condition"] <- as.character(rename.df[i, "new"])
  all.data[all.data$Condition == as.character(rename.df[i, "old"]), "changed"] <- T
}
# print out the unchanged rows
print(all.data[!all.data$changed & !(all.data$Condition %in% as.vector(rename.df[, "new"])), ])
#and drop
all.data <- all.data[, !(names(all.data) %in% c("changed"))] 

# reorder factors
all.data$Condition <- factor(all.data$Condition, as.vector(rename.df[, "new"]) )

# #NOTE: this needs to be changed if new conditions are added
# 
# conditions <- all.data$Condition %>% unique()
# 
# new.conditions <- c("PS.0.High.Amp", "Inv", "PS.0", "PS.0.TEA", "Silent.TEA", "PS.22", "PS.22.High.Amp", "PS.22.orig", "PS.45", 
#                     "PS.90",
#                     "HA 90 Degree",
#                     "Silent.53mV",  "PS.0.orig", "PS.180.orig", "PS.90.orig", "PS.45.orig",
#                     "TEA.Active") #FIXME
# 
# 
# 
# 
# # new.conditions <- c("PS.0.High.Amp", "Inv", "PS.0", "PS.0.TEA", "Silent.TEA", "PS.22", "PS.22.High.Amp", "PS.22.orig", "PS.45", 
# #                     "PS.90",
# #                     "HA 90 Degree",
# #                     "Silent.53mV",  "PS.0.orig", "PS.180.orig", "PS.90.orig", "PS.45.orig",
# #                     "TEA.Active") #FIXME
# 
# for (i in 1:length(conditions)) {
#   all.data[all.data$Condition == conditions[i], "Condition" ] <- new.conditions[i]
# }
# 
# # reorder factors
# all.data$Condition <- factor(all.data$Condition, c(
#   "PS.0", "PS.22", "PS.45", 
#   "PS.90",
#   "HA 90 Degree",
#   "PS.0.High.Amp", "PS.22.High.Amp", 
#   "PS.0.orig", "PS.22.orig", "PS.45.orig", "PS.90.orig", "PS.180.orig", 
#   "PS.0.TEA", "Silent.TEA", "Inv", "Silent.53mV",
#   "TEA.Active"
# ))

### NOTE: setting silent TEA to PS0TEA: ####
#ignore silent TEA
# all.data[all.data$Condition == "Silent.TEA", "Condition"] <- "PS.0.TEA"

## Drop outliers by the following rules: ====

#convert gj to inverse to make it easier to work with.
all.data$gj <- (1/all.data$gj) 
```


QC
```{r}
### 1. Resistances can't be zero, drop any which are.  ####
all.data[(all.data$r11 < 0) & !is.na(all.data$r11) , "r11"] <- NA
all.data[(all.data$r1 < 0) & !is.na(all.data$r1) , "r1"] <- NA
all.data[(all.data$rc < 0) & !is.na(all.data$rc) , "rc"] <- NA
all.data[(all.data$gj < 0) & !is.na(all.data$gj) , "gj"] <- NA

# 2. If coupling coef is less than 0 or above 1, drop it. ####
all.data[(all.data$cc > 1 | all.data$cc < 0) & !is.na(all.data$cc) , "cc"] <- NA

# for condition | time | response var
conditions <- all.data$Condition %>% unique()
times <- all.data$Time %>% unique()
response.vars <- c("r11", "r1", "cc", "a.peak.nA", "htk.peak.nA", "rc", "gj")

multiplier <-  2
use.method <- "use.sd" #use.iqr

tic <- Sys.time()
for (i in seq_along(conditions)) {
  for (j in seq_along(times)) {
    for (k in seq_along(response.vars)) {
      if (use.method == "use.sd") {
        current.mean <- all.data[all.data$Condition == conditions[i] &
          all.data$Time == times[j], response.vars[k]] %>% mean(na.rm = TRUE)
        current.sd <- all.data[all.data$Condition == conditions[i] &
          all.data$Time == times[j], response.vars[k]] %>% sd(na.rm = TRUE)

        all.data[all.data$Condition == conditions[i] & all.data$Time == times[j] & ((all.data[[response.vars[k]]] < (current.mean - (multiplier * current.sd))) | (all.data[[response.vars[k]]] > (current.mean + (multiplier * current.sd)))) & !(is.na(all.data[[response.vars[k]]])), response.vars[k]] <- NA
      } else if (use.method == "use.iqr") {
        current.median <- all.data[all.data$Condition == conditions[i] &
          all.data$Time == times[j], response.vars[k]] %>% median(na.rm = TRUE)
        current.iqr <- all.data[all.data$Condition == conditions[i] &
          all.data$Time == times[j], response.vars[k]] %>% IQR(na.rm = TRUE)

        all.data[all.data$Condition == conditions[i] & all.data$Time == times[j] & ((all.data[[response.vars[k]]] < (current.median - (multiplier * current.iqr))) | (all.data[[response.vars[k]]] > (current.median + (multiplier * current.iqr)))) & !(is.na(all.data[[response.vars[k]]])), response.vars[k]] <- NA
      } else {
        warning(paste(as.character(use.method), "is not use.sd or use.iqr!"))
      }
    }
  }
}
print(Sys.time() - tic)
```


### Reduce dataset


```{r}
# Reduce data to target times ----
all.data <- all.data[all.data$Time %in% c(0, 20, 40, 60) |
                       all.data$Condition == "TEA.Active", ]

```



## Drop questionable observation
```{r}
all.data <- all.data[all.data$Experiment != "170817a",]
```

### Calculate deltas and percent changes 
```{r}
## Calculate percent change for later use: ====
all.data.p <- convert_data_to(
  input.df = all.data,
  convert.to = c("percent"),
  data.cols = c(
    "r11", "r12", "r1", "rc", "cc", "rmp", "gj"#,
    #FIXME as above, so below
    # "htk.peak.mV", "htk.peak.nA", "htk.end.mV", "htk.end.nA",
    # "a.peak.mV", "a.peak.nA", "a.end.mV", "a.end.nA"
  )
)



all.data.d <- convert_data_to(
  input.df = all.data,
  convert.to = c("difference"),
  data.cols = c(   "r11", "r12", "r1", "rc", "cc", "rmp", "gj"#,
                    #FIXME as above, so below
                   # "htk.peak.mV", "htk.peak.nA", "htk.end.mV", "htk.end.nA",
                   # "a.peak.mV", "a.peak.nA", "a.end.mV", "a.end.nA"
  )
)

M <- all.data#[all.data$Time %in% c(0, 20, 40, 60) , ]
M.p <- all.data.p#[all.data.p$Time %in% c(0, 20, 40, 60) , ]
M.d <- all.data.d#[all.data.d$Time %in% c(0, 20, 40, 60) , ] 

## Deduplicate gap junction measurements ====
M.gj<- deduplicate_gj_obs(input.df = M)
M.p.gj<- deduplicate_gj_obs(input.df = M.p)
M.d.gj <- deduplicate_gj_obs(input.df = M.d)
```


# Drop questionable observations
```{r drop questionable data}
# #there are some experiment timepoints which need to be replaced wholesale and others which have a duplicated that behaves oddly. To clean up this data I have dropped the following duplicated values
# df.tevc_gj$drop <- FALSE
# 
# 
# df.tevc_gj[df.tevc_gj$Experiment == "180214" & 
#              df.tevc_gj$`Time Exposed` == 40 & 
#              df.tevc_gj$inj_in_IN4 == F &
#              df.tevc_gj$Recording == 38, "drop"] <- TRUE
# 
# df.tevc_gj[df.tevc_gj$Experiment == "180212" & 
#              df.tevc_gj$`Time Exposed` == 40 & 
#              df.tevc_gj$inj_in_IN4 == F &
#              df.tevc_gj$Recording == 50, "drop"] <- TRUE #%>% hist()
# 
# df.tevc_gj[df.tevc_gj$Experiment == "180214" & 
#              df.tevc_gj$`Time Exposed` == 40 & 
#              df.tevc_gj$inj_in_IN4 == T &
#              df.tevc_gj$Recording == 42, "drop"] <- TRUE
# 
# df.tevc_gj[df.tevc_gj$Experiment == "180212" & 
#              df.tevc_gj$`Time Exposed` == 40 & 
#              df.tevc_gj$inj_in_IN4 == T &
#              df.tevc_gj$Recording == 50, "drop"] <- TRUE
# 
# df.tevc_gj[df.tevc_gj$Experiment == "180125" & 
#              df.tevc_gj$`Time Exposed` == 0 & 
#              df.tevc_gj$inj_in_IN4 == T &
#              df.tevc_gj$Recording == 43, "drop"] <- TRUE
# 
# df.tevc_gj[df.tevc_gj$Experiment == "180507" & #Looks like voltage sensing electrode in IN9 was slipping out. Ihtk like activity. 
#              df.tevc_gj$`Time Exposed` == 40 & 
#              df.tevc_gj$inj_in_IN4 == F &
#              df.tevc_gj$Recording == 13, "drop"] <- TRUE
# 
# df.tevc_gj <- df.tevc_gj[df.tevc_gj$drop != TRUE, ]
# df.tevc_gj <- df.tevc_gj[, !(names(df.tevc_gj) %in% c("drop"))]
# 
# #df.tevc_gj[df.tevc_gj$Experiment == "180125" & 
# #               df.tevc_gj$`Time Exposed` == 0 & 
# #               df.tevc_gj$inj_in_IN4 == T, c("Recording", "gj")]
```

> Seems to contain at least some of the to drop points.
[1] 1.235307
numeric(0)
[1] 1.431159
numeric(0)
numeric(0)
[1]       NA 3.821254

```{r}
# # df.tevc_gj[df.tevc_gj$Experiment == "180214" & 
# #              df.tevc_gj$`Time Exposed` == 40 & 
# #              df.tevc_gj$inj_in_IN4 == F &
# #              df.tevc_gj$Recording == 38, "drop"] <- TRUE
# # 
# # df.tevc_gj[df.tevc_gj$Experiment == "180212" & 
# #              df.tevc_gj$`Time Exposed` == 40 & 
# #              df.tevc_gj$inj_in_IN4 == F &
# #              df.tevc_gj$Recording == 50, "drop"] <- TRUE #%>% hist()
# # 
# # df.tevc_gj[df.tevc_gj$Experiment == "180214" & 
# #              df.tevc_gj$`Time Exposed` == 40 & 
# #              df.tevc_gj$inj_in_IN4 == T &
# #              df.tevc_gj$Recording == 42, "drop"] <- TRUE
# # 
# # df.tevc_gj[df.tevc_gj$Experiment == "180212" & 
# #              df.tevc_gj$`Time Exposed` == 40 & 
# #              df.tevc_gj$inj_in_IN4 == T &
# #              df.tevc_gj$Recording == 50, "drop"] <- TRUE
# # 
# # df.tevc_gj[df.tevc_gj$Experiment == "180125" & 
# #              df.tevc_gj$`Time Exposed` == 0 & 
# #              df.tevc_gj$inj_in_IN4 == T &
# #              df.tevc_gj$Recording == 43, "drop"] <- TRUE
# # 
# # df.tevc_gj[df.tevc_gj$Experiment == "180507" & #Looks like voltage sensing electrode in IN9 was slipping out. Ihtk like activity. 
# #              df.tevc_gj$`Time Exposed` == 40 & 
# #              df.tevc_gj$inj_in_IN4 == F &
# #              df.tevc_gj$Recording == 13, "drop"] <- TRUE
# 
# 
# present.vars <- data.frame(exp = c("180214", "180212", "180214", "180212", "180125", "180507"),
# rec = c(38,50,42,50,43,13))
# for (i in 1:nrow(present.vars)){
#   print(unique(M[M$Experiment == present.vars[i, "exp"] &
#   M$tevc.recording == present.vars[i, "rec"] , c("gj")]))
# }
```

```{r eval=FALSE, include=FALSE}
# # Get ballanced groups ----
# all.data <- all.data[(all.data$Condition == "PS.0" &
#   all.data$Experiment %in% c(
#     "180507",
#     "180509",
#     "180509a",
#     "180510",
#     "180514"
#   )) |
#   all.data$Condition != "PS.0", ]
# 
# all.data <- all.data[(all.data$Condition == "PS.22" &
#   all.data$Experiment %in% c(
#     "180315", 
#     "180314", 
#     "180309", #real high
#     # "180308", #real low, t=0 measures furthest apart
#     "180705", 
#     "181001"
#   )) |
#   all.data$Condition != "PS.22", ]
# 
# all.data <- all.data[(all.data$Condition == "PS.45" &
#   all.data$Experiment %in% c(
#     "180413",  
#     "180425",  
#     "180622",  
#     "180625",  
#     "190404a"
#   )) |
#   all.data$Condition != "PS.45", ]
# 
# all.data <- all.data[(all.data$Condition == "PS.90" &
#   all.data$Experiment %in% c(
#     "190319", 
#     "190319a", 
#     "190322",  
#     "190322a", 
#     "190404"
#   )) |
#   all.data$Condition != "PS.90", ]
# 
# all.data <- all.data[(all.data$Condition == "PS.22.High.Amp" &
#   all.data$Experiment %in% c(
#     "180604", 
#     "180607", 
#     "180615", 
#     "180530", 
#     "180531"
#   )) |
#   all.data$Condition != "PS.22.High.Amp", ]
# 
# all.data <- all.data[(all.data$Condition == "PS.0.High.Amp" &
#   all.data$Experiment %in% c(
#    "180221",  
#     "180221a", 
#     #"180212",  
#     "180214",  
#     "181019",  
#     "180223"
#   )) |
#   all.data$Condition != "PS.0.High.Amp", ]
# 
# 
# # PS.0
# # "180507",
# # "180509",
# # "180509a",
# # "180510",
# # "180514"
# 
# # PS.22
# # "180315", 
# # "180314", 
# # "180309", #real high
# # # "180308", #real low, t=0 measures furthest apart
# # "180705", 
# # "181001"
# 
# # PS.45
# # "180413",  
# # "180425",  
# # "180622",  
# # "180625",  
# # "190404a"
# 
# # PS.90
# # "190319", 
# # "190319a", 
# # "190322",  
# # "190322a", 
# # "190404"
#  
# # PS.22.High.Amp
# # "180604", 
# # "180607", 
# # "180615", 
# # "180530", 
# # "180531"
# 
# # PS.0.High.Amp
# # "180221",  
# # "180221a", 
# # #"180212",  
# # "180214",  
# # "181019",  
# # "180223"

```



```{r}
M.d.gj$Condition %>% unique()
```



# Thu May 30 11:03:56 2019 ------------------------------


### funcitons/prep
```{r}
# d = M.d.gj
# yvar = "gj"
# 
# d$inter <- paste0(d$Experiment, ".", d$Inj_Cell)

add_Stim.type_Phase.angle <- function(d = M.d.gj){
  d$Stim.type <- ""
  d$Phase.angle <- ""
  
  
  d[d$Condition %in% c("PS.0", 
                       "PS.22", 
                       "PS.45", 
                       "PS.90"), "Stim.type"] <- "Standardized"
  
  d[d$Condition %in% c(  "PS.0.orig",
                         "PS.22.orig",
                         "PS.45.orig",
                         "PS.90.orig",
                         "PS.180.orig"), "Stim.type"] <- "Naturalistic"
  
  d[d$Condition %in% c(  "PS.0.High.Amp",
                         "PS.22.High.Amp"), "Stim.type"] <- "High Voltage"
  
  d[d$Condition %in% c("Silent.53mV"), "Stim.type"] <- "Silent"
  
  d[d$Condition %in% c("PS.0.TEA"), "Stim.type"] <- "TEA"
  
  d[d$Condition %in% c("Inv"), "Stim.type"] <- "Inversion"
  
  
  d[d$Condition %in% c(  "PS.0", "PS.0.orig", "PS.0.High.Amp","Silent.53mV", "PS.0.TEA",  "Inv"), "Phase.angle"] <- "0"
  d[d$Condition %in% c(  "PS.22", "PS.22.orig","PS.22.High.Amp"), "Phase.angle"] <- "22.5"
  d[d$Condition %in% c(  "PS.45", "PS.45.orig"), "Phase.angle"] <- "45"
  d[d$Condition %in% c("PS.90", "PS.90.orig"), "Phase.angle"] <- "90"
  d[d$Condition %in% c(  "PS.180.orig"), "Phase.angle"] <- "180"
  
  
  d$Stim.type <- as.factor(d$Stim.type)
  d$Phase.angle <- as.factor(d$Phase.angle)
  
  
  d$Stim.type <- factor(d$Stim.type, levels = c("Naturalistic",
                                                "Standardized",
                                                "High Voltage",
                                                "Inversion", "TEA", "Silent"      ))
  d$Phase.angle <- factor(d$Phase.angle, levels = c(0, 22.5, 45,   90,   180 ))
  
  
  # d$Condition.Mean <- NA
  # 
  # for (i in unique(d$Condition)){
  #   for (j in unique(d[d$Condition == i, "Time"])){
  #       d[d$Condition == i &
  #           d$Time == j, "Condition.Mean"] <- mean(d[d$Condition == i &
  #           d$Time == j, yvar], na.rm = T)
  #   }
  # }
  
  return(d)
}

```

### STG Meeting Fig
#### Fig 5. Summary
```{r}
d <- add_Stim.type_Phase.angle(d = M.d)
yvar = "gj"
d$inter <- paste0(d$Experiment, ".", d$Inj_Cell)

d <- d %>% filter(Condition %in% c(
  "PS.0.High.Amp",
  "PS.22.High.Amp",
  
  "PS.0",
  "PS.22",
  "PS.45",
  "PS.90",
  
  "PS.0.orig", 
  "PS.22.orig",
  "PS.45.orig",
  "PS.90.orig",   
  "PS.180.orig"
  
)) %>%  mutate(Condition = as.character(Condition))

d[d$Condition == "PS.0.High.Amp", "Condition"] <- "TEA Mimic Sync"
d[d$Condition == "PS.22.High.Amp", "Condition"] <- "TEA Mimic Async"

d[d$Condition == "PS.0", "Condition"] <- "Low mV 0 Deg."
d[d$Condition == "PS.22", "Condition"] <- "Low mV 22.5 Deg."
d[d$Condition == "PS.45", "Condition"] <- "Low mV 45 Deg."
d[d$Condition == "PS.90", "Condition"] <- "Low mV 90 Deg."

d[d$Condition == "PS.0.orig", "Condition"] <- "Natural 0 Deg."
d[d$Condition == "PS.22.orig", "Condition"] <- "Natural 22.5 Deg."
d[d$Condition == "PS.45.orig", "Condition"] <- "Natural 45 Deg."
d[d$Condition == "PS.90.orig", "Condition"] <- "Natural 90 Deg."
d[d$Condition == "PS.180.orig", "Condition"] <- "Natural 180 Deg."

d <- d %>% mutate(Condition = as.factor(Condition))

d$Condition <- factor(d$Condition, levels = c(
  "TEA Mimic Sync" ,
  "TEA Mimic Async",
  
  "Low mV 0 Deg.",
  "Low mV 22.5 Deg.",
  "Low mV 45 Deg.",
  "Low mV 90 Deg.",
  
  "Natural 0 Deg.",
  "Natural 22.5 Deg.",
  "Natural 45 Deg.",
  "Natural 90 Deg.",
  "Natural 180 Deg."
))


# ## TEA Mimic ====
# plt.sfn.tea <- 
# ggplot(
#   filter(d, Condition %in% c(  
#     "TEA Mimic Sync" ,
#     "TEA Mimic Async"#,
#                                
#                                # "Low mV 0 Deg.",
#                                # "Low mV 22.5 Deg.",
#                                # "Low mV 45 Deg.",
#                                # "Low mV 90 Deg."#,
#                                
#                                # "Natural 0 Deg.",
#                                # "Natural 22.5 Deg.",
#                                # "Natural 45 Deg.",
#                                # "Natural 90 Deg.",
#                                # "Natural 180 Deg."
#                                )), 
#   aes_string("Time", yvar, fill = "Condition"))+
#   geom_hline(yintercept = 0, color = "black")+
#   stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "ribbon", alpha = 0.2)+
#   # geom_ribbon(aes(ymin=0, ymax=Condition.Mean), alpha = 0.5)+
#   # geom_ribbon(aes(ymin=-4, ymax=0), fill = "Black")+
#   # stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "ribbon", alpha = 0.02)+
#   
#   stat_summary(fun.y = mean, geom = "point", aes(color = Condition), size = 5, color = "white", alpha = 0.7) +
#   stat_summary(fun.y = mean, geom = "point", aes(color = Condition), size = 5, color = "black", shape = 1,
#                alpha = 0.7) +
#   stat_summary( fun.y = mean, geom = "line", aes(color = Condition), size = 1, linetype = 1 , color = "white") +
#   geom_pointline(aes(group = inter, color = Condition))+
#   
#   kickme()+
#   # coord_cartesian(ylim = c(-2, 4))+
#   # labs(y = paste(expression("Delta"), "Coupling Resistance"))+
#   labs(y = expression(paste(Delta, "Rc", " in M", Omega)), x = "Time in Minutes")+
#   
#   
#   facet_grid(. ~ Condition)+
#   scale_color_manual(values = c(
#     "#d95f0e", "#993404"#,
#     # "#a6bddb", "#74a9cf", "#2b8cbe", "#045a8d"#,
#     # "#a1d99b", "#74c476", "#41ab5d", "#238b45", "#005a32"
#   )    
#   )+
#   scale_fill_manual(values = c(
#     "#d95f0e", "#993404"#,
#     # "#a6bddb", "#74a9cf", "#2b8cbe", "#045a8d"#,
#     # "#a1d99b", "#74c476", "#41ab5d", "#238b45", "#005a32"    
#   ))+
#   theme(legend.position = "")
# 
# 
# ## Standardized ====
# plt.sfn.s <- 
# 
# ggplot(
#   filter(d, Condition %in% c(  
#     # "TEA Mimic Sync" ,
#     # "TEA Mimic Async",
#                                
#                                "Low mV 0 Deg.",
#                                "Low mV 22.5 Deg.",
#                                "Low mV 45 Deg.",
#                                "Low mV 90 Deg."#,
#                                
#                                # "Natural 0 Deg.",
#                                # "Natural 22.5 Deg.",
#                                # "Natural 45 Deg.",
#                                # "Natural 90 Deg.",
#                                # "Natural 180 Deg."
#                                )), 
#   aes_string("Time", yvar, fill = "Condition"))+
#   geom_hline(yintercept = 0, color = "black")+
#   stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "ribbon", alpha = 0.2)+
#   # geom_ribbon(aes(ymin=0, ymax=Condition.Mean), alpha = 0.5)+
#   # geom_ribbon(aes(ymin=-4, ymax=0), fill = "Black")+
#   # stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "ribbon", alpha = 0.02)+
#   
#   stat_summary(fun.y = mean, geom = "point", aes(color = Condition), size = 5, color = "white", alpha = 0.7) +
#   stat_summary(fun.y = mean, geom = "point", aes(color = Condition), size = 5, color = "black", shape = 1,
#                alpha = 0.7) +
#   stat_summary( fun.y = mean, geom = "line", aes(color = Condition), size = 1, linetype = 1 , color = "white") +
#   geom_pointline(aes(group = inter, color = Condition))+
#   
#   kickme()+
#   # coord_cartesian(ylim = c(-2, 4))+
#   # labs(y = paste(expression("Delta"), "Coupling Resistance"))+
#   labs(y = expression(paste(Delta, "Rc", " in M", Omega)), x = "Time in Minutes")+
#   
#   
#   facet_grid(. ~ Condition)+
#   scale_color_manual(values = c(
#     # "#d95f0e", "#993404", 
#     "#a6bddb", "#74a9cf", "#2b8cbe", "#045a8d"#,
#     # "#a1d99b", "#74c476", "#41ab5d", "#238b45", "#005a32"
#   )    
#   )+
#   scale_fill_manual(values = c(
#     # "#d95f0e", "#993404", 
#     "#a6bddb", "#74a9cf", "#2b8cbe", "#045a8d"#,
#     # "#a1d99b", "#74c476", "#41ab5d", "#238b45", "#005a32"    
#   ))+
#   theme(legend.position = "")
# 
# 
# ## Natural ====
# plt.sfn.n <- 
# ggplot(
#   filter(d, Condition %in% c(  
#     # "TEA Mimic Sync" ,
#     # "TEA Mimic Async",
#                                
#                                # "Low mV 0 Deg.",
#                                # "Low mV 22.5 Deg.",
#                                # "Low mV 45 Deg.",
#                                # "Low mV 90 Deg."#,
#                                
#                                "Natural 0 Deg.",
#                                "Natural 22.5 Deg.",
#                                "Natural 45 Deg.",
#                                "Natural 90 Deg.",
#                                "Natural 180 Deg."
#                                )), 
#   aes_string("Time", yvar, fill = "Condition"))+
#   geom_hline(yintercept = 0, color = "black")+
#   stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "ribbon", alpha = 0.2)+
#   # geom_ribbon(aes(ymin=0, ymax=Condition.Mean), alpha = 0.5)+
#   # geom_ribbon(aes(ymin=-4, ymax=0), fill = "Black")+
#   # stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "ribbon", alpha = 0.02)+
#   
#   stat_summary(fun.y = mean, geom = "point", aes(color = Condition), size = 5, color = "white", alpha = 0.7) +
#   stat_summary(fun.y = mean, geom = "point", aes(color = Condition), size = 5, color = "black", shape = 1,
#                alpha = 0.7) +
#   stat_summary( fun.y = mean, geom = "line", aes(color = Condition), size = 1, linetype = 1 , color = "white") +
#   geom_pointline(aes(group = inter, color = Condition))+
#   
#   kickme()+
#   # coord_cartesian(ylim = c(-2, 4))+
#   # labs(y = paste(expression("Delta"), "Coupling Resistance"))+
#   labs(y = expression(paste(Delta, "Rc", " in M", Omega)), x = "Time in Minutes")+
#   
#   
#   facet_grid(. ~ Condition)+
#   scale_color_manual(values = c(
#     # "#d95f0e", "#993404", 
#     # "#a6bddb", "#74a9cf", "#2b8cbe", "#045a8d"#,
#     "#a1d99b", "#74c476", "#41ab5d", "#238b45", "#005a32"
#   )    
#   )+
#   scale_fill_manual(values = c(
#     # "#d95f0e", "#993404", 
#     # "#a6bddb", "#74a9cf", "#2b8cbe", "#045a8d"#,
#     "#a1d99b", "#74c476", "#41ab5d", "#238b45", "#005a32"
#   ))+
#   theme(legend.position = "")
# 

```

```{r eval=FALSE}
ggsave(
      "SFN_s.tiff",
      plot = plt.sfn.s, #ggplot2::last_plot(),
      device = NULL,
      path = paste0(getwd(), "/data/figures"),
width = 20, height = 9.67,
      # units = c("in", "cm", "mm"),
      dpi = 175#, limitsize = TRUE, ...
    )

ggsave(
      "SFN_n.tiff",
      plot = plt.sfn.n, #ggplot2::last_plot(),
      device = NULL,
      path = paste0(getwd(), "/data/figures"),
width = 20, height = 9.67,
      # units = c("in", "cm", "mm"),
      dpi = 175#, limitsize = TRUE, ...
    )

ggsave(
      "SFN_tea.tiff",
      plot = plt.sfn.tea, #ggplot2::last_plot(),
      device = NULL,
      path = paste0(getwd(), "/data/figures"),
width = 20, height = 9.67,
      # units = c("in", "cm", "mm"),
      dpi = 175#, limitsize = TRUE, ...
    )
```


### remaking `d`

```{r}
d <- add_Stim.type_Phase.angle(d = M.d)
yvar = "gj"
d$inter <- paste0(d$Experiment, ".", d$Inj_Cell)

d <- d %>% filter(Condition %in% c(
  "PS.0.High.Amp",
  "PS.22.High.Amp",
  
  "PS.90.HA",
  "PS.90.HA.Cd",
    
  "PS.0",
  "PS.22",
  "PS.45",
  "PS.90",
  
  "PS.0.orig", 
  "PS.22.orig",
  "PS.45.orig",
  "PS.90.orig",   
  "PS.180.orig"
  
)) %>%  mutate(Condition = as.character(Condition))

d[d$Condition == "PS.0.High.Amp", "Condition"] <- "TEA Mimic Sync"
d[d$Condition == "PS.22.High.Amp", "Condition"] <- "TEA Mimic Async"

d[d$Condition == "PS.90.HA", "Condition"] <- "High Amplitude Async"
d[d$Condition == "PS.90.HA.Cd", "Condition"] <- "High Amplitude Async Cd2+"

d[d$Condition == "PS.0", "Condition"] <- "Low mV 0 Deg."
d[d$Condition == "PS.22", "Condition"] <- "Low mV 22.5 Deg."
d[d$Condition == "PS.45", "Condition"] <- "Low mV 45 Deg."
d[d$Condition == "PS.90", "Condition"] <- "Low mV 90 Deg."

d[d$Condition == "PS.0.orig", "Condition"] <- "Natural 0 Deg."
d[d$Condition == "PS.22.orig", "Condition"] <- "Natural 22.5 Deg."
d[d$Condition == "PS.45.orig", "Condition"] <- "Natural 45 Deg."
d[d$Condition == "PS.90.orig", "Condition"] <- "Natural 90 Deg."
d[d$Condition == "PS.180.orig", "Condition"] <- "Natural 180 Deg."

d <- d %>% mutate(Condition = as.factor(Condition))

d$Condition <- factor(d$Condition, levels = c(
  "TEA Mimic Sync" ,
  "TEA Mimic Async",
  
  "High Amplitude Async",
  "High Amplitude Async Cd2+",
  
  "Low mV 0 Deg.",
  "Low mV 22.5 Deg.",
  "Low mV 45 Deg.",
  "Low mV 90 Deg.",
  
  "Natural 0 Deg.",
  "Natural 22.5 Deg.",
  "Natural 45 Deg.",
  "Natural 90 Deg.",
  "Natural 180 Deg."
))





```



```{r}

plt.sfn.all.1 <- 
ggplot(
  filter(d, Condition %in% c(  
    "TEA Mimic Sync" ,
    "TEA Mimic Async",

                               "Low mV 0 Deg.",
                               "Low mV 22.5 Deg.",
                               "Low mV 45 Deg.",
                               "Low mV 90 Deg."#,
                               # 
                               # "Natural 0 Deg.",
                               # "Natural 22.5 Deg.",
                               # "Natural 45 Deg.",
                               # "Natural 90 Deg.",
                               # "Natural 180 Deg."
                               )), 
  aes_string("Time", yvar, fill = "Condition"))+
  geom_hline(yintercept = 0, color = "black")+
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "ribbon", alpha = 0.2)+
  # geom_ribbon(aes(ymin=0, ymax=Condition.Mean), alpha = 0.5)+
  # geom_ribbon(aes(ymin=-4, ymax=0), fill = "Black")+
  # stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "ribbon", alpha = 0.02)+
  
  stat_summary(fun.y = mean, geom = "point", aes(color = Condition), size = 5, color = "white", alpha = 0.7) +
  stat_summary(fun.y = mean, geom = "point", aes(color = Condition), size = 5, color = "black", shape = 1,
               alpha = 0.7) +
  stat_summary( fun.y = mean, geom = "line", aes(color = Condition), size = 1, linetype = 1 , color = "white") +
  geom_pointline(aes(group = inter, color = Condition))+
  
  kickme()+
  # coord_cartesian(ylim = c(-2, 4))+
  # labs(y = paste(expression("Delta"), "Coupling Resistance"))+
  labs(y = expression(paste(Delta, "Rc", " in M", Omega)), x = "Time in Minutes")+
  
  
  facet_grid(. ~ Condition)+
  scale_color_manual(values = c(
    "#d95f0e", "#993404",
    "#a6bddb", "#74a9cf", "#2b8cbe", "#045a8d",
    "#a1d99b", "#74c476", "#41ab5d", "#238b45", "#005a32"
  )    
  )+
  scale_fill_manual(values = c(
    "#d95f0e", "#993404",
    "#a6bddb", "#74a9cf", "#2b8cbe", "#045a8d",
    "#a1d99b", "#74c476", "#41ab5d", "#238b45", "#005a32"
  ))+
  theme(legend.position = "")+
  ylim(-4, 4)






plt.sfn.all.2 <- 
ggplot(
  filter(d, Condition %in% c(  
    # "TEA Mimic Sync" ,
    # "TEA Mimic Async",
    # 
    #                            "Low mV 0 Deg.",
    #                            "Low mV 22.5 Deg.",
    #                            "Low mV 45 Deg.",
                               # "Low mV 90 Deg.",
                               
                               "Natural 0 Deg.",
                               "Natural 22.5 Deg.",
                               "Natural 45 Deg.",
                               "Natural 90 Deg.",
                               "Natural 180 Deg."
                               )), 
  aes_string("Time", yvar, fill = "Condition"))+
  geom_hline(yintercept = 0, color = "black")+
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "ribbon", alpha = 0.2)+
  # geom_ribbon(aes(ymin=0, ymax=Condition.Mean), alpha = 0.5)+
  # geom_ribbon(aes(ymin=-4, ymax=0), fill = "Black")+
  # stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "ribbon", alpha = 0.02)+
  
  stat_summary(fun.y = mean, geom = "point", aes(color = Condition), size = 5, color = "white", alpha = 0.7) +
  stat_summary(fun.y = mean, geom = "point", aes(color = Condition), size = 5, color = "black", shape = 1,
               alpha = 0.7) +
  stat_summary( fun.y = mean, geom = "line", aes(color = Condition), size = 1, linetype = 1 , color = "white") +
  geom_pointline(aes(group = inter, color = Condition))+
  
  kickme()+
  # coord_cartesian(ylim = c(-2, 4))+
  # labs(y = paste(expression("Delta"), "Coupling Resistance"))+
  labs(y = expression(paste(Delta, "Rc", " in M", Omega)), x = "Time in Minutes")+
  
  
  facet_grid(. ~ Condition)+
  scale_color_manual(values = c(
    # "#d95f0e", "#993404",
    # "#a6bddb", "#74a9cf", "#2b8cbe", 
    # "#045a8d",
    "#a1d99b", "#74c476", "#41ab5d", "#238b45", "#005a32"
  )    
  )+
  scale_fill_manual(values = c(
    # "#d95f0e", "#993404",
    # "#a6bddb", "#74a9cf", "#2b8cbe", 
    # "#045a8d",
    "#a1d99b", "#74c476", "#41ab5d", "#238b45", "#005a32"
  ))+
  theme(legend.position = "")+
  ylim(-4, 4)



```

```{r eval=FALSE}

ggsave(
      "SFN_all1.tiff",
      plot = plt.sfn.all.1, #ggplot2::last_plot(),
      device = NULL,
      path = paste0(getwd(), "/data/figures"),
width = 20, height = 9.67,
      # units = c("in", "cm", "mm"),
      dpi = 175#, limitsize = TRUE, ...
    )

ggsave(
      "SFN_all2.tiff",
      plot = plt.sfn.all.2, #ggplot2::last_plot(),
      device = NULL,
      path = paste0(getwd(), "/data/figures"),
width = 20, height = 9.67,
      # units = c("in", "cm", "mm"),
      dpi = 175#, limitsize = TRUE, ...
    )
```




```{r}
 # start of testing ----

plt <- ggplot(
  filter(d, Condition %in% c(  
    "TEA Mimic Sync" ,
    "TEA Mimic Async",
    
    "High Amplitude Async",     
    "High Amplitude Async Cd2+"
    # 
    # "Low mV 0 Deg.",
    # "Low mV 22.5 Deg.",
    # "Low mV 45 Deg.",
    # "Low mV 90 Deg.",
    # 
    # "Natural 0 Deg.",
    # "Natural 22.5 Deg.",
    # "Natural 45 Deg.",
    # "Natural 90 Deg.",
    # "Natural 180 Deg."
                               )), 
  aes_string("Time", yvar, fill = "Condition"))+
  geom_hline(yintercept = 0, color = "black")+
  geom_line(aes(group = inter, color = Condition))+
  geom_point(aes(group = inter, color = Condition))+
  
  kickme()+
  # coord_cartesian(ylim = c(-2, 4))+
  # labs(y = paste(expression("Delta"), "Coupling Resistance"))+
  labs(y = expression(paste(Delta, "Rc", " in M", Omega)), x = "Time in Minutes")+
  
  facet_grid(. ~ Condition)+
  
  theme(legend.position = "")+
  ylim(-4, 4)

plt %>% plotly::ggplotly()



```



#### Dave's email

From: "Schulz, David J." <schulzd@missouri.edu>
Date: Thursday, June 13, 2019 at 12:05 PM
To: "Kick, Daniel R. (MU-Student)" <drk8b9@mail.missouri.edu>
Subject: One more set of figures, revisited

Daniel,
 
>I would like to see the combined delta GJ across experimental groups where we combine everything that has the same phase (skip the inverted waveform).  So in other words, if you could take Figure 5 and collapse it to a 1x5 where there is no factor of stimulus type.  I would like to see this, formatted to replace the inverted waveform row.
 
Thanks,
Dave

```{r}
d <- add_Stim.type_Phase.angle(d = M.d)
yvar = "rc"
d$inter <- paste0(d$Experiment, ".", d$Inj_Cell)


d$Condition <- factor(d$Condition, levels = c(
  "PS.0.orig",
  "PS.22.orig",
  "PS.45.orig",
  "PS.90.orig",
  "PS.180.orig",
  
  "PS.0",
  "PS.22",
  "PS.45",
  "PS.90",
  
  "PS.0.High.Amp",
  "PS.22.High.Amp",
  
  "Inv",
  "PS.0.TEA",
  "Silent.53mV"
))

d.pooled <- d %>% filter(Condition %in% c(
  "PS.0",
  "PS.22",
  "PS.45",
  "PS.90",
  
  "PS.0.High.Amp",
  "PS.22.High.Amp",
  
  "PS.0.orig",
  "PS.22.orig",
  "PS.45.orig",
  "PS.90.orig",
  "PS.180.orig"
))
d.pooled$Stim.type <- "All"

d <- full_join(d, d.pooled)
d$Stim.type <- as.factor(d$Stim.type)

d$Stim.type <- factor(d$Stim.type, levels = c(  "Inversion",
                                                "Standardized",       
                                                "Naturalistic",     
                                                "High Voltage",
                                                "All",
                                                "TEA",
                                                "Silent" 
))


d$Condition <- as.character(d$Condition)
d[d$Stim.type == "All" & d$Phase.angle == "0", "Condition"] <- "All.0"
d[d$Stim.type == "All" & d$Phase.angle == "22.5", "Condition"] <- "All.22.5"
d[d$Stim.type == "All" & d$Phase.angle == "45", "Condition"] <- "All.45"
d[d$Stim.type == "All" & d$Phase.angle == "90", "Condition"] <- "All.90"
d[d$Stim.type == "All" & d$Phase.angle == "180", "Condition"] <- "All.180"

d$Condition <- as.factor(d$Condition)
d$Condition <- factor(d$Condition, levels = c(
  "PS.0.orig",
  "PS.22.orig",
  "PS.45.orig",
  "PS.90.orig",
  "PS.180.orig",
  
  "PS.0",
  "PS.22",
  "PS.45",
  "PS.90",
  
  "PS.0.High.Amp",
  "PS.22.High.Amp",
  
  "All.0",
  "All.22.5",
  "All.45",
  "All.90",
  "All.180",
  
  
  "Silent.53mV",
  "PS.0.TEA",
  "Inv"
))

ggplot(d[
  (d$Condition %in% c(
    # "Silent.53mV",
    # "PS.0.TEA",
    # "Inv",
    
    "PS.0",
    "PS.22",
    "PS.45",
    "PS.90",
    
    "PS.0.High.Amp",
    "PS.22.High.Amp",
    
    "PS.0.orig",
    "PS.22.orig",
    "PS.45.orig",
    "PS.90.orig",
    "PS.180.orig",
    
    "All.0",
    "All.22.5",
    "All.45",
    "All.90",
    "All.180"
    
  )),], aes_string("Time", yvar, fill = "Condition"))+
  geom_hline(yintercept = 0, color = "black")+
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "ribbon", alpha = 0.2)+
  geom_pointline(aes(group = inter, color = Condition))+
  stat_summary(fun.y = mean, geom = "point", aes(color = Condition), size = 5, color = "white", alpha = 0.7) +
  stat_summary( fun.y = mean, geom = "line", aes(color = Condition), size = 1, linetype = 1 , color = "white") +
  
  kickme()+
  # coord_cartesian(ylim = c(-2, 4))+
  labs(y = "Coupling Resistance")+
  facet_grid(Stim.type ~ Phase.angle)+
  scale_color_manual(values = c(
    "#77A8C8", "#046FB5", "#046FB5", "#003856", "#003856", 
    "#41AE77", "#006E2C", "#006E2C", "#00451B", 
    "#FC8D58", "#EF6548", #"#D43120", "#B40001", "#810000", 
    "#77A8C8", "#046FB5", "#046FB5", "#003856", "#003856")    
  )+
  scale_fill_manual(values = c(
    "#77A8C8", "#046FB5", "#046FB5", "#003856", "#003856", 
    "#41AE77", "#006E2C", "#006E2C", "#00451B", 
    "#FC8D58", "#EF6548", #"#D43120", "#B40001", "#810000", 
    "#77A8C8", "#046FB5", "#046FB5", "#003856", "#003856"
  ))
```

```{r}
ggsave(
      "fig5_pooled_means.pdf",
      plot = ggplot2::last_plot(),
      device = NULL,
      path = paste0(getwd(), "/data/figures"),
width = 11, height = 8.5,
      # units = c("in", "cm", "mm"),
      dpi = 75#, limitsize = TRUE, ...
    )
```





>And perhaps we can see this one with mean and median as the population measure (two separate versions). 

```{r}
# d <- add_Stim.type_Phase.angle(d = M.d)
# yvar = "rc"
# d$inter <- paste0(d$Experiment, ".", d$Inj_Cell)
# 
# 
# d$Condition <- factor(d$Condition, levels = c(
#   "PS.0.orig",
#   "PS.22.orig",
#   "PS.45.orig",
#   "PS.90.orig",
#   "PS.180.orig",
#   
#   "PS.0",
#   "PS.22",
#   "PS.45",
#   "PS.90",
#   
#   "PS.0.High.Amp",
#   "PS.22.High.Amp",
#   
#   "Inv",
#   "PS.0.TEA",
#   "Silent.53mV"
# ))
# 
# d.pooled <- d %>% filter(Condition %in% c(
#   "PS.0",
#   "PS.22",
#   "PS.45",
#   "PS.90",
#   
#   "PS.0.High.Amp",
#   "PS.22.High.Amp",
#   
#   "PS.0.orig",
#   "PS.22.orig",
#   "PS.45.orig",
#   "PS.90.orig",
#   "PS.180.orig"
# ))
# d.pooled$Stim.type <- "All"
# 
# d <- full_join(d, d.pooled)
# d$Stim.type <- as.factor(d$Stim.type)
# 
# d$Stim.type <- factor(d$Stim.type, levels = c(  "Inversion",
#                                                 "Standardized",       
#                                                 "Naturalistic",     
#                                                 "High Voltage",
#                                                 "All",
#                                                 "TEA",
#                                                 "Silent" 
# ))
# 
# 
# d$Condition <- as.character(d$Condition)
# d[d$Stim.type == "All" & d$Phase.angle == "0", "Condition"] <- "All.0"
# d[d$Stim.type == "All" & d$Phase.angle == "22.5", "Condition"] <- "All.22.5"
# d[d$Stim.type == "All" & d$Phase.angle == "45", "Condition"] <- "All.45"
# d[d$Stim.type == "All" & d$Phase.angle == "90", "Condition"] <- "All.90"
# d[d$Stim.type == "All" & d$Phase.angle == "180", "Condition"] <- "All.180"
# 
# d$Condition <- as.factor(d$Condition)
# d$Condition <- factor(d$Condition, levels = c(
#   "PS.0.orig",
#   "PS.22.orig",
#   "PS.45.orig",
#   "PS.90.orig",
#   "PS.180.orig",
#   
#   "PS.0",
#   "PS.22",
#   "PS.45",
#   "PS.90",
#   
#   "PS.0.High.Amp",
#   "PS.22.High.Amp",
#   
#   "All.0",
#   "All.22.5",
#   "All.45",
#   "All.90",
#   "All.180",
#   
#   
#   "Silent.53mV",
#   "PS.0.TEA",
#   "Inv"
# ))
# 
# use.conditions <- c(
#     # "Silent.53mV",
#     # "PS.0.TEA",
#     # "Inv",
#     
#     "PS.0",
#     "PS.22",
#     "PS.45",
#     "PS.90",
#     
#     "PS.0.High.Amp",
#     "PS.22.High.Amp",
#     
#     "PS.0.orig",
#     "PS.22.orig",
#     "PS.45.orig",
#     "PS.90.orig",
#     "PS.180.orig",
#     
#     "All.0",
#     "All.22.5",
#     "All.45",
#     "All.90",
#     "All.180"
#     
#   )
# 
# ggplot(d[
#   (d$Condition %in% use.conditions),], aes_string("Time", yvar, fill = "Condition"))+
#   geom_hline(yintercept = 0, color = "black")+
#   stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "ribbon", alpha = 0.2)+
#   geom_pointline(aes(group = inter, color = Condition))+
#   stat_summary(data = filter(d[d$Condition %in% use.conditions, ], Stim.type != "All"), fun.y = mean, geom = "point", aes(color = Condition), size = 5, color = "white", alpha = 0.7) +
#   stat_summary(data = filter(d[d$Condition %in% use.conditions, ], Stim.type != "All"), fun.y = mean, geom = "line", aes(color = Condition), size = 1, linetype = 1 , color = "white") +
#   # last row uses medians
#   stat_summary(data = filter(d[d$Condition %in% use.conditions, ], Stim.type == "All"), fun.y = median, geom = "point", aes(color = Condition), size = 5, color = "white", alpha = 0.7) +
#   stat_summary(data = filter(d[d$Condition %in% use.conditions, ], Stim.type == "All"), fun.y = median, geom = "line", aes(color = Condition), size = 1, linetype = 1 , color = "white") +
#   
#   kickme()+
#   # coord_cartesian(ylim = c(-2, 4))+
#   labs(y = "Coupling Resistance")+
#   facet_grid(Stim.type ~ Phase.angle)+
#   scale_color_manual(values = c(
#     "#77A8C8", "#046FB5", "#046FB5", "#003856", "#003856", 
#     "#41AE77", "#006E2C", "#006E2C", "#00451B", 
#     "#FC8D58", "#EF6548", #"#D43120", "#B40001", "#810000", 
#     "#77A8C8", "#046FB5", "#046FB5", "#003856", "#003856")    
#   )+
#   scale_fill_manual(values = c(
#     "#77A8C8", "#046FB5", "#046FB5", "#003856", "#003856", 
#     "#41AE77", "#006E2C", "#006E2C", "#00451B", 
#     "#FC8D58", "#EF6548", #"#D43120", "#B40001", "#810000", 
#     "#77A8C8", "#046FB5", "#046FB5", "#003856", "#003856"
#   ))
```

```{r}
# ggsave(
#       "fig5_pooled_medians.pdf",
#       plot = ggplot2::last_plot(),
#       device = NULL,
#       path = paste0(getwd(), "/data/figures"),
# width = 11, height = 8.5,
#       # units = c("in", "cm", "mm"),
#       dpi = 75#, limitsize = TRUE, ...
#     )
```

```{r}

# cowplot::plot_grid(plotlist = list(
# ggplot(filter(d[d$Condition %in% use.conditions, ], Stim.type == "Naturalistic"), aes(x = Time, y = rc, color = Condition))+
#   geom_hline(yintercept = 0, color = "black")+
#   stat_summary(fun.y = mean, geom = "point", aes(color = Condition), size = 5, alpha = 0.7) +
#   stat_summary(fun.y = mean, geom = "line", aes(color = Condition), size = 1, linetype = 1 )+
#   facet_grid(Stim.type~.)+
#   kickme(),
# 
# 
# ggplot(filter(d[d$Condition %in% use.conditions, ], Stim.type == "Standardized"), aes(x = Time, y = rc, color = Condition))+
#   geom_hline(yintercept = 0, color = "black")+
#   stat_summary(fun.y = mean, geom = "point", aes(color = Condition), size = 5, alpha = 0.7) +
#   stat_summary(fun.y = mean, geom = "line", aes(color = Condition), size = 1, linetype = 1 )+
#   facet_grid(Stim.type~.)+
#   kickme()
# 
# ))
```


#### Supplemental figure, pairs with Fig 2
```{r}
d <- add_Stim.type_Phase.angle(d = M.d.gj)
yvar = "gj"
d$inter <- paste0(d$Experiment, ".", d$Inj_Cell)

# labeli2 <- function(variable, value){
#   value <- droplevels(value)
#   names_li <- list(
#     "PS.0.orig"= "0 Natural",
#     "PS.22.orig" = "22.5 Natural",
#     "PS.45.orig" = "45 Natural",
#     "PS.90.orig" = "90 Natural",
#     "PS.180.orig" = "180 Natural",
#     
#     "PS.0" = "0",
#     "PS.22" = "22.5",
#     "PS.45" = "45",
#     "PS.90" = "90",
#     
#     "PS.0.High.Amp" = "0 High V",
#     "PS.22.High.Amp" = "22.5 High V",
#     
#     "Inv" = "0 Inverted",
#     "PS.0.TEA" = "0 TEA",
#     "Silent.53mV" = "Silent"
#     )
#   return(names_li[value])
# }

d$Condition <- factor(d$Condition, levels = c(
  # "PS.0.orig",
  # "PS.22.orig",
  # "PS.45.orig",
  # "PS.90.orig",
  # "PS.180.orig",
  # 
  # "PS.0",
  # "PS.22",
  # "PS.45",
  # "PS.90",
  # 
  # "PS.0.High.Amp",
  # "PS.22.High.Amp",
  
  "Inv",
  # "PS.0.TEA",
  "Silent.53mV"
))




ggplot(d[
  (d$Condition %in% c(
    "Silent.53mV",
    # "PS.0.TEA",
    "Inv"#,
    
    # "PS.0",
    # "PS.22",
    # "PS.45",
    # "PS.90",
    # 
    # "PS.0.High.Amp",
    # "PS.22.High.Amp",
    # 
    # "PS.0.orig",
    # "PS.22.orig",
    # "PS.45.orig",
    # "PS.90.orig",
    # "PS.180.orig"
  )),], aes_string("Time", yvar, fill = "Condition"))+
  geom_hline(yintercept = 0, color = "black")+
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "ribbon", alpha = 0.5)+
  # geom_ribbon(aes(ymin=0, ymax=Condition.Mean), alpha = 0.5)+
  # geom_ribbon(aes(ymin=-4, ymax=0), fill = "Black")+
  # stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "ribbon", alpha = 0.02)+
  geom_pointline(aes(group = inter, color = Condition))+
  stat_summary(fun.y = mean, geom = "point", aes(color = Condition), size = 5, color = "white", alpha = 0.7) +
  stat_summary( fun.y = mean, geom = "line", aes(color = Condition), size = 1, linetype = 1 , color = "white") +
  kickme()+
  # coord_cartesian(ylim = c(-2, 4))+
  labs(y = "Coupling Resistance")+
  facet_grid(. ~ Condition)+
  scale_color_manual(values = c(
    # "#77A8C8", "#046FB5", "#046FB5", "#003856", "#003856", 
    # "#41AE77", "#006E2C", "#006E2C", "#00451B", 
    # "#FC8D58", "#EF6548", #"#D43120", "#B40001", "#810000", 
    "#CD1256", "#E32D91"
    ))+
  scale_fill_manual(values = c(
    # "#77A8C8", "#046FB5", "#046FB5", "#003856", "#003856", 
    # "#41AE77", "#006E2C", "#006E2C", "#00451B", 
    # "#FC8D58", "#EF6548", #"#D43120", "#B40001", "#810000", 
    "#CD1256", "#E32D91"
  ))
# RColorBrewer::brewer.pal(9, "Blues")[5:9],
# RColorBrewer::brewer.pal(9, "Purples")[6:9],
# RColorBrewer::brewer.pal(9, "Reds")[8:9],
# RColorBrewer::brewer.pal(9, "Blues")[9]


```

```{r}
ggsave(
      "fig2_sup.pdf",
      plot = ggplot2::last_plot(),
      device = NULL,
      path = paste0(getwd(), "/data/figures"),
width = 11, height = 8.5,
      # units = c("in", "cm", "mm"),
      dpi = 75#, limitsize = TRUE, ...
    )
```


### Quick answers for djs

```{r}
M.gj %>% dplyr::select(c("Time", "gj")) %>% filter(Time == 0) %>% summary()
```



```{r}
M.d.gj %>% 
  dplyr::select(c("Time", "Condition", "gj")) %>% 
  filter(Time == 60 & 
           (Condition == "PS.0" | 
              Condition == "PS.22." | 
              Condition == "PS.45" | 
              Condition == "PS.90" | 
              Condition == "PS.0.High.Amp" | 
              Condition == "PS.22.High.Amp") ) %>% 
  group_by(Condition) %>% 
  summarise_at(vars(-Time), funs(mean(., na.rm=TRUE)))

```


### stats tables lme
#### Controlled
```{r perform resampling, eval=FALSE}
if (resample.results == TRUE){
  tic1 <- Sys.time()
  me_cell <- purrr::map(c("r11", "r1", "cc"
                          # , "htk.peak.nA", "a.peak.nA"
                          ), function(x) {
    run_standardized_lme_resample_Phase(
      response.var = x,
      input.df = M[M$Condition %in% c("PS.0", "PS.22", "PS.45", "PS.90"), ],
      nreps = resample.nreps,
      use.seed = 432431,
      mute.completion = TRUE,
      mute.time = FALSE
    )
  })
  
  me_exps <- purrr::map(c("rc", "gj"), function(x) {
    run_standardized_lme_resample_Phase(
      response.var = x,
      input.df = M.gj[M.gj$Condition %in% c("PS.0", "PS.22", "PS.45", "PS.90"), ],
      nreps = resample.nreps,
      use.seed = 432431,
      mute.completion = TRUE,
      mute.time = FALSE
    )
  })
  toc1 <- Sys.time()
  print(toc1 - tic1)
  
  # Restructure into a single list of all outputs
  me_all <- list()
  walk(seq_along(me_cell), function(X){ me_all[[length(me_all)+1]] <<- me_cell[[X]] })
  walk(seq_along(me_exps), function(X){ me_all[[length(me_all)+1]] <<- me_exps[[X]] })
  
  saveRDS(me_all, file = paste0(getwd(), "/data/output/", "rPS0_PS90_model_results", ".rds"))
  write.csv(me_all, file = paste0(getwd(), "/data/output/", "rPS0_PS90_model_results", ".csv"))
} else {
  me_all <- readRDS(paste0(getwd(), "/data/", "rPS0_PS90_model_results", ".rds"))
}

```


```{r calc empirical p, eval=FALSE}
# Main effect empirical p values
measures <- c("r11", "r1", 
              "cc", 
              # "htk.peak.nA", "a.peak.nA",
              "rc", 
              "gj")
out <- as.data.frame(matrix(ncol = 4, nrow = length(measures)))
names(out) <- c("Intercept", "Time", "Phase", "Time:Phase")
rownames(out) <- measures

walk(seq_along(measures), function(i){
  walk(1:4, function(j){
    out[i, j] <<- one_tail_to_epval(input.array = me_all[[i]][,j], tail = "upper")
  })
})


out.holm <- t(out) %>% as.data.frame()
walk(1:ncol(out.holm), function(i){
  out.holm[,i] <<- p.adjust(out.holm[,i], method = "holm") 
})
out.holm <- t(out.holm) %>% as.data.frame()


knitr::kable(out)
knitr::kable(out.holm)

# write.csv(out, paste0(getwd(), "/epvals_phase.csv"))
# write.csv(out.holm, paste0(getwd(), "/epvals_holm_phase.csv"))

write.csv(out, paste0(getwd(), "/data/output/", "rPS0_PS90_model_pvals", ".csv"))
write.csv(out.holm, paste0(getwd(), "/data/output/", "rPS0_PS90_model_pvals_holm", ".csv"))
# write.csv(out.holm, paste0("C:/Users/Daniel/Desktop/epvals_holm_phase.csv"))

```


#### Naturalistic
```{r perform resampling, eval=FALSE}
if (resample.results == TRUE){
  tic1 <- Sys.time()
  me_cell <- purrr::map(c("r11", "r1", "cc"
                          # , "htk.peak.nA", "a.peak.nA"
                          ), function(x) {
    run_standardized_lme_resample_Phase_Orig(
      response.var = x,
      input.df = M[M$Condition %in% c("PS.0.orig",
    "PS.22.orig",
    "PS.45.orig",
    "PS.90.orig",
    "PS.180.orig"), ],
      nreps = resample.nreps,
      use.seed = 432431,
      mute.completion = TRUE,
      mute.time = FALSE
    )
  })
  
  me_exps <- purrr::map(c("rc", "gj"), function(x) {
    run_standardized_lme_resample_Phase_Orig(
      response.var = x,
      input.df = M.gj[M.gj$Condition %in% c("PS.0.orig",
    "PS.22.orig",
    "PS.45.orig",
    "PS.90.orig",
    "PS.180.orig"), ],
      nreps = resample.nreps,
      use.seed = 432431,
      mute.completion = TRUE,
      mute.time = FALSE
    )
  })
  toc1 <- Sys.time()
  print(toc1 - tic1)
  
  # Restructure into a single list of all outputs
  me_all <- list()
  walk(seq_along(me_cell), function(X){ me_all[[length(me_all)+1]] <<- me_cell[[X]] })
  walk(seq_along(me_exps), function(X){ me_all[[length(me_all)+1]] <<- me_exps[[X]] })
  
  saveRDS(me_all, file = paste0(getwd(), "/data/output/", "rOrig0_Orig180_model_results", ".rds"))
  write.csv(me_all, file = paste0(getwd(), "/data/output/", "rOrig0_Orig180_model_results", ".csv"))
  
} else {
  me_all <- readRDS(paste0(getwd(), "/data/output/", "rOrig0_Orig180_model_results", ".rds"))
}

```


```{r calc empirical p, eval=FALSE}
# Main effect empirical p values
measures <- c("r11", "r1", 
              "cc", 
              # "htk.peak.nA", "a.peak.nA",
              "rc", 
              "gj")
out <- as.data.frame(matrix(ncol = 4, nrow = length(measures)))
names(out) <- c("Intercept", "Time", "Phase", "Time:Phase")
rownames(out) <- measures

walk(seq_along(measures), function(i){
  walk(1:4, function(j){
    out[i, j] <<- one_tail_to_epval(input.array = me_all[[i]][,j], tail = "upper")
  })
})


out.holm <- t(out) %>% as.data.frame()
walk(1:ncol(out.holm), function(i){
  out.holm[,i] <<- p.adjust(out.holm[,i], method = "holm") 
})
out.holm <- t(out.holm) %>% as.data.frame()


knitr::kable(out)
knitr::kable(out.holm)

# write.csv(out, paste0(getwd(), "/epvals_phase.csv"))
# write.csv(out.holm, paste0(getwd(), "/epvals_holm_phase.csv"))

write.csv(out, paste0(getwd(), "/data/output/", "rOrig0_Orig180_model_pvals", ".csv"))
write.csv(out.holm, paste0(getwd(), "/data/output/", "rOrig0_Orig180_model_pvals_holm", ".csv"))

```


























# Testing out alternate predictors for naturalistic stim


```{r}
data.frame(stringsAsFactors=FALSE,
           Condition       = c("PS.22.orig", "PS.22.orig", "PS.22.orig", "PS.22.orig", "PS.0.orig",
                               "PS.0.orig", "PS.180.orig", "PS.0.orig", "PS.90.orig",
                               "PS.180.orig", "PS.180.orig", "PS.90.orig", "PS.90.orig",
                               "PS.180.orig", "PS.180.orig", "PS.0.orig", "PS.45.orig",
                               "PS.45.orig", "PS.45.orig", "PS.0.orig", "PS.0.orig", "PS.0.orig",
                               "PS.45.orig", "PS.90.orig", "PS.0.orig", "PS.45.orig"),
           
           Experiment = c("180717", "180717a", "180718", "180718a", 
                          
                          "170623b", "170705a",
                          "170710", "170711e", "170713b", "170728a", 
                          
                          "170801a",
                          "170802a", "170803a", "170808b", "170811", "170814b", "170817b",
                          "170824a", "170825a", "171201", "171016", "171017",
                          "170828a", "170803b", "170808a", "170925A")
)
```

```{r}
library(tidyverse)
library(zoo)


# Really just a wrapper for loadABF()
readABF_as_matrix <- function(
  path = "S:/Data_Daniel/ActiveProjects/181015_electrical_synapses_voltage_modification/experiments/180117_inverted_wave/raw/180205_0061.abf",
  channels = c("IN 4", "IN 9")){

  trace <- readABF::readABF(file = path)

  start.time <- trace$header$recTime[1]
  end.time <- trace$header$recTime[2]
  obs <- nrow(trace$data[[1]])

  temp <- trace$data[[1]][, (trace$channelNames %in% channels)]
  temp <- as.matrix(temp)

  colnames(temp) <- trace$channelNames[trace$channelNames %in% channels]
  temp <- cbind(temp, Time = seq(from = start.time,
                                 to = end.time,
                                 length.out = obs))

  return(temp)
}

```



```{r}
traces <- list.files(here::here("inst", "extdata", "orig_waveforms"))

stim <- map(traces, function(i){
  readABF_as_matrix(
  path = paste0(here::here("inst", "extdata", "orig_waveforms"), "/", i),
  channels = c("IN 4", "IN 9"))
  
})

names(stim) <- traces

stim <- plyr::ldply(stim, data.frame)

stim <- rename(stim, Trace = .id)






min.times <- stim %>% group_by(Trace) %>% summarise(min(Time))

stim$min.time <- NA
walk(seq(from = 1, to = nrow(min.times)), 
     function(i){
       stim[stim$Trace == as.character(min.times[i, "Trace"]), "min.time"] <<- as.numeric(min.times[i, 2])
     })

stim <- stim %>% mutate(Time = Time - min.time)  %>% gather(Ch, mV, c("IN.4", "IN.9"))

#large artifact in 180717a_0013.abf between 4.918, 4.926. Replace with values at 4.918

# replace.vals <- stim %>% ungroup() %>% filter(Trace == "180717a_0013.abf", Time == 0) %>% group_by(Ch)

stim[stim$Trace == "180717a_0013.abf" & (stim$Time > 4.918 & stim$Time < 4.926), "mV"] <- -56.0



stim <- stim %>% 
  ungroup() %>% 
  group_by(Trace, Ch) %>% 
  mutate(mV.f = zoo::rollmean(x = mV, k = 5, fill = "extend")) %>%
  mutate(ID = paste(Ch, Trace)) %>%
  ungroup()
  

# stim %>% 
#   # filter(Trace == "180717a_0013.abf") %>% 
#   ggplot(aes(Time, mV.f, group = ID, color = Trace))+
#   geom_line(alpha = 0.6)+
#   facet_grid(.~Ch)+
#   theme(legend.position = "")


# unique(stim$Trace)

one.trace <- stim %>%
  # filter(Trace %in% c("170710_0037.abf", "180718a_0009.abf")) %>% #FIXME When ready, remove to put all through 
  dplyr::select(-min.time,  -ID, -mV) %>%
  spread(Ch, mV.f)

# one.trace %>% ggplot()+
#   geom_line(aes(x = Time, y = IN.4), color = "Steelblue")+
#   geom_line(aes(x = Time, y = IN.9), color = "Firebrick")
# 
# 
# one.trace %>% ggplot()+
#   geom_path(aes(x = IN.4, y = IN.9, color = Time))


# First pass at annotation ----

# one.trace %>% ggplot()+
#   geom_line(aes(x = Time, y = IN.4), color = "Steelblue")+
#   geom_line(aes(x = Time, y = IN.9), color = "Firebrick")+
#   geom_hline(yintercept = min(one.trace$IN.4, na.rm = T), color = "Steelblue")+
#   geom_hline(yintercept = min(one.trace$IN.9, na.rm = T), color = "Firebrick")


# one.trace %>%
#   # Voltage difference
#   mutate(diff = IN.4 - IN.9) %>% # Not really useful atm
#   mutate(intersect.V = ifelse( # lower of the two, used for overlap
#     IN.4 <= IN.9,
#     IN.4, IN.9
#     )
#     ) %>%
#     mutate(union.V = ifelse( # Higher of the two.
#     IN.4 >= IN.9,
#     IN.4, IN.9
#     )
#     ) %>%
#   mutate(higher.V.min = ifelse(
#     min(one.trace$IN.4, na.rm = T) >= min(one.trace$IN.9, na.rm = T),
#      min(one.trace$IN.4, na.rm = T),
#      min(one.trace$IN.9, na.rm = T)
#   )) %>%
#   mutate(Overlap.V =  intersect.V - higher.V.min) %>%
#   ggplot()+
#   geom_line(aes(x = Time, y = Overlap.V))+
#   geom_ribbon(aes(x = Time, ymin=min(Overlap.V), ymax=Overlap.V))+
#   geom_line(aes(x = Time, y = IN.4 - min(one.trace$IN.4, na.rm = T)),
#             color = "Steelblue",
#             size = 1)+
#   geom_line(aes(x = Time, y = IN.9 - min(one.trace$IN.9, na.rm = T)),
#             color = "Firebrick",
#             size = 1)

# geom_line(aes(x = Time, y = IN.4), color = "Steelblue")+
# geom_line(aes(x = Time, y = IN.9), color = "Firebrick")
# geom_hline(yintercept = min(one.trace$IN.4, na.rm = T), color = "Steelblue")+
# geom_hline(yintercept = min(one.trace$IN.9, na.rm = T), color = "Firebrick")

# geom_line(aes(x = Time, y = IN.4 - min(one.trace$IN.4, na.rm = T)), color = "Steelblue")+
# geom_line(aes(x = Time, y = IN.9 - min(one.trace$IN.9, na.rm = T)), color = "Firebrick")+
# geom_line(aes(x = Time, y = diff))

# Second pass at annotation ----

one.trace <-
  one.trace %>%
  ungroup() %>%
  gather(Ch, mV, c("IN.4", "IN.9")) %>%
  group_by(Trace, Ch) %>%
  # Min Voltage
  mutate(Min.V = min(mV, na.rm = T)) %>%
  # Baseline voltage
  # Defining as average of the lowest 20% of points
  mutate(Use.in.Base = quantile(mV, probs = .2, na.rm = T)) %>%
  mutate(Use.in.Base = ifelse(mV <= Use.in.Base,
    mV,
    NA
  )) %>%
  mutate(Use.in.Base = mean(Use.in.Base, na.rm = T)) %>%
  # Max voltage
  mutate(Max.V = max(mV, na.rm = T)) %>%
  # Median Voltage
  mutate(Med.V = median(mV, na.rm = T)) %>%
  # Mean Voltage
  mutate(Mean.V = mean(mV, na.rm = T)) %>%
  # Duration
  mutate(Max.Time = max(Time, na.rm = T))






# Delay
# Get time at which voltage traces cross a threshold. Then compute the abs(difference)
delays.to.annotate <- one.trace %>%
  mutate(Delay = (mV >= quantile(mV, probs = .9, na.rm = T))) %>%
  filter(Delay == T) %>%
  summarise(
    Thres.Time.b = min(Time, na.rm = T),
    Thres.Time.e = max(Time, na.rm = T)
  )


one.trace$Onset <- NA
one.trace$Termination <- NA
walk(seq(1, nrow(delays.to.annotate)), function(i) {
  one.trace[
    one.trace$Trace == as.character(delays.to.annotate[i, "Trace"]) &
      one.trace$Ch == as.character(delays.to.annotate[i, "Ch"]),
    "Onset"
  ] <<- as.numeric(delays.to.annotate[i, "Thres.Time.b"])

  one.trace[
    one.trace$Trace == as.character(delays.to.annotate[i, "Trace"]) &
      one.trace$Ch == as.character(delays.to.annotate[i, "Ch"]),
    "Termination"
  ] <<- as.numeric(delays.to.annotate[i, "Thres.Time.e"])
})



one.trace <- one.trace %>%
  # On duration
  mutate(On.Duration = Termination - Onset) %>%
  # Duty Cycle
  mutate(Duty.Cycle = On.Duration / Max.Time) %>%
  # AUC
  # Using Min.V
  mutate(AUC = (mV - Min.V))


one.trace.list <- map(c("IN.4", "IN.9"), function(i) {
  temp <- filter(one.trace, Ch == i)

  temp.names <- names(temp)

  temp.names[!(temp.names %in% c("Trace", "Time", "Ch"))] <-
    paste(temp.names[!(temp.names %in% c("Trace", "Time", "Ch"))], i, sep = "_")

  names(temp) <- temp.names

  temp %>% ungroup()

  return(temp)
})


one.trace <- full_join(one.trace.list[[1]],
  one.trace.list[[2]],
  by = c("Trace", "Time")
)


one.trace <- one.trace %>%
  dplyr::group_by(Trace) %>%
  # Delay
  mutate(Delay_IN.4 = ifelse(
    Onset_IN.4 <= Onset_IN.9,
    0,
    Onset_IN.4 - Onset_IN.9
  )) %>%
  mutate(Delay_IN.9 = ifelse(
    Onset_IN.9 <= Onset_IN.4,
    0,
    Onset_IN.9 - Onset_IN.4
  )) %>%
  # Percent Delay (can be converted into phase)
  mutate(P.Delay_IN.4 = Delay_IN.4 / Max.Time_IN.4) %>%
  mutate(P.Delay_IN.9 = Delay_IN.9 / Max.Time_IN.9) %>%
  # Correlation
  mutate(Cor = cor(mV_IN.4, mV_IN.9,
    use = "pairwise.complete.obs",
    method = "pearson"
  )) %>%
  # intersect AUC / % overlap
  mutate(Min.AUC = ifelse(AUC_IN.4 <= AUC_IN.9,
    AUC_IN.4,
    AUC_IN.9
  ))



```




```{r}

## show that min AUC is acting as expected ====

# one.trace %>%
#   ggplot(aes(group = Trace)) +
#   geom_line(aes(x = Time, y = mV_IN.4 - Min.V_IN.4), color = "Blue", alpha = 0.4) +
#   geom_line(aes(x = Time, y = mV_IN.9 - Min.V_IN.9), color = "Red", alpha = 0.4) +
#   geom_line(aes(x = Time, y = Min.AUC), color = "Purple") +
#   facet_grid(. ~ Trace)



## Get summary of all ====

# 1. Get single value descriptors for each trace
one.trace  <- one.trace %>% ungroup() %>% dplyr::group_by(Trace) %>% 
  # Voltages
  mutate(Mean.Min.V = mean(mean(Min.V_IN.4, na.rm = T), mean(Min.V_IN.9, na.rm = T))) %>% 
  mutate(Mean.Max.V = mean(mean(Max.V_IN.4, na.rm = T), mean(Max.V_IN.9, na.rm = T))) %>% 
  mutate(Mean.Med.V = mean(mean(Med.V_IN.4, na.rm = T), mean(Med.V_IN.9, na.rm = T))) %>% 
  mutate(Mean.Mean.V = mean(mean(Mean.V_IN.4, na.rm = T), mean(Mean.V_IN.9, na.rm = T))) %>% 
  
  # Times
  mutate(Mean.Duration = mean(mean(Max.Time_IN.4, na.rm = T), mean(Max.Time_IN.9, na.rm = T))) %>%
  mutate(Mean.On.Duration = mean(mean(On.Duration_IN.4, na.rm = T), mean(On.Duration_IN.9, na.rm = T))) %>% 
  mutate(Mean.Duty.Cycle = mean(mean(Duty.Cycle_IN.4, na.rm = T), mean(Duty.Cycle_IN.9, na.rm = T))) %>% 
  
  mutate(Onset.Delay = max(Delay_IN.4, Delay_IN.9, na.rm = T)) %>% 
  mutate(P.Onset.Delay = max(P.Delay_IN.4, P.Delay_IN.9, na.rm = T)) %>% 
  
  # AUCs -- convert to single value of mV/trace
  mutate(Mean.AUC = mean(sum(AUC_IN.4, na.rm = T), sum(AUC_IN.9, na.rm = T))) %>% 
  mutate(Min.AUC = sum(Min.AUC, na.rm = T)) %>% 
  ## and mV/S
  mutate(Mean.AUC.mV.S = Mean.AUC/Mean.Duration) %>%
  mutate(Min.AUC.mV.S = Min.AUC/Mean.Duration) %>%

  # Clean up selection
  dplyr::select(Trace, #Time, 
                Mean.Min.V, Mean.Max.V, Mean.Med.V, Mean.Mean.V, 
                Mean.Duration, Mean.On.Duration, Mean.Duty.Cycle, 
                Onset.Delay, P.Onset.Delay,
                Mean.AUC, Min.AUC, 
                Mean.AUC.mV.S, Min.AUC.mV.S,
                Cor) %>% ungroup()
 
# 2. Remove the duplicate measures.  
one.trace <- one.trace[!(duplicated(one.trace)), ] 

# 3. Join with gj change datasets
## get the OG dataset
Orig <- M.d %>% dplyr::filter(Condition %in% c("PS.0.orig",     
                                               "PS.22.orig",   
                                               "PS.45.orig",   
                                               "PS.90.orig",
                                               "PS.180.orig"))
Orig.exps <- Orig$Experiment %>% unique()

# Make trace names join-able
new.Trace.names <- stringr::str_split(one.trace$Trace, pattern = "_0") %>% 
  map(function(i){
    pluck(i,1)
  }) %>% unlist()

# Manually fix two
# Orig.exps[!(Orig.exps %in% new.Trace.names)]
# new.Trace.names[!(new.Trace.names %in% Orig.exps)]
new.Trace.names[new.Trace.names == "171016_B"] <- "171016"
new.Trace.names[new.Trace.names == "171017_A"] <- "171017"

one.trace <- one.trace %>% mutate(Experiment = new.Trace.names)

Orig <- full_join(Orig, one.trace, by = "Experiment")



EDA <- 
Orig %>% 
  dplyr::select(
    "Condition", "Experiment", "Time", "Inj_Cell", 
    "r11", "r12", "r1", "rc", "cc", "rmp",
    "Mean.Min.V", "Mean.Max.V", "Mean.Med.V","Mean.Mean.V",
    "Mean.Duration", "Mean.On.Duration", "Mean.Duty.Cycle", "Onset.Delay", "P.Onset.Delay", 
    "Mean.AUC", "Min.AUC", "Mean.AUC.mV.S", "Min.AUC.mV.S", "Cor")# %>% 
  # dplyr::filter(Time == "40") %>% 
  # ggplot()+
  # geom_point(aes(x = Mean.Min.V, y =rc))
```

## EDA
```{r}

# Orig %>% 
#   dplyr::filter(Time == "40") %>% 
#   dplyr::select(
#     # "Condition", "Experiment", "Time", "Inj_Cell", 
#     # "r11", "r12", "r1", 
#     "rc", "cc", "rmp",
#     "Mean.Min.V", "Mean.Max.V", "Mean.Med.V","Mean.Mean.V",
#     "Mean.Duration", "Mean.On.Duration", "Mean.Duty.Cycle", "Onset.Delay", "P.Onset.Delay", 
#     "Mean.AUC", "Min.AUC", "Cor") %>% GGally::ggpairs()



# library(plotly)
# 
# 
# plot_ly(EDA, y = ~Time, z = ~rc, x = ~Onset.Delay) %>% 
#   add_markers()
# 
# 
# plot_ly(EDA, y = ~Time, z = ~rc, x = ~Mean.Min.V) %>% 
#   add_markers()




# outputs: 
#     "rc", "cc"
# inputs: 
#     "Mean.Min.V", "Mean.Max.V", "Mean.Med.V","Mean.Mean.V",
#     "Mean.Duration", "Mean.On.Duration", "Mean.Duty.Cycle", "Onset.Delay", "P.Onset.Delay", 
#     "Mean.AUC", "Min.AUC", "Cor"
# facets:
#     "Time", ("rc", "cc")


EDA.r <- filter(EDA, Time != 0)

EDA.r <- EDA.r %>% mutate(Percent.Shift = Condition)

EDA.r$Percent.Shift <- (as.numeric(stringr::str_extract(EDA.r$Percent.Shift, "\\d+"))/360) 





iter.plot <- function(X = "Cor", Y = "rc"){
  ggplot(EDA.r, aes_string(x= X, y = Y))+
    geom_smooth(method = "lm")+
    geom_hline(yintercept = 0, color = "firebrick")+
    geom_point()+
    facet_grid(. ~ Time)+
    theme_clean()+
    theme(legend.position = "")  
}


ccplts <- map(
  c("Mean.Min.V", "Mean.Max.V", "Mean.Med.V", "Mean.Mean.V",
    "Mean.Duration", "Mean.On.Duration", "Mean.Duty.Cycle", NA,
    "Percent.Shift", "Onset.Delay", "P.Onset.Delay", "Cor",
    "Mean.AUC", "Min.AUC", "Mean.AUC.mV.S", "Min.AUC.mV.S"), 
  function(i){
    iter.plot(X = i, Y = "cc")
  })

rcplts <- map(
  c("Mean.Min.V", "Mean.Max.V", "Mean.Med.V", "Mean.Mean.V",
    "Mean.Duration", "Mean.On.Duration", "Mean.Duty.Cycle", NA,
    "Percent.Shift", "Onset.Delay", "P.Onset.Delay", "Cor",
    "Mean.AUC", "Min.AUC", "Mean.AUC.mV.S", "Min.AUC.mV.S"), 
  function(i){
    iter.plot(X = i, Y = "rc")
  })

# rcplts <- map(
cowplot::plot_grid(plotlist = ccplts, ncol = 4)


cowplot::plot_grid(plotlist = rcplts)

```





```{r}



df <- EDA.r %>% 
  filter(Time == 40) %>% 
  select("r11", "r12", "r1", "rc", "cc", "rmp",
   "Mean.Min.V", "Mean.Max.V", "Mean.Med.V", "Mean.Mean.V",
    "Mean.Duration", "Mean.On.Duration", "Mean.Duty.Cycle",
    "Percent.Shift", "Onset.Delay", "P.Onset.Delay", "Cor",
    "Mean.AUC", "Min.AUC", "Mean.AUC.mV.S", "Min.AUC.mV.S")


z <- prcomp(~., data = df, center = TRUE, scale. = TRUE)
fviz_screeplot(z, addlabels = TRUE, ylim = c(0, 50))
fviz_pca_var(z, col.var="contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE # Avoid text overlapping
             )

# z <- prcomp(~ Fat + Lactose, data = M, center = TRUE, scale. = TRUE)
# 
# str(z)
# summary(z)
# biplot(z)



library(factoextra)
library("FactoMineR") #PCA

res.pca <- PCA(df,  graph = FALSE)
# Extract eigenvalues/variances
get_eig(res.pca)
# Visualize eigenvalues/variances
fviz_screeplot(res.pca, addlabels = TRUE, ylim = c(0, 50))
# Extract the results for variables
var <- get_pca_var(res.pca)
var

# Graph of variables: default plot
fviz_pca_var(res.pca, col.var = "black")

# Control variable colors using their contributions
fviz_pca_var(res.pca, col.var="contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE # Avoid text overlapping
             )

```

```{r}

rc
Mean.Min.V
Mean.Max.V
Mean.Duty.Cycle
# Mean.On.Duration
# Mean.Duration

library(AICcmodavg)



mod <- aictab(
  cand.set = list(
  lm(rc ~ Mean.Min.V, data = df),

  lm(rc ~ Mean.Min.V + Mean.Duty.Cycle, data = df),
  lm(rc ~ Mean.Max.V + Mean.Duty.Cycle, data = df),
  lm(rc ~ Mean.Min.V + Mean.Max.V, data = df),
  
  
  lm(rc ~ Mean.Min.V * Mean.Duty.Cycle, data = df),
  lm(rc ~ Mean.Max.V * Mean.Duty.Cycle, data = df),
  lm(rc ~ Mean.Min.V * Mean.Max.V, data = df),
  
  lm(rc ~ Mean.Min.V + Mean.Max.V + Mean.Duty.Cycle, data = df),
  lm(rc ~ Mean.Min.V * Mean.Duty.Cycle + Mean.Max.V, data = df),
  lm(rc ~ Mean.Min.V + Mean.Max.V * Mean.Duty.Cycle, data = df),
  lm(rc ~ Mean.Min.V * Mean.Max.V + Mean.Duty.Cycle, data = df),
  lm(rc ~ Mean.Min.V * Mean.Max.V * Mean.Duty.Cycle, data = df)
  
))

write.csv(mod, file = "C:/Users/drk8b9/Desktop/temp.csv")


```


```{r}
EDA.r %>% ggplot(aes())




library(plotly)


plot_ly(dplyr::filter(EDA.r, Time == 40), y = ~Time, z = ~rc, x = ~Onset.Delay) %>%
  add_markers()
```


## Repeat with known endpoint, i.e. for other conditions

```{r}
M.d %>% filter(Condition %in% c("PS.0.High.Amp",  
                                "PS.22.High.Amp",
                                "PS.0",               
                                "PS.22",         
                                "PS.45",          
                                "PS.90")) %>% select(Experiment) %>% unique()
```






# Return to normal analysis

#### High Amp


```{r}

run_standardized_lme_resample_HA <- function(response.var = "cc",
                                          input.df = M[M$Condition %in% c("PS.0.High.Amp", "PS.22.High.Amp"), ],
                                          nreps = 1e4,
                                          use.seed = 432431,
                                          mute.completion = FALSE,
                                          mute.time = FALSE) {
  #for debugging
  if (F == T){
    response.var = "cc"
    input.df = M[M$Condition %in% c("PS.0.High.Amp", "PS.22.High.Amp"), ]
    nreps = 100
    use.seed = 432431
    mute.completion = FALSE
    mute.time = FALSE
  }
  
  tic <- Sys.time()
  
  # Transform the data so that it's ready for the test
  input.df <- input.df[!(is.na(input.df[[response.var]])), ]
  input.df$response.var <- input.df[[response.var]]
  # input.df$Time <- as.factor(input.df$Time)
  input.df$interact <- interaction(input.df$Experiment, input.df$Inj_Cell)
  
  input.df$Phase <- "None"
  input.df[input.df$Condition %in% c("PS.45", "PS.22.High.Amp"), "Phase"] <- "Offset"
  input.df[input.df$Condition %in% c("PS.0", "PS.0.High.Amp"), "Phase"] <- "Normal"
  input.df$Amp <- "None"
  # input.df[input.df$Condition %in% c("PS.0.High.Amp", "PS.22.High.Amp"), "Amp"] <- "High"
  # input.df[input.df$Condition %in% c("PS.0", "PS.45"), "Amp"] <- "Normal"
  
  input.df <- input.df[, c("response.var", "interact", "Time", "Phase", "Amp")]
  
  # First model with observed data
  fm <- lme(response.var ~ Time * Phase #+ Time * Amp + Phase * Amp
            , random = ~1 | interact, method = "ML", data = input.df)
  
  
  stats.table <- anova.lme(fm)
  
  F_stats <- matrix(NA, nrow = nreps, ncol = length(stats.table$`F-value`))
  F_stats[1, ] <- stats.table$`F-value`
  
  
  set.seed(use.seed)
  for (ii in 2:nreps) {
    
    if (mute.completion != TRUE){
      print(paste0(((ii/nreps)*100), "%"))
    }
    rand.lme <- try(lme(sample(response.var) ~ Time * Phase #+ Time * Amp + Phase * Amp
                        , random = ~1 | interact, method = "ML", data = input.df))
    
    
    F_stats[ii, ] <- try(anova.lme(rand.lme)$`F-value`)
    
    
    # In case there is a convergence issue we immediately replace that value to get the target number of reps. 
    while (is.na(as.numeric(F_stats[ii, 1]))) {
      print("Replacing model with singular convergence")
      rand.lme <- try(lme(sample(response.var) ~ Time * Phase #+ Time * Amp + Phase * Amp
                          , random = ~1 | interact, method = "ML", data = input.df))
      
      
      F_stats[ii, ] <- try(anova.lme(rand.lme)$`F-value`)
      
    }
  }
  
  F_stats <- as.data.frame(F_stats)
  names(F_stats) <- rownames(stats.table)
  
  #Convert from factor/cha to int
  walk(1:4, function(X){
    F_stats[,X] <<- as.numeric(F_stats[,X])
  })
  toc <- Sys.time()
  
  if (mute.time != TRUE){
    print(toc - tic)    
  }
  return(na.omit(F_stats))
}






```





```{r perform resampling, eval=FALSE}
if (resample.results == TRUE){
  tic1 <- Sys.time()
  me_cell <- purrr::map(c("r11", "r1", "cc"
                          # , "htk.peak.nA", "a.peak.nA"
                          ), function(x) {
    run_standardized_lme_resample_HA(
      response.var = x,
      input.df = M[M$Condition %in% c("PS.0.High.Amp", "PS.22.High.Amp"), ],
      nreps = resample.nreps,
      use.seed = 432431,
      mute.completion = TRUE,
      mute.time = FALSE
    )
  })
  
  me_exps <- purrr::map(c("rc", "gj"), function(x) {
    run_standardized_lme_resample_HA(
      response.var = x,
      input.df = M.gj[M.gj$Condition %in% c("PS.0.High.Amp", "PS.22.High.Amp"), ],
      nreps = resample.nreps,
      use.seed = 432431,
      mute.completion = TRUE,
      mute.time = FALSE
    )
  })
  toc1 <- Sys.time()
  print(toc1 - tic1)
  
  # Restructure into a single list of all outputs
  me_all <- list()
  walk(seq_along(me_cell), function(X){ me_all[[length(me_all)+1]] <<- me_cell[[X]] })
  walk(seq_along(me_exps), function(X){ me_all[[length(me_all)+1]] <<- me_exps[[X]] })
  
  saveRDS(me_all, file = paste0(getwd(), "/data/output/", "rHighAmp_model_results", ".rds"))
  write.csv(me_all, file = paste0(getwd(), "/data/output/", "rHighAmp_model_results", ".csv"))
} else {
  me_all <- readRDS(paste0(getwd(), "/data/", "rHighAmp_model_results", ".rds"))
}

```


```{r calc empirical p, eval=FALSE}
# Main effect empirical p values
measures <- c("r11", "r1", 
              "cc", 
              # "htk.peak.nA", "a.peak.nA",
              "rc", 
              "gj")
out <- as.data.frame(matrix(ncol = 4, nrow = length(measures)))
names(out) <- c("Intercept", "Time", "Phase", "Time:Phase")
rownames(out) <- measures

walk(seq_along(measures), function(i){
  walk(1:4, function(j){
    out[i, j] <<- one_tail_to_epval(input.array = me_all[[i]][,j], tail = "upper")
  })
})


out.holm <- t(out) %>% as.data.frame()
walk(1:ncol(out.holm), function(i){
  out.holm[,i] <<- p.adjust(out.holm[,i], method = "holm") 
})
out.holm <- t(out.holm) %>% as.data.frame()


knitr::kable(out)
knitr::kable(out.holm)

# write.csv(out, paste0(getwd(), "/epvals_phase.csv"))
# write.csv(out.holm, paste0(getwd(), "/epvals_holm_phase.csv"))

write.csv(out, paste0(getwd(), "/data/output/", "rHighAmp_model_pvals", ".csv"))
write.csv(out.holm, paste0(getwd(), "/data/output/", "rHighAmp_model_pvals_holm", ".csv"))
# write.csv(out.holm, paste0("C:/Users/Daniel/Desktop/epvals_holm_phase.csv"))

```




#### 2x2

```{r perform resampling, eval=FALSE}
if (resample.results == TRUE){
  tic1 <- Sys.time()
  me_cell <- purrr::map(c("r11", "r1", "cc"
                          # , "htk.peak.nA", "a.peak.nA"
                          ), function(x) {
    run_standardized_lme_resample(
      response.var = x,
      input.df = M[M$Condition %in% c("PS.0.High.Amp", "PS.0", "PS.22", "PS.22.High.Amp"), ],
      nreps = resample.nreps,
      use.seed = 432431,
      mute.completion = TRUE,
      mute.time = FALSE
    )
  })
  
  me_exps <- purrr::map(c("rc", "gj"), function(x) {
    run_standardized_lme_resample(
      response.var = x,
      input.df = M.gj[M.gj$Condition %in% c("PS.0.High.Amp", "PS.0", "PS.22", "PS.22.High.Amp"), ],
      nreps = resample.nreps,
      use.seed = 432431,
      mute.completion = TRUE,
      mute.time = FALSE
    )
  })
  toc1 <- Sys.time()
  print(toc1 - tic1)
  
  # Restructure into a single list of all outputs
  me_all <- list()
  walk(seq_along(me_cell), function(X){ me_all[[length(me_all)+1]] <<- me_cell[[X]] })
  walk(seq_along(me_exps), function(X){ me_all[[length(me_all)+1]] <<- me_exps[[X]] })
  
  saveRDS(me_all, file = paste0(getwd(), "/data/output/", "r2x2_model_results", ".rds"))
  write.csv(me_all, file = paste0(getwd(), "/data/output/", "r2x2_model_results", ".csv"))
} else {
  me_all <- readRDS(paste0(getwd(), "/data/output/", "r2x2_model_results", ".rds"))
}

```


```{r calc empirical p, eval=FALSE}
# Main effect empirical p values
measures <- c("r11", "r1", 
              "cc", 
              # "htk.peak.nA", "a.peak.nA",
              "rc", 
              "gj")
out <- as.data.frame(matrix(ncol = 7, nrow = length(measures)))
names(out) <- c("Intercept", "Time", "Phase", "Amp", "Time:Phase", "Time:Amp", "Phase:Amp")
rownames(out) <- measures

walk(seq_along(measures), function(i){
  walk(1:7, function(j){
    out[i, j] <<- one_tail_to_epval(input.array = me_all[[i]][,j], tail = "upper")
  })
})


out.holm <- t(out) %>% as.data.frame()
walk(1:ncol(out.holm), function(i){
  out.holm[,i] <<- p.adjust(out.holm[,i], method = "holm") 
})
out.holm <- t(out.holm) %>% as.data.frame()


knitr::kable(out)
knitr::kable(out.holm)

write.csv(out, paste0(getwd(), "/data/output/", "r2x2_model_pvals", ".csv"))
write.csv(out.holm, paste0(getwd(), "/data/output/", "r2x2_model_pvals_holm", ".csv"))
```

##### 2x2 using _45_
```{r perform resampling, eval=FALSE}
if (resample.results == TRUE){
  tic1 <- Sys.time()
  me_cell <- purrr::map(c("r11", "r1", "cc"
                          # , "htk.peak.nA", "a.peak.nA"
                          ), function(x) {
    run_standardized_lme_resample_W_45(
      response.var = x,
      input.df = M[M$Condition %in% c("PS.0.High.Amp", "PS.0", "PS.45", "PS.22.High.Amp"), ],
      nreps = resample.nreps,
      use.seed = 432431,
      mute.completion = TRUE,
      mute.time = FALSE
    )
  })
  
  me_exps <- purrr::map(c("rc", "gj"), function(x) {
    run_standardized_lme_resample_W_45(
      response.var = x,
      input.df = M.gj[M.gj$Condition %in% c("PS.0.High.Amp", "PS.0", "PS.45", "PS.22.High.Amp"), ],
      nreps = resample.nreps,
      use.seed = 432431,
      mute.completion = TRUE,
      mute.time = FALSE
    )
  })
  toc1 <- Sys.time()
  print(toc1 - tic1)
  
  # Restructure into a single list of all outputs
  me_all <- list()
  walk(seq_along(me_cell), function(X){ me_all[[length(me_all)+1]] <<- me_cell[[X]] })
  walk(seq_along(me_exps), function(X){ me_all[[length(me_all)+1]] <<- me_exps[[X]] })
  
  saveRDS(me_all, file = paste0(getwd(), "/data/output/", "r2x2_W_45_model_results", ".rds"))
  write.csv(me_all, file = paste0(getwd(), "/data/output/", "r2x2_W_45_model_results", ".csv"))
} else {
  me_all <- readRDS(paste0(getwd(), "/data/output/", "r2x2_W_45_model_results", ".rds"))
}

```


```{r calc empirical p, eval=FALSE}
# Main effect empirical p values
measures <- c("r11", "r1", 
              "cc", 
              # "htk.peak.nA", "a.peak.nA",
              "rc", 
              "gj")
out <- as.data.frame(matrix(ncol = 7, nrow = length(measures)))
names(out) <- c("Intercept", "Time", "Phase", "Amp", "Time:Phase", "Time:Amp", "Phase:Amp")
rownames(out) <- measures

walk(seq_along(measures), function(i){
  walk(1:7, function(j){
    out[i, j] <<- one_tail_to_epval(input.array = me_all[[i]][,j], tail = "upper")
  })
})


out.holm <- t(out) %>% as.data.frame()
walk(1:ncol(out.holm), function(i){
  out.holm[,i] <<- p.adjust(out.holm[,i], method = "holm") 
})
out.holm <- t(out.holm) %>% as.data.frame()


knitr::kable(out)
knitr::kable(out.holm)

write.csv(out, paste0(getwd(), "/data/output/", "r2x2_W_45_model_pvals", ".csv"))
write.csv(out.holm, paste0(getwd(), "/data/output/", "r2x2_W_45_model_pvals_holm", ".csv"))
```


### stats tables ANOVA on t = 40 deltas
#### Controlled
```{r}
d <- M.d.gj
d <- d %>% 
  dplyr::select(c("Condition", "Experiment", "Time", "gj")) %>% 
  dplyr::filter(Condition %in% c(
    # "PS.0.orig",
    # "PS.22.orig",
    # "PS.45.orig",
    # "PS.90.orig",
    # "PS.180.orig",
    
    "PS.0",
    "PS.22",
    "PS.45",
    "PS.90"#,
    
    # "PS.0.High.Amp",
    # "PS.22.High.Amp",
    # 
    # "Inv",
    # "PS.0.TEA",
    # "Silent.53mV"
  )) 

# d <- d[is.na(d$Condition),]
d$Condition <- factor(d$Condition, levels = c(
  "PS.0",
  "PS.22",
  "PS.45",
  "PS.90"))

aov_tab <- data.frame()
hsd_tab <- data.frame()
walk(c(20, 40, 60), function(i){
# for (i in c(20, 40, 60)){
  print(paste(as.character(i), "minutes"))
  fm <- lm(gj ~ Condition,   dplyr::filter(d, Time == i))
  print(Anova(fm, type = "III"))
  fm_T <- agricolae::HSD.test(fm, "Condition")
  print(fm_T$groups)
# }
  
  t1 <- Anova(fm, type = "III")
  t1$endpoint <- i
  t2 <- fm_T$groups
  t2$endpoint <- i
  
aov_tab <<- rbind(aov_tab, t1)
hsd_tab <<- rbind(hsd_tab, t2)  
})



write.csv(aov_tab, "./data/output/aovCon.csv")
write.csv(hsd_tab, "./data/output/hsdCon.csv")
```

#### Controlled rstanarm
```{r}
d <- M.gj
d <- d %>% 
  dplyr::select(c("Condition", "Experiment", "Time", "gj")) %>% 
  dplyr::filter(Condition %in% c(
    # "PS.0.orig",
    # "PS.22.orig",
    # "PS.45.orig",
    # "PS.90.orig",
    # "PS.180.orig",
    
    "PS.0",
    "PS.22",
    "PS.45",
    "PS.90"#,
    
    # "PS.0.High.Amp",
    # "PS.22.High.Amp",
    # 
    # "Inv",
    # "PS.0.TEA",
    # "Silent.53mV"
  )) 

# d <- d[is.na(d$Condition),]
d$Condition <- factor(d$Condition, levels = c(
  "PS.0",
  "PS.22",
  "PS.45",
  "PS.90"))

d$Time <- as.factor(d$Time)
d$Time <- factor(d$Time, levels = c(0, 20, 40, 60))

d$interact <- paste(d$Experiment, d$Inj_Cell, sep = ".")

model <- rstanarm::stan_lmer(gj ~ Time * Condition + (1 | Experiment), data = d)

#PD
result <- p_direction(model)
plot(result) + theme_modern() + scale_fill_manual(values = c("firebrick", "steelblue"))

ggsave(
      "PD.Con.pdf",
      plot = ggplot2::last_plot(),
      device = NULL,
      path = paste0(getwd(), "/data/figures"),
width = 9.4, height = 9.4,
      # units = c("in", "cm", "mm"),
      dpi = 75#, limitsize = TRUE, ...
    )

#HDI
# result <- hdi(model, ci = c(0.67, 0.89, 0.97))
# plot(result) + theme_modern() + scale_fill_brewer(palette = "Blues", 
#     direction = -1)

#ROPE
# result <- rope(model, ci = c(0.9, 0.95))
# 
# plot(result, data = model, rope_color = "firebrick") + theme_modern() + 
#     scale_fill_brewer(palette = "Blues", direction = -1)

#Test for Practical Equivalence
result <- equivalence_test(model, ci = c(0.95))
plot(result) + theme_modern() + scale_fill_manual(values = c("firebrick", "steelblue"))

ggsave(
      "CI95.Con.pdf",
      plot = ggplot2::last_plot(),
      device = NULL,
      path = paste0(getwd(), "/data/figures"),
width = 9.4, height = 9.4,
      # units = c("in", "cm", "mm"),
      dpi = 75#, limitsize = TRUE, ...
    )

write.csv(describe_posterior(model, ci = 0.95, rope_ci = 0.95), paste0(getwd(), "/data/output/", "bayesCon", ".csv"))
```

#### Naturalistic
```{r}
d <- M.d.gj
d <- d %>% 
  dplyr::select(c("Condition", "Experiment", "Time", "rc")) %>% 
  dplyr::filter(Condition %in% c(
    "PS.0.orig",
    "PS.22.orig",
    "PS.45.orig",
    "PS.90.orig",
    "PS.180.orig"#,
    
    # "PS.0",
    # "PS.22",
    # "PS.45",
    # "PS.90",
    
    # "PS.0.High.Amp",
    # "PS.22.High.Amp",
    # 
    # "Inv",
    # "PS.0.TEA",
    # "Silent.53mV"
  )) 

# d <- d[is.na(d$Condition),]
d$Condition <- factor(d$Condition, levels = c(
  "PS.0.orig",
  "PS.22.orig",
  "PS.45.orig",
  "PS.90.orig",
  "PS.180.orig"))

aov_tab <- data.frame()
hsd_tab <- data.frame()
walk(c(20, 40, 60), function(i){
# for (i in c(20, 40, 60)){
  print(paste(as.character(i), "minutes"))
  fm <- lm(rc ~ Condition,   dplyr::filter(d, Time == i))
  print(Anova(fm, type = "III"))
  fm_T <- agricolae::HSD.test(fm, "Condition")
  print(fm_T$groups)
# }
    t1 <- Anova(fm, type = "III")
  t1$endpoint <- i
  t2 <- fm_T$groups
  t2$endpoint <- i
  
aov_tab <<- rbind(aov_tab, t1)
hsd_tab <<- rbind(hsd_tab, t2)  
})

write.csv(aov_tab, "./data/output/aovNat.csv")
write.csv(hsd_tab, "./data/output/hsdNat.csv")
```

#### Naturalistic rstanarm
```{r}
d <- M.gj
d <- d %>% 
  dplyr::select(c("Condition", "Experiment", "Time", "rc")) %>% 
  dplyr::filter(Condition %in% c(
    "PS.0.orig",
    "PS.22.orig",
    "PS.45.orig",
    "PS.90.orig",
    "PS.180.orig"#,
    
    # "PS.0",
    # "PS.22",
    # "PS.45",
    # "PS.90",
    
    # "PS.0.High.Amp",
    # "PS.22.High.Amp",
    # 
    # "Inv",
    # "PS.0.TEA",
    # "Silent.53mV"
  )) 

# d <- d[is.na(d$Condition),]
d$Condition <- factor(d$Condition, levels = c(
  "PS.0.orig",
  "PS.22.orig",
  "PS.45.orig",
  "PS.90.orig",
  "PS.180.orig"))

d$Time <- as.factor(d$Time)
d$Time <- factor(d$Time, levels = c(0, 20, 40, 60))

d$interact <- paste(d$Experiment, d$Inj_Cell, sep = ".")

model <- rstanarm::stan_lmer(rc ~ Time * Condition + (1 | Experiment), data = d)
# model <- rstanarm::stan_glm(rc ~ Time * Condition + Experiment, data = d)

#PD
result <- p_direction(model)
plot(result) + theme_modern() + scale_fill_manual(values = c("firebrick", "steelblue"))

ggsave(
      "PD.Nat.pdf",
      plot = ggplot2::last_plot(),
      device = NULL,
      path = paste0(getwd(), "/data/figures"),
width = 9.4, height = 9.4,
      # units = c("in", "cm", "mm"),
      dpi = 75#, limitsize = TRUE, ...
    )

#HDI
# result <- hdi(model, ci = c(0.67, 0.89, 0.97))
# plot(result) + theme_modern() + scale_fill_brewer(palette = "Blues", 
#     direction = -1)

#ROPE
# result <- rope(model, ci = c(0.9, 0.95))
# 
# plot(result, data = model, rope_color = "firebrick") + theme_modern() + 
#     scale_fill_brewer(palette = "Blues", direction = -1)

#Test for Practical Equivalence
result <- equivalence_test(model, ci = c(0.95))
plot(result) + theme_modern() + scale_fill_manual(values = c("firebrick", "steelblue"))

ggsave(
      "CI95.Nat.pdf",
      plot = ggplot2::last_plot(),
      device = NULL,
      path = paste0(getwd(), "/data/figures"),
width = 9.4, height = 9.4,
      # units = c("in", "cm", "mm"),
      dpi = 75#, limitsize = TRUE, ...
    )

write.csv(describe_posterior(model, ci = 0.95, rope_ci = 0.95), paste0(getwd(), "/data/output/", "bayesNat", ".csv"))
```

#### 2x2
```{r}
d <- M.d.gj
# d <- M.gj
d <- d %>% 
  dplyr::select(c("Condition", "Experiment", "Inj_Cell", "Time", "gj")) %>% 
  dplyr::filter(Condition %in% c(
    # "PS.0.orig",
    # "PS.22.orig",
    # "PS.45.orig",
    # "PS.90.orig",
    # "PS.180.orig",
    
    "PS.0",
    "PS.22",
    # "PS.45",
    # "PS.90",
    
    "PS.0.High.Amp",
    "PS.22.High.Amp"#,
    # 
    # "Inv",
    # "PS.0.TEA",
    # "Silent.53mV"
  )) 


d$Amp <- ifelse(d$Condition %in% c("PS.0", "PS.22"), "low", "high")
d$Phase <- ifelse(d$Condition %in% c("PS.0", "PS.0.High.Amp"), "0", "22.5")

d$Amp <- as.factor(d$Amp)
d$Amp <- factor(d$Amp, levels = c("low", "high"))

d$Phase <- as.factor(d$Phase)
d$Phase <- factor(d$Phase, levels = c("0", "22.5"))


aov_tab <- data.frame()
hsd_tab <- data.frame()
walk(c(20, 40, 60), function(i){
# for (i in c(20, 40, 60)){
  print(paste(as.character(i), "minutes"))
  fm <- lm(gj ~ Phase*Amp,   dplyr::filter(d, Time == i))
  print(Anova(fm, type = "III"))
  fm_T <- agricolae::HSD.test(fm, c("Phase", "Amp"))
  print(fm_T$groups)
# }
  t1 <- Anova(fm, type = "III")
  t1$endpoint <- i
  t2 <- fm_T$groups
  t2$endpoint <- i
  
aov_tab <<- rbind(aov_tab, t1)
hsd_tab <<- rbind(hsd_tab, t2)  
})

write.csv(aov_tab, "./data/output/aov2x2.csv")
write.csv(hsd_tab, "./data/output/hsd2x2.csv")



# # model <- rstanarm::stan_glm(Sepal.Length ~ Petal.Width * Species,
# #     data = iris)
# 
# 
# d$interact <- paste(d$Experiment, d$Inj_Cell, sep = ".")
# 
# #   fm <- lme(gj ~ Time * Phase + Time * Amp + Phase * Amp, random = ~1 | interact, method = "ML", data = d)
# 
# 
# d$Time <- as.factor(d$Time)
# d$Time <- factor(d$Time, levels = c(0, 20, 40, 60))
# 
# # model <- rstanarm::stan_lmer(gj ~ Time * Phase + Time * Amp + Phase * Amp + (1 | interact), data = d)
# 
# ggplot(dplyr::filter(d, Time == 40), aes(x = Condition, y = gj))+
#   geom_hline(yintercept = 0)+
#   geom_boxplot()+
#   geom_point(aes(color = Condition), size = 2)+
#   kickme()
# 
# 
# model <- rstanarm::stan_glm(gj ~ Phase*Amp,
#                             # prior = student_t(),
#           data = dplyr::filter(d, Time == 40))
# 
# 
# result <- estimate_density(model)
# 
# plot(result)
# 
# 
# #PI
# result <- p_direction(model)
# 
# plot(result) + theme_modern() + scale_fill_manual(values = c("firebrick", "steelblue"))
# 
# #HDI
# result <- hdi(model, ci = c(0.67, 0.89, 0.97))
# 
# plot(result) + theme_modern() + scale_fill_brewer(palette = "Blues",
#     direction = -1)
# 
# #ROPE
# result <- rope(model, ci = c(0.9, 0.95))
# 
# plot(result, data = model, rope_color = "firebrick") + theme_modern() +
#     scale_fill_brewer(palette = "Blues", direction = -1)
# 
# #Test for Practical Equivalence
# 
# result <- equivalence_test(model)
# 
# plot(result) + theme_blackboard() + scale_fill_material()
# 
# 
# result <- equivalence_test(model, ci = c(0.92, 0.94, 0.95))
# plot(result) + theme_abyss() + scale_fill_flat()
```

#### 2x2 rstanarm
```{r}
d <- M.gj
# d <- M.gj
d <- d %>% 
  dplyr::select(c("Condition", "Experiment", "Inj_Cell", "Time", "gj")) %>% 
  dplyr::filter(Condition %in% c(
    # "PS.0.orig",
    # "PS.22.orig",
    # "PS.45.orig",
    # "PS.90.orig",
    # "PS.180.orig",
    
    "PS.0",
    "PS.22",
    # "PS.45",
    # "PS.90",
    
    "PS.0.High.Amp",
    "PS.22.High.Amp"#,
    # 
    # "Inv",
    # "PS.0.TEA",
    # "Silent.53mV"
  )) 


d$Amp <- ifelse(d$Condition %in% c("PS.0", "PS.22"), "low", "high")
d$Phase <- ifelse(d$Condition %in% c("PS.0", "PS.0.High.Amp"), "0", "22.5")

d$Amp <- as.factor(d$Amp)
d$Amp <- factor(d$Amp, levels = c("low", "high"))

d$Phase <- as.factor(d$Phase)
d$Phase <- factor(d$Phase, levels = c("0", "22.5"))


d$Time <- as.factor(d$Time)
d$Time <- factor(d$Time, levels = c(0, 20, 40, 60))

d$interact <- paste(d$Experiment, d$Inj_Cell, sep = ".")

model <- rstanarm::stan_lmer(gj ~ Time * Phase + Time * Amp + Phase * Amp + (1 | interact), data = d)


#PD
result <- p_direction(model)
plot(result) + theme_modern() + scale_fill_manual(values = c("firebrick", "steelblue"))

ggsave(
      "PD.2x2.pdf",
      plot = ggplot2::last_plot(),
      device = NULL,
      path = paste0(getwd(), "/data/figures"),
width = 9.4, height = 9.4,
      # units = c("in", "cm", "mm"),
      dpi = 75#, limitsize = TRUE, ...
    )

#HDI
# result <- hdi(model, ci = c(0.67, 0.89, 0.97))
# plot(result) + theme_modern() + scale_fill_brewer(palette = "Blues", 
#     direction = -1)

#ROPE
# result <- rope(model, ci = c(0.9, 0.95))
# 
# plot(result, data = model, rope_color = "firebrick") + theme_modern() + 
#     scale_fill_brewer(palette = "Blues", direction = -1)

#Test for Practical Equivalence
result <- equivalence_test(model, ci = c(0.95))
plot(result) + theme_modern() + scale_fill_manual(values = c("firebrick", "steelblue"))

ggsave(
      "CI95.2x2.pdf",
      plot = ggplot2::last_plot(),
      device = NULL,
      path = paste0(getwd(), "/data/figures"),
width = 9.4, height = 9.4,
      # units = c("in", "cm", "mm"),
      dpi = 75#, limitsize = TRUE, ...
    )

write.csv(describe_posterior(model, ci = 0.95, rope_ci = 0.95), paste0(getwd(), "/data/output/", "bayes2x2", ".csv"))
```






#### Naturalistic rstanarm
```{r}
d <- M.gj
d <- d %>% 
  dplyr::select(c("Condition", "Experiment", "Time", "rc")) %>% 
  dplyr::filter(Condition %in% c(
    "PS.0.orig",
    "PS.22.orig",
    "PS.45.orig",
    "PS.90.orig",
    # "PS.180.orig"#,
    
    "PS.0",
    "PS.22",
    "PS.45",
    "PS.90",
    
    "PS.0.High.Amp",
    "PS.22.High.Amp"
    # 
    # "Inv",
    # "PS.0.TEA",
    # "Silent.53mV"
  )) 

d$Condition <- as.character(d$Condition)

d[d$Condition %in% c("PS.0.orig",
    "PS.0",
    "PS.0.High.Amp"), "Condition"] <- "0"

d[d$Condition %in% c(
    "PS.22.orig",
    "PS.22",
    "PS.22.High.Amp"), "Condition"] <- "22.5"

d[d$Condition %in% c(
    "PS.45.orig",
    "PS.45"
), "Condition"] <- "45"

d[d$Condition %in% c("PS.90.orig",
    
    "PS.90"), "Condition"] <- "90"


d$Condition <- as.factor(d$Condition)
# d <- d[is.na(d$Condition),]
d$Condition <- factor(d$Condition, levels = c(
  "0",
  "22.5",
  "45",
  "90"))

d$Time <- as.factor(d$Time)
d$Time <- factor(d$Time, levels = c(0, 20, 40, 60))

d$interact <- paste(d$Experiment, d$Inj_Cell, sep = ".")

model <- rstanarm::stan_lmer(rc ~ Time * Condition + (1 | Experiment), data = d)
# model <- rstanarm::stan_glm(rc ~ Time * Condition + Experiment, data = d)

# plot(model$coefficients)

#PD
result <- p_direction(model)
plot(result) + theme_modern() + scale_fill_manual(values = c("firebrick", "steelblue"))

ggsave(
      "PD.Nat.pdf",
      plot = ggplot2::last_plot(),
      device = NULL,
      path = paste0(getwd(), "/data/figures"),
width = 9.4, height = 9.4,
      # units = c("in", "cm", "mm"),
      dpi = 75#, limitsize = TRUE, ...
    )

#HDI
result <- hdi(model, ci = c(0.67, 0.89, 0.97))
plot(result) + theme_modern() + scale_fill_brewer(palette = "Blues",
    direction = -1)

#ROPE
result <- rope(model, ci = c(0.9, 0.95))

plot(result, data = model, rope_color = "firebrick") + theme_modern() +
    scale_fill_brewer(palette = "Blues", direction = -1)

#Test for Practical Equivalence
result <- equivalence_test(model, ci = c(0.95))
plot(result) + theme_modern() + scale_fill_manual(values = c("firebrick", "steelblue"))

# ggsave(
#       "CI95.Nat.pdf",
#       plot = ggplot2::last_plot(),
#       device = NULL,
#       path = paste0(getwd(), "/data/figures"),
# width = 9.4, height = 9.4,
#       # units = c("in", "cm", "mm"),
#       dpi = 75#, limitsize = TRUE, ...
#     )

# write.csv(describe_posterior(model, ci = 0.95, rope_ci = 0.95), paste0(getwd(), "/data/output/", "bayesNat", ".csv"))

# fit <- stan_glm(mpg ~ ., data = mtcars)
posterior <- as.matrix(model)

plot_title <- ggtitle("Posterior distributions",
                      "with medians and 80% intervals")

library(bayesplot)
mcmc_areas(posterior,
           pars = c("Time60:Condition22.5", "Time60:Condition45", "Time60:Condition90")[3:1],
           prob = 0.8) + plot_title+
  coord_flip()


#see
result <- estimate_density(model)

result$Parameter %>% unique()

plot(result[result[,1] %in% c("Time60:Condition22.5", "Time60:Condition45", "Time60:Condition90"),])
```




# end for now
```{r}
#FIXME temp end
print(paste0("Completed in ", as.character(Sys.time()-ttock)))
# 3h, 10m
```

```{r}

```











###

```{r}
ribbon_fig <- function(d = M.d.gj,
                       condition = "PS.0",
                       yvar = "gj"){
  ggplot(d[d$Condition == condition, ], aes_string("Time", yvar, fill = "Condition"))+
    stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "ribbon", alpha = 0.1)+ 
    geom_pointline(aes(group = inter, color = Condition), alpha = 0.3)+
    stat_summary(fun.y = mean, geom = "point", aes(color = Condition), size = 3, shape = 15) +
    stat_summary( fun.y = mean, geom = "line", aes(color = Condition), size = 1, linetype = 2) +
    kickme()+
    theme(legend.position = "")
}

# "Silent.53mV",
# "PS.0.TEA", 
# "Inv", 
# "PS.0", 
# "PS.22", 
# "PS.45", 
# "PS.90", 
# "PS.0.High.Amp",
# "PS.22.High.Amp",
# 
# "PS.0.orig",
# "PS.22.orig",
# "PS.45.orig",
# "PS.90.orig",
# "PS.180.orig"
















# condition.array <- c(
#   "PS.0.orig",
#   "PS.22.orig",
#   "PS.45.orig",
#   "PS.90.orig",
#   "PS.180.orig",
#   
#   "PS.0",
#   "PS.22",
#   "PS.45",
#   "PS.90",
#   
#   "PS.0.High.Amp",
#   "PS.22.High.Amp",
#   
#   "Inv",
#   "PS.0.TEA",
#   "Silent.53mV"
# 
# )
# 
# color.array <- c("#9E0142" , "#D53E4F" , "#F46D43" , "#FDAE61" , "#FEE08B" , "#FFFFBF" , "#E6F598" , "#ABDDA4" , "#66C2A5" , "#3288BD" , "#5E4FA2",
#                  "#9E0142" , "#D53E4F" , "#F46D43" , "#FDAE61" , "#FEE08B" , "#FFFFBF" , "#E6F598" , "#ABDDA4" , "#66C2A5" , "#3288BD" , "#5E4FA2")
# 
# myplts <- map(seq_along(condition.array), function(i){
#        condition <- condition.array[i]
# 
# ggplot(data = d[d$Condition %in% condition, ], aes_string("Time", yvar, fill = "Condition"))+
#   geom_hline(yintercept = 0, color = "black")+
#   geom_ribbon(aes(ymin=0, ymax=Condition.Mean), alpha = 0.5)+
#   # geom_ribbon(aes(ymin=-4, ymax=0), fill = "Black")+
#   # stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "ribbon", alpha = 0.02)+
#   geom_pointline(aes(group = inter, color = Condition), alpha = 0.3)+
#   stat_summary(fun.y = mean, geom = "point", aes(color = Condition), size = 3, shape = 15) +
#   stat_summary( fun.y = mean, geom = "line", aes(color = Condition), size = 1, linetype = 2) +
#   kickme()+
#   # coord_cartesian(ylim = c(-4, 4))+
#   labs(y = "", x = "")+
#   theme(legend.position = "")+
#   # facet_grid(Stim.type ~ Phase.angle)
#   scale_fill_manual(values = color.array[i])+
#   scale_color_manual(values = color.array[i])
#      })
#     
# plot_grid(plotlist = 
#             list(myplts[[1]], myplts[[2]], myplts[[3]], myplts[[4]], myplts[[5]], 
#                  myplts[[6]], myplts[[7]], myplts[[8]], myplts[[9]],    NULL, 
#                  myplts[[10]], myplts[[11]],    NULL,    NULL,    NULL,
#                  myplts[[12]],    NULL,    NULL,    NULL,    NULL,
#                  myplts[[13]],    NULL,    NULL,    NULL,    NULL,
#                           myplts[[14]]), 
#           ncol = 5)
# 
# ggplot()+geom_blank()+xlim(0,0)+ylim(0,0)


```


# 0, 22, 45, 90, silent (ctrl), TEA (ctrl) ====
## Figures

### Exploratory, look at all six groups

```{r}
phase_figs <- function(d = M.d.gj,
                       response.var = "r11",
                       x.lab = 'Time in Minutes',
                       y.lab = 'MegaOhms',
                       title.lab = "Coupling Resistance Changes with Phase",
                       ...) {
  d <- d[d$Condition %in% c("Silent.53mV",
                            "PS.0.TEA",
                            "PS.0",
                            "PS.22",
                            "PS.45",
                            "PS.90"), ]
  
  # d$Condition <- factor(d$Condition, levels = c(
  #   "Silent.53mV",
  # "PS.0.TEA",
  #  "PS.0",
  # "PS.22",
  # "PS.45",
  # "PS.90"
  # ))
  
  
  d$interact <- interaction(d$Experiment, d$Inj_Cell)
  
  d$Condition <- as.character(d$Condition)
  d[d$Condition %in% c("Silent.53mV"), "Condition"] <- "Silent"
  d[d$Condition %in% c("PS.0.TEA"), "Condition"] <- "0 Degrees TEA"
  
  d[d$Condition %in% c("PS.0"), "Condition"] <- "0 Degrees"
  d[d$Condition %in% c("PS.22"), "Condition"] <- "22.5 Degrees"
  d[d$Condition %in% c("PS.45"), "Condition"] <- "45 Degrees"
  d[d$Condition %in% c("PS.90"), "Condition"] <- "90 Degrees"
  d$Condition <- as.factor(d$Condition)
  
  d$Condition <- factor(
    d$Condition,
    levels = c(
      "Silent",
      "0 Degrees TEA",
      "0 Degrees",
      "22.5 Degrees",
      "45 Degrees",
      "90 Degrees"
    )
  )
  
  plt <-
    ggplot(d, aes_string(x = "Time", y = response.var)) +
    stat_summary(
      mapping = aes(fill = Condition),
      fun.data = mean_sdl,
      fun.args = list(mult = 1),
      geom = "ribbon",
      alpha = 0.2
    ) +
    stat_summary(
      aes(group = Condition),
      fun.y = mean,
      geom = "line",
      size = 1,
      linetype = 2,
      color = "black"
    ) +
    stat_summary(
      mapping = aes(color = Condition),
      fun.y = mean,
      geom = "point",
      size = 3,
      shape = 15
    ) +
    stat_summary(
      fun.y = mean,
      geom = "point",
      size = 3,
      shape = 0
    ) +
    geom_pointline(aes(group = interact)) +
    facet_grid(. ~ Condition) +
    theme_fivethirtyeight() +
    theme(
      legend.position = "",
      axis.title = element_text(),
      axis.title.x = element_text()
    ) +
    ylab(y.lab) +
    xlab(x.lab) +
    labs(title = title.lab)+
    kickme()
  
  
    return(plt)
}


for (i in 1:5){
  print(i)
  phase_figs(
    d = list(M, M, M, M.gj, M.gj)[[i]],
  response.var = c("r11","r1","cc","rc","gj")[i],
  x.lab = c('Time in Minutes', 'Time in Minutes', 'Time in Minutes','Time in Minutes', 'Time in Minutes')[i],
  y.lab = c('MegaOhms','MegaOhms','','MegaOhms','MegaOhms')[i],
  title.lab = c("Input Resistance", "Membrane Resistance", "Coupling Coefficient", "Coupling Resistance", "1/Coupling Conductance")[i],
  plt.name = c("phase_r_r11.tiff", "phase_r_r1.tiff", "phase_r_cc.tiff", "phase_r_rc.tiff", "phase_r_gj.tiff")[i]
  ) %>% plot()


}

for (i in 1:5){
  print(i)
  phase_figs(
    d = list(M.d, M.d, M.d, M.d.gj, M.d.gj)[[i]],
  response.var = c("r11","r1","cc","rc","gj")[i],
  x.lab = c('Time in Minutes', 'Time in Minutes', 'Time in Minutes','Time in Minutes', 'Time in Minutes')[i],
  y.lab = c('MegaOhms','MegaOhms','','MegaOhms','MegaOhms')[i],
  title.lab = c("Input Resistance", "Membrane Resistance", "", "Coupling Resistance", "")[i],
  plt.name = c("phase_d_r11.tiff", "phase_d_r1.tiff", "phase_d_cc.tiff", "phase_d_rc.tiff", "phase_d_gj.tiff")[i]
  )
}




```

saving figs
```{r}
#                        save.plt = FALSE,
#                        #if T, plt.name = "test.plt.tiff", plt.path =
# 
# if (save.plt) {
#     ggsave(
#       plt.name,
#       plot = plt,
#       device = NULL,
#       path = plt.path,
# width = 11, height = 8.5,
#       # units = c("in", "cm", "mm"),
#       dpi = 75#, limitsize = TRUE, ...
#     )
#   } else {
```

mean sd figs
```{r}
plot_means2 <- function(temp = M[M$Condition %in% CONDITIONS, ],
                       predictor = "Time",
                       response = "cc",
                       dodge = .9,
                       
                       YLIM = c(0.25, 0.75),
                       TITLE = "Coupling Coefficient Over Time",
                       XLAB = "Time in Minutes",
                       YLAB = "Coupling Coefficient",
                       # ymin = .25,
                       # ymax = 0.75,
                       USE.COLORS = c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3"),
                       LEGEND.POSITION = "",
                       
                       include.points = "No") {
  
  if (include.points == "No"){
  p <- ggplot(temp, aes_string(x = predictor, y = response, color = temp$Condition, group = temp$Condition)) +

    
    # stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "ribbon", alpha = 0.2)+
    geom_pointrange(
      stat = "summary", fun.ymin = function(z) {
        mean(z) - sd(z)
      }, fun.ymax = function(z) {
        mean(z) + sd(z)
      }, fun.y = mean,
      position = position_dodge(dodge),
      shape = 15
    ) +
    stat_summary(aes(group = Condition), fun.y = mean, geom = "line", size = 1, linetype = 2) +
    # stat_summary(position = position_dodge(.9), fun.y = mean, geom = "point", size = 3, shape = 15, alpha = 0.5) +
    # stat_summary(position = position_dodge(.9), fun.y = mean, geom = "point", size = 3, shape = 15, color = "White") +
    # stat_summary(position = position_dodge(.9), fun.y = mean, geom = "point", size = 3, shape = 0, color = "Black") +

    labs(title = TITLE, x = XLAB, y = YLAB) +
    # coord_capped_cart(bottom = "both") +
    # theme(panel.border = element_blank(), axis.line = element_line()) + # needed for lemon
    # theme(text = element_text(face = "bold", size = 14)) +
    kickme()+
    theme(legend.position = LEGEND.POSITION) +
    coord_cartesian(ylim = YLIM)+
    scale_color_manual(values = USE.COLORS)+
    facet_grid(.~temp$Condition)#
  
  
  } 
  # else if (include.points == "Yes"){
  # p <- ggplot(temp, aes_string(x = predictor, y = response, color = temp$Condition, group = temp$Condition)) +
  #   # stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "ribbon", alpha = 0.2)+
  #   geom_point(position = position_jitter(width = 0.3, height = 0), alpha = 0.3) +
  #   # geom_point(shape = 1, position = position_jitter(width = 0.3, height = 0)) +
  #   geom_pointrange(
  #     stat = "summary", fun.ymin = function(z) {
  #       mean(z) - sd(z)
  #     }, fun.ymax = function(z) {
  #       mean(z) + sd(z)
  #     }, fun.y = mean#,
  #     #position = position_dodge(.9)
  #   ) +
  #   stat_summary(aes(group = Condition), fun.y = mean, geom = "line", size = 1, linetype = 2) +
  #   stat_summary(fun.y = mean, geom = "point", size = 3, shape = 15, alpha = 0.5) +
  #   stat_summary(fun.y = mean, geom = "point", size = 3, shape = 15, color = "White") +
  #   stat_summary(fun.y = mean, geom = "point", size = 3, shape = 0, color = "Black") +
  #   labs(title = TITLE, x = XLAB, y = YLAB) +
  #   coord_capped_cart(bottom = "both") +
  #   theme(panel.border = element_blank(), axis.line = element_line()) + # needed for lemon
  #   theme(text = element_text(face = "bold", size = 14)) +
  #   theme(legend.position = LEGEND.POSITION) +
  #   #ylim(YLIM[1], YLIM[2]) +
  #   coord_cartesian(ylim = YLIM)+
  #   scale_color_manual(values = USE.COLORS)
  # }
  else if (include.points == "Pointline"){
  # p <- ggplot(temp, aes_string(x = predictor, y = response, color = temp$Condition, group = temp$Condition)) +
  #   # stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "ribbon", alpha = 0.2)+
  #   lemon::geom_pointline(aes(group = temp$Experiment))+
  #   geom_point(shape = 1, position = position_jitter(width = 0.3, height = 0)) +
  #   geom_pointrange(
  #     stat = "summary", fun.ymin = function(z) {
  #       mean(z) - sd(z)
  #     }, fun.ymax = function(z) {
  #       mean(z) + sd(z)
  #     }, fun.y = mean#,
  #     #position = position_dodge(.9)
  #   ) +
  #   stat_summary(aes(group = Condition), fun.y = mean, geom = "line", size = 1, linetype = 2) +
  #   stat_summary(fun.y = mean, geom = "point", size = 3, shape = 15, alpha = 0.5) +
  #   stat_summary(fun.y = mean, geom = "point", size = 3, shape = 15, color = "White") +
  #   stat_summary(fun.y = mean, geom = "point", size = 3, shape = 0, color = "Black") +
  #   labs(title = TITLE, x = XLAB, y = YLAB) +
  #   coord_capped_cart(bottom = "both") +
  #   theme(panel.border = element_blank(), axis.line = element_line()) + # needed for lemon
  #   theme(text = element_text(face = "bold", size = 14)) +
  #   theme(legend.position = LEGEND.POSITION) +
  #   # ylim(YLIM[1], YLIM[2]) +
  #   coord_cartesian(ylim = YLIM)+
  #   scale_color_manual(values = USE.COLORS)
  
  
  
  
  p <- ggplot(temp, aes_string(x = predictor, y = response, color = temp$Condition, group = temp$Condition)) +
    lemon::geom_pointline(aes(group = temp$Experiment))+
    geom_point(shape = 1, position = position_jitter(width = 0.3, height = 0)) +
    
    # stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "ribbon", alpha = 0.2)+
    geom_pointrange(
      stat = "summary", fun.ymin = function(z) {
        mean(z) - sd(z)
      }, fun.ymax = function(z) {
        mean(z) + sd(z)
      }, fun.y = mean,
      position = position_dodge(dodge),
      shape = 15
    ) +
    stat_summary(aes(group = Condition), fun.y = mean, geom = "line", size = 1, linetype = 2) +
    # stat_summary(position = position_dodge(.9), fun.y = mean, geom = "point", size = 3, shape = 15, alpha = 0.5) +
    # stat_summary(position = position_dodge(.9), fun.y = mean, geom = "point", size = 3, shape = 15, color = "White") +
    # stat_summary(position = position_dodge(.9), fun.y = mean, geom = "point", size = 3, shape = 0, color = "Black") +

    labs(title = TITLE, x = XLAB, y = YLAB) +
    # coord_capped_cart(bottom = "both") +
    # theme(panel.border = element_blank(), axis.line = element_line()) + # needed for lemon
    # theme(text = element_text(face = "bold", size = 14)) +
    kickme()+
    theme(legend.position = LEGEND.POSITION) +
    coord_cartesian(ylim = YLIM)+
    scale_color_manual(values = USE.COLORS)+
    facet_grid(.~temp$Condition)#
  
  }
  if (include.points != "Yes"){
  return(p)
  }else {
    warning("Yes and Pointline have not been modified. \nPlease edit code to mirror that for include.points == No")
  }
}
```


```{r}


```



#figs for djs

```{r}

select_groups <- function(d = M.d){
  # d <- M.d

d <- d[d$Condition %in% c(
          
  "Silent.53mV", 
  "PS.0.TEA", 
  "Inv", 
  "PS.0", 
  "PS.22", 
  "PS.45", 
  "PS.90",
  "PS.0.High.Amp",
  "PS.22.High.Amp",
  "PS.22.orig",
  "PS.0.orig",
  "PS.180.orig",
  "PS.90.orig",
  "PS.45.orig"
  ),]

# # Drop weird point
# d <- d[!(d$Experiment == "170802a" &
#          d$Inj_Cell == "LC5"),]
# d <- d[d$Time < 65,]
# #levels(d$Condition)

# Weird o45, v high
d <- d[d$Experiment != "170817a", ]

d <- d[d$Experiment != "170801a", ]


# d[d$Condition == 
#     "PS.180.orig" & 
#     d$Time== 20&
#     d$rc < -3.6, "Experiment"]
# 
# d[d$Condition == 
#     "PS.180.orig" & 
#     d$Time== 20, "rc"] %>% min(., na.rm = T)



d$Condition <- factor(d$Condition, levels = c(
  "Silent.53mV",
  "PS.0.TEA", 
  "Inv", 
  "PS.0", 
  "PS.22", 
  "PS.45", 
  "PS.90", 
  "PS.0.High.Amp",
  "PS.22.High.Amp",
  
  "PS.0.orig",
  "PS.22.orig",
    "PS.45.orig",
  "PS.90.orig",
  "PS.180.orig"
))

# 
# d$Condition2 <- as.character(d$Condition)
# 
# d[d$Condition %in% c("PS.0.orig", "PS.0"), "Condition2"] <- "g0"
# d[d$Condition %in% c("PS.22.orig", "PS.22"), "Condition2"] <- "g22"
# d[d$Condition %in% c("PS.45.orig", "PS.45"), "Condition2"] <- "g45"
# d[d$Condition %in% c("PS.90.orig", "PS.90"), "Condition2"] <- "g90"
# d[d$Condition %in% c("PS.180.orig"), "Condition2"] <- "g180"
# 
# d$Condition2 <- as.factor(d$Condition2)
# 
# 
# d$Condition2 <- factor(d$Condition2, levels = c(
# "g0",  "g22",  "g45", "g90",  "g180", "PS.0.High.Amp", "Inv", "PS.0.TEA", "PS.22.High.Amp", "Silent.53mV"))
# 
# d$Condition <- d$Condition2

return(d)
}

# plot_means2(
#     temp = d,
#     predictor = "Time",
#     response = "cc",
#     dodge = 1.9,
#     
#     YLIM =c(-1, 1),
#     TITLE = "Coupling Coef.",
#     XLAB = "Time (Min)",
#     YLAB = "Coupling Coef.",
#     USE.COLOR = RColorBrewer::brewer.pal(n = 7, "Paired"),
#     LEGEND.POSITION = "bottom",
#     include.points = "No"
#   )


iter.list <- list(
  df = list(M.d.gj, M.d, M.d, M.d.gj, M.d.gj),
  response = list("cc", "r11", "r1", "rc", "gj"),
  titles = list("CC", "Rin", "Rmem", "Rc", "Igj"),
  ylims = list(c(-1, 1), c(-1.5, 1.5), c(-2.5, 9), 
               # c(-2.5, 2.5),
               c(-5, 5),
               c(-2.5, 2.5)),
  ylabs = list("mV/mV", "M ohms", "M ohms", "M ohms", "M ohms")
)

# plot_grid(
#   plotlist = 
    purrr::map(1, function(i){
      
  plot_means2(
    temp = select_groups(d = iter.list$df[[i]]),
    predictor = "Time",
    response = iter.list$response[[i]],
    dodge = 1.9,
    
    YLIM = iter.list$ylims[[i]],
    TITLE = iter.list$titles[[i]],
    XLAB = "Time (Min)",
    YLAB = iter.list$ylabs[[i]],
    USE.COLOR = rep("#000000", 14), #RColorBrewer::brewer.pal(n = 7, "Paired"),
    LEGEND.POSITION = "",
    include.points = "Pointline" #"Pointline"
  )
      
      # ggsave(
      #   c("CC2.pdf", "Rin2.pdf", "Rmem2.pdf", "Rc2.pdf", "Igj2.pdf")[i],
      #   plot = last_plot(),
      #   # path = "",
      #   # , scale = 1, width = NA, height = NA,
      #   # units = c("in", "cm", "mm"),
      #   dpi = 75#, limitsize = TRUE, ...
      # )

})
# )
```



## read + incorperate
## TEST for DJS: CC with Mean/sd ###

0-90
```{r}
#d <- M
d <- M.d
# d <- M.p
d <- d[d$Condition %in% c(
  #"PS.0.High.Amp", 
  #"Inv", 
  "PS.0",
  #"PS.0.TEA", 
  "PS.22",# "PS.22.High.Amp"#,
  # "PS.22.orig", 
  "PS.45",
  "PS.90"
  #"Silent.53mV", 
  # "PS.0.orig", "PS.180.orig", "PS.90.orig"#, "PS.45.orig"
                          ),]

# Drop weird point
d <- d[!(d$Experiment == "170802a" &
         d$Inj_Cell == "LC5"),]
d <- d[d$Time < 65,]
#levels(d$Condition)

d$Condition <- factor(d$Condition, levels = c(
# "PS.0.orig", "PS.22.orig", #"PS.45.orig", 
#"PS.45", 
# "PS.90.orig", "PS.180.orig"#, 
#"PS.0", "PS.22",  "PS.0.High.Amp", "PS.22.High.Amp", 
#"PS.0.TEA", "Silent.TEA", "Inv", "Silent.53mV"  
  "PS.0",
  "PS.22",
  "PS.45",
  "PS.90"
))




#"No" "Yes" "Pointline"
show.pts <- "No"








# cowplot::plot_grid(plotlist = list(
#   plot_means2(
#     temp = d,
#     predictor = "Time",
#     response = "cc",
#     YLIM =
#     # c(0, 1),
#     c(-1, 1),
#      # c(-30, 60),
#     #c(min(d$cc, na.rm = T), max(d$cc, na.rm = T)),
#     TITLE = "Coupling Coef.",
#     XLAB = "Time (Min)",
#     YLAB = "Coupling Coef.",
#     USE.COLOR = # c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3")
#     # c("#7FC97F", "#BEAED4", "#FDC086", "#FFFF99", "#386CB0", "#F0027F")
#     c("#4d4d4d", "#984EA3", "#377EB8", "#4DAF4A", "#FF7F00", "#E41A1C"),
#     LEGEND.POSITION = "right",
#     include.points = show.pts
#   ),
# 
#   plot_means2(
#     temp = d,
#     predictor = "Time",
#     response = "r11",
#     YLIM =
#     # c(0, 6),
#     c(-3, 3),
#      # c(-30, 35),
#     #c(min(d$r11, na.rm = T), max(d$r11, na.rm = T)),
#     TITLE = "Input Resistance",
#     XLAB = "Time (Min)",
#     YLAB = "Mega Ohms",
#     USE.COLOR = # c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3")
#     # c("#7FC97F", "#BEAED4", "#FDC086", "#FFFF99", "#386CB0", "#F0027F")
#     c("#4d4d4d", "#984EA3", "#377EB8", "#4DAF4A", "#FF7F00", "#E41A1C"),
#     LEGEND.POSITION = "right",
#     include.points = show.pts
#   ),
# 
#   plot_means2(
#     temp = d,
#     predictor = "Time",
#     response = "gj",
#     YLIM =
#     # c(0, 15),
#     c(-2.5, 2.5),
#      # c(-40, 50),
#     #c(min(d$rc, na.rm = T), max(d$rc, na.rm = T)),
#     TITLE = "Coupling Resistance",
#     XLAB = "Time (Min)",
#     YLAB = "Mega Ohms",
#     USE.COLOR = # c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3")
#     # c("#7FC97F", "#BEAED4", "#FDC086", "#FFFF99", "#386CB0", "#F0027F")
#     c("#4d4d4d", "#984EA3", "#377EB8", "#4DAF4A", "#FF7F00", "#E41A1C"),
#     LEGEND.POSITION = "right",
#     include.points = show.pts
#   ),
#   
#     plot_means2(
#       temp = d,
#       predictor = "Time",
#       response = "rmp",
#       YLIM =
#       # c(-80, -20),
#       c(-20, 20),
#        # c(-10, 25),
#       #c(min(d$rmp, na.rm = T), max(d$rmp, na.rm = T)),
#       TITLE = "Resting Membrane Potential",
#       XLAB = "Time (Min)",
#       YLAB = "mV",
#       USE.COLOR = # c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3")
#       # c("#7FC97F", "#BEAED4", "#FDC086", "#FFFF99", "#386CB0", "#F0027F")
#       c("#4d4d4d", "#984EA3", "#377EB8", "#4DAF4A", "#FF7F00", "#E41A1C"),
#       LEGEND.POSITION = "right",
#       include.points = show.pts
#     )
#   
# ), nrow = 1)




```
names of the resultant files:
1500x600_raw_x_sd_pts
1500x600_raw_x_sd

1500x600_del_x_sd_pts
1500x600_del_x_sd

1500x600_per_x_sd_pts
1500x600_per_x_sd


> group_vector <- paste(d$Experiment, d$Inj_Cell)

## Statistics
Here we resample all of our linear models and then produce standard and empirical p values
```{r perform resampling}
if (resample.results == TRUE){
  tic1 <- Sys.time()
  me_cell <- purrr::map(c("r11", "r1", "cc"
                          # , "htk.peak.nA", "a.peak.nA"
                          ), function(x) {
    run_standardized_lme_resample_Phase(
      response.var = x,
      input.df = M[M$Condition %in% c("PS.0", "PS.22", "PS.45", "PS.90"), ],
      nreps = resample.nreps,
      use.seed = 432431,
      mute.completion = TRUE,
      mute.time = FALSE
    )
  })
  
  me_exps <- purrr::map(c("rc", "gj"), function(x) {
    run_standardized_lme_resample_Phase(
      response.var = x,
      input.df = M.gj[M.gj$Condition %in% c("PS.0", "PS.22", "PS.45", "PS.90"), ],
      nreps = resample.nreps,
      use.seed = 432431,
      mute.completion = TRUE,
      mute.time = FALSE
    )
  })
  toc1 <- Sys.time()
  print(toc1 - tic1)
  
  # Restructure into a single list of all outputs
  me_all <- list()
  walk(seq_along(me_cell), function(X){ me_all[[length(me_all)+1]] <<- me_cell[[X]] })
  walk(seq_along(me_exps), function(X){ me_all[[length(me_all)+1]] <<- me_exps[[X]] })
  
  saveRDS(me_all, file = paste0(getwd(), "/data/output/", "rPS0_PS90_model_results", ".rds"))
  write.csv(me_all, file = paste0(getwd(), "/data/output/", "rPS0_PS90_model_results", ".csv"))
} else {
  me_all <- readRDS(paste0(getwd(), "/data/", "resampled_phase_model_results", ".rds"))
}

```


```{r calc empirical p}
# Main effect empirical p values
measures <- c("r11", "r1", 
              "cc", 
              # "htk.peak.nA", "a.peak.nA",
              "rc", 
              "gj")
out <- as.data.frame(matrix(ncol = 4, nrow = length(measures)))
names(out) <- c("Intercept", "Time", "Phase", "Time:Phase")
rownames(out) <- measures

walk(seq_along(measures), function(i){
  walk(1:4, function(j){
    out[i, j] <<- one_tail_to_epval(input.array = me_all[[i]][,j], tail = "upper")
  })
})


out.holm <- t(out) %>% as.data.frame()
walk(1:ncol(out.holm), function(i){
  out.holm[,i] <<- p.adjust(out.holm[,i], method = "holm") 
})
out.holm <- t(out.holm) %>% as.data.frame()


knitr::kable(out)
knitr::kable(out.holm)

# write.csv(out, paste0(getwd(), "/epvals_phase.csv"))
# write.csv(out.holm, paste0(getwd(), "/epvals_holm_phase.csv"))

write.csv(out, paste0(getwd(), "/data/output/", "rPS0_PS90_model_pvals", ".csv"))
write.csv(out, paste0(getwd(), "/data/output/", "rPS0_PS90_model_pvals_holm", ".csv"))
# write.csv(out.holm, paste0("C:/Users/Daniel/Desktop/epvals_holm_phase.csv"))

```


## Phase Shift -- All tests resampled








# 0, 22, 22HV, 90HV ==== Is 22.5 effect real?
```{r}
d <- M.gj
d <- M.d.gj
#d <- M.p

d <- d[d$Time < 61,]

d <- d[d$Condition %in% c(
  "PS.0",
  "PS.22",
  "PS.0.High.Amp",
  "PS.22.High.Amp"

                          ),]

# Drop weird point
# d <- d[!(d$Experiment == "170802a" &
#          d$Inj_Cell == "LC5"),]
# d <- d[d$Time < 55,]
#levels(d$Condition)

d$Condition <- factor(d$Condition, levels = c(
 "PS.0",
"PS.22",
"PS.0.High.Amp",
"PS.22.High.Amp"
))


d$interact <- interaction(d$Experiment, d$Inj_Cell)

d$Phase <- "None"
  d[d$Condition %in% c("PS.22", "PS.22.High.Amp"), "Phase"] <- "22.5 Degrees"
  d[d$Condition %in% c("PS.0", "PS.0.High.Amp"), "Phase"] <- "0 Degrees"
  d$Amp <- "None"
  d[d$Condition %in% c("PS.0.High.Amp", "PS.22.High.Amp"), "Amp"] <- "High Voltage"
  d[d$Condition %in% c("PS.0", "PS.22"), "Amp"] <- "Control Voltage"



#   # First model with observed data
#   fm <- lme(gj ~ Time * Phase + Time * Amp + Phase * Amp, random = ~1 | interact, method = "ML", data = d)
#   stats.table <- anova.lme(fm)
# stats.table


#summary(glht(fm, linfct=mcp(Condition="Tukey")))


ggplot(d, aes(x = Time, y = gj))+
  stat_summary(mapping = aes(fill = Condition), fun.data = mean_sdl, fun.args = list(mult = 1), geom = "ribbon", alpha = 0.2) +
  stat_summary(aes(group = Condition), fun.y = mean, geom = "line", size = 1, linetype = 2, color = "black")+
  stat_summary(mapping = aes(color = Condition), fun.y = mean, geom = "point", size = 3, shape = 15) +
  stat_summary(fun.y = mean, geom = "point", size = 3, shape = 0) +
  geom_pointline(aes(group = Experiment))+
  facet_grid(Phase~Amp)+
  theme_fivethirtyeight()+
  theme(legend.position = "",
        axis.title = element_text(), 
        axis.title.x = element_text()) + 
  ylab('MegaOhms')+
  xlab('Time in Minutes')+
  labs(title = "Coupling Resistance Changes with Phase")+
  theme(
        #panel.grid.major = element_blank(), 
        #panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "transparent",colour = NA),
        plot.background = element_rect(fill = "transparent",colour = NA),
        strip.background =element_rect(fill="transparent", colour =NA))+
  # ggsci::scale_fill_aaas()+
  # ggsci::scale_color_aaas()
  scale_color_manual(values = c("#000000",
                                "#002163",
                                "#006837",
                               "#31A354"))+
  scale_fill_manual(values = c("#000000",
                                "#002163",
                                "#006837",
                               "#31A354"))


```

```{r}
# phase_HA_figs <- function(d = M.d.gj,
# response.var = "r11",
# x.lab = 'Time in Minutes',
# y.lab = 'MegaOhms',
# title.lab = "Coupling Resistance Changes with Phase",
# plt.name = "test.plt.tiff"){
#   
# 
#   d <- d[d$Time < 61,]
# 
# d <- d[d$Condition %in% c(
#   "PS.0",
#   "PS.22",
#   "PS.0.High.Amp",
#   "PS.22.High.Amp"
# 
#                           ),]
# 
# # Drop weird point
# # d <- d[!(d$Experiment == "170802a" &
# #          d$Inj_Cell == "LC5"),]
# # d <- d[d$Time < 55,]
# #levels(d$Condition)
# 
# d$Condition <- factor(d$Condition, levels = c(
#  "PS.0",
# "PS.22",
# "PS.0.High.Amp",
# "PS.22.High.Amp"
# ))
# 
# 
# d$interact <- interaction(d$Experiment, d$Inj_Cell)
# 
# d$Phase <- "None"
#   d[d$Condition %in% c("PS.22", "PS.22.High.Amp"), "Phase"] <- "22.5 Degrees"
#   d[d$Condition %in% c("PS.0", "PS.0.High.Amp"), "Phase"] <- "0 Degrees"
#   d$Amp <- "None"
#   d[d$Condition %in% c("PS.0.High.Amp", "PS.22.High.Amp"), "Amp"] <- "High Voltage"
#   d[d$Condition %in% c("PS.0", "PS.22"), "Amp"] <- "Control Voltage"
# 
#   
# plt <- 
# ggplot(d, aes_string(x = "Time", y = response.var))+
#   stat_summary(mapping = aes(fill = Condition), fun.data = mean_sdl, fun.args = list(mult = 1), geom = "ribbon", alpha = 0.2) +
#   stat_summary(aes(group = Condition), fun.y = mean, geom = "line", size = 1, linetype = 2, color = "black")+
#   stat_summary(mapping = aes(color = Condition), fun.y = mean, geom = "point", size = 3, shape = 15) +
#   stat_summary(fun.y = mean, geom = "point", size = 3, shape = 0) +
#   geom_pointline(aes(group = interact))+
#   facet_grid(Phase~Amp)+
#   theme_fivethirtyeight()+
#   theme(legend.position = "",
#         axis.title = element_text(), 
#         axis.title.x = element_text()) + 
#   ylab(y.lab)+
#   xlab(x.lab)+
#   labs(title = title.lab)+
#   theme(
#         #panel.grid.major = element_blank(), 
#         #panel.grid.minor = element_blank(),
#         panel.background = element_rect(fill = "transparent",colour = NA),
#         plot.background = element_rect(fill = "transparent",colour = NA),
#         strip.background =element_rect(fill="transparent", colour =NA)
#         )+
#    scale_color_manual(values = c("#000000",
#                                 "#002163",
#                                 "#006837",
#                                "#31A354"))+
#   scale_fill_manual(values = c("#000000",
#                                 "#002163",
#                                 "#006837",
#                                "#31A354"))+
#   theme(strip.text.x = element_text(size = 18, colour = "Black", angle = 0),
#         strip.text.y = element_text(size = 18, colour = "Black", angle = -90),
#         axis.text.x = element_text(size = 12, colour = "Black", angle = 0),
#         axis.text.y = element_text(size = 12, colour = "Black", angle = 0),
#         axis.title.x = element_text(size = 18, colour = "Black", angle = 0),
#         axis.title.y = element_text(size = 18, colour = "Black", angle = 90))
# 
# 
# 
# ggsave(plt.name, plot = plt, 
#        device = NULL,
#   # path = NULL
#   # , scale = 1, width = NA, height = NA,
#   # units = c("in", "cm", "mm"), 
#   dpi = 75#, limitsize = TRUE, ...
#   )
# }
# 
# 
# for (i in 1:5){
#   print(i)
# 
#   phase_HA_figs(
#     d = list(M, M, M, M.gj, M.gj)[[i]],
#   response.var = c("r11","r1","cc","rc","gj")[i],
#   x.lab = c('Time in Minutes', 'Time in Minutes', 'Time in Minutes','Time in Minutes', 'Time in Minutes')[i],
#   y.lab = c('MegaOhms','MegaOhms','','MegaOhms','MegaOhms')[i],
#   title.lab = c("Input Resistance", "Membrane Resistance", "Coupling Coefficient", "Coupling Resistance", "1/Coupling Conductance")[i],
#   plt.name = c("twoxtwo_r_r11.tiff", "twoxtwo_r_r1.tiff", "twoxtwo_r_cc.tiff", "twoxtwo_r_rc.tiff", "twoxtwo_r_gj.tiff")[i]
#   )
#   
#   
# }
# 
# 
# 
# for (i in 1:5){
#   print(i)
# 
#   phase_HA_figs(
#     d = list(M.d, M.d, M.d, M.d.gj, M.d.gj)[[i]],
#   response.var = c("r11","r1","cc","rc","gj")[i],
#   x.lab = c('Time in Minutes', 'Time in Minutes', 'Time in Minutes','Time in Minutes', 'Time in Minutes')[i],
#   y.lab = c('MegaOhms','MegaOhms','','MegaOhms','MegaOhms')[i],
#   title.lab = c("Input Resistance", "Membrane Resistance", "", "Coupling Resistance", "")[i],
#   plt.name = c("twoxtwo_d_r11.tiff", "twoxtwo_d_r1.tiff", "twoxtwo_d_cc.tiff", "twoxtwo_d_rc.tiff", "twoxtwo_d_gj.tiff")[i]
#   )
# }

```


### 2x2 -- All tests resampled
Here we resample all of our linear models and then produce standard and empirical p values

```{r resampling fcns}
run_standardized_lme <- function(response.var = "cc",
                                 input.df = M[M$Condition %in% c("PS.0.High.Amp", "PS.0", "PS.22", "PS.22.High.Amp"), ],
                                 mute.time = FALSE) {
  tic <- Sys.time()

  # Transform the data so that it's ready for the test
  input.df <- input.df[!(is.na(input.df[[response.var]])), ]
  input.df$response.var <- input.df[[response.var]]
  # input.df$Time <- as.factor(input.df$Time)
  input.df$interact <- interaction(input.df$Experiment, input.df$Inj_Cell)

  input.df$Phase <- "None"
  input.df[input.df$Condition %in% c("PS.22", "PS.22.High.Amp"), "Phase"] <- "Offset"
  input.df[input.df$Condition %in% c("PS.0", "PS.0.High.Amp"), "Phase"] <- "Normal"
  input.df$Amp <- "None"
  input.df[input.df$Condition %in% c("PS.0.High.Amp", "PS.22.High.Amp"), "Amp"] <- "High"
  input.df[input.df$Condition %in% c("PS.0", "PS.22"), "Amp"] <- "Normal"

  input.df <- input.df[, c("response.var", "interact", "Time", "Phase", "Amp")]

  # First model with observed data
  fm <- lme(response.var ~ Time * Phase + Time * Amp + Phase * Amp, random = ~1 | interact, method = "ML", data = input.df)
  stats.table <- anova.lme(fm)

  toc <- Sys.time()

  if (mute.time != TRUE){
    print(toc - tic)
  }
  return(stats.table)
}




```

### non-resampled
```{r run standard tests}
tic1 <- Sys.time()
me_cell <- purrr::map(c("r11", "r1", "cc", "htk.peak.nA", "a.peak.nA"), function(x) {
  run_standardized_lme(
    response.var = x,
    input.df = M[M$Condition %in% c("PS.0.High.Amp", "PS.0", "PS.22", "PS.22.High.Amp"), ],
    mute.time = FALSE
  )
})

me_exps <- purrr::map(c("rc", "gj"), function(x) {
  run_standardized_lme(
    response.var = x,
    input.df = M.gj[M.gj$Condition %in% c("PS.0.High.Amp", "PS.0", "PS.22", "PS.22.High.Amp"), ],
    mute.time = FALSE
  )
})
toc1 <- Sys.time()
print(toc1 - tic1)
```


```{r mk tables for standard tests}
# Restructure into a single list of all outputs
me_all <- list()
walk(seq_along(me_cell), function(X){ me_all[[length(me_all)+1]] <<- me_cell[[X]] })
walk(seq_along(me_exps), function(X){ me_all[[length(me_all)+1]] <<- me_exps[[X]] })

measures <- c("r11", "r1", 
              "cc", 
              "htk.peak.nA", "a.peak.nA",
              "rc", 
              "gj")
# Add measures column
walk(seq_along(me_all), function(X){
  me_all[[X]]$response.var <<- measures[X]
})

# 
out <- me_all[[1]]
walk(2:length(me_all), function(X){
  out <<- rbind(out, me_all[[X]])
})

# Holm correct
out.holm <- out

responses <- unique(out.holm$response.var)

walk(seq_along(responses), function(i){
  out.holm[out.holm$response.var == responses[i], "p-value"] <<- p.adjust(out.holm[out.holm$response.var == responses[i], "p-value"], method = "holm")
})


knitr::kable(out)

knitr::kable(out.holm)

#write.csv(out, paste0(getwd(), "/inst/extdata/output/pvals_main_effect.csv"))
#write.csv(out.holm, paste0(getwd(), "/inst/extdata/output/pvals_main_effect_holm.csv"))


```


### Resampled
```{r perform resampling}
if (resample.results == TRUE){
  tic1 <- Sys.time()
  me_cell <- purrr::map(c("r11", "r1", "cc"
                          # , "htk.peak.nA", "a.peak.nA"
                          ), function(x) {
    run_standardized_lme_resample(
      response.var = x,
      input.df = M[M$Condition %in% c("PS.0.High.Amp", "PS.0", "PS.22", "PS.22.High.Amp"), ],
      nreps = resample.nreps,
      use.seed = 432431,
      mute.completion = TRUE,
      mute.time = FALSE
    )
  })
  
  me_exps <- purrr::map(c("rc", "gj"), function(x) {
    run_standardized_lme_resample(
      response.var = x,
      input.df = M.gj[M.gj$Condition %in% c("PS.0.High.Amp", "PS.0", "PS.22", "PS.22.High.Amp"), ],
      nreps = resample.nreps,
      use.seed = 432431,
      mute.completion = TRUE,
      mute.time = FALSE
    )
  })
  toc1 <- Sys.time()
  print(toc1 - tic1)
  
  # Restructure into a single list of all outputs
  me_all <- list()
  walk(seq_along(me_cell), function(X){ me_all[[length(me_all)+1]] <<- me_cell[[X]] })
  walk(seq_along(me_exps), function(X){ me_all[[length(me_all)+1]] <<- me_exps[[X]] })
  
  saveRDS(me_all, file = paste0(getwd(), "/data/chapter2/", "resampled_2x2_model_results", ".rds"))
} else {
  me_all <- readRDS(paste0(getwd(), "/data/chapter2/", "resampled_2x2_model_results", ".rds"))
}

```


```{r calc empirical p}




# Main effect empirical p values
measures <- c("r11", "r1", 
              "cc", 
              # "htk.peak.nA", "a.peak.nA",
              "rc", 
              "gj")
out <- as.data.frame(matrix(ncol = 7, nrow = length(measures)))
names(out) <- c("Intercept", "Time", "Phase", "Amp", "Time:Phase", "Time:Amp", "Phase:Amp")
rownames(out) <- measures

walk(seq_along(measures), function(i){
  walk(1:7, function(j){
    out[i, j] <<- one_tail_to_epval(input.array = me_all[[i]][,j], tail = "upper")
  })
})


out.holm <- t(out) %>% as.data.frame()
walk(1:ncol(out.holm), function(i){
  out.holm[,i] <<- p.adjust(out.holm[,i], method = "holm") 
})
out.holm <- t(out.holm) %>% as.data.frame()


knitr::kable(out)
knitr::kable(out.holm)

write.csv(out, paste0("C:/Users/Daniel/Desktop/epvals_2x2.csv"))
write.csv(out.holm, paste0("C:/Users/Daniel/Desktop/epvals_holm_2x2.csv"))
```





# Extra-- the originals
## TEST for DJS: visualize only the original data
```{r}
d <- M.gj
d <- d[d$Condition %in% c(
  #"PS.0.High.Amp", 
  #"Inv", 
  #"PS.0", #"PS.0.TEA", 
  #"PS.22", "PS.22.High.Amp", 
  "PS.22.orig", 
  #"PS.45"#, 
  #"Silent.53mV", 
  "PS.0.orig", "PS.180.orig", "PS.90.orig", "PS.45.orig"
                          ),]
d$Synchronous <- F
d[d$Condition == "PS.0.orig", "Synchronous"] <- T


cowplot::plot_grid(plotlist = list(

ggplot(d, aes(x = Time, y = rc, color = Synchronous))+
  geom_smooth()+
  geom_point(),

ggplot(d, aes(x = Time, y = cc, color = Synchronous))+
  geom_smooth()+
  geom_point(),





ggplot(d, aes(x = Time, y = rc, color = Condition))+
  geom_smooth(se = F)+
  geom_point(),

ggplot(d, aes(x = Time, y = cc, color = Condition))+
  geom_smooth(se = F)+
  geom_point()

))
```


## TEST for djs recreate comps percent change figure
```{r}
#d <- M
#d <- M.d
d <- M.p
d <- d[d$Condition %in% c(
  #"PS.0.High.Amp", 
  #"Inv", 
  #"PS.0", 
  #"PS.0.TEA", 
  #"PS.22", "PS.22.High.Amp"#, 
  "PS.22.orig", 
  "PS.45", 
  #"Silent.53mV", 
  "PS.0.orig", "PS.180.orig", "PS.90.orig", "PS.45.orig"
                          ),]

#levels(d$Condition)

d$Condition <- factor(d$Condition, levels = c(
"PS.0.orig", "PS.22.orig", "PS.45.orig", "PS.45", "PS.90.orig", "PS.180.orig"#, 
#"PS.0", "PS.22",  "PS.0.High.Amp", "PS.22.High.Amp", 
#"PS.0.TEA", "Silent.TEA", "Inv", "Silent.53mV"  
))

#library(RColorBrewer)
# ggplot(d, aes(x = Time, y = cc, color = Condition))+
#   geom_point(shape = 1)+
#   geom_point(alpha = 0.3)+
#   geom_hline(yintercept = 0, linetype = "dashed")+
#   stat_summary(aes(group=Condition), fun.y=mean, geom="line", size = 1)+
#   stat_summary(aes(group=Condition), fun.y=mean, geom="point", shape = 3, size = 3)+
#   theme(legend.position = "bottom")+
#   labs(title = "with mean")+
#   ggsci::scale_color_locuszoom()
  
cowplot::plot_grid(plotlist = list(
ggplot(d, aes(x = Time, y = cc, color = Condition))+
  geom_point(shape = 1)+
  geom_point(alpha = 0.3)+
  geom_hline(yintercept = 0, linetype = "dashed")+
  stat_summary(aes(group=Condition), fun.y=mean, geom="line", size = 1)+
  stat_summary(aes(group=Condition), fun.y=mean, geom="point", shape = 3, size = 3)+
  #theme(legend.position = "bottom")+
  labs(title = "with mean")+
  ggsci::scale_color_locuszoom(),
  
  
ggplot(d, aes(x = Time, y = cc, color = Condition))+
  geom_point(shape = 1)+
  geom_point(alpha = 0.3)+
  geom_hline(yintercept = 0, linetype = "dashed")+
  stat_summary(aes(group=Condition), fun.y=median, geom="line", size = 1)+
  stat_summary(aes(group=Condition), fun.y=median, geom="point", shape = 3, size = 3)+
  #theme(legend.position = "bottom")+
  labs(title = "with median")+
  ggsci::scale_color_locuszoom()
))

cowplot::plot_grid(plotlist = list(
ggplot(d[d$Condition != "PS.45.orig", ], aes(x = Time, y = cc, color = Condition))+
  geom_point(shape = 1)+
  geom_point(alpha = 0.3)+
  geom_hline(yintercept = 0, linetype = "dashed")+
  stat_summary(aes(group=Condition), fun.y=mean, geom="line", size = 1)+
  stat_summary(aes(group=Condition), fun.y=mean, geom="point", shape = 3, size = 3)+
  #theme(legend.position = "bottom")+
  labs(title = "with mean, no 45")+
  ggsci::scale_color_locuszoom(),

ggplot(d[d$Condition != "PS.45.orig" &
           d$Condition != "PS.45", ], aes(x = Time, y = cc, color = Condition))+
  geom_point(shape = 1)+
  geom_point(alpha = 0.3)+
  geom_hline(yintercept = 0, linetype = "dashed")+
  stat_summary(aes(group=Condition), fun.y=mean, geom="line", size = 1)+
  stat_summary(aes(group=Condition), fun.y=mean, geom="point", shape = 3, size = 3)+
  
  stat_summary(data = d[d$Condition == "PS.45", ],
                aes(x = Time, y = cc, color = Condition, group = Condition), fun.y=median, geom="line", linetype = "dashed", size = 1
               #, color = "#EDF8FB"
               )+
  #theme(legend.position = "bottom")+
  labs(title = "with mean, no 45")+
  ggsci::scale_color_locuszoom()
))


### Change colors ####
cowplot::plot_grid(plotlist = list(
ggplot(d[d$Condition != "PS.45.orig" &
              d$Condition != "PS.45", ], aes(x = Time, y = cc, color = Condition))+
  geom_point(shape = 1)+
  geom_point(alpha = 0.3)+
  geom_hline(yintercept = 0, linetype = "dashed")+
  stat_summary(aes(group=Condition), fun.y=mean, geom="line", size = 1)+
  stat_summary(aes(group=Condition), fun.y=mean, geom="point", shape = 3, size = 3)+
  #theme(legend.position = "bottom")+
  labs(title = "with mean, no 45")+

  stat_summary(data = d[d$Condition == "PS.45", ],
                aes(x = Time, y = cc, color = Condition, group = Condition), fun.y=median, geom="line", linetype = "dashed", size = 1
               #, color = "#EDF8FB"
               )+
  #ggsci::scale_color_locuszoom()  
  scale_color_manual(values = c("#7FCDBB","#41B6C4","#1D91C0","#225EA8","#253494") ),

ggplot(d[d$Condition != "PS.45.orig" &
              d$Condition != "PS.45", ], aes(x = Time, y = cc, color = Condition))+
  geom_point(shape = 1)+
  geom_point(alpha = 0.3)+
  geom_hline(yintercept = 0, linetype = "dashed")+
  stat_summary(aes(group=Condition), fun.y=median, geom="line", size = 1)+
  stat_summary(aes(group=Condition), fun.y=median, geom="point", shape = 3, size = 3)+
  #theme(legend.position = "bottom")+
  labs(title = "with median, no 45")+

  stat_summary(data = d[d$Condition == "PS.45", ],
                aes(x = Time, y = cc, color = Condition, group = Condition), fun.y=median, geom="line", linetype = "dashed", size = 1
               #, color = "#EDF8FB"
               )+
  #ggsci::scale_color_locuszoom()  
  scale_color_manual(values = c("#7FCDBB","#41B6C4","#1D91C0","#225EA8","#253494") )
#c("#C7E9B4","#7FCDBB","#41B6C4","#2C7FB8","#253494"))

))





### Drop points ####

cowplot::plot_grid(plotlist = list(
ggplot(d[d$Condition != "PS.45.orig" &
           d$Condition != "PS.45", ], aes(x = Time, y = cc, color = Condition))+
  # geom_point(shape = 1)+
  # geom_point(alpha = 0.3)+
  geom_hline(yintercept = 0, linetype = "dashed")+
  stat_summary(aes(group=Condition), fun.y=mean, geom="line", size = 1)+
  stat_summary(aes(group=Condition), fun.y=mean, geom="point", shape = 3, size = 3)+
  
  stat_summary(data = d[d$Condition == "PS.45", ],
                aes(x = Time, y = cc, color = Condition, group = Condition), fun.y=median, geom="line", linetype = "dashed", size = 1
               #, color = "#EDF8FB"
               )+
  #theme(legend.position = "bottom")+
  labs(title = "with mean, no 45")+
  ggsci::scale_color_locuszoom(),

ggplot(d[d$Condition != "PS.45.orig" &
           d$Condition != "PS.45", ], aes(x = Time, y = cc, color = Condition))+
  # geom_point(shape = 1)+
  # geom_point(alpha = 0.3)+
  geom_hline(yintercept = 0, linetype = "dashed")+
  stat_summary(aes(group=Condition), fun.y=mean, geom="line", size = 1)+
  stat_summary(aes(group=Condition), fun.y=mean, geom="point", shape = 3, size = 3)+
  
  stat_summary(data = d[d$Condition == "PS.45", ],
                aes(x = Time, y = cc, color = Condition, group = Condition), fun.y=median, geom="line", linetype = "dashed", size = 1
               #, color = "#EDF8FB"
               )+
  #theme(legend.position = "bottom")+
  labs(title = "with mean, no 45")+
  scale_color_manual(values = c("#7FCDBB","#41B6C4","#1D91C0","#225EA8","#253494") )
))

```



# Link to Frankenstein experiments
















# For SFN Abstract

```{r}
# median delta
median(M.d.gj[M.d.gj$Condition %in% c("PS.22") & M.d.gj$Time == 60, "rc"], na.rm = T)


median(M.d.gj[M.d.gj$Condition %in% c("PS.90") & M.d.gj$Time == 60, "rc"], na.rm = T)
```



```{r}

response.var = "rc"
input.df = M.gj[M.gj$Condition %in% c("PS.0", "PS.22", "PS.45", "PS.90"), ]
nreps = 100
use.seed = 432431
mute.completion = FALSE
mute.time = FALSE

  
  
  tic <- Sys.time()

  # Transform the data so that it's ready for the test
  input.df <- input.df[!(is.na(input.df[[response.var]])), ]
  input.df$response.var <- input.df[[response.var]]
  # input.df$Time <- as.factor(input.df$Time)
  input.df$interact <- interaction(input.df$Experiment, input.df$Inj_Cell)

  input.df$Phase <- "None"
  
  input.df[input.df$Condition %in% c("PS.0"),  "Phase"] <- "0"
  input.df[input.df$Condition %in% c("PS.22"), "Phase"] <- "22"
  input.df[input.df$Condition %in% c("PS.45"), "Phase"] <- "45"
  input.df[input.df$Condition %in% c("PS.90"), "Phase"] <- "90"
  

  input.df <- input.df[, c("response.var", "interact", "Time", "Phase"
                           # , "Amp"
                           )]

  # First model with observed data
  fm <- lme(response.var ~ Time * Phase, random = ~1 | interact, method = "ML", data = input.df)
  stats.table <- anova.lme(fm)
```


```{r}
response.var = "rc"
input.df = M.gj[M.gj$Condition %in% c("PS.0.High.Amp", "PS.0", "PS.22", "PS.22.High.Amp"), ]
mute.time = FALSE


tic <- Sys.time()

# Transform the data so that it's ready for the test
input.df <- input.df[!(is.na(input.df[[response.var]])), ]
input.df$response.var <- input.df[[response.var]]
# input.df$Time <- as.factor(input.df$Time)
input.df$interact <- interaction(input.df$Experiment, input.df$Inj_Cell)

input.df$Phase <- "None"
input.df[input.df$Condition %in% c("PS.22", "PS.22.High.Amp"), "Phase"] <- "Offset"
input.df[input.df$Condition %in% c("PS.0", "PS.0.High.Amp"), "Phase"] <- "Normal"
input.df$Amp <- "None"
input.df[input.df$Condition %in% c("PS.0.High.Amp", "PS.22.High.Amp"), "Amp"] <- "High"
input.df[input.df$Condition %in% c("PS.0", "PS.22"), "Amp"] <- "Normal"

input.df <- input.df[, c("response.var", "interact", "Time", "Phase", "Amp")]

# First model with observed data
fm <- lme(response.var ~ Time * Phase + Time * Amp + Phase * Amp, random = ~1 | interact, method = "ML", data = input.df)
stats.table <- anova.lme(fm)
```


